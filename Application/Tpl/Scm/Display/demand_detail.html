<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/utils/css/public.style.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/icon/css/font-awesome.min.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Oms/Public/css/list_common.css?v=<{$Think.config.VER_NUM}>">
    <title>{{$lang('创建需求')}}</title>
</head>
<style>
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none !important;
        margin: 0;
    }

    input::-ms-outer-spin-button,
    input::-ms-inner-spin-button {
        -ms-appearance: none !important;
        margin: 0;
    }

    input::-o-outer-spin-button,
    input::-o-inner-spin-button {
        -o-appearance: none !important;
        margin: 0;
    }

    input::-moz-outer-spin-button,
    input::-moz-inner-spin-button {
        -moz-appearance: none !important;
        margin: 0;
    }

    input[type="number"] {
        -moz-appearance: textfield !important;
    }

    .tran-table, .forecast-table {
        width: 100%;
        font-size: 13px;
        color: #546E7A;
        font-family: MicrosoftYaHei;
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
        background: #F7F9FB;
        margin: 20px 0;
    }

    .tran-table th, .forecast-table th {
        padding: 8px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #e4e9ed;
        text-align: center;
        white-space: nowrap;
    }

    .tran-table td, .forecast-table td {
        padding: 8px 10px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #F7F9FB;
        text-align: center;
    }
    .forecast-table {
        margin: 0;
    }
    .tran-table td:nth-child(odd) {
        text-align: center;
    }
    .tran-table td:nth-child(odd) {
        width: 13%;
        padding: 18px 10px;
        background: #f5fafe;
    }
    .forecast-table td:nth-child(odd) {
        width: 13%;
        padding: 18px 10px;
        background: #f5fafe;
    }

    .tran-table td:nth-child(even) {
        width: 37%;
    }

    .tab {
        color: #c8d2d7;
        font-size: 16px;
    }

    .tab span {
        cursor: pointer;
    }

    .tab span:hover {
        color: #48576a;
    }

    .active {
        color: #263238;
    }

    .tran-table caption,
    header {
        height: 40px;
        background: #546E7A;
        font-family: MicrosoftYaHei;
        font-size: 16px;
        color: #FFFFFF;
        letter-spacing: 0;
        padding: 0px 10px;
        line-height: 40px;
        text-align: left;
    }
    .required {
        color: red;
    }

    .order-list-table.table-common tr th {
        color: #546E7A;
        background: #e4e9ed;
    }

    .el-select {
        padding: 0;
    }

    .width-100 {
        width: 100% !important;
    }

    .width-50 {
        width: 49.5% !important;
    }

    .width-33 {
        width: 33% !important;
    }

    .width-20 {
        width: 19.5% !important;
    }

    .nowrap {
        white-space: nowrap;
    }

    .el-dialog__header {
        display: block;
    }

    .dialog_title,
    .dialog_button {
        text-align: center;
    }

    .required::after {
        content: '*';
        color: #ff4949;
        margin-left: 5px;
        vertical-align: middle;
    }

    .poniter .el-input__inner {
        cursor: pointer !important;
    }

    .imgStyle {
        width: 80px !important;
        height: 80px !important;
        cursor: pointer;
    }

    .table-common {
        overflow: visible !important;
    }

    .table-common .el-table__body-wrapper {
        overflow-x: visible !important;
        overflow-y: visible !important;
    }

    .selectBg .el-input-group__prepend {
        background-color: #fff !important;
    }
</style>

<body class="orderList">
    <div id="demand" class="list-common" v-cloak style="margin-bottom:220px">
        <div class="use-title tab">
            <span style="margin-right: 35px;" :class="{'active':type == 'detail'}">
                {{$lang('需求详情')}}
            </span>
            <!-- <span :class="{'active':type == 'log'}" @click="viewLog()">$lang('操作日志')</span> -->
        </div>
        <div class="baseline"></div>
        <!-- 销售信息模块 -->
        <div v-if="type == 'detail'">
            <div>
                <table class="tran-table" cellpadding="0" cellspacing="0">
                    <caption>
                        {{$lang('销售信息')}}
                    </caption>
                    <tbody>
                        <tr>
                            <td>
                                {{$lang('需求类型')}}<label class="required"></label>
                            </td>
                            <td>
                                <el-radio v-for="(item, index) in baseData.sell_demand_type" @change="handleChangeDemandType" v-model="form.demand_type" :key="index" :label="item.CD">{{$lang(item.CD_VAL)}}</el-radio>
                            </td>
                            <td>
                                {{$lang('客户名称')}}
                                <label :class="{'required':!typeDifference}"></label>
                            </td>
                            <td>
                                <el-select class="width-100" remote filterable clearable v-model="form.customer_charter_no" @change="handleSelect" :loading="customLoading" :placeholder="$lang('请输入客户名称')" value-key="SP_NAME" :remote-method="remoteMethod">
                                    <el-option v-for="(item, index) in customOptions" :key="index" :label="$lang(item.SP_NAME)" :value="item.SP_CHARTER_NO"></el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('预计销售国家')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-select  :popper-append-to-body="false" v-model="form.expected_sales_country" multiple clearable filterable collapse-tags :placeholder="$lang('请选择预计销售国家')" class="width-100">
                                    <el-option v-for="(item, index) in saleCountries" :key="index" :label="$lang(item.NAME)"
                                        :value="item.id" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('预计销售平台')}}
                                <label :class="{'required':typeDifference && !form.customer_charter_no}"></label>
                            </td>
                            <td>
                                <el-select :disabled="typeDifference && form.customer_charter_no !==''" :popper-append-to-body="false" multiple collapse-tags v-model="form.expected_sales_platform_cd" clearable filterable :placeholder="$lang('请选择预计销售平台')" class="width-100">
                                    <el-option v-for="(item, index) in saleSitecd" :key="index" :label="$lang(item.cdVal)"
                                        :value="item.cd" style="text-align: left;">
                                    </el-option>
                                </el-select> 
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('框架合同')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference || (!typeDifference && form.is_purchase_only == 1)'
                                    :loading="contractLoading" v-model="form.contract" :placeholder="$lang('请选择适用合同')"
                                    style="width:70%;" clearable @change="setCompany">
                                    <el-option v-for="(item, index) in contract" :key="index" :label="item.CON_NO"
                                        :value="item.CON_NO" style="text-align: left;">
                                    </el-option>
                                </el-select>
                                <el-checkbox :disabled='typeDifference || (!typeDifference && !!form.contract)' v-model="form.is_purchase_only"
                                    false-label="0" true-label="1">
                                    {{$lang('无框架合同')}}
                                </el-checkbox>
                            </td>
                            <td>
                                {{$lang('我方公司')}} <label :class="{'required':!typeDifference}"></label>
                            </td>
                            <td>
                                <el-select  :popper-append-to-body="false" v-model="form.our_company" clearable filterable :placeholder="$lang('请选择我方公司')" class="width-100">
                                    <el-option v-for="(item, index) in baseData.our_company" :key="index" :label="$lang(item.CD_VAL)"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('业务类型')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.business_mode" clearable :placeholder="$lang('请选择业务类型')" class="width-100">
                                    <el-option v-for="(item, index) in baseData.business_type" :key="index" :label="item.CD_VAL"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('客户收货方式')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="form.receive_mode"
                                    :placeholder="$lang('请选择交货方式')" class="width-100">
                                    <el-option v-for="(item, index) in baseData.delivery_type" :key="index" :label="item.CD_VAL"
                                        :value="item.CD" style="text-align: left;"> </el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('发货操作')}}<label :class="typeDifference ? '':'required'"></label>
                            </td>
                            <td class="nowrap">
                                <el-radio :disabled='typeDifference' v-model="form.need_warehouse" label="0">
                                    {{$lang('直接发给客户')}}
                                </el-radio>
                                <el-radio :disabled='typeDifference' v-model="form.need_warehouse" label="1">
                                    {{$lang('先入我方仓库，再发给客户')}}
                                </el-radio>
                            </td>
                            <td>
                                {{$lang('客户收货地址')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="form.receive_country"
                                    :placeholder="$lang('国家')" style="width:32%;" clearable filterable>
                                    <el-option v-for="(item, index) in countries" :key="index" :label="item.NAME"
                                        :value="item.ID" style="text-align: left;"></el-option>
                                </el-select>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' :loading="provinceLoading"  clearable filterable
                                    v-model="form.receive_province" :placeholder="$lang('省/州')" style="width:33%;">
                                    <el-option v-for="(item, index) in provinces" :key="index" :label="item.NAME"
                                        :value="item.ID" style="text-align: left;">
                                    </el-option>
                                </el-select>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' :loading="cityLoading"  clearable filterable
                                    v-model="form.receive_city" :placeholder="$lang('市/区')" style="width:33%;">
                                    <el-option v-for="(item, index) in citys" :key="index" :label="item.NAME" :value="item.ID"
                                        style="text-align: left;"> </el-option>
                                </el-select>
                                <el-input v-model="form.receive_address" :disabled='typeDifference' :placeholder="$lang('详细地址')"
                                    style="margin-top:5px;"></el-input>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('预计销售金额（含税）')}}</label>
                            </td>
                            <td>
                                {{currencyVal}} {{form.sell_amount |　numberFormat}}
                            </td>
                            <td>
                                {{$lang('销售发货时间')}} <label :class="typeDifference ? '':'required'"></label>
                            </td>
                            <td>
                                <el-date-picker :disabled='typeDifference' v-model="form.ship_date" :picker-options="picksBefore"
                                    value-format="yyyy-MM-dd" type="date" :placeholder="$lang('请填写预计发货时间')" class="width-100">
                                </el-date-picker>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('收款周期')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="form.collection_cycle"
                                    :placeholder="$lang('请选择收款期数')" class="width-100">
                                    <el-option v-for="(item, index) in baseData.collection_cycle" :key="index" :label="$lang(item.CD_VAL)"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('收款时间')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <div style="text-align: left;margin: 5px 0;" class="nowrap" v-for="(child, index) in form.collection_time"
                                    :key="index">
                                    <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="child.node"
                                        :placeholder="$lang('节点')" style="width:20%;">
                                        <el-option v-for="(item, index) in baseData.collection_node" :key="index"
                                            :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                    <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="child.days"
                                        :placeholder="$lang('天数')" style="width:16%;">
                                        <el-option v-for="(item, index) in baseData.payment_days" :key="index" :label="item.CD_VAL"
                                            :value="item.CD" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                    <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="child.day_type"
                                        :placeholder="$lang('天数类型')" style="width:20%;">
                                        <el-option v-for="(item, index) in baseData.collection_days_type" :key="index"
                                            :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                    <el-input v-model="child.percent" :value="typeDifference ? (child.percent=100) : child.percent"
                                        :disabled='typeDifference' :placeholder="$lang('比例')" style="width:12%;"></el-input>%
                                    <el-date-picker :picker-options="child.picksBeforeTime" @change="test(index)"
                                        v-model="child.date" value-format="yyyy-MM-dd" type="date" :placeholder="$lang('收款时间')"
                                        style="width:26%;">
                                    </el-date-picker>
                                </div>
                            </td>
                        </tr>
                        <tr>

                            <td>
                                {{$lang('【采购部分】销售物流及服务费用（预估）')}}
                            </td>
                            <td>
                                <el-input :placeholder="$lang('请输入金额')" :disabled="form.is_spot == 1" :class="{selectBg: form.is_spot !== 1}"
                                    v-model="form.expense">
                                    <el-select :popper-append-to-body="false" :disabled="form.is_spot == 1" v-model="form.expense_currency"
                                        slot="prepend" :placeholder="$lang('请选择币种')">
                                        <el-option v-for="(item, index) in baseData.currency" :key="index" :label="item.CD_VAL"
                                            :value="item.CD" style="text-align: left;"></el-option>
                                    </el-select>
                                </el-input>
                            </td>
                            <td>
                                {{$lang('【现货部分】销售物流及服务费用（预估）')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-input :placeholder="$lang('请输入金额')" :disabled="form.is_spot == 2" :class="{selectBg: form.is_spot !== 2}"
                                    v-model="form.expense_spot">
                                    <el-select :popper-append-to-body="false" :disabled="form.is_spot == 2" v-model="form.expense_currency_spot"
                                        slot="prepend" :placeholder="$lang('请选择币种')">
                                        <el-option v-for="(item, index) in baseData.currency" :key="index" :label="item.CD_VAL"
                                            :value="item.CD" style="text-align: left;"></el-option>
                                    </el-select>
                                </el-input>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('【采购部分】销售应缴税')}}</label>
                            </td>
                            <td>
                                <el-input :placeholder="$lang('请输入金额')" :disabled="form.is_spot == 1" :class="{selectBg: form.is_spot !== 1}"
                                    v-model="form.tax">
                                    <el-select :popper-append-to-body="false" :disabled="form.is_spot == 1" v-model="form.tax_currency"
                                        slot="prepend" :placeholder="$lang('请选择币种')">
                                        <el-option v-for="(item, index) in baseData.currency" :key="index" :label="item.CD_VAL"
                                            :value="item.CD" style="text-align: left;"></el-option>
                                    </el-select>
                                </el-input>
                            </td>
                            <td>
                                {{$lang('【现货部分】销售应缴税')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td>
                                <el-input :placeholder="$lang('请输入金额')" :disabled="form.is_spot == 2" :class="{selectBg: form.is_spot !== 2}"
                                    v-model="form.tax_spot">
                                    <el-select :popper-append-to-body="false" :disabled="form.is_spot == 2" v-model="form.tax_currency_spot"
                                        slot="prepend" :placeholder="$lang('请选择币种')">
                                        <el-option v-for="(item, index) in baseData.currency" :key="index" :label="item.CD_VAL"
                                            :value="item.CD" style="text-align: left;"></el-option>
                                    </el-select>
                                </el-input>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('销售发票')}}<label :class="{'required':form.is_spot == 1}"></label>
                            </td>
                            <td class="nowrap">
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' v-model="form.invoice_type"
                                    :placeholder="$lang('请选择发票类型')" class="width-50">
                                    <el-option v-for="(item, index) in baseData.invoice_type" :key="index" :label="$lang(item.CD_VAL)"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                                <el-select :popper-append-to-body="false" :disabled='typeDifference' @change="changeRate" v-model="form.tax_rate"
                                    :placeholder="$lang('请选择税点')" class="width-50">
                                    <el-option v-for="(item, index) in baseData.tax_rate" :key="index" :label="item.CD_VAL"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('需求截止时间')}} <label class="required"></label>
                            </td>
                            <td>
                                <el-date-picker v-model="form.deadline" value-format="yyyy-MM-dd" type="date"
                                    :placeholder="$lang('选择截止日期')" class="width-100">
                                </el-date-picker>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('销售同事')}} <label class="required"></label>
                            </td>
                            <td>
                                <el-select class="width-100" remote filterable v-model="form.seller" :loading="sellLoading"
                                    :placeholder="$lang('请输入销售同事')" value-key="name" :remote-method="querySearchSeller">
                                    <el-option v-for="(item, index) in sellOptions" :key="index" :label="item.name"
                                        :value="item.name"></el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('销售团队')}} <label class="required"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.sell_team" :placeholder="$lang('请选择销售团队')"
                                    class="width-100">
                                    <el-option v-for="(item, index) in baseData.sell_team" :key="index" :label="item.CD_VAL"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('返利比例(预估)')}} <label v-if='!typeDifference'></label>
                            </td>
                            <td>
                                <el-input v-model="form.rebate_rate" class="width-50" @blur="getAmount()" :disabled='typeDifference'></el-input> %
                            </td>
                            <td>{{$lang('返利金额(预估)')}}</td>
                            <td>
                                {{currencyVal}} {{form.rebate_amount}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('订单备注')}}
                            </td>
                            <td colspan="3">
                                <el-input v-model="form.remark" :placeholder="$lang('请输入订单备注')" class="width-100"></el-input>
                            </td>
                        </tr>
                          <tr>
                            <td>
                                {{$lang('订单附件')}}
                            </td>
                            <td colspan="3" style="text-align: left;">
                                <el-upload multiple action="/index.php?m=order_detail&a=file_upload" :before-upload="beforeUpload" :on-remove="removeList"
                                    :on-change="upProgress" :file-list="upFileList" accept="application">
                                    <el-button size="small" type="primary">
                                        {{$lang('选择文件')}}
                                    </el-button>
                                    <span style="margin-left: 20px;" slot="tip" class="el-upload__tip">
                                        {{$lang('只能上传 Excel、Word、PPT、PDF、Picture文件，≤50M')}}
                                    </span>
                                </el-upload>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 商品信息 -->
            <div>
                <header>
                    <el-row>
                        <el-col :span="16">
                            {{$lang('商品信息')}}
                        </el-col>
                        <el-col :span="8" class="text-right">
                            <el-upload style="display: inline;" :on-error="handleError" :before-upload="beforeImportUpload"
                                :on-success="handleSuccess" :show-file-list="false" action="/index.php?g=scm&m=demand&a=import_goods"
                                :auto-upload="true" accept="application">
                                <el-button size="small" type="primary">
                                    {{$lang('批量导入')}}
                                </el-button>
                            </el-upload>
                            <el-button size="small" type="info" plain @click="downTemplate">
                                {{$lang('下载模板')}}
                            </el-button>
                        </el-col>
                    </el-row>
                </header>
                <el-table border show-header show-summary :summary-method="getSummaries" :data="form.goods"
                    tooltip-effect="dark" style="width: 100%" class="order-list-table table-common" v-loading="tableLoading">
                    <el-table-column label="SKUID/BarCode" width="205">
                        <template slot-scope="scope">
                            <el-input v-model="form.goods[scope.$index].search_id" placeholder="SKUID/BarCode">
                                <i class="el-icon-search el-input__icon" style="cursor:pointer;" slot="suffix" @click="handerSerch(scope.$index, scope.row)"></i>
                            </el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('图片信息')">
                        <template slot-scope="scope">
                            <img :class="{imgStyle: scope.row.guds_img_cdn_addr}" :src="scope.row.guds_img_cdn_addr"
                                @mouseenter="showImg(scope.$index)" @mouseleave="hiddenImg">
                            <div style="position: absolute; top: -10px; left: 120px; box-shadow: 0 0 5px #536d7a;z-index:99999"
                                v-show="imgShowIndex === scope.$index">
                                <img :src="scope.row.guds_img_cdn_addr" width="300" height="300">
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="goods_name" :label="$lang('商品名称')"></el-table-column>
                    <el-table-column prop="sku_attribute" :label="$lang('SKU属性')"></el-table-column>
                    <el-table-column prop="sale_num" :label="$lang('可售库存')"></el-table-column>
                    <el-table-column prop="hotness" :label="$lang('热度评级')" width="90"></el-table-column>
                    <el-table-column :label="$lang('需求数量')">
                        <template slot-scope="scope">
                            <el-input v-model="scope.row.require_number" :placeholder="$lang('需求数量')" @input="fillRequire(scope.row, 'require_number')"></el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('销售单价（含增值税）')" width="200">
                        <template slot-scope="scope">
                            <el-input :placeholder="$lang('单价')" class="selectBg" v-model="form.goods[scope.$index].sell_price" @input="fillRequire(scope.row, 'sell_price')" @blur="calcPrice(scope.row,'sell_price',scope.$index)">
                                <el-select :popper-append-to-body="false" v-model="form.sell_currency" slot="prepend" :placeholder="$lang('币种')" class="poniter" style="width: 80px;">
                                    <el-option v-for="(item, index) in baseData.currency" :key="index" :label="item.CD_VAL" :value="item.CD" style="text-align: left;"></el-option>
                                </el-select>
                            </el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('销售单价（不含增值税）')" width="200">
                        <template slot-scope="scope">
                            <el-input :placeholder="$lang('单价')" class="selectBg" v-model="form.goods[scope.$index].sell_price_not_contain_tax" @input="fillRequire(scope.row, 'sell_price_not_contain_tax')" @blur="calcPrice(scope.row,'sell_price_not_contain_tax',scope.$index)">
                                <el-select :popper-append-to-body="false" v-model="form.sell_currency" slot="prepend" :placeholder="$lang('币种')" class="poniter" style="width: 80px;">
                                    <el-option v-for="(item, index) in baseData.currency" :key="index" :label="item.CD_VAL" :value="item.CD" style="text-align: left;"></el-option>
                                </el-select>
                            </el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('使用现货数量')">
                        <template slot-scope="scope">
                            <!-- {{gridData}} -->
                            <span v-show="typeDifference">-</span>
                            <div style="text-decoration:underline;cursor:pointer;" v-show="!typeDifference" :index="scope.$index" @click="selectBatch(scope.$index, scope.row)">
                                <p style="text-decoration:underline;color:#66b1ff" v-for="(item, index) in scope.row.spot_warehouse"
                                    :key="index">{{$lang(item.deliveryWarehouseName)}}: {{item.num}}</p>
                                <p class="batch" v-show="scope.row.spot_warehouse && !scope.row.spot_warehouse.length">{{$lang('无现货')}}</p>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('使用在途库存数量')">
                        <template slot-scope="scope">
                            <div style="text-decoration:underline;cursor:pointer;" v-show="!typeDifference && (statusType == 'N002130100' ||isCreat)" :index="scope.$index" @click="selectOnTheWay(scope.$index, scope.row)">
                                <div v-show="!scope.row.on_way_warehouse.length">
                                    <p class="on-way" v-show="scope.row.on_way_warehouse && !scope.row.on_way_warehouse.length">{{$lang('无在途库存')}}</p>
                                </div>
                                <p v-show="scope.row.on_way_warehouse && scope.row.on_way_warehouse.length" style="text-decoration:underline;color:#66b1ff" v-for="(item, index) in scope.row.on_way_warehouse" :key="index"> {{$lang(item.deliveryWarehouseName)}}: {{item.num}}</p>
                            </div>
                            <div>
                                <p v-show="statusType != 'N002130100' && !isCreat" v-for="(item, index) in scope.row.on_way_warehouse" :key="index"> {{$lang(item.deliveryWarehouseName)}}: {{item.num}}</p>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('采购数量')">
                        <template slot-scope="scope">
                            <el-input type="number" v-model="scope.row.purchase_number" :disabled="true" :placeholder="$lang('采购数量')"></el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('授权&链路要求')">
                        <template slot-scope="scope">
                            <el-select v-model="form.goods[scope.$index].auth_and_link" :placeholder="$lang('授权&链路要求')"
                                class="width-100">
                                <el-option v-for="(item, index) in baseData.auth_and_link" :key="index" :label="$lang(item.CD_VAL)"
                                    :value="item.CD" style="text-align: left;">
                                </el-option>
                            </el-select>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('操作')">
                        <template slot-scope="scope">
                            <el-button type="text" icon="el-icon-plus" @click="addShop(scope.$index, scope.row)"></el-button>
                            <el-button type="text" icon="el-icon-minus" v-show="!scope.row.isDeleteIndex" @click="deleteShop(scope.$index, scope.row)"></el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <!-- 现货预估利润表 -->
            
                <div v-show="sumSpotNumber || sumOnwayNumber">
                    <header>
                        <el-row>
                            <el-col :span="20">
                                {{$lang('现货&在途-预估利润(货币单位：USD)')}}
                            </el-col>
                        </el-row>
                    </header>
                    <table class="forecast-table" cellpadding="0" cellspacing="0">
                        <tr>
                            <td>{{$lang('收入（合同金额）')}}</td>
                            <td>{{revenue_spot | numberFormat}}</td>
                            <td>{{$lang('收入（缴税后/KPI）')}}</td>
                            <td>{{revenue_after_tax_spot | numberFormat}}</td>
                            <td>{{$lang('应缴税')}}</td>
                            <td>{{tax_spot | numberFormat}}</td>
                        </tr>
                        <tr>
                            <td>{{$lang('成本（退税前）')}}</td>
                            <td>{{commodity_cost_spot | numberFormat}}</td>
                            <td>{{$lang('退税')}}</td>
                            <td>{{tax_refund_spot | numberFormat}}</td>
                            <td>{{$lang('成本（退税后）')}}</td>
                            <td>{{cost_after_tax_refund_spot | numberFormat}}</td>
                        </tr>
                        <tr>
                            <td>{{$lang('销售物流及服务费用（预估）')}}</td>
                            <td>{{sale_cost_spot | numberFormat}}</td>
                            <td>{{$lang('毛利（退税前）')}}</td>
                            <td>{{gross_profit_spot | numberFormat}}</td>
                            <td>{{$lang('毛利（退税后）')}}</td>
                            <td>{{gross_profit_after_tax_refund_spot | numberFormat}}</td>
                        </tr>
                        <tr>
                            <td>{{$lang('毛利率（退税前）')}}</td>
                            <td>{{gross_profit_rate_spot | percentage}}</td>
                            <td>{{$lang('毛利率（退税后）')}}</td>
                            <td>{{gross_profit_rate_after_tax_refund_spot | percentage}}</td>
                            <td>{{$lang('净利润（预估）')}}</td>
                            <td>{{net_profit_spot | numberFormat}}</td>
                        </tr>
                        <tr>
                            <td>{{$lang('净利润率（预估）')}}</td>
                            <td>{{net_profit_rate_spot | percentage}}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </table>
                </div>
                <!-- 收款效率表 -->
                <div v-if="form.demand_type === 'N002100200' || form.demand_type === 'N002100201'">
                    <header>
                        <el-row>
                            <el-col :span="20">
                                {{$lang('收款效率')}}
                            </el-col>
                        </el-row>
                    </header>
                    <table class="forecast-table" cellpadding="0" cellspacing="0">
                        <tr>
                            <td class="width-20">{{$lang('本单预计收款天数加权')}}</td>
                            <td>{{dateWeighting}} days</td>
                            <td class="width-20">{{$lang('该客户近三个月平均实际收款天数加权')}}</td>
                            <td>{{customerWeighting}} days</td>
                        </tr>
                        <tr>
                            <td>{{$lang('本单预计收款天数评级')}}</td>
                            <td>{{dateLevel}}</td>
                            <td>{{$lang('该客户近三个月平均实际收款天数评级')}}</td>
                            <td>{{customerLevel}}</td>
                        </tr>
                    </table>
                </div>
                <footer>
                    <el-row>
                        <el-col :span="24" style="text-align: center;">
                            <el-button v-show="drafFlag" type="primary" @click="saveDraft" style="margin-right: 20px;">
                                {{$lang('存草稿')}}
                            </el-button>
                            <el-button type="primary" @click="subRequirements" style="margin-left: 20px;">
                                {{$lang('提交需求')}}
                            </el-button>
                        </el-col>
                    </el-row>
                </footer>
            </div>
            <el-dialog title="" width="70%" :close-on-click-modal="false" :visible.sync="dialogTableVisible">
                <el-row>
                    <el-col :span="24">
                        <div style="font-weight: bold;text-align: center">{{goodsName}}；{{$lang('需求数量')}}{{demandFor}}</div>
                    </el-col>
                </el-row>
                <el-table ref="multipleTable" height="350" v-loading="batchLoading" :border="true" :data="gridData || []"
                    show-summary :summary-method="getBatchSummaries" @selection-change="handleSelectionChange"
                    @select-all="gridSelect" @select="manualSelect" class="order-list-table">
                    <el-table-column type="selection" width="60" style="padding: 0;text-align: center"></el-table-column>
                    <el-table-column property="deliveryWarehouseName" :label="$lang('仓库')"></el-table-column>
                    <el-table-column property="availableNum" :label="$lang('可选择数量')"></el-table-column>
                    <el-table-column :label="$lang('本次选择数量')">
                        <template slot-scope="scope">
                            <el-input type="number" v-model="scope.row.num" :disabled="scope.row.isSelected" @focus="confirmDisabled = true"
                                @blur="numChange(scope.$index, scope.row)" placeholder=""></el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('现货成本（退税前）')">
                        <template slot-scope="scope">
                            <span>
                                <!-- ￥{{scope.row.cost | numberFormat}} -->
                                ￥<span>{{(scope.row.num?scope.row.cost:0) | numberFormat}}</span>
                                <!-- ￥<span>{{(scope.row.num?scope.row.unitPrice*scope.row.selectNum:0) | numberFormat}}</span> -->

                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('退税')">
                        <template slot-scope="scope">
                            <span>
                                <!-- ￥{{scope.row.drawback | numberFormat}} -->
                                ￥<span>{{(scope.row.num?scope.row.drawback:0) | numberFormat}}</span>
                            </span>
                        </template>
                    </el-table-column>
                </el-table>
                <footer style="margin-top:20px;padding-bottom:10px;">
                    <el-row>
                        <el-col :span="24" style="text-align: center;">
                            <el-button type="primary" style="margin-right: 50px;" @click="batchConfire" :disabled="confirmDisabled"
                                :loading="confirmFlag">
                                {{$lang('保存')}}
                            </el-button>
                        </el-col>
                    </el-row>
                </footer>
            </el-dialog>
            <!-- 在途弹窗 -->
            <el-dialog title="" width="70%" :close-on-click-modal="false" :visible.sync="dialogOnWayVisible">
                <el-row>
                    <el-col :span="24">
                        <div style="font-weight: bold;text-align: center">{{goodsName}}；{{$lang('需求数量')}}:{{demandFor}}；{{$lang('已选现货数量')}}:{{rowSelectedOnWayNum}}</div>
                    </el-col>
                </el-row>
                <h3 style="margin-left: 20px;" v-if="gridDataOnWay">采购在途</h3>
                <el-table  v-if="gridDataOnWay"  show-summary :summary-method="getOnWaySummaries" ref="multipleTableOnway"  v-loading="onWayLoading" :border="true" :data="gridDataOnWay || []"
                     @selection-change="handleSelectionChangeOnWay"
                    @select-all="gridSelectOnWay" @select="manualSelectOnWay" class="order-list-table">
                    <el-table-column type="selection" width="60" style="padding: 0;text-align: center"></el-table-column>
                     <el-table-column  :label="$lang('采购单号')">
                        <template slot-scope="scope">
                            <span>{{scope.row.purchaseOrderNo}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column  :label="$lang('供应商')">
                        <template slot-scope="scope">
                                <span>{{scope.row.supplier}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('采购团队')">
                        <template slot-scope="scope">
                                <span>{{scope.row.purchaseTeamName}}</span>

                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('待入仓库')">
                        <template slot-scope="scope">
                                <span>{{scope.row.deliveryWarehouseName}}</span>
                                
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('可选数量')">
                        <template slot-scope="scope">
                                <span>{{scope.row.num}}</span>

                        </template>
                    </el-table-column>  
                    <el-table-column :label="$lang('采购单价')">
                        <template slot-scope="scope">
                            ￥<span>{{scope.row.unitPrice | numberFormat}}</span>
                        </template>
                    </el-table-column> 
                     <el-table-column :label="$lang('本次选择数量')">
                        <template slot-scope="scope">
                            <el-input v-model="scope.row.selectNum" @blur="numChangeOnWay(scope.$index, scope.row)" :disabled="scope.row.isSelected === false? false:true" @focus="confirmDisabledOnway = true"></el-input>
                        </template>
                    </el-table-column> 
                    <el-table-column :label="$lang('成本（退税前）')">
                        <template slot-scope="scope">
                            ￥<span>{{(scope.row.selectNum?scope.row.unitPrice*scope.row.selectNum:'0.00') | numberFormat}}</span>
                        </template>
                    </el-table-column>
<!--                    <el-table-column :label="$lang('退税')">
                        <template slot-scope="scope">
                            ￥<span>{{(scope.row.noTaxUnitPrice * scope.row.selectNum * scope.row.proportionOfTax) | numberFormat}}</span>
                        </template>
                    </el-table-column>-->
                </el-table>
                <h3 style="margin-left: 20px;" v-if="gridDataOnWay2.length>0">调拨在途</h3>
                <el-table  v-if="gridDataOnWay2.length>0"  show-summary :summary-method="getOnWaySummaries2" ref="multipleTableOnway"  v-loading="onWayLoading" :border="true" :data="gridDataOnWay2 || []"
                           @selection-change="handleSelectionChangeOnWay2"
                           @select-all="gridSelectOnWay2" @select="manualSelectOnWay2" class="order-list-table">
                    <el-table-column type="selection" width="60" style="padding: 0;text-align: center"></el-table-column>
                    <el-table-column  :label="$lang('调拨单号')">
                        <template slot-scope="scope">
                            <span>{{scope.row.purchaseOrderNo}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column  :label="$lang('发起人')">
                        <template slot-scope="scope">
                            <span>{{scope.row.supplier}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('待入仓库')">
                        <template slot-scope="scope">
                            <span>{{scope.row.deliveryWarehouseName}}</span>

                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('可选数量')">
                        <template slot-scope="scope">
                            <span>{{scope.row.num}}</span>

                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('本次选择数量')">
                        <template slot-scope="scope">
                            <el-input  :disabled="scope.row.isSelected === false? false:true"  @input="batch_num($event,scope.row)" v-model="scope.row.selectNum" @blur="numChangeOnWay(scope.$index, scope.row)"  @focus="confirmDisabledOnway = true"></el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('成本（退税前）')">
                        <template slot-scope="scope">
                            ￥<span>{{scope.row.cost | numberFormat}}</span>
                        </template>
                    </el-table-column>
                </el-table>
                <div style="padding: 0 10px">
                    <h3>合计</h3>
                    <div style="display: flex">
                        <div style="    flex: 1;">可选在途数量合计: {{tot1}}</div>
                        <div style="    flex: 1;">已选在途数量合计:{{tot2}}</div>
                        <div style="    flex: 1;">已选在途成本合计:{{tot3}}</div>
                    </div>
                </div>
                <footer style="margin-top:20px;padding-bottom:10px;">
                    <el-row>
                         <el-col :span="24" style="text-align: center;">
                            <el-button type="primary" style="margin-right: 50px;" @click="onWayConfire" :disabled="confirmDisabledOnway">
                                {{$lang('保存')}}
                            </el-button>
                        </el-col> 
                    </el-row>
                </footer>
            </el-dialog>
        </div>
    </div>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/utils/utils.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js?<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.2.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
    <script>
        if (getCookie('think_language') !== "zh-cn") {
            ELEMENT.locale(ELEMENT.lang.en)
        }
        var stockRequire = ["seller", "sell_team", "deadline"],
            stockDsc = ["销售同事", "销售团队", "截止时间"],
            sellRequire = ["customer", "our_company", "need_warehouse", "ship_date", "seller", "sell_team", "deadline"];
            sellRequireDsc = ["客户名称",  "我方公司", "发货操作", "发货时间", "销售同事", "销售团队", "截止时间", "返利比例"],
            sellGoods = ["search_id", "require_number", "purchase_number", "auth_and_link"],
            sellGoodsDsc = ["商品搜索ID", "需求数量", "采购数量", "授权和链路要求"],
            spot = ["customer", "our_company", "business_mode", "receive_mode", "need_warehouse", "receive_country",
                "receive_address", "sell_currency", "sell_amount", "ship_date", "collection_cycle",
                "invoice_type", "tax_rate", "expense_currency_spot", "expense_spot", "tax_currency_spot", "tax_spot",
                "seller", "sell_team", "deadline"
            ],
            spotDsc = ["客户名称", "我方公司", "业务类型", "客户收货方式", "发货操作", "国家",  "详细地址", "销售币种", "销售金额", "发货时间", "收款周期",
                "发票类型", "税点", "物流服务费用（现货）币种", "物流服务费用（现货）", "税额币种（现货）", "税额（现货）", "销售同事", "销售团队", "截止时间"
            ];
        var CURREN = [];
        var OPTION = {
            lock: true
        };
        var SPUHEAT = 'http://3rd-biapi.izene.org/external/get_spu_heat_v2';
        var BATCHSTOCK = '/index.php?g=scm&m=demand&a=batch_stock';
        var BATCHSEARCH = '/index.php?g=scm&m=demand&a=batch_search';
        var ID = getQueryString("type");
        var ISREFRESH = true;
        var NOWDATETIME = new Date().getTime();

        function _toConsumableArray(arr) {
            if (Array.isArray(arr)) {
                for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {
                    arr2[i] = arr[i];
                }
                return arr2;
            } else {
                return Array.from(arr);
            }
        }
        demand = new Vue({
            el: '#demand',
            data: {
                saleSitecd: [], // y预计销售平台
                saleCountries: [], // 预计销售国家
                currentOnway:[],
                currentOnway2:[],
                dialogOnWayVisible:false,
                gridDataOnWay:[],
                gridDataOnWay2:[],
                onWayLoading:false,
                
                //判断是否有现货
                sumSpotNumber: 0,
                isEdit: false,
                labelPosition: 'left',
                tableLoading: false,
                batchLoading: true,
                type: 'detail',
                baseData: {},
                customer: '',
                seller: '',
                countries: [],
                provinces: [],
                citys: [],
                typeDifference: false,
                contract: [],
                dialogTableVisible: false,
                gridData: [],
                goodsName: '',
                demandFor: '',
                rowSelectedOnWayNum:0,
                rowSelectedSpotNum:0,
                batchIndex: 0,
                currentBatch: [],
                provinceLoading: false,
                cityLoading: false,
                contractLoading: false,
                isCreateContry: true,
                isCreateCity: true,
                currencyVal: '',
                upFileList: [],
                isAddShopFlag: false,
                imgShowIndex: '',
                collectionCycleFlag: true,
                demandCode: '',
                curreneyobj: {
                    '': ''
                },
                statusType:'',
                customOptions: [],
                customLoading: false,
                sellOptions: [],
                sellLoading: false,
                isCreat:true,
                picksBefore: {
                    disabledDate(item) {
                        return item.getTime() < (Date.now() - 24 * 60 * 60 * 1000);
                    }
                },
                picksBeforeTime: {},
                drafFlag: true,
                demandTypeFlag: true,
                exchangerate: {},
                confirmDisabled: true,
                confirmDisabledOnway: true,
                confirmFlag: false,
                confirmFlagOnway:false,
                customerWeighting: null,
                sumOnwayNumber:0,
                form: {
                    goods: [{
                        id: '',
                        search_id: '',
                        sku_id: '',
                        goods_name: '',
                        sku_attribute: '',
                        hotness: '',
                        require_number: '',
                        sell_price: '',
                        purchase_number: '',
                        sell_price_not_contain_tax:'',
                        auth_and_link: '',
                        spot_number: '0',
                        on_way_number:'0',
                        spot_batch: [],
                        spot_warehouse: [],
                        on_way_warehouse: [],
                        on_way_batch:[],
                        on_way_cost:'',
                        guds_img_cdn_addr: '',
                        bar_code: '',
                        spot_cost: '',
                        spot_drawback:'',
                        on_way_drawback:0,
                        sale_num: '',
                    }],
                    expected_sales_country: [], // 预计销售国家
                    expected_sales_platform_cd: [], // 预计销售平台
                    id: '',
                    demand_type: 'N002100200',
                    is_purchase_only: '0',
                    customer: '',
                    customer_charter_no: '',
                    contract: '',
                    our_company: '',
                    business_mode: '',
                    need_warehouse: '0',
                    receive_mode: '',
                    receive_country: '',
                    receive_province: '',
                    receive_city: '',
                    receive_address: '',
                    sell_currency: '',
                    sell_amount: '',
                    sell_amount_not_contain_tax:'',
                    ship_date: '',
                    collection_cycle: '',
                    collection_time: [{
                        node: '',
                        days: '',
                        day_type: '',
                        percent: '',
                        date: ''
                    }],
                    invoice_type: '',
                    tax_rate: '',
                    expense_currency: '',
                    expense: '',
                    tax_currency: '',
                    tax: '',
                    expense_currency_spot: '',
                    expense_spot: '',
                    tax_currency_spot: '',
                    tax_spot: '',
                    seller: '',
                    sell_team: '',
                    deadline: '',
                    rebate_rate: '',
                    rebate_amount: '',
                    sell_currency_val: '',
                    remark: '',
                    attachment: [],
                    
                    is_submit: 0,
                    is_spot: 2, //1：纯现货，2：纯采购，0：采现混合
                },
                queryPost: function (url, param) {
                    var headers = {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    };
                    return axios.post(url, Qs.stringify(param), headers);
                }
            },
            created: function () {
                this.isCreat = getQueryString('type') == 'create'?true:false;
                this.getExchangeRate();
                this.getBaseData();
                this.getCountries();
                this.distinguishDemand();
                this.getCountryies();
                this.getOurCompany();
            },
            methods: {
                handleChangeDemandType() {
                    // 热销品囤货，默认选中发货方式：先入我方仓库
                    if (this.form.demand_type === 'N002100100') {
                        this.form.need_warehouse = '1';
                    } else {
                        this.form.need_warehouse = '0';
                    }
                },
                getOurCompany() {
                    axios.post('/index.php?g=common&m=index&a=get_our_company').then(res => {
                        if (res.data.code === 2000) {
                            this.baseData.our_company = res.data.data;
                        } else {
                            this.$message.error(this.$lang(res.data.msg));
                        }
                    })
                },
                // 获取预计销售国家和平台
                getCountryies() {
                    axios.post('index.php?g=oms&m=CommonData&a=commonData',{
                        data: {
                            query: {
                                area_code: true,
                                site_cd: true,
                            },
                            type:"outstorage_sort"
                        }
                    }).then(res => {
                        console.log(res);
                        if(res.data.code==2000){
                            this.saleCountries = res.data.data.area_code;
                            this.saleSitecd = res.data.data.site_cd;
                        }
                    })
                },
                matchCurrency: function (val) {
                    if (val) {
                        var label = this.baseData.currency.filter(function (item) {
                            return item.CD == val;
                        }).CD_VAL;
                        return label;
                    };
                },
                getExchangeRate: function () {
                    var _this = this;
                    this.queryPost("/index.php?g=common&m=index&a=exchange_rate").then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            _this.exchangerate = _data.data.exchange_rate;
                        } else {
                            _this.$message.error(_this.$lang(_data.msg));
                        };
                    });
                },
                calcPrice: function (row, key, rowIndex) {
                    var _this = this, rate = 0;
                    if (!row[key]) { 
                        this.$set(row, 'sell_price_not_contain_tax','')
                        this.$set(row, 'sell_price','')
                        if (rowIndex >= 0) {
                            this.$set(this.form.goods[rowIndex], 'sell_price_not_contain_tax', '')
                            this.$set(this.form.goods[rowIndex], 'sell_price', '')
                        }
                        return;
                    };
                    if (this.form.tax_rate) {
                        rate = (this.baseData.tax_rate.filter(function (e) {
                            return e.CD == _this.form.tax_rate
                        })[0].CD_VAL.replace(/%/, '')) / 100;
                    }
                    if (key == 'sell_price') {
                        this.$set(row, 'sell_price_not_contain_tax', row[key] / (1 + rate))
                        if (rowIndex >= 0) {
                            this.$set(this.form.goods[rowIndex], 'sell_price_not_contain_tax', row[key] / (1 + rate))
                        }
                    } else {
                        this.$set(row, 'sell_price', row[key] * (1 + rate))
                        if (rowIndex >= 0) {
                            this.$set(this.form.goods[rowIndex], 'sell_price', row[key] * (1 + rate))
                        }
                    }
                    this.round(row, key, rowIndex);
                },
                changeRate:function(type){
                    var _this = this;
                    this.form.goods.forEach(function(e){
                        if(type == true  && e.sell_price_not_contain_tax > 0){
                            _this.calcPrice(e,'sell_price_not_contain_tax');
                        }else{
                            _this.calcPrice(e,'sell_price');
                        }
                    })
                },
                //四舍五入
                round: function (row, key, rowIndex) {
                    if(!row[key]){ return row[key]; }
                    if(row[key].toString().indexOf('.') > -1){
                        num = row[key].toString().split('.')[1];
                        if (num.length > 8) {
                            Vue.set(row, key, parseFloat(row[key]).toFixed(8));
                            if (rowIndex >= 0) {
                                Vue.set(this.form.goods[rowIndex], key, parseFloat(row[key]).toFixed(8));
                            }
                        }
                    }
                },
                setCompany: function (val) {
                    var data = this.contract.filter(function (item) {
                        return item.CON_NO == val;
                    })[0];
                    this.form.our_company = val ? data.CON_COMPANY_CD : '';
                },
                // 编辑需求还是创建需求区分
                distinguishDemand: function () {
                    var _this = this;
                    var _id = getQueryString("type");

                    if (_id !== "create") {
                        // 编辑需求
                        this.queryPost("/index.php?g=scm&m=demand&a=demand_detail", {
                            id: _id
                        }).then((res) => {
                            var _data = res.data;
                            if (_data.code === 2000) {
                                var selectedDatas = _data.data.demand,
                                    currentStepCode = _data.data.status_list.step;
                                selectedGoodsDatas = _data.data.goods;
                                this.statusType = _data.data.demand.status;
                                this.demandCode = _data.data.demand.demand_code,
                                    currentStepCode !== "N002120100" && (this.drafFlag = false);
                                selectedDatas.demand_type === 'N002100100' && (this.demandTypeFlag =
                                    false);
                                selectedDatas.receive_country && (this.isCreateContry = false);
                                selectedDatas.receive_province && (this.isCreateCity = false);
                                selectedDatas.collection_cycle && (this.collectionCycleFlag = false);
                                this.customOptions = [{
                                    SP_NAME: _data.data.demand.customer,
                                    SP_CHARTER_NO: _data.data.demand.customer_charter_no
                                }];
                                this.customerWeighting = _data.data.demand.receivables_day_avg;
                                this.provinces = [{
                                    ID: selectedDatas.receive_province,
                                    NAME: selectedDatas.receive_province_val
                                }];

                                this.citys = [{
                                    ID: selectedDatas.receive_city,
                                    NAME: selectedDatas.receive_city_val
                                }];
                                for (var key in this.form) {
                                    if (selectedDatas.hasOwnProperty(key)) {
                                        if (key === "attachment") {
                                            var _array = selectedDatas["attachment"] || [];
                                            this.form[key] = selectedDatas["attachment"] || [];
                                            for (var q = 0, len = _array.length; q < len; q++) {
                                                var _obj_ = {
                                                    name: _array[q].original_name,
                                                    url: ""
                                                };
                                                this.upFileList.push(_obj_);
                                            };
                                        } else if (key === "collection_time" && selectedDatas[
                                                "collection_time"] == null) {
                                            this.form["collection_time"] = [{
                                                node: '',
                                                days: '',
                                                day_type: '',
                                                percent: '',
                                                date: ''
                                            }];
                                        } else {
                                            if (type(selectedDatas[key]) === "array" && !
                                                selectedDatas[key].length) {
                                                this.form[key] = [];
                                            } else {
                                                if (key === "ship_date" || key === "deadline") {
                                                    if (selectedDatas[key] === "0000-00-00") {
                                                        this.form[key] = "";
                                                    } else {
                                                        this.form[key] = selectedDatas[key];
                                                    };
                                                } else {
                                                    this.form[key] = selectedDatas[key];
                                                };
                                            };
                                        };
                                    };
                                };
                                console.log(selectedDatas)
                                this.form.expected_sales_country = selectedDatas.expected_sales_country ? selectedDatas.expected_sales_country.split(',') : [];
                                this.form.expected_sales_platform_cd = selectedDatas.expected_sales_platform_cd ? selectedDatas.expected_sales_platform_cd.split(',') : [];
                                
                                
                                for (var i = 0, len = selectedGoodsDatas.length; i < len; i++) {
                                    selectedGoodsDatas[i].spot_warehouse = selectedGoodsDatas[i].spot_warehouse ||
                                        [];
                                    selectedGoodsDatas[i].on_way_warehouse = selectedGoodsDatas[i].on_way_warehouse ||
                                        [];
                                    var itemWarehouse = selectedGoodsDatas[i].spot_warehouse;
                                    var itemWarehouseOnway = selectedGoodsDatas[i].on_way_warehouse;

                                    for (var j = 0, jlen = itemWarehouse.length; j < jlen; j++) {
                                        itemWarehouse[j].isSelected = itemWarehouse[j].isSelected === 'false' ? false : true;
                                    };
                                    for (var j = 0, jlen = itemWarehouseOnway.length; j < jlen; j++) {
                                        itemWarehouseOnway[j].isSelected = itemWarehouseOnway[j].isSelected === 'false' ? false : true;
                                    };
                                };
                                this.form.goods = selectedGoodsDatas;
                                var batchStock = [];
                                for (var i = 0, len = this.form.goods.length; i < len; i++) {
                                    var obj_ = {};
                                    obj_.skuId = this.form.goods[i].sku_id;
                                    obj_.saleTeamCode = selectedDatas.sell_team;
                                    batchStock.push(obj_);
                                };

                                // 请求获取可用库存
                                var req = {
                                    processCode: "ORDER_BATCH_SEARCH",
                                    processId: "4ea9083b9c74f80c23b097d820f4a8e7",
                                    data: batchStock
                                };
                                var reqOnway = {
                                    "processCode":"BATCH_ONWAY_SEARCH",
                                    "processId":"4ea9083b9c74f80c23b097d820f4a8e7",
                                    "data":batchStock}
                                var reqOnway2 = {
                                    "processCode":"BATCH_ONWAYALLO_SEARCH",
                                    "processId":"4ea9083b9c74f80c23b097d820f4a8e7",
                                    "data":batchStock}

                                this.getMultipleSkuStock(req, initData);
                                this.getMultipleSkuStockOnway(reqOnway);
                                this.getMultipleSkuStockOnway(reqOnway2);
                                function initData(_arr) {
                                    var stockObj = _this.stocksData(_arr);
                                    _this.form.goods.map(function (item, index) {
                                        stockObj[item.sku_id] && _this.$set(item, 'sale_num', stockObj[item.sku_id]);
                                        !stockObj[item.sku_id] && _this.$set(item, 'sale_num', '0');
                                        if (!item.spot_warehouse.length) {
                                            item.sale_num > 0 && _this.documentBatch(index, _this.$lang('可选择现货'), '#66b1ff');
                                            item.sale_num <= 0 && _this.documentBatch(index, _this.$lang('无现货'), '#000');
                                        };
                                        return item;
                                    });
                                };
                            } else {
                                this.$message.error(this.$lang(_data.msg));
                            };

                        }).catch(function (err) {
                            console.log(err);
                        });

                    };
                },
                //跳转详情页
                getBaseData() {
                    let param = {
                        cd_type: {
                            delivery_type: false,
                            sell_demand_type: false,
                            business_type: false,
                            currency: false,
                            collection_cycle: false,
                            collection_node: false,
                            payment_days: false,
                            collection_days_type: false,
                            invoice_type: false,
                            tax_rate: false,
                            sell_team: false,
                            sell_order_source: false,
                            payment_node: false,
                            auth_and_link: false
                        }
                    }
                    this.queryPost("/index.php?g=common&m=index&a=get_cd", param).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.baseData = Object.assign({}, _data.data, this.baseData)
                            CURREN = _data.data.currency;
                            for (var o = 0, _len = CURREN.length; o < _len; o++) {
                                this.$set(this.curreneyobj, CURREN[o].CD, CURREN[o].CD_VAL)
                            };
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                //获取国家
                getCountries: function () {
                    var _this = this;
                    this.queryPost("/index.php?g=common&m=index&a=get_address").then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.countries = _data.data;
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                //获取省
                getProvinces: function (id) {
                    this.provinceLoading = true;
                    this.queryPost("/index.php?g=common&m=index&a=get_address", {
                        pid: id
                    }).then((res) => {
                        this.provinceLoading = false;
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.provinces = _data.data
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                //获取市区
                getCitys: function (id) {
                    this.cityLoading = true;
                    this.queryPost("/index.php?g=common&m=index&a=get_address", {
                        pid: id
                    }).then((res) => {
                        this.cityLoading = false;
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.citys = _data.data;
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                showImg: function (index) {
                    this.imgShowIndex = index;
                },
                hiddenImg: function () {
                    this.imgShowIndex = '';
                },
                getSummaries: function () {
                    var sums = [this.$lang("合计")];
                    var _sum1 = 0,
                        _sum2 = 0,
                        _sum3 = 0,
                        _sum4 = 0;
                        _sum5 = 0;
                        _sum6 = 0;
                    // console.log(this.form.goods);
                    for (var i = 0; i < this.form.goods.length; i++) {
                        if (this.form.goods[i].require_number) {
                            _sum1 += (this.form.goods[i].require_number - 0);
                        };
                        if (this.form.goods[i].sell_price && this.form.goods[i].require_number) {
                            _sum2 += (this.form.goods[i].sell_price * Number(this.form.goods[i].require_number));
                        };
                        if (this.form.goods[i].sell_price_not_contain_tax && this.form.goods[i].require_number) {
                            _sum3 += (this.form.goods[i].sell_price_not_contain_tax * this.form.goods[i].require_number);
                        };
                        if (this.form.goods[i].purchase_number) {
                            _sum4 += (this.form.goods[i].purchase_number - 0);
                        };
                        if (this.form.goods[i].spot_number) {
                            _sum5 += (this.form.goods[i].spot_number - 0);
                        };
                        /*if (this.form.goods[i].on_way_number) {
                            _sum6 += (this.form.goods[i].on_way_number - 0);
                        };*/
                        if(this.form.goods[i].on_way_batch){
                            for(var y = 0;y< this.form.goods[i].on_way_batch.length;y++){
                                _sum6 +=Number(this.form.goods[i].on_way_batch[y].num)
                            }
                        }
                        if (this.form.goods[i].require_number && !this.typeDifference) {
                            this.form.goods[i].purchase_number = this.form.goods[i].require_number - this.form.goods[i].spot_number - this.form.goods[i].on_way_number;
                        };
                        if (this.typeDifference && this.form.goods[i].require_number) {
                            this.form.goods[i].purchase_number = this.form.goods[i].require_number;
                        };
                    };
                    sums[6] = _sum1;
                    
                    console.log(_sum1,_sum2,_sum3,_sum4,_sum5,_sum6)
                    this.form.sell_amount = _sum2;
                    this.form.sell_amount_not_contain_tax = _sum2;
                    _sum2 = _sum2.toFixed(3)
                    _sum3 = _sum3.toFixed(3)
                    
                    sums[7] = this.currencyVal + " " + this.$options.filters.numberFormat(_sum2);
                    sums[8] = this.currencyVal + " " + this.$options.filters.numberFormat(_sum3);

                    sums[9] = _sum5;
                    this.sumSpotNumber = _sum5;
                    sums[10] = _sum6;


                    sums[11] = _sum4;
                    this.sumOnwayNumber =_sum6;
                    if (this.typeDifference) {
                        sums[11] = _sum1;
                    };

                    if (sums[11] === 0 && sums[6] > 0 && sums[6] == sums[9]+sums[10] ) {
                        this.form.is_spot = 1; // 纯现货
                        this.form.expense_currency = '';
                        this.form.expense = '';
                        this.form.tax_currency = '';
                        this.form.tax = '';
                    } else if (sums[11] === sums[6] && sums[6] > 0) {

                        this.form.is_spot = 2; // 纯采购
                        this.form.expense_currency_spot = '';
                        this.form.expense_spot = '';
                        this.form.tax_currency_spot = '';
                        this.form.tax_spot = '';
                    } else if (sums[6] > 0 && (sums[9] > 0 || sums[10] >0 )) {
                        this.form.is_spot = 0; // 采现混合
                    };
                    return sums;                    
                },
                remoteMethod(queryString) {
                    var demand_type = this.form.demand_type

                    if (!queryString) {
                        return;
                    };
                    this.customLoading = true;
                    this.queryPost("/index.php?g=common&m=index&a=search_customer_or_supplier", {
                        supplier_id: queryString,
                        type: '1',
                        demand_type:demand_type
                    }).then((res) => {
                        this.customLoading = false;
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.customOptions = _data.data && _data.data.filter(function(item){
                                return item.SP_CHARTER_NO
                            })
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                },
                handleSelect: function (val) {
                    this.contractLoading = true;
                    if (!val) {
                        this.form.customer = val;
                        return;
                    };
                    this.form.contract = '';
                    this.form.our_company = '';
                    this.form.is_purchase_only = '0';
                    var _arr = this.customOptions.filter((item) => {
                        return item.SP_CHARTER_NO === val;
                    });

                    this.form.customer = _arr[0].SP_NAME;
                    this.form.supplier_no = _arr[0].ID;
                    this.customerWeighting = _arr[0].receivables_day_avg !== null ? _arr[0].receivables_day_avg :
                        null;
                },
                querySearchSeller: function (qs) {
                    if (!qs) {
                        return;
                    };
                    this.sellLoading = true;
                    this.queryPost("/index.php?g=common&m=user&a=search_user", {
                        name: qs
                    }).then((res) => {
                        var _data = res.data;
                        this.sellLoading = false;
                        if (_data.code === 2000) {
                            if (_data.data) {
                                this.sellOptions = _data.data;
                            };
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    })
                },
                addShop: function (index, row) {
                    this.form.goods.push({
                        id: '',
                        search_id: '',
                        sku_id: '',
                        goods_name: '',
                        sku_attribute: '',
                        hotness: '',
                        require_number: '',
                        sell_price: '',
                        purchase_number: '',
                        guds_img_cdn_addr: "",
                        auth_and_link: '',
                        spot_number: '0',
                        on_way_number: '0',
                        spot_warehouse: [],
                        on_way_warehouse:[],
                        on_way_batch:[],
                        spot_batch: [],
                        bar_code: '',
                        spot_cost: '',
                        spot_drawback: ''
                    });
                },
                deleteShop: function (index, row) {
                    if (this.form.goods.length > 1) {
                        this.form.goods.splice(index, 1);
                    } else {
                        this.form.goods.splice(index, 1);
                        if (!this.typeDifference) {
                            this.documentBatch(0, "");
                        };
                        this.form.goods.push({
                            id: '',
                            search_id: '',
                            sku_id: '',
                            goods_name: '',
                            sku_attribute: '',
                            hotness: '',
                            require_number: '',
                            sell_price: '',
                            purchase_number: '',
                            guds_img_cdn_addr: '',
                            auth_and_link: '',
                            spot_number: '0',
                            on_way_number:'0',
                            on_way_batch:[],
                            on_way_cost:'',
                            spot_batch: [],
                            spot_warehouse: [],
                            on_way_warehouse:[],
                            bar_code: '',
                            spot_cost: '',
                            spot_drawback: '',
                        });
                    };
                },
                beforeUpload: function (file) {
                    for (var i = 0, len = this.form.attachment.length; i < len; i++) {
                        if (this.form.attachment[i].original_name === file.name) {
                            this.$message.warning(this.$lang('该文件已上传'));
                            return false;
                        };
                    };
                },
                upProgress: function (file) {
                    if (file.status === "success") {
                        if (file.response.status === 1) {
                            this.form.attachment.push({
                                original_name: file.response.info.name,
                                save_name: file.response.info.savename
                            });
                        } else {
                            this.$message.error(this.$lang('此文件上传失败'));
                        };
                    };
                },
                removeList: function (file) {
                    if (file.status === "success") {
                        if (file.response.status === 1) {
                            for (var i = 0, len = this.form.attachment.length; i < len; i++) {
                                if (this.form.attachment[i].original_name === file.response.info.name) {
                                    this.form.attachment.splice(i, 1);
                                };
                            };
                        };
                    };
                },
                //存草稿
                saveDraft: function () {
                    this.form.is_submit = 0;
                    if (this.typeDifference) { // 热销品囤货
                        for (var i = 0, len = this.form.goods.length; i < len; i++) {
                            this.form.goods[i].spot_batch = [];
                            this.form.goods[i].spot_number = '0';
                            this.form.goods[i].spot_cost = '';
                            this.form.goods[i].spot_drawback = '';
                            this.form.goods[i].spot_warehouse = [];
                        };
                    };
                    this.$loading(OPTION);
                    
                    this.form.expected_sales_country = this.form.expected_sales_country.join(',');
                    this.form.expected_sales_platform_cd = this.form.expected_sales_platform_cd.join(',');
                    console.log(this.form);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_save", this.form).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            backTab("/index.php?g=scm&m=display&a=demand_draft&type=" + _data.data.demand_id, this.$lang("需求详情"));
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                },
                formatAllPrice: function (pr) {
                    pr = pr + "";
                    var arr = pr.split(".");
                    if (!arr[1]) {
                        return pr;
                    };
                    if (arr[1] === "00") {
                        return arr[0];
                    } else if (arr[1].substr(1) === "0") {
                        return pr.substr(0, pr.length - 1);
                    } else {
                        return pr;
                    };
                },
                //返利比例求返利金额
                getAmount: function (){
                    if(this.form.rebate_rate && this.form.rebate_rate > 0){
                        this.form.rebate_rate = Math.floor(Number(this.form.rebate_rate) * 100) / 100;
                        this.form.rebate_amount = (this.form.rebate_rate * Number(this.form.sell_amount) / 100).toFixed(2);
                    }else{
                        this.form.rebate_rate = '';
                        this.form.rebate_amount = '0.00';
                    }
                },
                //提交需求
                subRequirements: function () {
                    var _tihs = this;
                    //校验数据是否为空
                    var res = this.validations(this.form);
                    if (!res) {
                        return false;
                    };
                    if (this.form.is_spot == 1) {
                        this.form.profit = {};
                        this.form.profit.revenue_spot = this.revenue_spot;
                        this.form.profit.revenue_after_tax_spot = this.revenue_after_tax_spot;
                        this.form.profit.commodity_cost_spot = this.commodity_cost_spot;
                        this.form.profit.tax_refund_spot = this.tax_refund_spot;
                        this.form.profit.cost_after_tax_refund_spot = this.cost_after_tax_refund_spot;
                        this.form.profit.tax_spot = this.tax_spot;
                        this.form.profit.sale_cost_spot = this.sale_cost_spot;
                        this.form.profit.gross_profit_spot = this.gross_profit_spot;
                        this.form.profit.gross_profit_after_tax_refund_spot = this.gross_profit_after_tax_refund_spot;
                        this.form.profit.gross_profit_rate_spot = this.gross_profit_rate_spot;
                        this.form.profit.gross_profit_rate_after_tax_refund_spot = this.gross_profit_rate_after_tax_refund_spot;
                        this.form.profit.net_profit_spot = this.net_profit_spot;
                        this.form.profit.net_profit_rate_spot = this.net_profit_rate_spot;
                        this.form.profit.days_of_receivables = this.dateWeighting;
                        this.form.profit.receivables_efficiency = this.dateLevel;
                        this.form.profit.average_days_of_receivables = this.customerWeighting;
                        this.form.profit.average_receivables_efficiency = this.customerLevel;
                    };

                    this.form.is_submit = 1;
                    if (this.typeDifference) { // 热销品囤货
                        for (var i = 0, len = this.form.goods.length; i < len; i++) {
                            this.form.goods[i].spot_batch = [];
                            this.form.goods[i].spot_number = '0';
                            this.form.goods[i].spot_cost = '';
                            this.form.goods[i].spot_drawback = '';
                            this.form.goods[i].spot_warehouse = [];
                        };
                    };
                    this.form.expected_sales_country = this.form.expected_sales_country.join(',');
                    this.form.expected_sales_platform_cd = this.form.expected_sales_platform_cd.join(',');
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_save", this.form).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            if(_tihs.form.is_spot == 1){
                                backTab("/index.php?g=scm&m=display&a=demands&type=" + _data.data.demand_id, this.$lang("需求详情"));
                            }else{
                                backTab("/index.php?g=scm&m=display&a=demand_draft&type=" + _data.data.demand_id, this.$lang("需求详情"));
                            }
                        } else {
                            _tihs.$message.error(this.$lang(_data.msg));
                        };
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                // 提交数据验证
                validations: function (obj) {
                    var _this = this;
                    if (obj.demand_type === "N002100200" || obj.demand_type === "N002100201") {
                        if(obj.expected_sales_country.length == 0) {
                            this.$message.warning(this.$lang("预计销售国家为必填项"));
                            return false
                        }
                        for (var i = 0; i < sellRequire.length; i++) {
                            if (!this.form[sellRequire[i]]) {
                                // if(sellRequire[i] == 'rebate_rate' && this.form[sellRequire[i]] != 0){
                                //     this.$message.warning(sellRequireDsc[i] + this.$lang('为必填项'));
                                //     return false;
                                // }
                                this.$message.warning(sellRequireDsc[i] + this.$lang('为必填项'));
                                return false;
                            }
                        };
                        
                        if (this.form.is_spot == 1) {
                            if (!+this.form.is_purchase_only && !this.form.contract) {
                                this.$alert('<strong>' + this.$lang("纯现货需求") + '</strong>' + this.$lang(
                                        '需要填写完整的销售信息才可以提交')
                                    , this.$lang('提示'), {
                                        dangerouslyUseHTMLString: true
                                    });
                                    return false;
                            }
                            for (var i = 0, len = spot.length; i < len; i++) {
                                if (!obj[spot[i]]) {
                                    this.$alert('<strong>' + this.$lang("纯现货需求") + '</strong>' + this.$lang(
                                            '需要填写完整的销售信息才可以提交') +
                                        '<br>' + this.$lang(spotDsc[i]) + this.$lang('框架合同为必填项'), this.$lang(
                                            '提示'), {
                                            dangerouslyUseHTMLString: true
                                        });
                                        return false;
                                };
                            }
                        };
                    } else {
                        if(obj.expected_sales_country.length == 0) {
                            this.$message.warning(this.$lang("预计销售国家为必填项"));
                            return false
                        }
                        if(!obj.customer_charter_no){
                            if(obj.expected_sales_platform_cd.length == 0) {
                                this.$message.warning(this.$lang("预计销售平台为必填项"));
                                return false
                            }
                        }
                        console.log(obj)
                        for (var i = 0, len = stockRequire.length; i < len; i++) {
                            if (!obj[stockRequire[i]]) {
                                console.log(obj[stockRequire[i]])
                                this.$message.warning(stockDsc[i] + this.$lang("为必填项"));
                                return false
                            };
                        };
                    };

                    if (!obj.goods[0].sku_id) {
                        this.$message.warning(this.$lang('请导入商品'));
                        return false;
                    } else {
                        for (var j = 0; j < obj.goods.length; j++) {
                            for (var k = 0; k < sellGoods.length; k++) {
                                if (obj.goods[j][sellGoods[k]] === "") {
                                    _this.$message.warning(sellGoodsDsc[k] + "不能为空");
                                    return false;
                                };
                            };
                        };
                    };
                    return true;
                },
                beforeImportUpload: function () {
                    if (!this.form.sell_team) {
                        this.$message.warning(this.$lang('请先选择销售团队'));
                        return false;
                    };
                },
                //获取商品信息
                handerSerch: function (index, row) {
                    for (var i = 0, len = this.form.goods.length - 1; i < len; i++) {
                        if (this.form.goods[i].search_id === row.search_id && row.search_id && index !== i) {
                            this.$message.warning(this.$lang('该商品已添加'));
                            return;
                        };
                    };

                    if (!this.form.sell_team) {
                        this.$message.warning(this.$lang('请先选择销售团队'));
                        return
                    };
                    
                    if (row.search_id.substring(0,3) == "900") {
                        this.$message.warning(this.$lang('该SKU为组合商品，无法添加'));
                        return
                    };
                    if (!row.search_id) {
                        return;
                    };
                    row.require_number = '';
                    row.sell_price = '';
                    row.sell_price_not_contain_tax = '';
                    row.sell_currency = '';
                    row.purchase_number = '';
                    row.spot_warehouse = [];
                    row.on_way_warehouse =[];
                    row.on_way_batch=[];
                    row.spot_batch = [];
                    row.on_way_cost = '';
                    row.spot_cost = '';
                    row.spot_drawback = '';
                    row.on_way_number = '0';
                    row.spot_number = '0';
                    row.auth_and_link = '';

                    var _this = this;
                    var jsonData = [{
                        spu: row.search_id.substr(0, 8)
                    }];

                    this.queryPost("/index.php?g=common&m=goods&a=get_goods", {
                        search_id: row.search_id
                    }).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {

                            // 商品对应的SPU的供应商等于GP才可以创建(供应商GP的code：N002680001)
                            if (_data.data.supplier_cd !== 'N002680001') {
                                this.$message.error(this.$lang('该商品对应的SPU的供应商不是GP，无法创建'));
                                row.guds_img_cdn_addr = '';
                                row.goods_name = '';
                                row.sku_attribute = '',
                                row.sale_num = '',
                                row.hotness = '',
                                row.require_number = '';
                                row.sell_price = '';
                                row.sell_price_not_contain_tax = '';
                                row.sell_currency = '';
                                row.purchase_number = '';
                                row.spot_warehouse = [];
                                row.on_way_warehouse =[];
                                row.on_way_batch=[];
                                row.spot_batch = [];
                                row.on_way_cost = '';
                                row.spot_cost = '';
                                row.spot_drawback = '';
                                row.on_way_number = '0';
                                row.spot_number = '0';
                                row.auth_and_link = '';
                                return;
                            }
                            for (var key in _data.data) {
                                this.$set(row, key, _data.data[key]);
                                this.$set(row, "sku_attribute", _data.data["goods_attribute"]);
                            };
                            this.getSingleSkuStock(_data.data.sku_id, index, row);
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                    axios.post(SPUHEAT, jsonData).then(function (res) {
                        var _data = res.data;
                        if (_data.res[0].isSucces) {
                            _this.$set(row, "hotness", _data.res[0].spu.level);
                        } else {
                            _this.$set(row, "hotness", '-');
                        };
                    });
                },
                getSingleSkuStock: function (id, i, row, cb) { // 根据sku获取库存
                    var _this = this;
                    var saleCode = this.form.sell_team;
                    var req = {
                        processCode: "ORDER_BATCH_SEARCH",
                        processId: "4ea9083b9c74f80c23b097d820f4a8e7",
                        data: [{
                            skuId: id,
                            saleTeamCode: saleCode
                        }],
                    };
                    
                    ID !== "create" && (req.data[0].orderId = this.demandCode); // 编辑需求
                    var o = {
                        one:false,
                        two:false
                    }
                    var return_bool = [false,false]
                    axios.post('/?g=scm&m=demand&a=batch_stock', req).then(function (res) {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            cb && cb(_data.data[0].batchStock,'batch');
                            if (i !== null) {
                                var _arr = _data.data[0].batchStock;
                                row.sale_num = _arr.reduce(function (init, item) {
                                    return init + item.availableNum;
                                }, 0);
                                if (_data.data[0].batchStock && _data.data[0].batchStock.length > 0) {
                                    _this.documentBatch(i, _this.$lang('可选择现货'), '#66b1ff');
                                } else {
                                    _this.documentBatch(i, _this.$lang('无现货'), '#000');
                                };
                            };
                            var reqOnWay = {
                                processCode: "BATCH_ONWAY_SEARCH",
                                processId: "4ea9083b9c74f80c23b097d820f4a8e7",
                                data: [{
                                    skuId: _data.data[0].request.skuId,
                                    saleTeamCode: _data.data[0].request.saleTeamCode
                                }],
                            };
                            axios.post('/index.php?g=scm&m=demand&a=on_way_search', reqOnWay).then(function (res) {
                                var _dataOnWay = res.data;
                                if (_dataOnWay.code === 2000) {
                                    cb && cb(_dataOnWay.data[0].occupyDetail,'onway',0);
                                    if (i !== null) {
                                        var _arr = _dataOnWay.data[0].occupyDetail;
                                        if (_dataOnWay.data[0].occupyDetail && _dataOnWay.data[0].occupyDetail.length > 0) {
                                            o.one = true

                                        } else {

                                        };
                                        for(var x = 0;x<_dataOnWay.data[0].occupyDetail.length;x++){
                                            _dataOnWay.data[0].occupyDetail[x].type = 0
                                        }
                                        _this.gridDataOnWay = _dataOnWay.data[0].occupyDetail
                                        if(o.one || o.two){
                                            _this.documentOnWay(i, _this.$lang('可选择在途库存'), '#66b1ff');
                                        }else{
                                            _this.documentOnWay(i, _this.$lang('无在途库存'), '#000');
                                        }

                                    };
                                } else {
                                    _this.$message.error(_this.$lang(_dataOnWay.msg));
                                };
                                _this.onWayLoading = false;
                                return_bool[0] = true
                            });

                            var reqOnWay2 = {
                                processCode: "BATCH_ONWAYALLO_SEARCH",
                                processId: "4ea9083b9c74f80c23b097d820f4a8e7",
                                data: [{
                                    skuId: _data.data[0].request.skuId,
                                    saleTeamCode: _data.data[0].request.saleTeamCode
                                }],
                            };
                            axios.post('/index.php?g=scm&m=demand&a=on_way_search', reqOnWay2).then(function (res) {
                                var _dataOnWay = res.data;
                                if (_dataOnWay.code === 2000) {
                                    cb && cb(_dataOnWay.data[0].occupyDetail,'onway',1);
                                    if (i !== null) {
                                        var _arr = _dataOnWay.data[0].occupyDetail;
                                        if (_dataOnWay.data[0].occupyDetail && _dataOnWay.data[0].occupyDetail.length > 0) {
                                            o.two = true;
                                            _this.documentOnWay(i, _this.$lang('可选择在途库存'), '#66b1ff');
                                        } else {
                                            _this.documentOnWay(i, _this.$lang('无在途库存'), '#000');
                                        };
                                        //_this.gridDataOnWay2 = _dataOnWay.data[0].occupyDetail


                                        _dataOnWay.data[0].occupyDetail = _dataOnWay.data[0].occupyDetail.map(function (item) {
                                            _this.$set(item, 'type', 1);
                                            _this.$set(item, 'isSelected', true);
                                            _this.$set(item, 'selectNum', '');
                                            _this.$set(item, 'cost', '0.00');
                                            _this.$set(item, 'on_way_drawback', '');
                                            _this.$set(item, 'batchs', []);
                                            _this.$set(item,'allprice','0.00')
                                            return item;
                                        });
                                        var arr = []; //调拨在途数据数组

                                        /**
                                         * 处理数据，把调拨在途数据，按照调拨单号分好，不同的批次放在数据的batch_arr字段里
                                         */
                                        for(var x = 0;x<_dataOnWay.data[0].occupyDetail.length;x++){
                                            var bool = true
                                            for(var y = 0;y<arr.length;y++){
                                                if(arr[y].purchaseOrderNo === _dataOnWay.data[0].occupyDetail[x].purchaseOrderNo){
                                                    arr[y].num += _dataOnWay.data[0].occupyDetail[x].num
                                                    arr[y].batch_arr.push(JSON.parse(JSON.stringify(_dataOnWay.data[0].occupyDetail[x])))
                                                   bool = false
                                                }
                                            }
                                            if(bool){
                                                var obj = {
                                                }
                                                for(var i in _dataOnWay.data[0].occupyDetail[x]){
                                                    obj[i] = _dataOnWay.data[0].occupyDetail[x][i]
                                                }
                                                obj.batch_arr = []
                                                obj.batch_arr.push(JSON.parse(JSON.stringify(_dataOnWay.data[0].occupyDetail[x])))
                                                arr.push(obj)
                                            }
                                        }
                                        _this.gridDataOnWay2 = arr


                                        if(o.one || o.two){
                                            _this.documentOnWay(i, _this.$lang('可选择在途库存'), '#66b1ff');
                                        }else{
                                            _this.documentOnWay(i, _this.$lang('无在途库存'), '#000');
                                        }
                                    };
                                } else {
                                    _this.$message.error(_this.$lang(_dataOnWay.msg));
                                };
                                _this.onWayLoading = false;
                                return_bool[1] = true

                            });
                        } else {
                            _this.$message.error(_this.$lang(_dataOnWay.msg));
                        };
                    });

                    var settime = setInterval(function () {
                        if(return_bool[0] && return_bool[1]){
                            if(o.one || o.two){
                                _this.documentOnWay(i, _this.$lang('可选择在途库存'), '#66b1ff');
                            }else{
                                _this.documentOnWay(i, _this.$lang('无在途库存'), '#000');
                            }
                            clearInterval(settime)
                        }
                    },10)

                },
                getMultipleSkuStockOnway: function (params) {
                    var _this = this;
                    axios.post('/index.php?g=scm&m=demand&a=on_way_search', params).then(function (res) {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            for (var i = 0; i < _data.data.length; i++) {
                                if(_data.data[i].occupyDetail[0] && _data.data[i].occupyDetail[0].num > 0){
                                    _this.documentOnWay(i, _this.$lang('可选择在途库存'), '#66b1ff');
                                }else{
                                    _this.documentOnWay(i, _this.$lang('无在途库存'), '#000');
                                }          
                            }
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    });
                },
                getMultipleSkuStock: function (params, cb) {
                    axios.post(BATCHSTOCK, params).then(function (res) {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            cb && cb(_data.data);
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    });
                },
                reduceArr: function (arr, key) { // 对数组中的对象元素进行根据某个key值进行去重
                    var hash = {};
                    return arr.reduce(function (item, next) {
                        hash[next[key]] ? '' : hash[next[key]] = true && item.push(next);
                        return item;
                    }, []);
                },
                //批量导入
                handleSuccess: function (file) {
                    if (file.code !== 2000) {
                        this.$message.error(file.msg);
                        return;
                    };
                    var obj = {
                        id: '',
                        search_id: '',
                        sku_id: '',
                        goods_name: '',
                        sku_attribute: '',
                        hotness: '',
                        require_number: '',
                        sell_price: '',
                        purchase_number: '',
                        guds_img_cdn_addr: '',
                        auth_and_link: '',
                        spot_number: '0',
                        on_way_number:'0',
                        on_way_cost:'',
                        on_way_cost_not_contain_tax:'',
                        on_way_warehouse:[],
                        on_way_batch:[],
                        spot_batch: [],
                        spot_warehouse: [],
                        bar_code: '',
                        spot_cost: '',
                        spot_cost_not_contain_tax: '',
                        spot_drawback:''
                    };
                    this.form.goods = [obj];
                    var _this = this;
                    var batchStock = [];
                    file.data = this.reduceArr(file.data, "search_id"); // 去重
                    var jsonDatas = [];
                    this.form.sell_currency = file.data[0].currency;
                    for (var i = 0, len = file.data.length; i < len; i++) {
                        for (var key in file.data[i]) {
                            if (file.data[i].hasOwnProperty(key)) {

                                file.data[i].require_number = file.data[i].number;
                                file.data[i].sku_attribute = file.data[i].goods_attribute;
                                file.data[i].sell_price = (file.data[i].price - 0).toFixed(4);
                                file.data[i].sell_price_not_contain_tax = (file.data[i].price_no_tax - 0).toFixed(4);
                            };
                        };
                        file.data[i] = Object.assign({}, obj, file.data[i]);
                    };

                    this.form.goods = this.form.goods.filter((item) => {
                        return item.search_id;
                    });
                    this.form.goods = [...this.form.goods, ...file.data];
                    // search_id相同的商品进行过滤去重
                    this.form.goods = this.reduceArr(this.form.goods, "search_id");

                    for (var i = 0, len = this.form.goods.length; i < len; i++) {
                        var item = this.form.goods[i];
                        var __obj = {};
                        var obj_ = {};
                        __obj["spu"] = item.search_id.substr(0, 8);
                        jsonDatas.push(__obj);

                        obj_.skuId = file.data[i].sku_id;
                        obj_.saleTeamCode = this.form.sell_team;
                        batchStock.push(obj_);
                    };
                    var req = {
                        processCode: "ORDER_BATCH_SEARCH",
                        processId: "4ea9083b9c74f80c23b097d820f4a8e7",
                        data: batchStock,
                    };
                    var reqOnway = {
                        "processCode":"BATCH_ONWAY_SEARCH",
                        "processId":"4ea9083b9c74f80c23b097d820f4a8e7",
                        "data":batchStock
                    }
                    this.getMultipleSkuStock(req, initData);
                    this.getMultipleSkuStockOnway(reqOnway);
                    function initData(_arr) {

                        var stockObj = _this.stocksData(_arr);

                        _this.form.goods.map(function (item, index) {
                            stockObj[item.sku_id] && (item.sale_num = stockObj[item.sku_id]);
                            !stockObj[item.sku_id] && (item.sale_num = '0');
                            item.sale_num > 0 && _this.documentBatch(index, _this.$lang('可选择现货'),
                                '#66b1ff');
                            item.sale_num <= 0 && _this.documentBatch(index, _this.$lang('无现货'),
                                '#000');
                            return item;
                        });
                    };
                    this.changeRate(true);
                    axios.post(SPUHEAT, jsonDatas).then(function (response) {
                        var data = response.data.res;

                        if (data.length == jsonDatas.length) {
                            for (var i = 0, len = data.length; i < len; i++) {
                                if (data[i].isSucces) {
                                    _this.$set(_this.form.goods[i], "hotness", _data.spu.level);
                                } else {
                                    _this.$set(_this.form.goods[i], "hotness", '-');
                                };
                            };
                        } else {
                            _this.form.goods.forEach(function (item) {
                                _this.$set(item, "hotness", '-');
                            })

                        }
                    });
                },
                stocksData: function (_arr) {
                    _arr = _arr || [];

                    for (var i = 0, len = _arr.length; i < len; i++) {
                        var batchStockItem = _arr[i].batchStock;
                        var _num = 0;
                        for (var j = 0, jlen = batchStockItem.length; j < jlen; j++) {
                            _num += batchStockItem[j].availableNum;
                        };
                        _arr[i].avaiNum = _num;
                    };

                    var _obj = _arr.reduce(function (init, item) {
                        if (init[item.request.skuId]) {
                            init[item.request.skuId] += item.avaiNum;
                        } else {
                            init[item.request.skuId] = item.avaiNum;
                        };
                        return init;
                    }, {});

                    return _obj;
                },
                test: function (index) {
                    if (index === this.form.collection_time.length - 1) {
                        return;
                    };
                    var _this = this;
                    var _time = new Date(_this.form.collection_time[index].date);
                    this.$set(this.form.collection_time[index + 1], 'picksBeforeTime', {
                        disabledDate(item) {
                            return item.getTime() < _time.getTime();
                        }
                    });
                },
                handleError: function (file) {
                    this.$message.error(this.$lang('导入失败'));
                },
                downTemplate: function (title, result) {
                    window.location.href =
                        "/index.php?g=common&m=file&a=template_download&name=scm_demand_import_goods.xls";
                },
                fillRequire: function (row, key) {
                    this.$nextTick(() => {
                        row[key] = row[key].replace(/\s|,/g, "");
                    });
                    if (this.typeDifference && key == 'require_number') {
                        row.purchase_number = row.require_number;
                    };
                    this.getAmount();
                },
                documentBatch: function (i, num, cor) {
                    document.getElementsByClassName("batch")[i].innerText = num;
                    if (cor) {
                        document.getElementsByClassName("batch")[i].setAttribute("style",
                            `color: ${cor};text-decoration:underline;cursor:pointer;`);
                    };
                },
                documentOnWay:function (i, num, cor) {
                    if(!document.getElementsByClassName("on-way")[i]) return false;
                    document.getElementsByClassName("on-way")[i].innerText = num;
                    if (cor) {
                        document.getElementsByClassName("on-way")[i].setAttribute("style",
                            `color: ${cor};text-decoration:underline;cursor:pointer;`);
                    };
                },
                // 点击弹窗在途库存
                selectOnTheWay: function (index, row) {
                    if (!row.require_number) {
                        this.$message.warning(this.$lang('请先完善该商品数据'));
                        return;
                    };
                    var _this = this;
                    this.dialogOnWayVisible = true;
                    this.onWayLoading = true;

                    this.goodsName = row.goods_name;
                    this.demandFor = row.require_number;
                    this.batchIndex = index;
                    this.rowSelectedOnWayNum = row.spot_number;
                    this.getSingleSkuStock(row.sku_id, null, null, onWayCb);
                    function onWayCb(_arr,type,type2){
                        if(type != 'onway') return;
                        _arr = _arr || [];
                        _this.onWayLoading = false;
                        _arr = _arr.filter(function (item) {
                            return item.num;
                        });
                        if(type2 === 0){
                            _this.gridDataOnWay = _arr.length && _arr.map(function (item) {
                                _this.$set(item, 'isSelected', true);
                                _this.$set(item, 'type', 0);
                                _this.$set(item, 'selectNum', '');
                                _this.$set(item, 'cost', '');
                                _this.$set(item, 'on_way_drawback', '');
                                _this.$set(item, 'batchs', []);
                                return item;
                            });
                        }
                        if(type2 === 1){
                            _this.gridDataOnWay2 =  _arr.length && _arr.map(function (item) {
                                _this.$set(item, 'isSelected', true);
                                _this.$set(item, 'type', 1);
                                _this.$set(item, 'selectNum', '');
                                _this.$set(item, 'cost', '');
                                _this.$set(item, 'on_way_drawback', '');
                                _this.$set(item, 'batchs', []);
                                return item;
                            });
                        }
                       /**var _array = [];

                        for (var i = 0, ilen = _this.gridDataOnWay.length; i < ilen; i++) {
                            var item = _this.gridDataOnWay[i];
                            for (var j = 0, jlen = row.on_way_warehouse.length; j < jlen; j++) {
                                var jtem = row.on_way_warehouse[j];
                                if (item.deliveryWarehouse === jtem.deliveryWarehouse) {
                                    jtem.batchs.forEach(function(el){
                                        if(item.purchaseOrderNo == el.purchaseOrderNo){
                                        _this.$set(item, 'isSelected', el.isSelected);
                                        _this.$set(item, 'selectNum', el.selectNum);
                                        _this.$set(item, 'cost', el.cost);
                                        _this.$set(item, 'noTaxUnitPrice', el.noTaxUnitPrice);
                                        _this.$set(item, 'on_way_drawback', el.on_way_drawback);
                                        _this.$set(item, 'batchs', el.batchs); 
                                        _array.push(item);
                                        }
                                    })
                                    
                                };
                            };

                        };

                        _this.$nextTick(function () {
                            var i = 0,
                                len = _array.length;
                            if (len) {
                                for (; i < len; i++) {
                                    _this.$refs.multipleTableOnway.toggleRowSelection(_array[i], true);
                                };
                            };
                        });**/
                    }
                },
                // 批次
                selectBatch: function (index, row) {
                    if (!row.require_number) {
                        this.$message.warning(this.$lang('请先完善该商品数据'));
                        return;
                    };
                    var _this = this;
                    this.dialogTableVisible = true;
                    this.batchLoading = true;

                    this.goodsName = row.goods_name;
                    this.demandFor = row.require_number;
                    this.rowSelectedSpotNum = row.on_way_number;
                    this.batchIndex = index;

                    row.spot_warehouse.length && (_this.confirmDisabled = false);
                    this.getSingleSkuStock(row.sku_id, null, null, stockCb);
                    function stockCb(_arr,type) {
                        if(type != 'batch') return;

                        _arr = _arr || [];
                        _this.batchLoading = false;
                        _arr = _arr.filter(function (item) {
                            return item.availableNum;
                        });

                        _this.gridData = _arr.length && _arr.map(function (item) {
                            _this.$set(item, 'isSelected', true);
                            _this.$set(item, 'num', '');
                            _this.$set(item, 'cost', '');
                            _this.$set(item, 'batchs', []);
                            _this.$set(item, 'drawback', '');
                            return item;
                        });
                        var _array = [];

                        for (var i = 0, ilen = _this.gridData.length; i < ilen; i++) {
                            var item = _this.gridData[i];
                            for (var j = 0, jlen = row.spot_warehouse.length; j < jlen; j++) {
                                var jtem = row.spot_warehouse[j];
                                if (item.deliveryWarehouse === jtem.deliveryWarehouse) {
                                    _this.$set(item, 'isSelected', jtem.isSelected);
                                    _this.$set(item, 'num', jtem.num);
                                    _this.$set(item, 'cost', jtem.cost);
                                    _this.$set(item, 'noTaxUnitPrice', jtem.noTaxUnitPrice);
                                    _this.$set(item, 'batchs', jtem.batchs);
                                    _this.$set(item, 'drawback', jtem.drawback);
                                    _array.push(item);
                                };
                            };
                        };
                        _this.$nextTick(function () {
                            var i = 0,
                                len = _array.length;
                            if (len) {
                                for (; i < len; i++) {
                                    _this.$refs.multipleTable.toggleRowSelection(_array[i], true);
                                };
                            };
                        });

                    };
                },
                getBatchSummaries: function () {
                    var sums = [this.$lang("合计")],
                        sum2 ,_sum3, _sum4 ,_sum5;
                        _sum2 = _sum3 = _sum4 = _sum5 = 0;

                    for (var i = 0, len = this.gridData.length; i < len; i++) {
                        _sum2 += (this.gridData[i].availableNum - 0);
                        _sum3 += (this.gridData[i].num - 0);
                        _sum4 += (this.gridData[i].cost - 0);
                        _sum5 += (this.gridData[i].drawback - 0);
                    };
                    sums[2] = _sum2;
                    sums[3] = _sum3;
                    sums[4] = '￥' + (_sum4 ? this.$options.filters.numberFormat(_sum4) : '0.00');
                    sums[5] = '￥' + (_sum4 ? this.$options.filters.numberFormat(_sum5) : '0.00');
                    return sums;
                },
                // 在途计算总和
                getOnWaySummaries: function() {
                    var sums = [this.$lang("合计")],
                        _sum2 = _sum3 = _sum4 = _sum5;
                        _sum2 = _sum3 = _sum4 = _sum5 = 0;
                    for (var i = 0, len = this.gridDataOnWay.length; i < len; i++) {
                        _sum2 += (this.gridDataOnWay[i].num - 0);
                        _sum3 += (this.gridDataOnWay[i].selectNum - 0);
                        _sum4 += (this.gridDataOnWay[i].cost - 0);
                        _sum5 += (this.gridDataOnWay[i].on_way_drawback - 0);
                    };
                    sums[5] = _sum2;
                    sums[7] = _sum3;
                    sums[8] = '￥' + (_sum4 ? this.$options.filters.numberFormat(_sum4) : '0.00');
                    sums[9] = '￥' + (_sum4 ? this.$options.filters.numberFormat(_sum5) : '0.00');
                    return sums;
                },
                getOnWaySummaries2: function() {
                    var sums = [this.$lang("合计")]
                    var sums2 = 0
                    var sums3 = 0
                    var sums4 = 0
                    for (var i = 0, len = this.gridDataOnWay2.length; i < len; i++) {
                        sums2 += (this.gridDataOnWay2[i].num - 0);
                        sums3 +=(this.gridDataOnWay2[i].selectNum - 0);
                        sums4 += (this.gridDataOnWay2[i].cost - 0);
                    };
                    sums[4] = sums2;
                    if(isNaN(sums3)){
                        sums[6] = '￥' + (sums4 ? this.$options.filters.numberFormat(sums4) : '0.00');
                        sums[5] = 0
                    }else{
                        sums[6] = '￥' + (sums4 ? this.$options.filters.numberFormat(sums4) : '0.00');
                        sums[5] = sums3;
                    }
                    return sums;
                },
                manualSelect: function (val, row) {
                    if (row.isSelected) {
                        row.num = "";
                        row.cost = 0;
                    };
                },
                //在途选择
                manualSelectOnWay:function (val, row) {
                    if (row.isSelected) {
                        row.selectNum = "";
                        row.cost = 0;
                    };
                },
                manualSelectOnWay2:function (val, row) {
                    if (row.isSelected) {
                        row.selectNum = "";
                        row.cost = 0;
                    };
                },
                // 现货勾选
                handleSelectionChange: function (val) {
                    this.gridData.map(function (item) {
                        item.isSelected = true;
                        return item;
                    });
                    val.map(function (item) {
                        item && (item.isSelected = false);
                        return item;
                    });
                    
                    this.currentBatch = val;
                },
                // 在途 勾选
                handleSelectionChangeOnWay :function (val) {
                    this.confirmDisabledOnway = false;
                    this.gridDataOnWay.map(function (item) {
                        item.isSelected = true;
                        return item;
                    });
                    val.map(function (item) {
                        item && (item.isSelected = false);
                        return item;
                    });
                    this.currentOnway = val
                },
                handleSelectionChangeOnWay2 :function (val) {
                    console.log(val)
                    this.gridDataOnWay2.map(function (item) {
                        item.isSelected = true;
                        return item;
                    });
                    val.map(function (item) {
                        item && (item.isSelected = false);
                        return item;
                    });
                    this.currentOnway2 = val
                    console.log(this.currentOnway2)
                },
                gridSelect: function (val) {
                    if (val && !val.length) {
                        this.gridData.map(function (item) {
                            item.isSelected = true;
                            item.num = '';
                            item.cost = '';
                            item.batchs = [];
                            return item;
                        });
                    };
                },
                // 在途全选
                gridSelectOnWay: function (val) {
                    if (val && !val.length) {
                        this.gridDataOnWay.map(function (item) {
                            item.isSelected = true;
                            item.selectNum = '';
                            item.cost = 0;
                            item.batchs = [];
                            return item;
                        });
                    };
                },
                gridSelectOnWay2: function (val) {
                    if (val && !val.length) {
                        this.gridDataOnWay2.map(function (item) {
                            item.isSelected = true;
                            item.selectNum = '';
                            item.cost = 0;
                            item.batchs = [];
                            return item;
                        });
                    };
                },
                batch_num:function(value,row){
                    if ((value - 0) > (row.num - 0)) {
                        this.$message.warning(this.$lang('已选数量不能大于可用数量'));
                        return;
                    };
                    if(value == row.num){
                        for(var x = 0;x<row.batch_arr.length;x++){
                            row.batch_arr[x].selectNum = row.batch_arr[x].num
                            row.batch_arr[x].cost =  row.batch_arr[x].allprice = row.batch_arr[x].unitPrice*row.batch_arr[x].selectNum
                        }
                    }else{
                        var n = value;
                        for(var x = 0;x<row.batch_arr.length;x++){
                            if(n <= 0){
                                row.batch_arr[x].selectNum = 0;
                                row.batch_arr[x].allprice = row.batch_arr[x].unitPrice*row.batch_arr[x].selectNum
                            }else{
                                if(n - row.batch_arr[x].num >= 0){
                                    row.batch_arr[x].selectNum = row.batch_arr[x].num
                                }else{
                                    row.batch_arr[x].selectNum = n
                                }
                                row.batch_arr[x].cost = row.batch_arr[x].allprice = row.batch_arr[x].unitPrice*row.batch_arr[x].selectNum
                                n = n - row.batch_arr[x].num;
                            }
                        }
                    }
                    row.selectNum = value

                    for(var x = 0;x<row.batch_arr.length;x++){
                        row.batch_arr[x].cost = row.batch_arr[x].allprice
                        // row.allprice = Number(row.allprice) + Number(row.batch_arr[x].allprice)
                        row.allprice = Number(row.batch_arr[x].allprice)

                    }
                    row.cost = row.allprice


                },
                numChangeOnWay:function(i,row){
                    if ((row.selectNum - 0) > (row.num - 0)) {
                        this.$message.warning(this.$lang('已选数量不能大于可用数量'));
                        return;
                    };
                    var skuID = this.form.goods[this.batchIndex].sku_id;
                    this.confirmDisabledOnway = false;
                    this.confirmFlagOnway = false;
                    var _this = this;
                    var temp = deepCopyObj([row]);
                    delete temp.batchs;
                    _this.$set(row, 'batchs', temp);

                    //row.cost = row.selectNum*row.unitPrice;
                    console.log(row.selectNum , row.noTaxUnitPrice, row.proportionOfTax)
                    row.on_way_drawback = row.selectNum * row.noTaxUnitPrice * row.proportionOfTax || 0;
                    if(row.batch_arr) {
                        for(var i = 0;i<row.batch_arr.length;i++){
                            row.batch_arr[i].on_way_drawback = row.on_way_drawback;
                        }
                    }
                    // this.$set(row,'on_way_drawback',row.selectNum * row.noTaxUnitPrice * row.proportionOfTax || 0)
                    console.log(row)
                },
                numChange: function (i, row) {
                    if ((row.num - 0) > (row.availableNum - 0)) {
                        this.$message.warning(this.$lang('已选数量不能大于可用数量'));
                        return;
                    };
                    var skuID = this.form.goods[this.batchIndex].sku_id;
                    this.confirmDisabled = false;
                    this.confirmFlag = true;
                    var _this = this;
                    var req = {
                        processCode: 'BATCH_SEARCH',
                        processId: '4ea9083b9c74f80c23b097d820f4a8e7',
                        data: [{
                            skuId: skuID,
                            deliveryWarehouse: row.deliveryWarehouse,
                            num: row.num,
                            saleTeamCode: this.form.sell_team
                        }]
                    };

                    ID !== "create" && (req.data[0].orderId = this.demandCode); // 编辑需求

                    axios.post(BATCHSEARCH, req).then(function (res) {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            _this.confirmFlag = false;
                            var occupyDetail = _data.data[0].occupyDetail;
                            row.cost = occupyDetail.reduce(function (init, item) {
                                return init + item.num * item.unitPrice;
                            }, 0);

                            row.drawback = occupyDetail.reduce(function (init, item) {
                                return init + item.num * item.drawback;
                            }, 0);
                            _this.$set(row, 'batchs', occupyDetail);
                        } else {
                            _this.$message.error(_this.$lang(_data.msg));
                        };
                    });
                },
                // 在途确定
                onWayConfire:function (){
                    if (this.confirmFlag) {
                        return;
                    };
                    for(var x = 0;x<this.currentOnway2.length;x++){
                        this.currentOnway.push(this.currentOnway2[x])
                    }
                    console.log(this.currentOnway);
                    this.currentOnway = unique(this.currentOnway)
                    var currentOnwayCopy =  JSON.parse(JSON.stringify(this.currentOnway))
                    for (var i = 0, len = this.currentOnway.length; i < len; i++) {
                        if (!this.currentOnway[i].selectNum) {
                            this.$message.warning(this.$lang('本次选择数量不能为空'));
                            return;
                        };
                    };
                    for(var x = 0;x<this.currentOnway.length;x++){
                        if(this.currentOnway[x].batch_arr){
                            for(var y = 0;y<this.currentOnway[x].batch_arr.length;y++){
                                if(this.currentOnway[x].batch_arr[y].selectNum){
                                    this.currentOnway.push(JSON.parse(JSON.stringify(this.currentOnway[x].batch_arr[y])))
                                }
                            }
                            this.currentOnway.splice(x,1)
                            x--
                        }
                    }

                    var on_way_number = 0,
                        _arr = [],
                        on_way_cost = 0,
                        on_way_cost_not_contain_tax = 0;
                        on_way_drawback = 0;
                    var _this = this;
                    var tempWarehouses = [];
                    var tempWarehouses2 = [];
                    var tempAll = [];
                    console.log(this.currentOnway)
                    this.currentOnway.forEach(function(el){
                        console.log(el);
                        var flag = true;
                        console.log(tempWarehouses)
                            tempWarehouses.forEach(function(item){
                                if(item.deliveryWarehouse == el.deliveryWarehouse ){
                                    flag = false;
                                }
                            })
                            if(flag){
                                tempWarehouses.push({
                                    deliveryWarehouse:el.deliveryWarehouse,
                                    deliveryWarehouseName:el.deliveryWarehouseName,
                                    type:el.type,
                                    cost:0,
                                    num:0,
                                    noTaxUnitPrice:0,
                                    on_way_drawback:0,
                                    batchs:[],
                                    unitPrice:el.unitPrice,
                                    unit_price_usd:el.unit_price_usd
                                });
                            }
                    })
                    for (var i = 0, len = this.currentOnway.length; i < len; i++) {
                        tempWarehouses.forEach(function(el){
                            if(el.deliveryWarehouse == _this.currentOnway[i].deliveryWarehouse){
                                el.batchs.push(_this.currentOnway[i])
                            }
                        })
                        
                    };
                    for (var i = 0, len = tempWarehouses.length; i < len; i++) {
                        tempWarehouses[i].batchs.forEach(function(el){
                            console.log(el)
                            tempWarehouses[i].cost += +el.cost;
                            tempWarehouses[i].noTaxUnitPrice += +el.noTaxUnitPrice;
                            tempWarehouses[i].on_way_drawback += +el.on_way_drawback;
                            tempWarehouses[i].num += +el.selectNum;
                            _arr.push({
                                id:el.batch_id,
                                num:el.selectNum,
                                selectNum:el.selectNum,
                                unitPrice:el.unitPrice,
                                unit_price_usd:el.unit_price_usd,
                                purchaseTeamName:el.purchaseTeamName,
                                purchaseTeamCode:el.purchaseTeamCode,
                                purchaseOrderNo:el.purchaseOrderNo,
                                deliveryWarehouse:el.deliveryWarehouse,
                                proportionOfTax:el.proportionOfTax,
                                deliveryWarehouseName:el.deliveryWarehouseName,
                                deliveryWarehouseName:el.deliveryWarehouseName,
                                cost:el.cost,
                                type:el.type
                            })
                        })
                        on_way_number+= +tempWarehouses[i].num;
                        on_way_cost+= +tempWarehouses[i].cost;
                        on_way_cost_not_contain_tax+= +tempWarehouses[i].noTaxUnitPrice;
                        on_way_drawback+= +tempWarehouses[i].on_way_drawback;

                    }
                    if (on_way_number + +this.rowSelectedOnWayNum > this.demandFor) {
                        this.$message.warning(this.$lang('本次选择数量总和不能大于需求数量'));
                        this.currentOnway = currentOnwayCopy
                        return;
                    };

                    this.form.goods[this.batchIndex].on_way_number = on_way_number;
                    this.form.goods[this.batchIndex].on_way_cost = on_way_cost;
                    this.form.goods[this.batchIndex].on_way_cost_not_contain_tax = on_way_cost_not_contain_tax;
                    // this.form.goods[this.batchIndex].on_way_drawback = on_way_drawback;


                    if(this.form.goods[this.batchIndex].spot_drawback != ''  && on_way_drawback != 0){

                        this.form.goods[this.batchIndex].spot_drawback = String(this.form.goods[this.batchIndex].spot_drawback);
                    } else if(this.form.goods[this.batchIndex].spot_drawback != ''  && on_way_drawback == 0){

                        this.form.goods[this.batchIndex].spot_drawback = Number(this.form.goods[this.batchIndex].spot_drawback);
                    }else{

                        this.form.goods[this.batchIndex].spot_drawback = '0.00';
                    }
              

                    // this.form.goods[this.batchIndex].on_way_drawback = on_way_drawback;
                    if(on_way_drawback == '0.00'){

                        this.form.goods[this.batchIndex].on_way_drawback = Number(on_way_drawback);
                    }else{

                        this.form.goods[this.batchIndex].on_way_drawback = String(on_way_drawback);
                    }
                    


                    this.form.goods[this.batchIndex].on_way_warehouse = tempWarehouses.filter(function (item) {
                        return item.num;
                    });

                    this.form.goods[this.batchIndex].on_way_warehouse = tempWarehouses.filter(function (item) {
                        return item.num;
                    });
                    
                    this.form.goods[this.batchIndex].on_way_batch = _arr;
                    this.dialogOnWayVisible = false;
                    this.currentOnway = [];
                    this.currentOnway2 = []


                },
                batchConfire: function () {
                    if (this.confirmFlag) {
                        return;
                    };
                    var spotNumber = 0,
                        _arr = [],
                        spotCost = 0;
                        spotDrawback = 0;
                        spotCostCotContainTax = 0;
                    var _this = this;
                    for (var i = 0, len = this.currentBatch.length; i < len; i++) {
                        if (!this.currentBatch[i].num) {
                            this.$message.warning(this.$lang('本次选择数量不能为空'));
                            return;
                        };
                    };
                   
                    for (var i = 0, len = this.currentBatch.length; i < len; i++) {
                        this.currentBatch[i].batchs.forEach(function (item) {
                            !item.id && _this.$set(item, 'id', item.batch_id);
                            !item.unit_price && _this.$set(item, 'unit_price', item.unitPrice);
                            item.batch_id && _this.$delete(item, 'batch_id');
                            item.unitPrice && _this.$delete(item, 'unitPrice');
                        });
                        spotNumber += (+this.currentBatch[i].num);
                        spotCost += (+this.currentBatch[i].cost);
                        spotCostCotContainTax += (+this.currentBatch[i].noTaxUnitPrice);
                        spotDrawback += (+this.currentBatch[i].drawback	);
                        _arr = _arr.concat(this.currentBatch[i].batchs);
                    };
                    if (spotNumber +  +this.rowSelectedSpotNum> this.demandFor) {
                        this.$message.warning(this.$lang('本次选择数量总和不能大于当前SKU需求数量'));
                        return;
                    };

                    this.form.goods[this.batchIndex].spot_number = spotNumber;
                    this.form.goods[this.batchIndex].spot_cost = spotCost;
                    this.form.goods[this.batchIndex].spot_cost_not_contain_tax = spotCostCotContainTax;

                    if(this.form.goods[this.batchIndex].on_way_drawback == '' || this.form.goods[this.batchIndex].on_way_drawback == undefined){
                        //console.log('111')
                        this.form.goods[this.batchIndex].on_way_drawback = 0;
                    }else{
                        if(spotDrawback != 0){
                            //console.log('222')
                            this.form.goods[this.batchIndex].on_way_drawback = this.form.goods[this.batchIndex].on_way_drawback;
                        }else{
                            //console.log('333')
                            this.form.goods[this.batchIndex].on_way_drawback = Number(this.form.goods[this.batchIndex].on_way_drawback);
                        }
                    }

                    this.form.goods[this.batchIndex].spot_drawback = spotDrawback;

                    this.form.goods[this.batchIndex].spot_warehouse = this.currentBatch.filter(function (item) {
                        return item.num;
                    });

                    this.form.goods[this.batchIndex].spot_batch = _arr;

                    this.dialogTableVisible = false;
                  //  console.log('现货退税'+this.form.goods[this.batchIndex].spot_drawback)
                   // console.log('在途退税'+this.form.goods[this.batchIndex].on_way_drawback)
                  //  console.log(this.form.goods)
                },
                // 页面跳转
                route: function (title, _html, type) {
                    var dom = document.createElement("a"),
                        _href = "/index.php?g=scm&m=display&a=" + _html + "&type=" + type;
                    dom.setAttribute("onclick", "opennewtab(this,'" + title + "')");
                    dom.setAttribute("_href", _href);
                    dom.click();
                },
            },
            computed: {
                tot1:function(){
                    var num = 0;
                    if(this.gridDataOnWay){
                        for(var x = 0;x<this.gridDataOnWay.length;x++){
                            num += this.gridDataOnWay[x].num
                        }
                    }
                    if(this.gridDataOnWay2){
                        for(var x = 0;x<this.gridDataOnWay2.length;x++){
                            num += this.gridDataOnWay2[x].num
                        }
                    }
                    return num
                },
                tot2:function(){
                    var num = 0;
                    if(this.gridDataOnWay){
                        for(var x = 0;x<this.gridDataOnWay.length;x++){
                            num += Number(this.gridDataOnWay[x].selectNum)
                        }
                    }
                    if(this.gridDataOnWay2){
                        for(var x = 0;x<this.gridDataOnWay2.length;x++){
                            num += Number(this.gridDataOnWay2[x].selectNum)
                        }
                    }
                    if(isNaN(num)){
                        num = 0
                    }
                    return num
                },
                tot3:function(){
                    var num = 0;
                    if(this.gridDataOnWay){
                        for(var x = 0;x<this.gridDataOnWay.length;x++){
                            var money = 0;
                            if(this.gridDataOnWay[x].selectNum){
                                money = this.gridDataOnWay[x].unitPrice*this.gridDataOnWay[x].selectNum
                            }
                            num += Number(money)
                        }
                    }
                    if(this.gridDataOnWay2){
                        for(var x = 0;x<this.gridDataOnWay2.length;x++){
                            var money = 0;
                            if(this.gridDataOnWay2[x].selectNum){
                                money = this.gridDataOnWay2[x].cost
                            }
                            num += Number(money)
                        }
                    }
                    if(isNaN(num)){
                        num = 0
                    }
                    return '￥'+num.toFixed(2)
                },
                batchTotal:function(){
                    var dom = document.getElementsByClassName('el-table_1_column_9 is-leaf')[1];
                    var num =  dom ? dom.firstChild.innerText :0;
                    return num;

                },
                revenue_spot: function () {
                    var _goods = this.form.goods;
                    var _this = this;
                    var val = _goods.reduce(function (init, item) {
                        if (item.require_number) {
                            return init + (utils.conversionRate(_this.exchangerate, _this.currencyVal,
                                item.sell_price, 'USD') * (item.require_number - (+item.purchase_number)));
                        };
                    }, 0);
                    return val;
                },
                revenue_after_tax_spot: function () {
                    var val = this.revenue_spot - utils.conversionRate(this.exchangerate, this.curreneyobj[
                        this.form.tax_currency_spot], this.form.tax_spot, 'USD');
                    return val || '0.00';
                },
                commodity_cost_spot: function () {
                    var _goods = this.form.goods;
                    var sums = 0;
                    for (var i = 0, len = _goods.length; i < len; i++) {
                        var batchs = _goods[i].spot_batch || [];
                        var onWays = _goods[i].on_way_batch || [];
                        for (var j = 0, jlen = batchs.length; j < jlen; j++) {
                            var price = batchs[j].unit_price || 0;
                            sums += batchs[j].num * utils.conversionRate(this.exchangerate, 'CNY', price,
                                'USD');
                        };
                        for (var j = 0, jlen = onWays.length; j < jlen; j++) {
                            var price = onWays[j].unitPrice || 0;
                            sums += onWays[j].num * utils.conversionRate(this.exchangerate, 'CNY', price,
                                'USD');
                        };
                    };
                    return sums;
                },
                tax_refund_spot:function(){
                    var _goods = this.form.goods,sums = 0;
                    for (var i = 0, len = _goods.length; i < len; i++) {
                        sums += utils.conversionRate(this.exchangerate, 'CNY', _goods[i].spot_drawback, 'USD') + utils.conversionRate(this.exchangerate, 'CNY', _goods[i].on_way_drawback, 'USD');
                    }
                    console.log(sums)
                    return sums;
                },
                cost_after_tax_refund_spot:function(){
                    return +(this.commodity_cost_spot  - this.tax_refund_spot).toFixed(2);
                },
                tax_spot: function () {
                    return utils.conversionRate(this.exchangerate, this.curreneyobj[this.form.tax_currency_spot],
                        this.form.tax_spot, 'USD') || '0.00';
                },
                sale_cost_spot: function () {
                    return parseFloat(utils.conversionRate(this.exchangerate, this.curreneyobj[this.form.expense_currency_spot],
                        this.form.expense_spot, 'USD')+ this.revenue_spot * this.form.rebate_rate * 0.01) || '0.00';
                },
                gross_profit_spot: function () {
                    return this.revenue_after_tax_spot - this.commodity_cost_spot;
                },
                gross_profit_after_tax_refund_spot: function () {
                    return +(this.gross_profit_spot + this.tax_refund_spot).toFixed(2);
                },
                gross_profit_rate_spot: function () {
                    if (!+this.revenue_after_tax_spot) {
                        return '0.00%'
                    };
                    return +this.gross_profit_spot.toFixed(2) / Math.abs(this.revenue_after_tax_spot);
                },
                gross_profit_rate_after_tax_refund_spot: function () {
                    if (!+this.gross_profit_after_tax_refund_spot) {
                        return '0.00%'
                    };
                    return +this.gross_profit_after_tax_refund_spot.toFixed(2) / Math.abs(this.revenue_after_tax_spot);
                },
                net_profit_spot: function () {
                    return +(this.gross_profit_after_tax_refund_spot - this.sale_cost_spot).toFixed(2);
                },
                net_profit_rate_spot: function () {
                    if (!+this.revenue_after_tax_spot) {
                        return '0.00%'
                    };
                    return +this.net_profit_spot.toFixed(2) / Math.abs(this.revenue_after_tax_spot);
                },
                // 收款效率
                dateWeighting: function () {
                    // 收款日期加权
                    var collections = this.form.collection_time;
                    if (!collections[0].date || !collections[0].percent) {
                        return;
                    };
                    var wei = collections.reduce(function (init, item) {
                        return init + getDate(item.date) * item.percent / 100;
                    }, 0);

                    return transformDays(wei.toFixed(0) - NOWDATETIME);

                },
                dateLevel: function () {
                    if (!this.dateWeighting) {
                        return;
                    };
                    var dateNum = this.dateWeighting - 0;
                    if (dateNum <= 20) {
                        return "A";
                    } else if (dateNum <= 30) {
                        return "B";
                    } else if (dateNum <= 40) {
                        return "C";
                    } else if (dateNum <= 60) {
                        return "D";
                    } else {
                        return "F";
                    };
                },
                customerLevel: function () {
                    if (this.customerWeighting === null || this.customerWeighting === undefined) {
                        return;
                    };
                    var avg = this.customerWeighting - 0;

                    if (avg <= 20) {
                        return "A";
                    } else if (avg <= 30) {
                        return "B";
                    } else if (avg <= 40) {
                        return "C";
                    } else if (avg <= 60) {
                        return "D";
                    } else {
                        return "F";
                    };
                },
            },
            watch: {
                'form.sell_amount': function (val) {
                    this.$nextTick(function () {
                        this.getAmount();
                    });
                },
                'form.expense': function (val) {
                    this.$nextTick(function () {
                        this.form.expense = val.replace(/\s|,/g, '');
                    });
                },
                'form.tax': function (val) {
                    this.$nextTick(function () {
                        this.form.tax = val.replace(/\s|,/g, '');
                    });
                },
                'form.expense_spot': function (val) {
                    this.$nextTick(function () {
                        this.form.expense_spot = val.replace(/\s|,/g, '');
                    });
                },
                'form.tax_spot': function (val) {
                    this.$nextTick(function () {
                        this.form.tax_spot = val.replace(/\s|,/g, '');
                    });
                },
                'form.receive_country': function (val, old) { //选择国家
                    if (this.isCreateContry) {
                        this.form.receive_province = "";
                        this.form.receive_city = "";
                        this.getProvinces(val);
                    };
                    this.isCreateContry = true;
                },
                'form.receive_province': function (val, old) { //选择省市
                    if (this.isCreateCity) {
                        this.form.receive_city = "";
                        this.getCitys(val);
                    };
                    this.isCreateCity = true;
                },
                'form.collection_cycle': function (newVal, oldVal) {
                    if (this.collectionCycleFlag) {
                        var obj = {
                            node: '',
                            days: '',
                            day_type: '',
                            percent: '',
                            date: ''
                        };
                        this.form.collection_time = [];
                        var len = newVal.substr(7, 1),
                            i = 0;
                        for (; i < len; i++) {
                            this.form.collection_time.push(deepCopyObj(obj));
                        };
                    };
                    this.collectionCycleFlag = true;
                },
                'form.demand_type': function (val) {
                    switch (val) {
                        case "N002100100":
                            this.typeDifference = true;
                            // 销售订单切换为囤货时进行一些数据初始化；
                            if (this.demandTypeFlag) {
                                this.form.customer_charter_no = "";
                                this.form.customer = "";
                                this.form.contract = "";
                                this.form.is_purchase_only = '0';
                                this.form.business_mode = "";
                                this.form.our_company = "";
                                this.form.receive_mode = "";
                                this.form.collection_cycle = "";
                                this.form.tax_rate = '';
                                this.form.invoice_type = '';
                                this.form.receive_country = '';
                                this.form.receive_province = '';
                                this.form.receive_city = '';
                                this.form.receive_address = '';
                                this.form.need_warehouse = '';
                                this.form.ship_date = '';
                                this.form.rebate_rate = "";
                                this.form.rebate_amount = "0.00";
                                this.form.collection_time = [{
                                    node: '',
                                    days: '',
                                    day_type: '',
                                    percent: '100',
                                    date: ''
                                }];
                                this.form.is_spot = 2;

                                for (var i = 0, len = this.form.goods.length; i < len; i++) {
                                    if (+this.form.goods[i].spot_number) {
                                        this.form.goods[i].spot_number = '0';
                                        this.form.goods[i].spot_batch = [];
                                        this.form.goods[i].spot_warehouse = [];
                                        this.form.goods[i].spot_cost = '';
                                        this.form.goods[i].spot_drawback = '';
                                    };
                                };
                            };
                            this.demandTypeFlag = true;
                            break;
                        case "N002100200":
                            this.typeDifference = false;
                            this.form.need_warehouse = '0';
                            this.form.business_mode = "";
                            this.form.our_company = "";
                            this.form.collection_time = [{
                                node: '',
                                days: '',
                                day_type: '',
                                percent: '',
                                date: ''
                            }];
                            this.form.is_spot = this.form.goods[0].purchase_number ? 2 : 0;
                            break;
                        case "N002100201":
                            this.typeDifference = false;
                            this.form.need_warehouse = '0';
                            this.form.business_mode = "";
                            this.form.our_company = "";
                            this.form.collection_time = [{
                                node: '',
                                days: '',
                                day_type: '',
                                percent: '',
                                date: ''
                            }];
                            this.form.is_spot = this.form.goods[0].purchase_number ? 2 : 0;
                            break;
                        default:
                    };

                },
                'form.sell_currency': function (val) {
                    for (var i = 0, len = CURREN.length; i < len; i++) {
                        if (CURREN[i].CD === val) {
                            this.currencyVal = CURREN[i].CD_VAL;
                            break;
                        };
                    };
                },
                'form.customer_charter_no': function (newVal) {
                    this.queryPost("/index.php?m=order_detail&a=getContract", {
                        sp_charter_no: newVal
                    }).then((res) => {
                        var _data = res.data;
                        this.contractLoading = false;
                        if (_data.status === 1) {
                            this.contract = _data.data;
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                dialogTableVisible: function (bol) {
                    !bol && (this.currentBatch = []);
                    !bol && (this.batchIndex = 0);
                },
            },
            //过滤器
            filters: {
                formatDate: function (time) {
                    if (time) {
                        return utils.dateFormat(new Date(time), 'yyyy-MM-dd')
                    }
                },
                numberFormat: function (num, flag) {
                    if (!num || num == 'NaN') {
                        return 0;
                    };
                    num = !flag ? (num - 0).toFixed(2) : num + '';
                    // num = !flag ? (Math.round((num)*100)/100).toFixed(2) : num + '';
                    return num.replace(/(\d)(?=(\d{3})+\.)/g, function ($0, $1) {
                        return $1 + ',';
                    }).replace(/\.$/, '');
                },
                percentage: function (val) {
                    return (parseFloat(val || 0) * 100).toFixed(2) + '%';
                },
                initNumber: function (val) {
                    return val.replace(/\,/g, '');
                },
            }
        });

        function type(o) {
            var s = Object.prototype.toString.call(o);
            return s.slice(s.indexOf(" ") + 1, s.length - 1).toLowerCase();
        };
        //获取连接参数
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        };
        // 深copy obj
        function deepCopyObj(obj) {
            obj = obj || {};
            return JSON.parse(JSON.stringify(obj).concat());
        };
        //获取时间
        function getDate(date) {
            return +new Date(date).getTime()
        };
        //转换成天数
        function transformDays(millisecond) {
            return Math.ceil(millisecond / (24 * 60 * 60 * 1000))
        };
        function unique(arr){
            for(var i=0; i<arr.length; i++){
                for(var j=i+1; j<arr.length; j++){
                    if(arr[i] ==arr[j] ){         //第一个等同于第二个，splice方法删除第二个
                        arr.splice(j,1);
                        j--;
                    }
                }
            }
            return arr;
        }
    </script>

</body>

</html>