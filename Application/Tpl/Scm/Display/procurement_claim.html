<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/utils/css/public.style.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet"
        href="./Application/Tpl/Home/Public/icon/css/font-awesome.min.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Oms/Public/css/list_common.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Oms/Order/orderList.css?v=<{$Think.config.VER_NUM}>">
    <title>采购认领</title>
</head>
<style>
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none !important;
        margin: 0;
    }

    input::-ms-outer-spin-button,
    input::-ms-inner-spin-button {
        -ms-appearance: none !important;
        margin: 0;
    }

    input::-o-outer-spin-button,
    input::-o-inner-spin-button {
        -o-appearance: none !important;
        margin: 0;
    }

    input::-moz-outer-spin-button,
    input::-moz-inner-spin-button {
        -moz-appearance: none !important;
        margin: 0;
    }

    input[type="number"] {
        -moz-appearance: textfield !important;
    }

    .market-steps {
        margin-top: 20px;
        min-height: 56px;
    }

    .tran-table,
    .forecast-table {
        width: 100%;
        font-size: 13px;
        color: #546E7A;
        font-family: MicrosoftYaHei;
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
        background: #F7F9FB;
        margin: 20px 0;
    }

    .tran-table th {
        padding: 8px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #e4e9ed;
        text-align: center;
        white-space: nowrap;
    }

    .tran-table td,
    .forecast-table td {
        padding: 8px 10px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #F7F9FB;
        text-align: center;
    }

    .tran-table td:nth-child(odd) {
        text-align: center;
        font-weight: 600;
    }

    .tran-table td:nth-child(odd) {
        width: 12%;
        padding: 18px 10px;
        background: #f5fafe;
    }

    .tran-table td:nth-child(even) {
        width: 35%;
    }

    .tab {
        color: #c8d2d7;
        font-size: 16px;
    }

    .tab span {
        cursor: pointer;
    }

    .tab span:hover {
        color: #48576a;
    }

    .active {
        color: #263238;
    }

    .tran-table caption,
    header {
        height: 40px;
        background: #546E7A;
        font-family: MicrosoftYaHei;
        font-size: 16px;
        color: #FFFFFF;
        letter-spacing: 0;
        padding: 0px 10px;
        line-height: 40px;
        text-align: left;
    }

    .required {
        color: red;
    }

    .order-list-table.table-common tr th {
        color: #546E7A;
        background: #e4e9ed;
    }

    .el-select {
        padding: 0;
    }

    .width-100 {
        width: 100% !important;
    }

    .width-50 {
        width: 49.5% !important;
    }

    .width-33 {
        width: 33% !important;
    }

    .width-20 {
        width: 19.5% !important;
    }

    .nowrap {
        white-space: nowrap;
    }

    .el-dialog__header {
        display: block;
    }

    .dialog_title,
    .dialog_button {
        text-align: center;
    }

    .forecast-table {
        margin: 0;
    }

    .forecast-table tr td:nth-child(odd) {
        width: 200px;
        font-weight: 600;
    }

    .calculate-table {
        width: 100%;
        font-size: 13px;
        color: #546E7A;
        font-family: MicrosoftYaHei;
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
        background: #F7F9FB;
        margin: 20px 0;
    }

    .calculate-table td {
        padding: 8px 10px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #F7F9FB;
        text-align: center;
    }

    .ceTitle {
        font-weight: 600;
    }

    .required {
        color: red;
    }

    .required::after {
        content: '*';
        color: #ff4949;
        margin-left: 5px;
        vertical-align: middle;
    }

    .imgStyle {
        width: 80px !important;
        height: 80px !important;
        cursor: pointer;
    }

    .table-common {
        overflow: visible !important;
    }

    .table-common .el-table__body-wrapper {
        overflow-x: visible !important;
        overflow-y: visible !important;
    }

    .selectBg .el-input-group__prepend {
        background-color: #fff !important;
    }

    .advance-payment .el-select {
        width: 110px;
    }

    .advance-payment .el-button+.el-button {
        margin-left: 0;
    }

    .advance-payment .el-input-group__append,
    .el-input-group__prepend {
        padding: 0;
    }

    .final-payment .el-input-group__append,
    .el-input-group__prepend {
        padding: 0;
    }

    .advance-payment .el-date-editor.el-input,
    .el-date-editor.el-input__inner {
        width: 135px;
    }

    .advance-payment .el-form-item {
        margin-bottom: 0;
    }
    .outer-po .el-input-group__prepend {
        width: auto;
    }
    .good-info .el-input-group__prepend .el-select {
        margin: -10px -10px;
    }
    .detail_table{
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
    }
    .detail_table td{
        width: 100px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        text-align: center;
    }
    .good_column li{
        height: 50px;
        line-height: 50px;
        border-bottom: 1px solid #EBEEF5;
    }
    .good_column li:last-child{
        border-bottom: none;
    }
    .good_column li i{
        cursor: pointer;
    }
</style>

<body class="orderList">
    <div id="demand" class="list-common" v-cloak style="margin-bottom:220px">
        <div class="use-title tab">
            <span style="margin-right: 35px;" class="active">
                {{$lang('采购详情')}}
            </span>
        </div>
        <div class="baseline"></div>
        <!-- 销售信息模块 -->
        <header>
            <el-row>
                <el-col>
                    {{$lang('总进度')}}
                </el-col>
            </el-row>
        </header>
        <!--总进度end-->
        <!--进度条satrt-->
        <div class="market-steps">
            <el-steps :active="currentStep" align-center finish-status="success" :process-status="currentState">
                <el-step v-for="(item, index) in getCd" :key="index" :title="$lang(stepValue(item.CD_VAL, index))"
                    :value="item.CD"></el-step>
            </el-steps>
        </div>

        <div>
            <div>
                <table class="tran-table" cellpadding="0" cellspacing="0">
                    <caption>
                        {{$lang('销售信息')}}
                    </caption>
                    <tbody>
                        <tr>
                            <td>
                                {{$lang('需求编号')}}
                            </td>
                            <td>
                                {{baseDatas.demand_code}}
                            </td>
                            <td>
                                {{$lang('销售进度')}}
                            </td>
                            <td>
                                {{$lang(baseDatas.status_val)}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('需求类型')}}
                            </td>
                            <td>
                                {{$lang(baseDatas.demand_type_val)}}
                            </td>
                            <td>
                                {{$lang('客户名称')}}
                            </td>
                            <td style="color: #409EFF">
                                    <el-popover
                                        placement="bottom"
                                        title=""
                                        trigger="hover">
                                        <table class="detail_table" cellpadding="0" cellspacing="0" v-if="audit_info">
                                            <tr>
                                                <td>{{$lang('成立时间')}}</td>
                                                <td>
                                                    {{audit_info.EST_TIME}}
                                                </td>
                                                <td>{{$lang('认缴资本')}}</td>
                                                <td>
                                                    {{audit_info.CURRENCY}}{{audit_info.SUB_CAPITAL}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>{{$lang('法人代表')}}</td>
                                                <td>
                                                    {{audit_info.LG_REP}}
                                                </td>
                                                <td>{{$lang('股东名称')}}</td>
                                                <td>
                                                    {{audit_info.SHARE_NAME}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>{{$lang('信用评分(境外公司必填)')}}</td>
                                                <td>
                                                    {{audit_info.CREDIT_SCORE}}
                                                </td>
                                                <td>{{$lang('信用评级(境外公司必填)')}}</td>
                                                <td>
                                                    {{audit_info.CREDIT_LEVEL}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>{{$lang('是否有负面信息')}}</td>
                                                <td>
                                                    {{audit_info.IS_HAVE_NAGETIVE_INFO}}
                                                </td>
                                                <td>{{$lang('负面信息项')}}</td>
                                                <td>
                                                    <span v-if="audit_info.negative">{{audit_info.negative[0]}}</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>{{$lang('风险评级')}}</td>
                                                <td>
                                                    {{audit_info.RISK_RATING}}
                                                </td>
                                                <td>{{$lang('审核人')}}</td>
                                                <td>
                                                    {{audit_info.REVIEWER}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>{{$lang('审核时间')}}</td>
                                                <td>
                                                    {{audit_info.REV_TIME}}
                                                </td>
                                                <td></td>
                                                <td>
                                                    
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>{{$lang('法务备注')}}</td>
                                                <td colspan="3">
                                                    {{audit_info.LEGAL_REMARK}}
                                                </td>
                                            </tr>
                                        </table>
                                        <span slot="reference" style="color:#409EFF;cursor: pointer;">{{$lang(baseDatas.customer)}}</span>
                                    </el-popover>
                                </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('预计销售国家')}}
                            </td>
                            <td>
                                {{baseDatas.expected_sales_country_val}}
                            </td>
                            <td>
                                {{$lang('预计销售平台')}}
                            </td>
                            <td>
                                {{$lang(baseDatas.expected_sales_platform_cd_val ? baseDatas.expected_sales_platform_cd_val : '非平台销售')}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('框架合同')}}
                            </td>
                            <td>
                                {{baseDatas.contract}}
                            </td>
                            <td>
                                {{$lang('我方公司')}}
                            </td>
                            <td>
                                {{baseDatas.our_company_val}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('业务类型')}}
                            </td>
                            <td>
                                {{baseDatas.business_mode_val}}
                            </td>
                            <td>
                                {{$lang('客户收货方式')}}
                            </td>
                            <td>
                                {{baseDatas.receive_mode_val}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('发货操作')}}
                            </td>
                            <td class="nowrap">
                                {{$lang(baseDatas.need_warehouse_val)}}
                            </td>
                            <td>
                                {{$lang('客户收货地址')}}
                            </td>
                            <td>
                                {{baseDatas.receive_country_val}}-{{baseDatas.receive_province_val}}-{{baseDatas.receive_city_val}}{{baseDatas.receive_address}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('预计销售金额（含税）')}}
                            </td>
                            <td>
                                {{$lang(baseDatas.sell_currency_val)}} {{separatNum(baseDatas.sell_amount)}}
                            </td>
                            <td>
                                {{$lang('预计销售时间')}}
                            </td>
                            <td>
                                {{baseDatas.ship_date}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('收款周期')}}
                            </td>
                            <td>
                                {{$lang(baseDatas.collection_cycle_val)}}
                            </td>
                            <td>
                                {{$lang('收款时间')}}
                            </td>
                            <td>
                                <p v-for="(item, index) in baseDatas.collection_time_val" :key="index">{{item}}</p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('【采购部分】销售物流及服务费用（预估）')}}
                            </td>
                            <td class="nowrap">
                                {{baseDatas.expense_currency_val}} {{baseDatas.expense | numberFormat}}
                            </td>
                            <td>{{$lang('【现货部分】销售物流及服务费用（预估）')}}</td>
                            <td>
                                {{baseDatas.expense_currency_spot_val}} {{baseDatas.expense_spot | numberFormat}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('【采购部分】销售应缴税')}}
                            </td>
                            <td class="nowrap">
                                {{baseDatas.tax_currency_val}} {{baseDatas.tax | numberFormat}}
                            </td>
                            <td>{{$lang('【现货部分】销售应缴税')}}</td>
                            <td>
                                {{baseDatas.tax_currency_spot_val}} {{baseDatas.tax_spot | numberFormat}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('销售发票')}}
                            </td>
                            <td class="nowrap">
                                {{$lang(baseDatas.invoice_type_val)}}-{{baseDatas.tax_rate_val}}
                            </td>
                            <td>
                                {{$lang('需求截止时间')}}
                            </td>
                            <td>
                                {{baseDatas.deadline}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('销售同事')}}
                            </td>
                            <td>
                                {{baseDatas.seller}}
                            </td>
                            <td>
                                {{$lang('销售团队')}}
                            </td>
                            <td>
                                {{baseDatas.sell_team_val}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('返利比例(预估)')}}</td>
                            <td>
                                {{baseDatas.rebate_rate}} %
                            </td>
                            <td>{{$lang('返利金额(预估)')}}</td>
                            <td>
                            {{baseDatas.sell_currency_val}} {{baseDatas.rebate_amount}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('订单备注')}}
                            </td>
                            <td colspan="3" style="text-align: left;">
                                {{baseDatas.remark}}
                            </td>
                        </tr>
                         <tr>
                            <td>
                                {{$lang('订单附件')}}
                            </td>
                            <td colspan="3" style="text-align: left;">
                                <span v-for="(item, index) in baseDatas.attachment" :key="index">
                                    <a style="color: #546E7A;" :href="'/index.php?m=order_detail&a=download&file='+item.save_name">{{item.original_name}}</a>,&nbsp;</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 商品信息 -->
            <div>
                <header>
                    <el-row>
                        <el-col :span="16">
                            {{$lang('商品信息')}}
                        </el-col>
                        <el-col :span="8" class="text-right">
                            <el-upload style="display: inline;" :on-error="handleError" :on-success="handleSuccess"
                                :show-file-list="false" :data="{demand_id: baseDatas.id}"
                                action="/index.php?g=scm&m=quotation&a=quotation_import_goods" :auto-upload="true"
                                accept="application">
                                <el-button size="small" type="primary">
                                    {{$lang('批量导入')}}
                                </el-button>
                            </el-upload>
                            <el-button size="small" type="info" plain @click="downTemplate">
                                {{$lang('下载模板')}}
                            </el-button>
                        </el-col>
                    </el-row>
                </header>
                <el-table border ref="multipleTable" show-header show-summary :summary-method="getSummaries"
                    @selection-change="handleSelectionChange" :data="goodsDatas" tooltip-effect="dark"
                    style="width: 100%" class="order-list-table table-common good-info table_good" v-loading="tableLoading">
                    <el-table-column type="selection" width="55"></el-table-column>
                    <el-table-column prop="sku_id" :label="$lang('SKU编码')" width="100"></el-table-column>
                    <el-table-column prop="bar_code" :label="$lang('条形码')" width="100"> </el-table-column>
                    <el-table-column :label="$lang('图片信息')" width="140">
                        <template scope="scope">
                            <img :class="{imgStyle: scope.row.guds_img_cdn_addr}" :src="scope.row.guds_img_cdn_addr"
                                @mouseenter="showImg(scope.$index)" @mouseleave="hiddenImg">
                            <div style="position: absolute; top: -10px; left: 120px; box-shadow: 0 0 5px #536d7a;z-index:99999"
                                v-show="imgShowIndex === scope.$index">
                                <img :src="scope.row.guds_img_cdn_addr" width="300" height="300">
                            </div>
                        </template>
                    </el-table-column>

                    <el-table-column :label="$lang('商品名称')">
                        <template scope="scope">
                            {{scope.row.goods_name}}
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('SKU信息')" width="100">
                        <template scope="scope">
                            {{scope.row.sku_attribute}}
                        </template>
                    </el-table-column>
                    <el-table-column prop="sell_price" :label="$lang('销售单价（含增值税）')" width="100"> </el-table-column>
                    <el-table-column prop="sell_price_not_contain_tax" :label="$lang('销售单价（不含增值税）')" width="110">
                    </el-table-column>
                    <el-table-column prop="purchase_number" :label="$lang('需采购数量')" width="100"> </el-table-column>
                    <el-table-column :label="$lang('授权&链路要求')">
                        <template scope="scope">
                            {{$lang(scope.row.auth_and_link_val)}}
                        </template>
                    </el-table-column>
                    <el-table-column v-if="!isSell_small_team" :label="$lang('可供数量')" width="120">
                        <template scope="scope">
                            <el-input v-model="scope.row.supply_number"
                                @input="fillRequire(scope.row, 'supply_number')"></el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('采购单价（含增值税）')" width="180">
                        <template scope="scope">
                            <el-input class="selectBg" class="currency-width"
                                @input="fillRequire(scope.row, 'purchase_price')" v-model="scope.row.purchase_price"
                                @blur="calcPrice(scope.row,'purchase_price')">
                                <el-select :popper-append-to-body="false" style="width: 80px;padding: 0px;"
                                    v-model="form.currency" slot="prepend" :placeholder="$lang('币种')">
                                    <el-option v-for="(item, index) in cds.currency" :key="index" :label="item.CD_VAL"
                                        :value="item.CD"></el-option>
                                </el-select>
                            </el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('采购单价（不含增值税）')" width="180">
                        <template scope="scope">
                            <el-input class="selectBg" @input="fillRequire(scope.row, 'purchase_price_not_contain_tax')"
                                v-model="scope.row.purchase_price_not_contain_tax"
                                @blur="calcPrice(scope.row,'purchase_price_not_contain_tax')">
                                <el-select :popper-append-to-body="false" style="width: 80px;" v-model="form.currency"
                                    slot="prepend" :placeholder="$lang('币种')">
                                    <el-option v-for="(item, index) in cds.currency" :key="index" :label="item.CD_VAL"
                                        :value="item.CD"></el-option>
                                </el-select>
                            </el-input>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('退税比例')">
                        <template scope="scope">
                            <el-select v-model="scope.row.drawback_percent" @input="selChange(scope.row)"
                                :placeholder="$lang('选择退税比例')" class="width-100">
                                <el-option v-for="(item, index) in cds.tax_rate" :key="index" :label="item.CD_VAL"
                                    :value="item.CD" style="text-align: left;">
                                </el-option>
                            </el-select>
                        </template>
                    </el-table-column>
                    <el-table-column v-if="isSell_small_team" :label="$lang('小团队')" width="120">
                        <template scope="scope">
                            <ul class="good_column" style="padding: 0;">
                                <li v-for="(item, index) in scope.row.sell_small_team_json">
                                    <el-select v-model="item.small_team_code"  @change="smallTeamSelect(item,index,scope.$index)"
                                        :placeholder="$lang('选择小团队')" clearable class="width-100">
                                        <el-option v-for="(item, index) in sell_small_team" :key="index" :label="item.CD_VAL"
                                            :value="item.CD" :disabled="item.disabled" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                </li>
                            </ul>
                        </template>
                    </el-table-column>
                    <el-table-column v-if="isSell_small_team" :label="$lang('供货数量')">
                        <template scope="scope">
                            <ul class="good_column" style="padding: 0;">
                                <li v-for="(item, index) in scope.row.sell_small_team_json">
                                    <el-input type= "number" @keyup.native="watchNum" v-model.number="item.number">    
                                </li>
                            </ul>
                        </template>
                    </el-table-column>
                    <el-table-column v-if="isSell_small_team" :label="$lang('操作')">
                        <template scope="scope">
                            <ul class="good_column" style="padding: 0;">
                                <li v-for="(item, index) in scope.row.sell_small_team_json">
                                    <i @click="editGood(scope.$index,index,'add')" class="el-icon-plus"></i>
                                    <i v-if="index != 0" @click="editGood(scope.$index,index,'delete')" class="el-icon-minus"></i>
                                </li>
                            </ul>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <!-- 采购信息 -->
            <div>
                <table class="tran-table" cellpadding="0" cellspacing="0">
                    <caption>
                        {{$lang('采购信息')}}
                    </caption>
                    <tbody>
                        <tr>
                            <td>{{$lang('采购类型')}}<label class="required"></label></td>
                            <td>
                                <!-- 销售订单时禁止选择线上采购 -->
                                <el-select :popper-append-to-body="false" :loading="contractLoading"
                                    v-model="form.purchase_type" :placeholder="$lang('请选择采购类型')" clearable
                                    style="width:100%;">
                                    <el-option
                                        :disabled="item.CD == 'N001890200' && baseDatas.demand_type == 'N002100200' "
                                        v-for="(item, index) in cds.purchase_type" :key="index"
                                        :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('供应商')}}<label class="required"></label>
                            </td>
                            <td>
                                <div v-show="form.purchase_type == 'N001890100'">
                                    <el-select class="width-100" remote filterable v-model="form.supplier_no"
                                        @change="handleSelect" :loading="supplyLoading" :placeholder="$lang('请输入供应商名称')"
                                        value-key="SP_NAME" :remote-method="querySearchAsync">
                                        <el-option v-for="(item, index) in supplyOptions" :key="index"
                                            :label="item.SP_NAME" :value="item.SP_CHARTER_NO"></el-option>
                                    </el-select>
                                </div>
                                <div v-show="form.purchase_type == 'N001890200'">
                                    <el-autocomplete class="width-100" v-model="form.supplier"
                                        :fetch-suggestions="queryAutoSearchAsync" value-key="SP_NAME"
                                        :placeholder="$lang('请输入供应商名称')" @select="handleAutoSelect"></el-autocomplete>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('框架合同')}} <label v-if="form.purchase_type != 'N001890200'"
                                    class="required"></label>
                            </td>
                            <td style="text-align: left;">
                                <el-select :popper-append-to-body="false" :loading="contractLoading"
                                    v-model="form.contract" :disabled="!form.supplier_no || form.has_contract === '0'"
                                    :placeholder="$lang('请选择适用合同')" style="width:60%;" clearable>
                                    <el-option v-for="(item, index) in contract" :key="index" :label="item.CON_NO"
                                        :value="item.CON_NO" style="text-align: left;">
                                    </el-option>
                                </el-select>
                                <el-checkbox v-model="form.has_contract"
                                    :disabled="!form.supplier_no || !!form.contract" false-label="1" true-label="0">
                                    {{$lang('无框架合同')}}
                                </el-checkbox>
                            </td>
                            <td>
                                {{$lang('我方公司')}} <label class="required"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.our_company" clearable
                                    filterable :placeholder="$lang('请选择我方公司')" class="width-100">
                                    <el-option v-for="(item, index) in cds.our_company" :key="index"
                                        :label="item.CD_VAL" :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('采购网站')}}<label v-if="form.purchase_type == 'N001890200'"
                                    class="required"></label></td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.pur_website"
                                    :placeholder="$lang('请选择采购网站')" class="width-100"
                                    :disabled="form.purchase_type != 'N001890200'">
                                    <el-option v-for="(item, index) in cds.pur_website" :key="index"
                                        :label="item.CD_VAL" :value="item.CD" style="text-align: left;"> </el-option>
                                </el-select>
                            </td>
                            <td>{{$lang('下单帐号')}}</td>
                            <td>
                                <el-input style="width: 100%;" v-model="form.pur_account"
                                    :disabled="form.purchase_type == 'N001890100' || currentStep != '7'"
                                    :placeholder="$lang('请输入线上采购下单帐号')"></el-input>
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('网站订单号')}}</td>
                            <td>
                                <el-input style="width: 100%;" v-model="form.pur_order_no"
                                    :disabled="form.purchase_type == 'N001890100' || currentStep != '7'"
                                    :placeholder="$lang('请输入线上采购订单号')"></el-input>
                            </td>
                            <td>
                                {{$lang('交货方式')}}<label v-if="form.purchase_type != 'N001890200'"
                                    class="required"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.delivery_type"
                                    :disabled="form.purchase_type == 'N001890200'" :placeholder="$lang('请选择交货方式')"
                                    style="width:100%;">
                                    <el-option v-for="(item, index) in cds.delivery_type" :key="index"
                                        :label="item.CD_VAL" :value="item.CD" style="text-align: left;"></el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('采购团队')}} <label class="required"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.purchase_team" clearable
                                    filterable :placeholder="$lang('采购团队')" style="width: 100%;">
                                    <el-option v-for="(item, index) in cds.purchase_team" :key="index"
                                        :label="item.CD_VAL" :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                            <td>
                                {{$lang('采购人员')}} <label class="required"></label>
                            </td>
                            <td>
                                <el-autocomplete style="width: 100%;" @focus="focusPurchaser"
                                    :disabled="!form.purchase_team" v-model="form.purchaser" @blur="blurPurchaser"
                                    @select="handleSelectPurchaser" value-key="name"
                                    :fetch-suggestions="querySearchPurchaser" :placeholder="$lang('采购人员')">
                                </el-autocomplete>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('供应商发货时间')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-date-picker v-model="form.ship_time" :picker-options="picksShipBefore"
                                    value-format="yyyy-MM-dd" type="date" :placeholder="$lang('请填写预计发货时间')"
                                    class="width-100"> </el-date-picker>
                            </td>
                            <td>
                                {{$lang('预计到货日期')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-date-picker v-model="form.arrive_time" :picker-options="picksArrBefore"
                                    value-format="yyyy-MM-dd" type="date" :placeholder="$lang('请填写预计到货时间')"
                                    class="width-100"> </el-date-picker>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('PO金额')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                {{this.curreneyobj[this.form.currency]}} {{poMoney}}
                            </td>
                            <td>
                                {{$lang('PO内其他费用')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                {{this.curreneyobj[this.form.currency]}}
                                <el-input style="width: 85%;" v-model="form.service_expense"
                                    @input="fillRequire(form, 'service_expense')" :placeholder="$lang('请输入金额')">
                                </el-input>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('预付款')}}
                                <label class="required"></label>
                            </td>
                            <td class="nowrap advance-payment">
                                <!-- <el-radio v-model="form.payment_cycle_type" v-for="(item, index) in cds.payment_cycle_type" :key="index" :label="item.CD">{{$lang(item.CD_VAL)}}</el-radio>
                                <br>
                                <br>
                                <el-select :popper-append-to-body="false" v-model="form.payment_cycle" :placeholder="$lang('请选择付款期数')" style="width: 100%;">
                                    <el-option v-for="(item, index) in cds.payment_cycle" :key="index" :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select> -->
                                <el-row type="flex">
                                    <el-col :span="5">
                                        <el-select v-model="hasAdvancePayment" size="mini">
                                            <el-option :label="$lang('有')" value="1"></el-option>
                                            <el-option :label="$lang('无')" value="0"></el-option>
                                        </el-select>
                                    </el-col>
                                </el-row>
                                <el-form v-if="hasAdvancePayment === '1'">
                                    <el-form-item v-for="(item, index) in form.pre_pay" :key="index">
                                        <el-row>
                                            <el-col :span="5">
                                                <el-select v-model="item.action_type_cd" size="mini"
                                                    @change="actionTypeChange(item.action_type_cd, index)">
                                                    <el-option :label="$lang('指定日期')" value="N002860002"></el-option>
                                                    <el-option :label="$lang('订单创建后')" value="N002860001" :disabled="index !== 0"></el-option>
                                                </el-select>
                                            </el-col>
                                            <el-col :span="4" v-if="item.action_type_cd === 'N002860001'">
                                                <el-input v-model="item.days" placeholder="" size="mini" type="number"
                                                    @blur="verifyDays(1, index)">
                                                    <template slot="append">{{$lang('天')}}</template>
                                                </el-input>
                                            </el-col>
                                            <el-col :span="5">
                                                <el-input v-model="item.percent" :placeholder="$lang('PO金额占比')"
                                                    @blur="verifyPoMoney(index)" size="mini">
                                                    <template slot="prepend">{{$lang('付')}}</template>
                                                    <template slot="append">%</template>
                                                </el-input>
                                            </el-col>
                                            <el-col :span="6">
                                                <el-date-picker v-model="item.pre_paid_date" type="date"
                                                    value-format="yyyy-MM-dd"
                                                    :placeholder="item.action_type_cd === 'N002860001' ? $lang('预计日期') :
                                                    $lang('填写日期')"
                                                    size="mini">
                                                </el-date-picker>
                                            </el-col>
                                            <el-col :span="4">
                                                <el-button type="primary" icon="el-icon-plus" size="mini"
                                                    @click="addAdvancePaymentItem"></el-button>
                                                <el-button type="primary" icon="el-icon-minus" size="mini"
                                                    @click="delAdvancePaymentItem(index)" v-if="index > 0"></el-button>
                                            </el-col>
                                        </el-row>
                                    </el-form-item>
                                </el-form>
                            </td>
                            <td>
                                {{$lang('尾款')}}
                                <label class="required"></label>
                            </td>
                            <td class="final-payment">
                                <!-- <div style="text-align: left;margin: 5px 0;" class="nowrap" v-for="(child, index) in form.payment_time" :key="index">
                                    <el-select v-show="form.payment_cycle_type === 'N002210100'" :popper-append-to-body="false" v-model="child.node"
                                        :placeholder="$lang('节点')" style="width:16%;">
                                        <el-option v-for="(item, index) in cds.payment_node" :key="index" :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                    <el-select v-show="form.payment_cycle_type === 'N002210100'" :popper-append-to-body="false" v-model="child.days"
                                        :placeholder="$lang('天数')" style="width:16%;">
                                        <el-option v-for="(item, index) in cds.payment_days" :key="index" :label="item.CD_VAL" :value="item.CD" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                    <el-select v-show="form.payment_cycle_type === 'N002210100'" :popper-append-to-body="false" v-model="child.day_type"
                                        :placeholder="$lang('天数类型')" style="width:20%;">
                                        <el-option v-for="(item, index) in cds.payment_days_type" :key="index" :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                        </el-option>
                                    </el-select>
                                    <el-input v-model="child.percent" :placeholder="$lang('比例')" style="width:12%;"></el-input>%
                                    <el-date-picker :picker-options="child.picksBeforeTime" @change="test(index)" v-model="child.date" value-format="yyyy-MM-dd"
                                        type="date" :placeholder="$lang('付款时间')" style="width:24%;"> </el-date-picker>
                                </div> -->
                                <el-row>
                                    <el-col :span="5">
                                        <el-select v-model="hasEndPayment" :disabled="endPaymentDisabled">
                                            <el-option :label="$lang('每次发货后')" value="N001390200"></el-option>
                                            <el-option :label="$lang('每次入库后')" value="N001390400"></el-option>
                                            <el-option :label="$lang('无')" value="N001390502"></el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="9" v-if="hasEndPayment !== 'N001390502'">
                                        <el-input v-model="form.end_pay.days" placeholder="" type="number"
                                            @blur="verifyDays(2)">
                                            <template slot="append">{{$lang('天付货值部分金额')}}</template>
                                        </el-input>
                                    </el-col>
                                    <el-col :span="10" v-if="hasEndPayment !== 'N001390502'">
                                        <el-date-picker v-model="form.end_pay.pre_paid_date" type="date"
                                            value-format="yyyy-MM-dd"
                                            :placeholder="$lang('平均预计日期')">
                                        </el-date-picker>
                                    </el-col>
                                </el-row>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('PO外我方支付的采购物流及服务费用（预估）')}}
                                <label class="required"></label>
                            </td>
                            <td class="outer-po">
                                <el-input :placeholder="$lang('请输入金额')" @input="fillRequire(form, 'expense')"
                                    v-model="form.expense" class="input-with-select selectBg">
                                    <el-select :popper-append-to-body="false" v-model="form.expense_currency"
                                        slot="prepend" :placeholder="$lang('请选择币种')">
                                        <el-option v-for="(item, index) in cds.currency" :key="index"
                                            :label="item.CD_VAL" :value="item.CD" style="text-align: left;"></el-option>
                                    </el-select>
                                </el-input>
                            </td>
                            <td>
                                {{$lang('采购发票')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-select :popper-append-to-body="false" v-model="form.invoice_type"
                                    :placeholder="$lang('请选择发票类型')" style="width: 46%;">
                                    <el-option v-for="(item, index) in cds.invoice_type" :key="index"
                                        :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                                <el-select :disabled="form.invoice_type === 'N001350200'" :popper-append-to-body="false" v-model="form.tax_rate"
                                    :placeholder="$lang('请选择税点')" style="width: 46%;" @change="changeRate">
                                    <el-option v-for="(item, index) in cds.tax_rate" :key="index" :label="item.CD_VAL"
                                        :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('退税时间')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-checkbox v-model="form.has_drawback" false-label="1" true-label="0"
                                    :disabled="!!form.drawback_time || isHasDrawback">
                                    {{$lang('无退税')}}
                                </el-checkbox>
                                <el-date-picker v-model="form.drawback_time" :disabled="form.has_drawback === '0'"
                                    value-format="yyyy-MM-dd" type="date" :placeholder="$lang('请填写预计退税时间')"
                                    style="width:60%;margin-left: 15px;"> </el-date-picker>
                            </td>
                            <td>
                                {{$lang('货源国家')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-select clearable filterable :popper-append-to-body="false"
                                    v-model="form.source_country" :placeholder="$lang('国家')" style="width:100%;">
                                    <el-option v-for="(item, index) in countries" :key="index" :label="item.NAME"
                                        :value="item.ID" style="text-align: left;"></el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('发货操作')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-radio-group v-model="form.ship_type" @change="changeDeliveryState">
                                    <el-radio v-show="baseDatas.demand_type == 'N002100100'" label="N002450400">
                                        {{$lang('入我方仓库')}}</el-radio>
                                    <el-radio v-show="baseDatas.demand_type == 'N002100200'" label="N002450100">
                                        {{$lang('先入我方仓库，再发给客户')}}</el-radio>
                                    <el-radio v-show="baseDatas.demand_type == 'N002100100'" label="N002450300">
                                        {{$lang('入虚拟仓')}}</el-radio>
                                    <el-radio v-show="baseDatas.demand_type == 'N002100200'" label="N002450300">
                                        {{$lang('直接发给客户')}}</el-radio>

                                </el-radio-group>
                            </td>
                            <td>
                                {{$lang('入库仓库')}}
                                <label class="required"></label>
                            </td>
                            <td>
                                <el-select clearable filterable :disabled="warehouseDisabled"
                                    :popper-append-to-body="false" v-model="form.warehouse"
                                    :placeholder="$lang('请选择仓库')" style="width:100%;">
                                    <el-option v-for="(item, index) in cds.warehouse" :key="index"
                                        :label="$lang(item.CD_VAL)" :value="item.CD" style="text-align: left;">
                                    </el-option>
                                </el-select>
                            </td>
                        </tr>
                        <tr>
                            <!-- <td>采购账期</td>
                            <td class="nowrap">
                                退税前({{form.purchase_days}}天)
                            </td> -->
                            <td>
                                {{$lang('订单备注')}}
                            </td>
                            <td colspan="3" style="text-align: left;">
                                <el-input style="width: 50%;" v-model="form.remark" :placeholder="$lang('请输入备注')">
                                </el-input>
                            </td>
                        </tr>
                        <!-- <tr>
                            <td>
                                {{$lang('订单附件')}}
                            </td>
                            <td colspan="3" style="text-align: left;">
                                <el-upload multiple action="/index.php?m=order_detail&a=file_upload" :before-upload="beforeUpload" :file-list="upFileList"
                                    :on-change="upProgress" accept="application">
                                    <el-button size="small" type="primary">
                                        {{$lang('选择文件')}}
                                    </el-button>
                                    <span style="margin-left: 20px;" slot="tip" class="el-upload__tip">
                                        {{$lang('只能上传 Excel、Word、PPT、PDF、Picture文件，≤50M')}}</span>
                                </el-upload>
                            </td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
            <!-- 预估利润表格 -->
            <div>
                <header>
                    <el-row>
                        <el-col :span="24">
                            {{$lang('预估利润(货币单位：USD，账期单位：天)')}}
                        </el-col>
                    </el-row>
                </header>
                <table class="forecast-table" cellpadding="0" cellspacing="0">
                    <tr>
                        <td>
                            {{$lang('采购金额（退税前）')}}
                        </td>
                        <td width="18%">{{separatNum(purchaseAmount)}}</td>
                        <td>
                            {{$lang('退税金额')}}
                        </td>
                        <td width="18%">{{separatNum(refundAmount)}}</td>
                        <td>
                            {{$lang('对应销售金额（缴税后）')}}
                        </td>
                        <td>{{separatNum(salesAmount)}}</td>
                    </tr>
                    <tr>
                        <td>
                            {{$lang('毛利（退税前）')}}
                        </td>
                        <td>{{separatNum(preGroProfit)}}</td>
                        <td>
                            {{$lang('净利润（预估）')}}
                        </td>
                        <td>{{separatNum(netProfit)}}</td>
                        <td>
                            {{$lang('物流费用（采购）')}}
                        </td>
                        <td>{{separatNum(proLogisticsCost)}}</td>
                    </tr>
                    <tr>
                        <td>
                            {{$lang('毛利（退税后）')}}
                        </td>
                        <td>{{separatNum(afterGroProfit)}}</td>
                        <td>
                            {{$lang('净利润率（预估）')}}
                        </td>
                        <td>{{netProfitRate}}</td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
            </div>

            <div>
                <footer>
                    <el-row>
                        <el-col :span="24" style="text-align: center;margin-top: 20px;">
                            <el-button type="primary" style="margin-right: 20px;" @click="saveDraft">
                                {{$lang('存草稿')}}
                            </el-button>
                            <el-button type="primary" style="margin-left: 20px;" @click="submit">
                                {{$lang('提交报价')}}
                            </el-button>
                        </el-col>
                    </el-row>
                </footer>
            </div>

            <!-- 计算方法 -->
            <el-dialog title="CE评级 & CE值计算方法与规则" :visible.sync="dialogCalculate">
                <table class="calculate-table" cellpadding="0" cellspacing="0">
                    <tr>
                        <td colspan="3">CE公式 = Net Margin %/(Purchase Amount(CNY)/200,000+Payment Days)*1000,000</td>
                    </tr>
                    <tr>
                        <td rowspan="3">Purchase Amount (CNY)</td>
                        <td>≤100,000</td>
                        <td>100,000</td>
                    </tr>
                    <tr>
                        <td>>100,000 and
                            <1,000,000</td> <td>Purchase Amount (CNY)</td>
                    </tr>
                    <tr>
                        <td>≥1,000,000</td>
                        <td>1,000,000</td>
                    </tr>
                </table>
                <div>
                    <p class="ceTitle">CE评级 & CE值规则：</p>
                </div>
            </el-dialog>
        </div>
        <div>

        </div>
    </div>
    <script type="text/javascript"
        src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/utils/utils.js?v=<{$Think.config.VER_NUM}>">
    </script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.admin.js?<{$Think.config.VER_NUM}>">
    </script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js?<{$Think.config.VER_NUM}>">
    </script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js">
    </script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.2.js">
    </script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>">
    </script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js">
    </script>
    <script>
        if (getCookie('think_language') !== "zh-cn") {
            ELEMENT.locale(ELEMENT.lang.en)
        }
        var procurementDatas = ["supplier", "our_company", "purchase_team", "purchase", "ship_time", "arrive_time",
                "service_expense", "expense_currency",
                "expense", "invoice_type", "tax_rate", "source_country", "purchase_type"
            ],
            procurementTexts = ["供应商", "我方公司", "采购团队", "采购人员", "供应商发货时间", "预计到货日期", "PO内其他费用", "物流费用币种", "物流费用",
                "发票类型", "税点", "货源国家", "采购类型"
            ],
            goodsParameter = [ "purchase_price", "drawback_percent", "auth_and_link"],
            goodsParameterText = [ "商品采购单价", "商品退税比例", "商品授权和链路"];

        var PAGE = getQueryString("page");

        var OPTION = {
            lock: true,
        };
        demand = new Vue({
            el: '#demand',
            data: {
                hasAdvancePayment: '1', // 是否有预付款，'0'无, '1'有
                hasEndPayment: 'N001390502', // 是否有尾款，每次发货后 'N001390200'、每次入库后 'N001390400'、无 'N001390502'
                endPaymentDisabled: false, // 控制【尾款】选择框禁用
                warehouseList: [],
                warehouseListTemp: [],
                warehouseDisabled: false,
                tableLoading: true,
                getCd: [],
                cds: {},
                currentStep: 0,
                draftFlag: false,
                spotFlag: false,
                baseDatas: {},
                audit_info: {}, // 客户审核详情
                dialogTableVisible: false,
                dialogCalculate: false,
                dialogBack: false,
                currentState: "process",
                failState: false,
                claimFlag: false,
                dialogGiveUp: false,
                reportPriceFlag: false,
                whyGiveUp: "",
                backInfo: '',
                goodsDatas: [],
                isSell_small_team:true,
                sell_small_team:[],
                skuid: '',
                barCode: '',
                demandFor: '',
                imgShowIndex: '',
                contractLoading: false,
                contract: [],
                countries: [],
                taxRates: [],
                upFileList: [],
                selectPurchaserFlag: false,
                paymentCycleFlag: true,
                paymentCycleTypeFlag: true,
                isHasDrawback: false,
                _id: undefined,
                picksShipBefore: {
                    disabledDate(item) {
                        return item.getTime() < (Date.now() - 24 * 60 * 60 * 1000);
                    }
                },
                picksArrBefore: {
                    disabledDate(item) {
                        return item.getTime() < (Date.now() - 24 * 60 * 60 * 1000);
                    }
                },
                picksBeforeTime: {},

                supplyLoading: false,
                supplyOptions: [],

                //pointNumber 笔采购发票的税点
                pointNumber: '',

                // ce计算依托
                exchangerate: '',
                curreneyobj: {
                    '': ""
                },

                form: {
                    goods: [{
                        id: '',
                        search_id: '',
                        sku_id: '',
                        sell_price: '',
                        purchase_number: '',
                        supply_number: '',
                        purchase_price: '',
                        purchase_price_not_contain_tax: '',
                        drawback_percent: '',
                        sell_small_team_json:[
                            {
                                small_team_code:'',
                                small_team_name:'',
                                number:0.00,
                            }
                        ],
                        guds_img_cdn_addr: '',
                        auth_and_link: '',
                        goods_name: '',
                        sku_attribute: '',
                    }],
                    ship_type: 'N002450100',
                    warehouse: '',
                    supplier: '',
                    supplier_no: '',
                    contract: '',
                    has_contract: '1',
                    has_drawback: '1',
                    our_company: '',
                    purchase_team: '',
                    purchaser: '',
                    ship_time: '',
                    delivery_type: '',
                    arrive_time: '',
                    payment_cycle_type: PAGE === "purchase" ? '' : 'N002210100',
                    payment_cycle: '',
                    payment_time: [{
                        node: '',
                        days: '',
                        day_type: '',
                        percent: '',
                        date: ''
                    }],
                    expense_currency: '',
                    expense: '',
                    invoice_type: '',
                    tax_rate: '',

                    drawback_time: '',
                    source_country: '',
                    purchase_days: '',
                    remark: '',
                    drawback_amount: "",
                    amount: '',
                    amount_not_contain_tax: '',
                    currency: '',
                    service_expense: '',
                    attachment: [],
                    is_submit: "0",
                    purchase_type: '',
                    pur_website: '',
                    pur_account: '',
                    pur_order_no: '',
                    pre_pay: [
                        {
                            action_type_cd: 'N002860001',
                            days: '',
                            percent: '',
                            pre_paid_date: ''
                        }
                    ],
                    end_pay: {},

                },
                // 预估利润表格基本数据
                queryPost: function (url, param) {
                    var headers = {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }
                    return axios.post(url, Qs.stringify(param), headers);
                }
            },
            created: function () {
                var _this = this;
                if (PAGE === "purchase") {
                    this._ajax(this.getSteps(), this.getDetailQution(getQueryString("type")), this.get_our_company());
                } else {
                    this._ajax(this.getSteps(), this.getDetailDatas(getQueryString("type")), this.get_our_company());
                };

                this.getCountry();
                this.getExchangeRate();
            },
            methods: {
                get_our_company: function () {
                    return this.queryPost('/index.php?g=common&m=index&a=get_our_company');
                },
                get_sell_small_team:function(val){
                    this.queryPost("/index.php?g=scm&m=quotation&a=get_sell_small_teame", {
                        code: val,
                    }).then((res) => {
                        if(res.data.code == 2000){
                            if(res.data.data){
                                this.isSell_small_team = true
                                this.sell_small_team = res.data.data
                            }else{
                                this.isSell_small_team = false
                            }
                        }
                    });
                },
                verifyDays(type, index) {
                    let result
                    if (type === 1) {
                        result = this.verifyByReg(1, this.form.pre_pay[index].days)
                        if (!result || this.form.pre_pay[index].days.length > 3) {
                            this.form.pre_pay[index].days = ''
                            this.$message.error(this.$lang('天数为[0,999]之间的整数'))
                        }                     
                    } else if (type === 2) {
                        result = this.verifyByReg(1, this.form.end_pay.days)
                        if (!result || this.form.end_pay.days.length > 3) {
                            this.form.end_pay.days = ''
                            this.$message.error(this.$lang('天数为[0,999]之间的整数'))
                        }  
                    }
                },

                verifyPoMoney(index) {
                    let result
                    result = this.verifyByReg(2, this.form.pre_pay[index].percent)
                    if (!result) {
                        this.form.pre_pay[index].percent = ''
                        this.$message.error(this.$lang('请输入(0,100]间最多四位小数的数字'))
                    } else {
                        this.verifyPoMoneySum(index)
                    }
                },

                verifyPoMoneySum(index) {
                    const length = this.form.pre_pay.length
                    this.endPaymentDisabled = false
                    if (length <= 1) {
                        if (this.form.pre_pay[0].percent > 100) {
                            this.form.pre_pay[0].percent = ''
                            this.$message.error(this.$lang('PO金额占比加起来不能超过100%'))
                        } else if (this.form.pre_pay[0].percent == 100) {
                            
                            // PO金额占比加起来为100%时， 尾款默认为无,且不可改变
                            this.hasEndPayment = 'N001390502'
                            this.endPaymentDisabled = true
                        }
                    } else {
                        const poMoneyArr = this.form.pre_pay.map(item => item.percent)
                        const sum = poMoneyArr.reduce((prev, cur) => this.accAdd(prev, cur))
                        if (sum > 100) {
                            this.form.pre_pay[index].percent = ''
                            this.$message.error(this.$lang('PO金额占比加起来不能超过100%'))
                        } else if (sum == 100) {

                            // PO金额占比加起来为100%时， 尾款默认为无,且不可改变
                            this.hasEndPayment = 'N001390502'
                            this.endPaymentDisabled = true
                        }
                    }
                },

                /**
                 ** 加法函数，用来得到精确的加法结果
                 ** 说明：javascript的加法结果会有误差，在两个浮点数相加的时候会比较明显。这个函数返回较为精确的加法结果。
                 ** 调用：accAdd(arg1,arg2)
                 ** 返回值：arg1加上arg2的精确结果
                 **/
                accAdd(arg1, arg2) {
                    var r1, r2, m, c;
                    try {
                        r1 = arg1.toString().split(".")[1].length;
                    } catch (e) {
                        r1 = 0;
                    }
                    try {
                        r2 = arg2.toString().split(".")[1].length;
                    } catch (e) {
                        r2 = 0;
                    }
                    c = Math.abs(r1 - r2);
                    m = Math.pow(10, Math.max(r1, r2));
                    if (c > 0) {
                        var cm = Math.pow(10, c);
                        if (r1 > r2) {
                            arg1 = Number(arg1.toString().replace(".", ""));
                            arg2 = Number(arg2.toString().replace(".", "")) * cm;
                        } else {
                            arg1 = Number(arg1.toString().replace(".", "")) * cm;
                            arg2 = Number(arg2.toString().replace(".", ""));
                        }
                    } else {
                        arg1 = Number(arg1.toString().replace(".", ""));
                        arg2 = Number(arg2.toString().replace(".", ""));
                    }
                    return (arg1 + arg2) / m;
                },

                /** 
                 * 利用正则验证输入的值是否满足需求
                 *
                 * @param {number} type 输入的值的校验需求，1 只能为非负整数，2 (0,100]的数字，最多4位小数
                 * @param {string} value 需要校验的值
                 * @return {boolean} 校验结果的布尔值
                 */
                verifyByReg(type, value) {
                    let reg
                    switch (type) {
                        case 1:
                            reg = '^[0-9]+?$'
                            break;
                        case 2:
                            reg = '(?!^0\.?0*$)^[0-9][0-9]?(\.[0-9]{1,4})?$|^100$'
                            break;
                        default:
                            break;
                    }
                    return new RegExp(reg).test(value)
                },
                // 新增一条"预付款"表单项
                addAdvancePaymentItem() {
                    this.form.pre_pay.push({
                        action_type_cd: '',
                        percent: '',
                        pre_paid_date: ''
                    })
                },

                // 监听预付款中，付款类型改变
                actionTypeChange(newVal, index) {
                    if (index != 0) {
                        return
                    }

                    if (newVal === 'N002860002') {
                        const obj = {
                            action_type_cd: 'N002860002',
                            percent: '',
                            pre_paid_date: ''
                        }
                        this.form.pre_pay.splice(0, 1, obj)
                    } else {
                        const obj = {
                            action_type_cd: 'N002860001',
                            days: '',
                            percent: '',
                            pre_paid_date: ''
                        }
                        this.form.pre_pay.splice(0, 1, obj)
                    }
                    this.verifyPoMoneySum()
                },
                // 删除一条"预付款"表单项
                delAdvancePaymentItem(itemIndex) {
                    this.form.pre_pay.splice(itemIndex, 1)
                },
                //四舍五入
                //  round:function(row,key){
                //     var num = row[key];
                //     list = num.split('.')[1] ;
                //     if(list && list.length > 4){
                //         Vue.set(row,key,parseFloat(num).toFixed(4));
                //     }
                // },
                // 选择发货操作时
                changeDeliveryState: function (val) {
                    var _this = this;
                    if (val == 'N002450100') {
                        this.cds.warehouse = deepCopyObj(this.warehouseListTemp)
                        this.form.warehouse = '';
                        this.warehouseDisabled = false;

                    } else if (val == 'N002450300') {
                        this.cds.warehouse = deepCopyObj(this.warehouseList)
                        this.form.warehouse = 'N000680800';
                        this.warehouseDisabled = true;
                    } else if (val == 'N002450400') {
                        this.cds.warehouse = deepCopyObj(this.warehouseList)
                        this.form.warehouse = '';
                        this.warehouseDisabled = false;
                    }
                },
                _ajax: function (a, b, c) {
                    var _this = this;
                    axios.all([a, b, c]).then(axios.spread((cds, detail, our_company) => {
                        console.log([our_company], '33333')
                        _this.tableLoading = false;
                        if (detail.data.code === 2000 && cds.data.code === 2000 && our_company.data.code === 2000) {
                            console.log(cds.data, 'data')
                            _this.cds = cds.data.data;
                            _this.cds.our_company = our_company.data.data;
                            _this.taxRates = cds.data.data.tax_rate;
                            _this.baseDatas = detail.data.data.demand;
                            _this.audit_info = detail.data.data.audit_info;
                            // 处理 仓库 
                            _this.warehouseList = deepCopyObj(_this.cds.warehouse)
                            _this.cds.warehouse.forEach(function (el, ind) {
                                if (el.CD == 'N000680800' || el.CD == 'N000685800' || el
                                    .CD == 'N000685900') {
                                    _this.$delete(_this.cds.warehouse, ind)
                                }
                            });


                            _this.get_sell_small_team(_this.baseDatas.sell_team)


                            // 判断 状态
                            if (this.baseDatas.demand_type == 'N002100100') {
                                this.form.ship_type = 'N002450400';
                            } else if (this.baseDatas.demand_type == 'N002100200') {
                                this.form.ship_type = 'N002450100';
                            }
                            _this.warehouseListTemp = deepCopyObj(_this.cds.warehouse)

                            var selectedGoods = [];

                            for (var o = 0, _len = _this.cds.currency.length; o < _len; o++) {
                                _this.$set(_this.curreneyobj, _this.cds.currency[o].CD, _this
                                    .cds.currency[o].CD_VAL)
                            };


                            if (PAGE !== "purchase") { // 创建认领需求
                                _this.form.purchaser = detail.data.data.login_name;
                                if (detail.data.data.goods) {
                                    for (var k = 0, len = detail.data.data.goods.length; k <
                                        len; k++) {
                                        _this.$set(detail.data.data.goods[k], "supply_number",
                                            "");
                                        _this.$set(detail.data.data.goods[k], "purchase_price",
                                            "");
                                        _this.$set(detail.data.data.goods[k],
                                            "drawback_percent", "");
                                        _this.$set(detail.data.data.goods[k], "demand_goods_id",
                                            detail.data.data.goods[k].id);
                                        _this.$set(detail.data.data.goods[k], "sell_small_team_json",
                                        [{small_team_code:''}]); 
                                        _this.$set(detail.data.data.goods[k], "sell_small_team_json",
                                        [{small_team_name:''}]); 
                                        _this.$set(detail.data.data.goods[k], "sell_small_team_json",
                                        [{number:0.00}]); 
                                    };

                                    _this.goodsDatas = detail.data.data.goods;
                                };

                            } else { // 编辑认领需求

                                if (detail.data.data.goods.length) {
                                    for (var k = 0, len = detail.data.data.goods.length; k <
                                        len; k++) {
                                        if (detail.data.data.goods[k].is_checked) {
                                            selectedGoods.push(detail.data.data.goods[k]);

                                            _this.selChange(detail.data.data.goods[k]);
                                        };
                                        _this.$set(detail.data.data.goods[k], "demand_goods_id",
                                            detail.data.data.goods[k].id);
                                    };

                                    _this.goodsDatas = detail.data.data.goods;

                                    _this.$nextTick(() => {
                                        selectedGoods.forEach((item) => {

                                            _this.$refs.multipleTable
                                                .toggleRowSelection(item, true);
                                        });
                                    });

                                };
                                var reportDatas = detail.data.data.quotation;
                                _this.supplyOptions = [{
                                    SP_NAME: reportDatas.supplier,
                                    SP_CHARTER_NO: reportDatas.supplier_no
                                }];
                                _this._id = detail.data.data.quotation.id;


                                if (reportDatas.payment_time) {
                                    _this.paymentCycleFlag = false;
                                    _this.paymentCycleTypeFlag = false;
                                };

                                for (var key in _this.form) {
                                    if (key !== "goods") {
                                        if (reportDatas.hasOwnProperty(key)) {
                                            if (key === "attachment" && reportDatas[
                                                    "attachment"]) {
                                                var _array = reportDatas["attachment"];
                                                _this.form[key] = reportDatas["attachment"];
                                                for (var q = 0, len = _array.length; q <
                                                    len; q++) {
                                                    var _obj_ = {
                                                        name: _array[q].original_name,
                                                        url: ""
                                                    };
                                                    _this.upFileList.push(_obj_);
                                                };

                                            } else if (key === "payment_time" && reportDatas[
                                                    "payment_time"] == null) {

                                                _this.form["payment_time"] = reportDatas
                                                    .payment_cycle_type === "N002210100" ? [{
                                                        node: '',
                                                        days: '',
                                                        day_type: '',
                                                        percent: '',
                                                        date: ''
                                                    }] : [{
                                                        percent: '',
                                                        date: ''
                                                    }];
                                            } else {
                                                _this.form[key] = reportDatas[key];
                                            };

                                        };
                                    };
                                };

                                // 编辑认领时，获取该供应商下的框架合同
                                _this.getContract(_this.form.supplier_no);

                            };

                            _this.getCd = cds.data.data.scm_step;

                            for (var i = 0, len = _this.getCd.length; i < len; i++) {
                                if (detail.data.data.status_list.step === _this.getCd[i]
                                    .CD) { // 查看当前进度
                                    _this.currentStep = i;
                                };
                            };

                        } else {
                            if (detail.data.code !== 2000) {
                                _this.$message.error(_this.$lang(detail.data.msg));
                                return;
                            };
                            _this.$message.error(_this.$lang("请求失败"));
                        };



                    })).catch(function (err) {
                        console.log(err);
                    });
                },
                getSteps: function () {
                    let param = {
                        cd_type: {
                            scm_step: false,
                            abandon_demand_reason: false,
                            demand_not_approve_reason: false,
                            tax_rate: false,
                            auth_and_link: false,
                            purchase_team: false,
                            payment_cycle: false,
                            payment_days_type: false,
                            payment_node: false,
                            payment_days: false,
                            payment_cycle_type: false,
                            invoice_type: false,
                            currency: false,
                            purchase_type: false,
                            delivery_type: false,
                            pur_website: false,
                            warehouse: false,
                            // sell_small_team:false
                        }
                    };
                    return this.queryPost("/index.php?g=common&m=index&a=get_cd", param);
                },
                getDetailDatas: function (id) {
                    return this.queryPost("/index.php?g=scm&m=demand&a=demand_detail", {
                        id: id
                    });
                },
                getDetailQution: function (id) {
                    return this.queryPost("/index.php?g=scm&m=quotation&a=quotation_detail", {
                        id: id,
                        type: "edit"
                    });
                },
                getCountry: function () {
                    this.queryPost("/index.php?g=common&m=index&a=get_address").then((res) => {
                        var _data = res.data;

                        if (_data.code === 2000) {
                            this.countries = _data.data;
                        } else {
                            this.$message.error(this.$lang(data.msg));
                        };
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                getExchangeRate: function () {
                    var _this = this;
                    this.queryPost("/index.php?g=common&m=index&a=exchange_rate").then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            _this.exchangerate = _data.data.exchange_rate;
                        } else {
                            _this.$message.error(_this.$lang(_data.msg));
                        };
                    });
                },
                handleSelectPurchaser: function (item) {
                    this.selectPurchaserFlag = true;
                },
                querySearchPurchaser: function (qs, cb) {
                    if (!qs) {
                        return;
                    };
                    this.queryPost("/index.php?g=common&m=user&a=search_user", {
                        name: qs
                    }).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            if (_data.data) {
                                _data.data && cb(_data.data);
                            };
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    })
                },
                blurPurchaser: function () {
                    if (!this.selectPurchaserFlag) {
                        this.form.purchaser = '';
                    };
                },
                focusPurchaser: function () {
                    this.selectPurchaserFlag = false;
                },
                stepValue: function (item, index) {
                    return item === "成功结束" ? item : item.substr(1);
                },
                // 商品信息
                handleSelectionChange: function (selection) {
                    this.form.goods = selection;
                    this.getSummaries();
                },
                showImg: function (index) {
                    this.imgShowIndex = index;
                },
                hiddenImg: function () {
                    this.imgShowIndex = '';
                },
                fillRequire: function (row, key) {
                    this.$nextTick(() => {
                        row[key] = row[key].replace(/\s|,/g, "");
                    });
                },
                changeRate: function (type) {
                    var _this = this;
                    this.goodsDatas.forEach(function (e) {
                        if (type == true && e.purchase_price_not_contain_tax > 0) {
                            _this.calcPrice(e, 'purchase_price_not_contain_tax');
                        } else {
                            _this.calcPrice(e, 'purchase_price');
                        }
                    })
                },
                calcPrice: function (row, key) {
                    var _this = this,
                        rate = 0;
                    if (!row[key]) {
                        this.$set(row, 'purchase_price_not_contain_tax', '')
                        this.$set(row, 'purchase_price', '')
                        return;
                    };
                    if (this.form.tax_rate) {
                        rate = (this.cds.tax_rate.filter(function (e) {
                            return e.CD == _this.form.tax_rate
                        })[0].CD_VAL.replace(/%/, '')) / 100;
                    }
                    if (key == 'purchase_price') {
                        this.$set(row, 'purchase_price_not_contain_tax', row[key] / (1 + rate))
                    } else {
                        this.$set(row, 'purchase_price', row[key] * (1 + rate))
                    }
                },
                //采购信息
                handleSelect: function (val) {
                    this.contractLoading = true;
                    if (!val) {
                        return;
                    };
                    console.log(val)
                    this.form.contract = '';
                    this.form.our_company = '';
                    this.form.has_contract = '1';
                    var _arr = this.supplyOptions.filter((item) => {
                        return item.SP_CHARTER_NO === val;
                    });
                    this.form.supplier = _arr[0].SP_NAME;
                    this.form.supplier_new_id = _arr[0].ID;
                    var _this = this;
                    this.getContract(this.form.supplier_no, function () {
                        _this.contractLoading = false;
                    });
                },
                handleAutoSelect: function (val) {
                    this.contractLoading = true;
                    if (!val) {
                        return;
                    };
                    this.form.supplier_no = val.SP_CHARTER_NO;
                    this.form.supplier_new_id = val.ID;
                    var _this = this;
                    this.getContract(this.form.supplier_no, function () {
                        _this.contractLoading = false;
                    });
                },
                queryAutoSearchAsync: function (queryString, cb) {
                    if (!queryString) {
                        return;
                    };
                    this.queryPost("/index.php?g=common&m=index&a=search_customer_or_supplier", {
                        supplier_id: queryString,
                        type: '0'
                    }).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            _data.data && cb(_data.data);
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                },
                getContract: function (no, cb) {
                    var _this5 = this;
                    this.queryPost("/index.php?m=order_detail&a=getContract", {
                        sp_charter_no: no
                    }).then((res) => {
                        cb && cb();
                        var _data = res.data;
                        if (_data.status === 1) {
                            _this5.contract = _data.data;
                        } else {
                            _this5.$message.error(_this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                querySearchAsync: function (queryString) {
                    if (!queryString) {
                        return;
                    };
                    this.supplyLoading = true;
                    this.queryPost("/index.php?g=common&m=index&a=search_customer_or_supplier", {
                        supplier_id: queryString,
                        type: '0'
                    }).then((res) => {
                        var _data = res.data;
                        this.supplyLoading = false;
                        if (_data.code === 2000) {
                            this.supplyOptions = _data.data;
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                },
                test: function (index) {
                    if (index === this.form.payment_time.length - 1) {
                        return;
                    };
                    var _this = this;
                    var _time = new Date(_this.form.payment_time[index].date);
                    this.$set(this.form.payment_time[index + 1], 'picksBeforeTime', {
                        disabledDate(item) {
                            return item.getTime() < _time.getTime();
                        }
                    });
                },
                upProgress: function (file) {
                    if (file.status === "success") {

                        if (file.response.status === 1) {
                            this.form.attachment.push({
                                original_name: file.response.info.name,
                                save_name: file.response.info.savename
                            });
                        } else {
                            this.$message.error(this.$lang("此文件上传失败"));
                        };
                    };
                },
                beforeUpload: function (file) {
                    for (var i = 0, len = this.form.attachment.length; i < len; i++) {
                        if (this.form.attachment[i].original_name === file.name) {
                            this.$message.warning(this.$lang("该文件已上传"));
                            return false;
                        };
                    };
                },
                saveDraft: function () {
                    var goodsArr = this.form.goods
                    for (const item in goodsArr) {
                        if(!this.isSell_small_team){
                            this.form.goods[item].sell_small_team_json = []
                        }else{
                            var sell_small_team_arr = this.form.goods[item].sell_small_team_json;
                            var stop = false;
                            for (const item2 in sell_small_team_arr) {
                                console.log(this.form.goods[item].sell_small_team_json[item2].small_team_code);
                                console.log(this.form.goods[item].sell_small_team_json[item2].number);
                                // 需求10838不校验小团队必填
                                if(!this.form.goods[item].sell_small_team_json[item2].small_team_code){
                                    stop = true;
                                } else {
                                    stop = false;
                                    break;
                                }
                                if(this.form.goods[item].sell_small_team_json[item2].number <= 0){
                                    this.$message.warning(this.$lang("供货数量需要大于0"));
                                    return;
                                }
                            }
                            console.log(stop);
                            if(sell_small_team_arr.length > 1 && stop) {
                                this.$message.warning(this.$lang("多个小团队时最少选择一个"));
                                return;
                            }
                        }
                        
                    }
                    this.form.is_submit = "0";

                    if (this._id) {
                        this.$set(this.form, "id", this._id);
                    };

                    this.$set(this.form, "demand_id", this.baseDatas.id);
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=quotation&a=quotation_save", this.form).then((
                        res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.$message.success(this.$lang("提交成功"));

                            if (window.top == window.self) {
                                document.write("已存为草稿，请到ERP系统内查看");
                                return false;
                            }
                            backTab("/index.php?g=scm&m=display&a=purchases&type=" + _data.data
                                .quotation_id, this.$lang("采购详情"));
                            if (PAGE !== "purchase") {
                                newTab("/index.php?g=scm&m=display&a=demands&type=" + this.form
                                    .demand_id, this.$lang("需求详情"))
                            }
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                },
                submit: function () {
                    // console.log(this.form);
                    // console.log(this.goodsDatas);


                    if (!this.validations(this.form)) {
                        return;
                    };

                    

                    // if(!this.isSell_small_team){
                    //     console.log('isnotSell_small_team');
                    //     var goodsArr = this.form.goods
                    //     for (const item in goodsArr) {
                    //         this.form.goods[item].sell_small_team_json = []
                    //     }
                    // }

                    var goodsArr = this.form.goods
                    for (const item in goodsArr) {
                        if(!this.isSell_small_team){
                            this.form.goods[item].sell_small_team_json = []
                        }else{
                            var sell_small_team_arr = this.form.goods[item].sell_small_team_json;
                            var stop = false;
                            for (const item2 in sell_small_team_arr) {
                                console.log(this.form.goods[item].sell_small_team_json[item2].small_team_code);
                                console.log(this.form.goods[item].sell_small_team_json[item2].number);
                                // 需求10838不校验小团队必填
                                if(!this.form.goods[item].sell_small_team_json[item2].small_team_code){
                                    stop = true;
                                } else {
                                    stop = false;
                                    break;
                                }
                                if(this.form.goods[item].sell_small_team_json[item2].number <= 0){
                                    this.$message.warning(this.$lang("供货数量需要大于0"));
                                    return;
                                }
                            }
                            console.log(stop);
                            if(sell_small_team_arr.length > 1 && stop) {
                                this.$message.warning(this.$lang("多个小团队时最少选择一个"));
                                return;
                            }
                        }
                        
                    }


                    

                    // var _sum = 0;
                    // for (var i = 0, len = this.form.payment_time.length; i < len; i++) {
                    //     _sum += (this.form.payment_time[i].percent - 0);
                    // };

                    // if (_sum !== 100) {
                    //     this.$message.warning(this.$lang("每期收款比例之和必须为100"));
                    //     return;
                    // };

                    if (this._id) {
                        this.$set(this.form, "id", this._id);
                    };

                    this.form.is_submit = "1";
                    this.$set(this.form, "demand_id", this.baseDatas.id);
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=quotation&a=quotation_save", this.form).then((
                        res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.$message.success(this.$lang("提交成功"));
                            if (window.top == window.self) {
                                document.write(this.$lang('已认领成功，请到ERP系统内查看'));
                                return false;
                            }
                            backTab("/index.php?g=scm&m=display&a=purchases&type=" + _data.data
                                .quotation_id, this.$lang("采购详情"));
                            if (PAGE !== "purchase") {
                                newTab("/index.php?g=scm&m=display&a=demands&type=" + this.form
                                    .demand_id, this.$lang("需求详情"))
                            }
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    });
                },
                validations: function (obj) {

                    if (this.form.purchase_type == 'N001890100' && !this.form.contract && this.form
                        .has_contract === '1') {
                        this.$message.warning(this.$lang('框架合同不能为空'));
                        return false;
                    };

                    for (var i = 0, len = procurementDatas.length; i < len; i++) {

                        if (obj[procurementDatas[i]] === "") {
                            this.$message.warning(this.$lang(procurementTexts[i] + "不能为空"));
                            return false;
                        };
                    };

                    if (this.form.purchase_type != 'N001890200' && obj.contract === "" && obj
                        .has_contract === "1") {
                        this.$message.warning(this.$lang('框架合同不能为空'));
                        return false;
                    };

                    if ((obj.drawback_time === null || obj.drawback_time === "") && obj.has_drawback ===
                        "1") {
                        this.$message.warning(this.$lang('退税时间不能为空'));
                        return false;
                    };

                    if (this.form.purchase_type != 'N001890200' && !this.form.delivery_type) {
                        this.$message.warning(this.$lang('交货方式不能为空'));
                        return false;
                    }

                    /* 检验"预付款"和"尾款" */
                    const prePayLength = obj.pre_pay.length
                    if (prePayLength === 0 && !obj.end_pay.action_type_cd) {

                        // 1.两者不能同时选无；
                        this.$message.warning(this.$lang('预付款和尾款不能同时选无'))
                        return false
                    } else if (prePayLength > 0 && !obj.end_pay.action_type_cd) {

                        // 2.【尾款】如果选择了“无”，则【预付款】PO金额的比例加起来必须等于100%
                        const poMoneyArr = obj.pre_pay.map(item => item.percent)
                        const sum = poMoneyArr.reduce((prev, cur) => this.accAdd(prev, cur))
                        if (sum != 100) {
                            this.$message.error(this.$lang('无尾款时，预付款中的PO金额比例加起来必须等于100%'))
                            return false
                        }
                    }

                    // 3.两者后面只要有展示出来的输入区域都必填；
                    if (prePayLength > 0) {
                        for (let i = 0; i < prePayLength; i++) {
                            for (let key in obj.pre_pay[i]) {
                                if (!obj.pre_pay[i][key]) {
                                    this.$message.warning(this.$lang('预付款中的输入项都是必填项'))
                                    return false
                                }
                            }
                        }
                    }
                    if (obj.end_pay.action_type_cd) {
                        for (let key in obj.end_pay) {
                            if (!obj.end_pay[key]) {
                                this.$message.warning(this.$lang('尾款中的输入项都是必填项'))
                                return false
                            }
                        }
                    }
    
                    
                    if (obj.goods[0].id === "") {
                        this.$message.warning(this.$lang('请选择商品'));
                        return false;
                    };

                    for (var k = 0, len = obj.goods.length; k < len; k++) {
                        for (var i = 0, lens = goodsParameter.length; i < lens; i++) {
                            if (obj.goods[k][goodsParameter[i]] === "") {
                                this.$message.warning(this.$lang(goodsParameterText[i] + "不能为空"));
                                return false;
                            };
                        };
                    };

                    return true;
                },
                viewMethods: function () {
                    this.dialogCalculate = true;
                },
                stripscript: function stripscript(s) {
                    var pattern = new RegExp("[%]");
                    var rs = "";
                    for (var i = 0; i < s.length; i++) {
                        rs = rs + s.substr(i, 1).replace(pattern, '');
                    }
                    return rs;
                },
                getSummaries: function () {
                    var sums = [this.$lang("合计")];
                    var _sum1 = 0,
                        _sum2 = 0,
                        _sum3 = 0,
                        _sum4 = 0,
                        _sum5 = 0,
                        _sum6 = 0,
                        allTaxRate = 0;
                    
                    for (var i = 0; i < this.form.goods.length; i++) {


                        if(this.isSell_small_team){
                            // 有销售小团队
                            var sell_small_team_json_arr = this.form.goods[i].sell_small_team_json
                            var supply_number2 = 0
                            for (var item in sell_small_team_json_arr) {
                                supply_number2 += parseFloat(sell_small_team_json_arr[item].number)
                                var sellSmallTeam = this.sell_small_team
                                if(sell_small_team_json_arr[item].small_team_code){
                                    var result =  sellSmallTeam.find((item2) => item2.CD == sell_small_team_json_arr[item].small_team_code)
                                    this.form.goods[i].sell_small_team_json[item].small_team_name = result.CD_VAL
                                } else {
                                    this.form.goods[i].sell_small_team_json[item].small_team_name = '';
                                    this.$set(this.form.goods[i].sell_small_team_json[item], "small_team_code","");
                                }
                            }

                            if (this.form.goods[i].sell_small_team_json) {
                                _sum3 += supply_number2;
                            };

                            this.form.goods[i].supply_number = supply_number2

                            if (this.form.goods[i].purchase_price && this.form.goods[i].sell_small_team_json) {
                                _sum4 += (this.form.goods[i].purchase_price * supply_number2);
                                _sum6 += (this.form.goods[i].purchase_price_not_contain_tax * supply_number2);
                            };

                            if (this.form.goods[i].taxRateVal && this.form.goods[i].sell_small_team_json && this.form
                                .goods[i].sell_price) {
                                if (this.pointNumber) {
                                    _sum5 += (this.form.goods[i].purchase_price / (1 + this.stripscript(this
                                            .pointNumber) / 100) * supply_number2 *
                                        parseInt(this.form.goods[i].taxRateVal) / 100);
                                } else {
                                    _sum5 = 0
                                };
                            };


                        }else{
                            if (this.form.goods[i].supply_number) {
                                _sum3 += (this.form.goods[i].supply_number - 0);
                            };

                            if (this.form.goods[i].purchase_price && this.form.goods[i].supply_number) {
                                _sum4 += (this.form.goods[i].purchase_price * this.form.goods[i].supply_number);
                                _sum6 += (this.form.goods[i].purchase_price_not_contain_tax * this.form.goods[i]
                                    .supply_number);
                            };

                            if (this.form.goods[i].taxRateVal && this.form.goods[i].supply_number && this.form
                                .goods[i].sell_price) {
                                if (this.pointNumber) {
                                    _sum5 += (this.form.goods[i].purchase_price / (1 + this.stripscript(this
                                            .pointNumber) / 100) * this.form.goods[i].supply_number *
                                        parseInt(this.form.goods[i].taxRateVal) / 100);
                                } else {
                                    _sum5 = 0
                                };
                            };

                        }

                        if (this.form.goods[i].purchase_number) {
                            _sum2 += (this.form.goods[i].purchase_number - 0);
                        };

                       
                        if (this.form.goods[i].taxRateVal) {
                            allTaxRate += (this.form.goods[i].taxRateVal.replace("%", '') - 0);
                        };
                        
                    };

                    this.isHasDrawback = allTaxRate ? true : false;
                    this.form.has_drawback = allTaxRate ? "1" : "0";

                    this.form.drawback_amount = _sum5.toFixed(2);
                    console.log(this.form.drawback_amount, 'amount' )
                    this.form.amount = _sum4.toFixed(2);
                    this.form.amount_not_contain_tax = _sum6.toFixed(2);

                    sums[6] = this.baseDatas.sell_currency_val;
                    sums[7] = this.baseDatas.sell_currency_val;
                    sums[8] = _sum2;



                    if(this.isSell_small_team){
                        // 有销售小团队
                        sums[10] = this.curreneyobj[this.form.currency] + " " + this.separatNum(_sum4.toFixed(2));
                        sums[11] = this.curreneyobj[this.form.currency] + " " + this.separatNum(_sum6.toFixed(2));

                        sums[14] = _sum3;
                    }else{
                        sums[10] = _sum3;
                        sums[11] = this.curreneyobj[this.form.currency] + " " + this.separatNum(_sum4.toFixed(
                            2));
                        sums[12] = this.curreneyobj[this.form.currency] + " " + this.separatNum(_sum6.toFixed(
                            2));
                        sums[13] = this.curreneyobj[this.form.currency] + " " + this.separatNum(_sum5.toFixed(
                            2));
                    }

                    

                    return sums;
                },
                selChange: function (row) {
                    for (var i = 0, len = this.taxRates.length; i < len; i++) {
                        if (this.taxRates[i].CD === row.drawback_percent) {
                            this.$set(row, "taxRateVal", this.taxRates[i].CD_VAL);
                            break;
                        };
                    };
                },
                handleError: function (file) {
                    this.$message.error(this.$lang("导入失败"));
                },
                downTemplate: function (title, result) {
                    window.location.href =
                        "/index.php?g=common&m=file&a=template_download&name=scm_quotation_import_goods.xls";
                },
                handleSuccess: function (file) {
                    if (file.code !== 2000) {
                        this.$message.error(this.$lang(file.msg));
                        return;
                    };
                    var i = 0,
                        len = this.goodsDatas.length;
                    this.form.currency = file.data[0].currency;
                    var _arr = [];
                    for (; i < len; i++) {
                        for (var j = 0, jlen = file.data.length; j < jlen; j++) {
                            var fileItem = file.data[j];
                            if (this.goodsDatas[i].search_id === fileItem.search_id) {
                                _arr.push(this.goodsDatas[i]);
                                this.goodsDatas[i].supply_number = fileItem.number;
                                this.goodsDatas[i].purchase_price = fileItem.price;
                                this.goodsDatas[i].purchase_price_not_contain_tax = fileItem.price_no_tax;
                                this.goodsDatas[i].drawback_percent = fileItem.drawback_percent;
                                this.selChange(this.goodsDatas[i]);
                                break;
                            };
                        };
                    };

                    for (var i = 0, len = _arr.length; i < len; i++) {
                        this.$refs.multipleTable.toggleRowSelection(_arr[i], true);
                    };
                    this.changeRate(true);
                },
                route: function (title, _html, type) {
                    var dom = document.createElement("a"),
                        _href = "/index.php?g=scm&m=display&a=" + _html + "&type=" + type;
                    dom.setAttribute("onclick", "opennewtab(this,'" + title + "')");
                    dom.setAttribute("_href", _href);
                    dom.click();
                },
                separatNum: function (num) { //千分位方法
                    if (!num) {
                        return
                    };
                    num = num + "";
                    var _arr = num.split(".");
                    return _arr[1] === "00" ? (num - 0).toLocaleString() + ".00" : (num - 0)
                        .toLocaleString();
                },
                editGood:function(index,itemIndex,type){
                    if(type == 'add'){
                        var obj = {}
                        obj.small_team_code = ''
                        obj.small_team_name = ''
                        obj.number = 0.00
                        // var obj2 = {}
                        // obj2.val = ''
                        // this.goodsDatas[index].sell_small_team.push(obj)
                        // this.goodsDatas[index].supply_quantity.push(obj2)
                        this.goodsDatas[index].sell_small_team_json.push(obj)
                    }else{
                        // this.goodsDatas[index].sell_small_team.splice(itemIndex,1)
                        // this.goodsDatas[index].supply_quantity.splice(itemIndex,1)
                        this.goodsDatas[index].sell_small_team_json.splice(itemIndex,1)
                    }
                    // console.log(this.form);
                },
                watchNum:function(e){
                    var keynum = window.event ? e.keyCode : e.which
                    var keychar = String.fromCharCode(keynum)
                    if(keynum==189||keynum==190||keynum==110||keynum==109){
                        e.target.value = ''
                    }
                },
                smallTeamSelect:function(val,index,index2){
                    // var smallTeamArr = []
                    // var resultList = ''
                    // var goodsDatas = this.goodsDatas
                    // var sellSmallTeam = this.cds.sell_small_team

                    // // console.log(val);
                    // // console.log(index);
                    // // console.log(index2);
                    // // console.log(goodsDatas[index2].sell_small_team_json);

                    // var sell_small_team_json = goodsDatas[index2].sell_small_team_json

                    // for (var item in sell_small_team_json) {
                    //     // console.log(item);
                    //     // console.log(index2);
                    //     // if(sell_small_team_json[item].small_team_code == val.small_team_code && item != index2){
                    //     //     this.$message.error(this.$lang('每个SKU，选择过的小团队在其他行不能选择'))
                    //     //     console.log(this.goodsDatas);
                    //     // }
                    // }

                    // for (var item in goodsDatas) {
                    //     var sell_small_team_json = goodsDatas[item].sell_small_team_json
                    //     for (var item2 in sell_small_team_json) {
                    //         smallTeamArr.push(sell_small_team_json[item2].small_team_code)
                    //         var result =  sellSmallTeam.find((item3) => item3.CD == sell_small_team_json[item2].small_team_code)
                    //         if(result){
                    //             resultList += result.CD
                    //         }
                    //     }
                    // }

                    // for (var item5 in sellSmallTeam) {
                    //   if(resultList.indexOf(sellSmallTeam[item5].CD) != -1){
                    //     this.cds.sell_small_team[item5].disabled = true
                    //   }else{
                    //     this.cds.sell_small_team[item5].disabled = false
                    //   }
                    // }
                }

            },
            computed: {
                invoice_type(){
                    return this.form.invoice_type
                },
                // 采购信息中的‘PO金额’, 【PO金额】=【商品成本】 + 【PO内其他费用】
                poMoney () {
                    const amount = Number(this.form.amount),
                          service_expense = Number(this.form.service_expense),
                          poMoney = (amount + service_expense).toFixed(2)
                    return this.separatNum(poMoney)
                },
                purchaseAmount: function () {

                    var allNum = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .currency], this.form.amount, "USD"),
                        logisticsCost = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .expense_currency], this.form.expense, "USD"),
                        serviceExpense = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .currency], this.form.service_expense, "USD");

                    return (allNum + logisticsCost + serviceExpense).toFixed(2);
                },
                refundAmount: function () {
                    // this.baseDatas.sell_currency_val
                    var drawback_amount = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                        .currency], parseFloat(this.form.drawback_amount), "USD");
                    return drawback_amount.toFixed(2);
                },
                salesAmount: function () {

                    var tax = utils.conversionRate(this.exchangerate, this.baseDatas.tax_currency_val, this
                            .baseDatas.tax, "USD"),
                        sellAmount = utils.conversionRate(this.exchangerate, this.baseDatas
                            .sell_currency_val, this.baseDatas.sell_amount, "USD");

                    var _goods = this.form.goods,
                        _allP = 0;
                    for (var i = 0, len = _goods.length; i < len; i++) {
                        if (_goods[i].search_id) {
                            _allP += _goods[i].sell_price * _goods[i].supply_number;
                        };
                    };

                    amount = utils.conversionRate(this.exchangerate, this.baseDatas.sell_currency_val,
                        _allP, "USD");
                    return sellAmount > 0 ? (amount * (1 - tax / sellAmount)).toFixed(2) : "0.00";
                },
                preGroProfit: function () {
                    var _goods = this.form.goods,
                        _allP = 0;
                    for (var i = 0, len = _goods.length; i < len; i++) {
                        if (_goods[i].search_id) {
                            _allP += (utils.conversionRate(this.exchangerate, this.baseDatas
                                        .sell_currency_val, parseFloat(_goods[i].sell_price), "USD") -
                                    utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                                        .currency], parseFloat(_goods[i].purchase_price), "USD")) * _goods[i]
                                .supply_number;
                        };
                    };
                    return _allP.toFixed(2);
                },
                afterGroProfit: function () {
                    return (+this.preGroProfit + (this.refundAmount - 0)).toFixed(2);
                },
                netProfit: function () {

                    var logistics = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .expense_currency], this.form.expense, "USD"),
                        serviceExpense = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .currency], this.form.service_expense, "USD");
                    return (this.afterGroProfit - logistics - serviceExpense).toFixed(2);
                },
                netProfitRate: function () {
                    return this.salesAmount > 0 ? (this.netProfit * 100 / this.salesAmount).toFixed(2) +
                        "%" : "0.00";
                },
                proLogisticsCost: function () {
                    var logCost = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .expense_currency], this.form.expense, "USD"),
                        serviceExpense = utils.conversionRate(this.exchangerate, this.curreneyobj[this.form
                            .currency], this.form.service_expense, "USD");
                    return (logCost + serviceExpense).toFixed(2);
                },
            },
            watch: {
                invoice_type(){
                    if(this.form.invoice_type === 'N001350200'){
                        this.form.tax_rate = 'N001340600'
                    }
                },
                'hasAdvancePayment'(newVal) {
                    if (newVal === '0') {
                        this.form.pre_pay = []
                        this.endPaymentDisabled = false
                    } else if (newVal === '1') {
                        this.form.pre_pay = [{
                            action_type_cd: 'N002860001',
                            days: '',
                            percent: '',
                            pre_paid_date: ''
                        }]
                    }
                },
                'hasEndPayment'(newVal) {
                    switch (newVal) {
                        case 'N001390502':
                            this.form.end_pay = {}
                            break;
                        case 'N001390200':
                            this.form.end_pay = {
                                action_type_cd: 'N001390200',
                                days: '',
                                pre_paid_date: ''
                            }
                            break
                        case 'N001390400':
                            this.form.end_pay = {
                                action_type_cd: 'N001390400',
                                days: '',
                                pre_paid_date: ''
                            }
                        default:
                            break;
                    }
                },
                // 'form.payment_cycle': function (newVal) {
                //     if (this.paymentCycleFlag) {
                //         this.form.payment_time = [];
                //         if (this.form.payment_cycle_type === "N002210100") { // 按实际情况
                //             var obj = {
                //                 node: '',
                //                 days: '',
                //                 day_type: '',
                //                 percent: '',
                //                 date: ''
                //             };
                //             var len = newVal ? newVal.substr(7, 1) : 1,
                //                 i = 0;
                //             for (; i < len; i++) {
                //                 this.form.payment_time.push(deepCopyObj(obj));
                //             };
                //         } else { // 按指定时间
                //             var obj = {
                //                 percent: '',
                //                 date: ''
                //             };
                //             var len = newVal ? newVal.substr(7, 1) : 1,
                //                 i = 0;
                //             for (; i < len; i++) {
                //                 this.form.payment_time.push(deepCopyObj(obj));
                //             };
                //         };
                //     };
                //     this.paymentCycleFlag = true;
                // },
                // 'form.payment_cycle_type': function (val) {
                //     if (this.paymentCycleTypeFlag) {
                //         this.form.payment_cycle = '';
                //         if (val === "N002210100") { // 按实际情况
                //             this.form.payment_time = [{
                //                 node: '',
                //                 days: '',
                //                 day_type: '',
                //                 percent: '',
                //                 date: ''
                //             }];
                //         } else { // 按指定时间
                //             this.form.payment_time = [{
                //                 percent: '',
                //                 date: ''
                //             }];
                //         };
                //     };
                //     this.paymentCycleTypeFlag = true;
                // },
                "form.tax_rate": function (val) {
                    var _arr = this.cds.tax_rate.filter(function (item) {
                        return item.CD == val;
                    });
                    this.pointNumber = _arr[0].CD_VAL;

                    this.getSummaries();
                },
                'form.purchase_type': function (newVal, oldVal) {
                    if (newVal !== oldVal && oldVal) {
                        this.form.supplier = '';
                        this.form.supplier_no = '';
                        this.form.contract = '';
                        this.form.has_contract = newVal == 'N001890100' ? '1' : '0';
                        this.form.pur_website = '';
                    }
                },
                'form.contract': function (newVal) {
                    if (!newVal) {
                        this.form.our_company = '';
                        return;
                    };
                    for (var i = 0, len = this.contract.length; i < len; i++) {
                        var item = this.contract[i];
                        if (item.CON_NO === newVal) {
                            this.form.our_company = item.CON_COMPANY_CD;
                            return;
                        };
                    };
                },
            },
            //过滤器
            filters: {
                formatDate: function (time) {
                    if (time) {
                        return utils.dateFormat(new Date(time), 'yyyy-MM-dd')
                    };
                },
                numberFormat: function (num, flag) {
                    if (!num || num == 'NaN') {
                        return 0;
                    };
                    num = !flag ? (num - 0).toFixed(2) : num + '';
                    return num.replace(/(\d)(?=(\d{3})+\.)/g, function ($0, $1) {
                        return $1 + ',';
                    }).replace(/\.$/, '');
                }
            }
        });

        //获取连接参数
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        };
        // 深copy obj
        function deepCopyObj(obj) {
            obj = obj || {};
            return JSON.parse(JSON.stringify(obj).concat());
        };
    </script>
</body>

</html>