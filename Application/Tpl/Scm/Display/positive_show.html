<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        <{$Think.lang.正次品转换详情}>
    </title>
    <link href="./Application/Tpl/Home/Public/css/H-ui-3.1.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/stock.css">
    <link rel="stylesheet" type="text/css" href="./Application/Tpl/Home/Public/css/style.css" />
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" type="text/css" href="./Application/Tpl/Home/Public/lib/Hui-iconfont/1.0.7/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="./Application/Tpl/Home/Public/css/stock_new.css" />
    <link rel="stylesheet" type="text/css" href="./Application/Tpl/Home/Public/css/NewAllocate.css" />
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.const.V}>">
</head>
<style>
    .col-sm-4 {
        padding: 0;
    }
    
    .title-left {
        width: 25%;
        float: left;
    }
    
    .input-text,
    .textarea {
        width: 60%;
    }
    
    table thead th {
        text-align: center;
    }
    
    .select-box {
        border: solid 1px #ddd;
    }
    
    .btn-upload {
        position: relative;
        display: inline-block;
        height: 31px;
        *display: inline;
        overflow: hidden;
        vertical-align: middle;
        cursor: pointer
    }
    
    .upload-url {
        cursor: pointer
    }
    
    .input-file {
        position: absolute;
        right: 0;
        top: -2px;
        cursor: pointer;
        z-index: 1;
        font-size: 30em;
        *font-size: 30px;
        opacity: 0;
        filter: alpha(opacity=0)
    }
    
    .btn-upload .input-text {
        width: auto
    }
    
    .form-group .upload-btn {
        margin-left: -1px
    }
    
    .table-bg thead th {
        background-color: #537a8c;
        color: white;
    }
    
    #content {
        padding: 0px;
    }
    
    .row {
        height: auto !important;
    }
</style>

<body>
    <div id="content">
        <div class="ck-wrap">
            <p class="ck-wrap-title">
                {{$lang("正次品转换详情")}}
            </p>
            <div class="row">
                <table class="table table-striped table-detail-bg">
                    <thead>
                        <th class="text-l table-detail-title" colspan="7">
                            {{$lang("基本信息")}}
                        </th>
                    </thead>
                    <tbody class="text-c">
                        <tr>
                            <td class="w-200">
                                {{$lang("转换单号")}}
                            </td>
                            <td>{{ret.conversion_no}}</td>
                            <td class="w-200">
                                {{$lang("状态")}}
                            </td>
                            <td>{{$lang(ret.status)}}</td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang("转换类型")}}
                            </td>
                            <td><span>{{$lang(type_style)}}</span></td>
                            <td>
                                {{$lang("本次转换是否同步更新采购单")}}
                            </td>
                            <td><span>{{$lang(affectValue)}}</span></td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang("货物归属销售团队")}}
                            </td>
                            <td><span>{{sales_teamValue}}</span></td>
                            <td>
                                {{$lang("货物归属仓库")}}
                            </td>
                            <td><span>{{$lang(warehouseValue)}}</span></td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang("应审核人")}}
                            </td>
                            <td> <span>{{ret.need_reviewer}}</span></td>
                            <td>
                                {{$lang("备注")}}
                            </td>
                            <td>{{ret.remark}}</td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang("发起人")}}
                            </td>
                            <td>{{ret.created_by}}</td>
                            <td>
                                {{$lang("发起时间")}}
                            </td>
                            <td>{{ret.created_at}}</td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang("审核人")}}
                            </td>
                            <td>
                                <span>{{ret.approval_by}}</span>
                            </td>
                            <td>
                                {{$lang("审核时间")}}
                            </td>
                            <td>{{ret.approval_at}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="row">
                <table class="table table-striped table-detail">
                    <thead>
                        <th class="text-l table-detail-title" colspan="11">
                            {{$lang("商品信息")}}
                        </th>
                    </thead>
                    <tbody>
                        <tr class="text-c table-th">
                            <td>
                                {{$lang("序号")}}
                            </td>
                            <td>
                                {{$lang("SKU编码")}}
                            </td>
                            <td>
                                {{$lang("条形码")}}
                            </td>
                            <td>
                                {{$lang("商品名称")}}
                            </td>
                            <td>
                                {{$lang("属性")}}
                            </td>
                            <td>
                                {{$lang("归属采购团队")}}
                            </td>
                            <td>
                                {{$lang("归属采购单号")}}
                            </td>
                            <td>
                                {{$lang("批次号")}}
                            </td>
                            <td>
                                {{$lang("到期日")}}
                            </td>
                            <td>
                                {{$lang("转换前商品类型")}}
                            </td>
                            <td>
                                {{$lang("转换数量")}}
                            </td>
                        </tr>
                        <tr v-for="(k, i) in ret.detail">
                            <td>{{i + 1}}</td>
                            <td>{{k.sku_id}}</td>
                            <td>{{k.upc_id}}</td>
                            <td>{{$lang(k.spu_name)}}</td>
                            <td>{{k.attributes}}</td>
                            <td>{{k.purchase_team}}</td>
                            <td>{{k.purchase_order_no}}</td>
                            <td>{{k.batch_code}}</td>
                            <td>{{k.deadline_date_for_use}}</td>
                            <td>{{$lang(typeValue)}}</td>
                            <td>{{k.number}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="bottom-row">
                <div>
                    <button class="el-button el-button--default el-button--small" @click="dialogVisible = true" v-if="ret.status == '待审核' && ret.can_approve"><{$Think.lang.不同意}></button>
                    <button class="bottom-btn btn-check-bottom" @click="agree()" v-if="ret.status == '待审核' && ret.can_approve"><{$Think.lang.同意}></button>
                    <button class="el-button el-button--default el-button--small" @click="remove()" v-if="ret.status=='待审核'"><{$Think.lang.撤回}></button>
                </div>
            </div>
        </div>

        <!--审批 start-->
        <el-dialog :title="$lang('填写不同意原因')" :visible.sync="dialogVisible" width="30%" :before-close="handleClose">
            <div style="text-align: center">
                <el-input type="textarea" :rows="4" :placeholder="$lang('请输入内容')" v-model="reason" style="width:100%">
                </el-input>
            </div>
            <div slot="footer">
                <el-button @click="confirmReason" type="primary">
                    {{$lang('提交')}}
                </el-button>
            </div>
        </el-dialog>
        <!--审批 end-->
    </div>
</body>
<script src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js " type="text/javascript "></script>
<script type="text/javascript " src="./Application/Tpl/Home/Public/js/vue.2.5.13.js "></script>
<script type="text/javascript " src="./Application/Tpl/Home/Public/lib/layer-v3.0.3/layer/layer.js "></script>
<script type="text/javascript " src="./Application/Tpl/Home/Public/js/jquery.form.min.js "></script>
<script type="text/javascript " src="./Application/Tpl/Home/Public/js/element-ui-2.2.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
<script src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
<script type="text/javascript">
    var ID = getQueryString("type");
    var vm = new Vue({
        el: '#content',
        data: {
            reason: '',
            dialogVisible: false,
            ret: '',
            typeValue: '',
            affectValue: '',
            sales_teamValue: '',
            warehouseValue: '',
            type_style: '',

            transWarehouse: '',
            transTeam: '',
            transType: '',
            queryPost: function(url, param) {
                var headers = {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }
                return axios.post(url, Qs.stringify(param), headers);
            }
        },
        created: function() {
            this.getBaseData();
            this.getQuoDetail();
        },
        methods: {
            getBaseData() {
                let param = {
                    cd_type: {
                        warehouse: true,
                        sell_team: true,
                        product_conversion_type: true,
                    }
                }
                this.queryPost("/index.php?g=common&m=index&a=get_cd", param).then((res) => {
                    if (res.data.code === 2000) {
                        this.transWarehouse = res.data.data.warehouse;
                        this.transTeam = res.data.data.sell_team;
                        this.transType = res.data.data.product_conversion_type;
                    } else {
                        this.$message.error(this.$lang(res.data.msg));
                    }
                }).catch(function(err) {
                    console.log(err);
                });
            },
            getQuoDetail: function() {
                var params = {
                    id: ID
                }
                this.queryPost("/index.php?g=warehouse&m=product&a=conversion_detail", params).then((res) => {
                    if (res.data.code == 2000) {
                        vm.ret = res.data.data
                        for (var item of this.transTeam) {
                            if (item.CD == vm.ret.sales_team_cd) {
                                this.sales_teamValue = item.CD_VAL
                            }
                        }
                        for (var item of this.transWarehouse) {
                            if (item.CD == vm.ret.warehouse_cd) {
                                this.warehouseValue = item.CD_VAL
                            }
                        }
                        for (var item of this.transType) {
                            if (item.CD == vm.ret.type_cd) {
                                this.type_style = item.CD_VAL
                            }
                        }
                        vm.typeValue = vm.ret.type_cd == 'N002720001' ? '正品' : '残次品'
                        vm.affectValue = vm.ret.affect_supplier_settlement == '0' ? '否' : '是'
                    } else {
                        vm.$message.error(res.data.msg);
                    }
                }).catch(function(err) {
                    console.log(err);
                });
            },
            remove: function() {
                var confirmIndex = layer.confirm("<{$Think.lang.是否撤回}> : " + vm.ret.conversion_no, {
                    btn: ["<{$Think.lang.确认}>", "<{$Think.lang.取消}>"], //按钮
                    title: "<{$Think.lang.提示}>"
                }, function() {
                    layer.close(confirmIndex);
                    var params = {
                        id: vm.ret.id
                    };
                    vm.queryPost("/index.php?g=warehouse&m=product&a=revoke", params).then((res) => {
                        if (res.data.code == 2000) {
                            layer.msg(res.data.msg, {
                                icon: 16,
                                time: 500
                            }, function() {
                                location.reload();
                            });
                        } else {
                            vm.$message.error(res.data.msg);
                        }
                    }).catch(function(err) {
                        console.log(err);
                    });
                }, function() {
                    layer.close(confirmIndex);
                    return false;
                });
            },
            agree: function() {
                var params = {
                    id: vm.ret.id,
                    status: 1
                }
                vm.queryPost("/index.php?g=warehouse&m=product&a=approve", params).then((res) => {
                    if (res.data.code == 2000) {
                        layer.msg(res.data.msg, {
                            icon: 16,
                            time: 500
                        }, function() {
                            location.reload();
                        });
                    } else {
                        vm.$message.error(res.data.msg);
                    }
                }).catch(function(err) {
                    console.log(err);
                });
            },
            confirmReason: function() {
                vm.refuse();
            },
            refuse: function() {
                if (vm.reason.trim() == '') {
                    layer.msg('<{$Think.lang.请填写原因}>');
                    return;
                }
                this.dialogVisible = false;
                var params = {
                    id: vm.ret.id,
                    status: 0,
                    reason: vm.reason
                }
                vm.queryPost("/index.php?g=warehouse&m=product&a=approve", params).then((res) => {
                    if (res.data.code == 2000) {
                        layer.msg(res.data.msg, {
                            icon: 16,
                            time: 500
                        }, function() {
                            location.reload();
                        });
                    } else {
                        vm.$message.error(res.data.msg);
                    }
                }).catch(function(err) {
                    console.log(err);
                });
            },
            handleClose: function() {
                this.dialogVisible = false;
            },

        },
    });
    //获取连接参数
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    };
</script>

</html>