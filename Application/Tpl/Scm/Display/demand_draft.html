<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/utils/css/public.style.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/icon/css/font-awesome.min.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Oms/Public/css/list_common.css?v=<{$Think.config.VER_NUM}>">
    <title>需求详情</title>
</head>
<style>
    input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    -webkit-appearance: none !important;
    margin: 0;
}

input::-ms-outer-spin-button,
input::-ms-inner-spin-button {
    -ms-appearance: none !important;
    margin: 0;
}

input::-o-outer-spin-button,
input::-o-inner-spin-button {
    -o-appearance: none !important;
    margin: 0;
}

input::-moz-outer-spin-button,
input::-moz-inner-spin-button {
    -moz-appearance: none !important;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield !important;
}
.market-steps {
    margin-top: 20px;
    min-height: 56px;
}
    .tran-table, .forecast-table {
        width: 100%;
        font-size: 13px;
        color: #546E7A;
        font-family: MicrosoftYaHei;
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
        background: #F7F9FB;
        margin: 20px 0;
    }
    
    .tran-table th {
        padding: 8px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #e4e9ed;
        text-align: center;
        white-space: nowrap;
    }

    .tran-table td, .forecast-table td {
        padding: 8px 10px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #F7F9FB;
        text-align: center;
    }

    .tran-table td:nth-child(odd) {
        text-align: center;
        font-weight: 600;
    }

    .tran-table td:nth-child(odd) {
        width: 15%;
        padding: 18px 10px;
        background: #f5fafe;
    }

    .tran-table td:nth-child(even) {
        width: 35%;
    }

    .tab {
        color: #c8d2d7;
        font-size: 16px;
    }

    .tab span {
        cursor: pointer;
    }

    .tab span:hover {
        color: #48576a;
    }

    .active {
        color: #263238;
    }

    .tran-table caption,
    header {
        height: 40px;
        background: #546E7A;
        font-family: MicrosoftYaHei;
        font-size: 16px;
        color: #FFFFFF;
        letter-spacing: 0;
        padding: 0px 10px;
        line-height: 40px;
        text-align: left;
    }

    .required {
        color: red;
    }

    .order-list-table.table-common tr th {
        color: #546E7A;
        background: #e4e9ed;
    }

    .el-select {
        padding: 0;
    }

    .width-100 {
        width: 100% !important;
    }

    .width-50 {
        width: 49.5% !important;
    }

    .width-33 {
        width: 33% !important;
    }

    .width-20 {
        width: 19.5% !important;
    }

    .nowrap {
        white-space: nowrap;
    }
    .el-dialog__header {
        display: block;
    }
    .dialog_title,.dialog_button {
        text-align: center;
    }
    .forecast-table {
        margin: 0;
    }
    .forecast-table tr td:nth-child(odd) {
        width: 200px;
        font-weight: 600;
    }
    .calculate-table {
        width: 100%;
        font-size: 13px;
        color: #546E7A;
        font-family: MicrosoftYaHei;
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
        background: #F7F9FB;
        margin: 20px 0;
    }
    .calculate-table td {
        padding: 8px 10px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        background: #F7F9FB;
        text-align: center;
    }
    .ceTitle {
        font-weight: 600;
    }
    .el-selectOption {
        position: relative;
        
    }
    .el-selectOption .el-select-dropdown {
        position: absolute !important;
        top: 40 !important;
        left: 0 !important;
    }
    .is-icon {
        width: 20px !important;
    }
    .red {
        color: #bf0917 !important;
    }
    .el-range__close-icon {
        width: 20px !important;
    }
    .imgStyle {
        width: 80px !important;
        height: 80px !important;
        cursor: pointer;
    }
    .table-common {
        overflow: visible !important;
    }
    .table-common .el-table__body-wrapper {
        overflow-x: visible !important;
        overflow-y: visible !important;
    }
    .input-with-select .el-input-group__prepend {
        background-color: #fff;
    }
    .required::after {
        content: '*';
        color: #ff4949;
        margin-left: 5px;
        vertical-align: middle;
    }
    .detail_table{
        border-bottom: 1px solid #CADEE7;
        border-right: 1px solid #CADEE7;
    }
    .detail_table td{
        width: 100px;
        border-top: 1px solid #CADEE7;
        border-left: 1px solid #CADEE7;
        text-align: center;
    }
</style>

<body class="orderList">
    <div id="demand" class="list-common" v-cloak style="margin-bottom:220px">
        <div class="use-title tab">
            <span style="margin-right: 35px;" :class="{'active':type == 'detail'}" @click="detail">{{$lang('需求详情')}}</span>
            <span :class="{'active':type == 'log'}" @click="log">{{$lang('操作日志')}}</span>
        </div>
        <div class="baseline"></div>
        <div v-show="type == 'detail'">
            <!-- 销售信息模块 -->
            <header v-show="stepFlag">
                <el-row>
                    <el-col>
                        {{$lang('总进度')}}
                    </el-col>
                </el-row>
            </header>
            <!--总进度end-->
            <!--进度条satrt-->
            <div class="market-steps" v-show="stepFlag">
                <el-steps :active="currentStep" align-center finish-status="success" :process-status="currentState">
                    <el-step v-for="(item, index) in getCd" :icon="iconReturn(index)" :key="index" :title="$lang(stepValue(item.CD_VAL, index))" :value="item.CD"></el-step>
                </el-steps>
            </div>

            <div>
                <table class="tran-table" cellpadding="0" cellspacing="0">
                    <caption>{{$lang('销售信息')}}</caption>
                    <tbody>
                        <tr>
                            <td>{{$lang('需求编号')}}</td>
                            <td>
                                {{form.demand_code}}
                            </td>
                            <td>{{$lang('销售进度')}}</td>
                            <td :class="{red: redFlag}">
                                {{$lang(form.status_val)}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('需求类型')}}</td>
                            <td>
                                {{$lang(form.demand_type_val)}}
                            </td>
                            <td>{{$lang('客户名称')}}<label :class="{'required':salesOrder && submitDemandType}"></label></td>
                            <td style="color: #409EFF">
                                <el-popover
                                    placement="bottom"
                                    title=""
                                    trigger="hover">
                                    <table class="detail_table" cellpadding="0" cellspacing="0" v-if="audit_info">
                                        <tr>
                                            <td>{{$lang('成立时间')}}</td>
                                            <td>
                                                {{audit_info.EST_TIME}}
                                            </td>
                                            <td>{{$lang('认缴资本')}}</td>
                                            <td>
                                                {{audit_info.CURRENCY}}{{audit_info.SUB_CAPITAL}}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>{{$lang('法人代表')}}</td>
                                            <td>
                                                {{audit_info.LG_REP}}
                                            </td>
                                            <td>{{$lang('股东名称')}}</td>
                                            <td>
                                                {{audit_info.SHARE_NAME}}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>{{$lang('信用评分(境外公司必填)')}}</td>
                                            <td>
                                                {{audit_info.CREDIT_SCORE}}
                                            </td>
                                            <td>{{$lang('信用评级(境外公司必填)')}}</td>
                                            <td>
                                                {{audit_info.CREDIT_LEVEL}}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>{{$lang('是否有负面信息')}}</td>
                                            <td>
                                                {{audit_info.IS_HAVE_NAGETIVE_INFO}}
                                            </td>
                                            <td>{{$lang('负面信息项')}}</td>
                                            <td>
                                                <span v-if="audit_info.negative">{{audit_info.negative[0]}}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>{{$lang('风险评级')}}</td>
                                            <td>
                                                {{audit_info.RISK_RATING}}
                                            </td>
                                            <td>{{$lang('审核人')}}</td>
                                            <td>
                                                {{audit_info.REVIEWER}}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>{{$lang('审核时间')}}</td>
                                            <td>
                                                {{audit_info.REV_TIME}}
                                            </td>
                                            <td></td>
                                            <td>
                                                
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>{{$lang('法务备注')}}</td>
                                            <td colspan="3">
                                                {{audit_info.LEGAL_REMARK}}
                                            </td>
                                        </tr>
                                    </table>
                                    <span slot="reference" style="color:#409EFF;cursor: pointer;">{{$lang(form.customer)}}</span>
                                </el-popover>
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('预计销售国家')}}<label :class="{'required':salesOrder && submitDemandType}"></label></td>
                            <td>
                                {{$lang(form.expected_sales_country_val)}}
                            </td>
                            <td>
                                {{$lang('预计销售平台')}}<label :class="{'required':salesOrder && submitDemandType}"></label></label>
                            </td>
                            <td>
                                {{$lang(form.expected_sales_platform_cd_val ? form.expected_sales_platform_cd_val : '非平台销售')}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('框架合同')}}<label :class="{'required':salesOrder && submitDemandType}"></label></td>
                            <td>
                                {{$lang(form.contract)}}
                            </td>
                            <td>
                                {{$lang('我方公司')}}<label :class="{'required':salesOrder && submitDemandType}"></label></label>
                            </td>
                            <td>
                                {{$lang(form.our_company_val)}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('业务类型')}}<label :class="{'required':salesOrder && submitDemandType}"></label></td>
                            <td>
                                {{form.business_mode_val}}
                            </td>
                            <td>{{$lang('客户收货方式')}}<label :class="{'required':salesOrder && submitDemandType}"></label></td>
                            <td>
                                {{form.receive_mode_val}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('发货操作')}}<label :class="{'required':salesOrder && submitDemandType}"></label></label>
                            </td>
                            <td class="nowrap">
                                {{$lang(form.need_warehouse_val)}}
                            </td>
                            <td>
                                {{$lang('客户收货地址')}}
                                <label :class="{'required':salesOrder && submitDemandType}"></label>
                            </td>
                            <td>
                                {{form.receive_country_val}}-{{form.receive_province_val}}-{{form.receive_city_val}}-{{form.receive_address}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('预计销售金额（含税）')}}</td>
                            <td>
                                {{curreneyobj[form.sell_currency]}}  {{allPrice | numberFormat}}
                            </td>
                            <td>
                                {{$lang('销售发货时间')}}<label :class="{'required':salesOrder && submitDemandType}"></label>
                            </td>
                            <td>
                                {{form.ship_date}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('收款周期')}}<label :class="{'required':salesOrder && submitDemandType}"></label>
                            </td>
                            <td>
                                {{$lang(form.collection_cycle_val)}}
                            </td>
                            <td>
                                {{$lang('收款时间')}}<label :class="{'required':salesOrder && submitDemandType}"></label>
                            </td>
                            <td>
                                <div>
                                    <p v-for="(item, index) in form.collection_time_val" :key="index">{{item}}</p>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('【采购部分】销售物流及服务费用（预估）')}}
                            </td>
                            <td class="nowrap">
                                {{form.expense_currency_val}} {{form.expense | numberFormat}}
                            </td>
                            <td>{{$lang('【现货部分】销售物流及服务费用（预估）')}}</td>
                            <td>
                                {{form.expense_currency_spot_val}} {{form.expense_spot | numberFormat}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('【采购部分】销售应缴税')}}
                            </td>
                            <td class="nowrap">
                                {{form.tax_currency_val}} {{form.tax | numberFormat}}
                            </td>
                            <td>{{$lang('【现货部分】销售应缴税')}}</td>
                            <td>
                                {{form.tax_currency_spot_val}} {{form.tax_spot | numberFormat}}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                {{$lang('销售发票')}}<label :class="{'required':salesOrder && submitDemandType}"></label>
                            </td>
                            <td class="nowrap">
                                {{$lang(form.invoice_type_val)}}-{{form.tax_rate_val}}
                            </td>
                            <td>{{$lang('需求截止时间')}}</td>
                            <td>
                                {{form.deadline}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('销售团队')}}<label :class="{'required':submitDemandType}"></label></td>
                            <td>
                                {{form.sell_team_val}}
                            </td>
                            <td>{{$lang('销售同事')}}<label :class="{'required':submitDemandType}"></label></td>
                            <td>
                                {{form.seller}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('返利比例(预估)')}}<label :class="{'required':submitDemandType}"></label></td>
                            <td>
                                {{form.rebate_rate}} %
                            </td>
                            <td>{{$lang('返利金额(预估)')}}<label :class="{'required':submitDemandType}"></label></td>
                            <td>
                                {{curreneyobj[form.sell_currency]}} {{form.rebate_amount}}
                            </td>
                        </tr>
                        <tr>
                            <td>{{$lang('订单备注')}}</td>
                            <td colspan="3">
                                {{form.remark}}
                            </td>
                        </tr>
                         <tr>
                            <td>{{$lang('订单附件')}}</td>
                            <td colspan="3" style="text-align: left;">
                                <span v-for="(item, index) in form.attachment" :key="index"><a style="color: #546E7A;" :href="'/index.php?m=order_detail&a=download&file='+item.save_name">{{item.original_name}}</a>,&nbsp;</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 商品信息 -->
            <div>
                <header>
                    <el-row>
                        <el-col>
                            {{$lang('商品信息')}}
                        </el-col>
                    </el-row>
                </header>
                <el-table border show-header show-summary :summary-method="getSummaries" :data="shopDetailDatas" tooltip-effect="dark" style="width: 100%" class="order-list-table table-common" v-loading="tableLoading">
                    <el-table-column prop="sku_id" :label="$lang('SKUID编码')" width="105"></el-table-column>
                    <el-table-column prop="bar_code" :label="$lang('条形码')" width="105"> </el-table-column>
                    <el-table-column :label="$lang('图片信息')">
                        <template slot-scope="scope">
                            <img :class="{imgStyle: scope.row.guds_img_cdn_addr}" :src="scope.row.guds_img_cdn_addr"  @mouseenter="showImg(scope.$index)" @mouseleave="hiddenImg">
                            <div style="position: absolute; top: -10px; left: 120px; box-shadow: 0 0 5px #536d7a;z-index:99999" v-show="imgShowIndex === scope.$index">
                                <img :src="scope.row.guds_img_cdn_addr" width="300" height="300">
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="goods_name" :label="$lang('商品名称')"></el-table-column>
                    <el-table-column  :label="$lang('SKU信息')">
                            <template slot-scope="scope">
                                    {{scope.row.sku_attribute}}
                                </template>
                    </el-table-column>
                    <el-table-column prop="hotness" :label="$lang('热度评级')"></el-table-column>
                    <el-table-column :label="$lang('需求数量')">
                        <template slot-scope="scope">
                            <span>{{scope.row.require_number}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column  :label="$lang('销售单价（含增值税）')" width="220">
                        <template slot-scope="scope">
                            <span>{{form.sell_currency_val}} {{scope.row.sell_price | numberFormat}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column  :label="$lang('销售单价（不含增值税）')" width="220">
                        <template slot-scope="scope">
                            <span>{{form.sell_currency_val}} {{scope.row.sell_price_not_contain_tax | numberFormat}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="purchase_number" :label="$lang('采购数量')">
                        <template slot-scope="scope">
                            <span>{{scope.row.purchase_number}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('使用现货数量')">
                        <template slot-scope="scope">

                            <div v-if="!!scope.row.spot_warehouse">
                                <p v-show="!!scope.row.spot_warehouse && !!scope.row.spot_warehouse.length" v-for="(item, index) in scope.row.spot_warehouse" :key="index">{{$lang(item.deliveryWarehouseName)}}: {{item.num}}</p>
                            </div>
                            <p v-else>0</p>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('使用在途数量')">
                        <template slot-scope="scope">
                        <div v-if="!!scope.row.on_way_warehouse">
                            <p v-show="scope.row.on_way_warehouse && scope.row.on_way_warehouse.length" v-for="(item, index) in scope.row.on_way_warehouse" :key="index">{{$lang(item.deliveryWarehouseName)}}: {{item.num}}</p>
                        </div>
                            <span v-else>0</span>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('现货&在途成本（退税前）')" width="120">
                        <template slot-scope="scope">
                            <span>￥{{(+scope.row.spot_cost + +scope.row.on_way_cost) | numberFormat}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column :label="$lang('退税')">
                        <template slot-scope="scope">
                            <span>￥{{(+scope.row.spot_drawback + +scope.row.on_way_drawback) | numberFormat}}</span>
                        </template>
                    </el-table-column>
                </el-table>
                
            </div>

            <!-- 待认领中的报价目录 -->
            <div v-show="reportPriceFlag">
                <header>
                    <el-row>
                        <el-col>
                            {{$lang('报价目录')}}
                        </el-col>
                    </el-row>
                </header>
                <el-table border show-header :data="reportPriceDatas" tooltip-effect="dark" style="width: 100%" class="order-list-table table-common" v-loading="tableLoading">
                    <el-table-column prop="quotation_code" :label="$lang('采购单号')" width="200">
                        
                    </el-table-column>
                    <el-table-column prop="purchaser" :label="$lang('采购')"></el-table-column>
                    <!-- <el-table-column prop="ce" :label="$lang('采购CE值')"></el-table-column> -->
                    <el-table-column prop="purchase_team_val" :label="$lang('采购团队&分成')"></el-table-column>
                    <el-table-column :label="$lang('销售团队&分成')">
                    </el-table-column>
                    <el-table-column :label="$lang('介绍团队&分成')">
                        
                    </el-table-column>
                    <el-table-column prop="chosen_val" :label="$lang('中标情况')">
                        
                    </el-table-column>
                    <el-table-column prop="step_val" :label="$lang('报价流程节点')">
                        
                    </el-table-column>
                    <el-table-column  :label="$lang('报价节点状态')">
                            <template slot-scope="scope">
                                    <span>{{$lang(scope.row.status_val)}}</span>
                            </template>
                    </el-table-column>
                    <el-table-column prop="legal_man" :label="$lang('法务审批人')">
                        
                    </el-table-column>
                    <el-table-column :label="$lang('操作')">
                        <template slot-scope="scope">
                            <el-button type="success"  @click="lookOver(scope.row.id)" size="small">{{$lang('查看')}}</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- 纯现货的情况下，增加预估利润表格 -->
            <div v-show="form.is_spot != 2">
                <header>
                    <el-row>
                        <el-col :span="20">
                            {{$lang('现货&在途-预估利润(货币单位：USD)')}}
                        </el-col>
                    </el-row>
                </header>
                <table class="forecast-table" cellpadding="0" cellspacing="0">
                    <tr>
                        <td>{{$lang('收入（合同金额）')}}</td>
                        <td>{{revenue_spot | numberFormat}}</td>
                        <td>{{$lang('收入（缴税后/KPI）')}}</td>
                        <td>{{revenue_after_tax_spot | numberFormat}}</td>
                        <td>{{$lang('应缴税')}}</td>
                        <td>{{tax_spot | numberFormat}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('成本（退税前）')}}</td>
                        <td>{{commodity_cost_spot | numberFormat}}</td>
                        <td>{{$lang('退税')}}</td>
                        <td>{{tax_refund_spot | numberFormat}}</td>
                        <td>{{$lang('成本（退税后）')}}</td>
                        <td>{{cost_after_tax_refund_spot | numberFormat}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('销售物流及服务费用（预估）')}}</td>
                        <td>{{sale_cost_spot | numberFormat}}</td>
                        <td>{{$lang('毛利（退税前）')}}</td>
                        <td>{{gross_profit_spot | numberFormat}}</td>
                        <td>{{$lang('毛利（退税后）')}}</td>
                        <td>{{gross_profit_after_tax_refund_spot | numberFormat}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('毛利率（退税前）')}}</td>
                        <td>{{gross_profit_rate_spot | percentage}}</td>
                        <td>{{$lang('毛利率（退税后）')}}</td>
                        <td>{{gross_profit_rate_after_tax_refund_spot | percentage}}</td>
                        <td>{{$lang('净利润（预估）')}}</td>
                        <td>{{net_profit_spot | numberFormat}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('净利润率（预估）')}}</td>
                        <td>{{net_profit_rate_spot | percentage}}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
            </div>
            <!-- 收款效率表 -->
            <div v-if="form.demand_type === 'N002100200' || form.demand_type === 'N002100201'">
                <header>
                    <el-row>
                        <el-col :span="20">
                            {{$lang('收款效率')}}
                        </el-col>
                    </el-row>
                </header>
                <table class="forecast-table" cellpadding="0" cellspacing="0">
                    <tr>
                        <td class="width-20">{{$lang('本单预计收款天数加权')}}</td>
                        <td>{{dateWeighting}} days</td>
                        <td class="width-20">{{$lang('该客户近三个月平均实际收款天数加权')}}></td>
                        <td>{{form.receivables_day_avg}} days</td>
                    </tr>
                    <tr>
                        <td>{{$lang('本单预计收款天数评级')}}</td>
                        <td>{{dateLevel}}</td>
                        <td>{{$lang('该客户近三个月平均实际收款天数评级')}}</td>
                        <td>{{customerLevel}}</td>
                    </tr>
                </table>
            </div>

            <div>
                <footer>
                    <el-row v-if="buttonStep === 'draft'">
                        <el-col :span="24" style="text-align: center;">
                            <el-button type="warning" style="margin-right: 20px;" @click="editorDemand">{{$lang('编辑需求')}}</el-button>
                            <el-button type="primary" style="margin-left: 20px;" @click="submitDemand">{{$lang('提交需求')}}</el-button>
                            <el-button type="info" style="margin-left: 40px;" plain @click="deleteConfirmFlag = true">{{$lang('删除需求')}}</el-button>
                        </el-col>
                        
                    </el-row>
                    <el-row v-else-if="buttonStep === 'approve'">
                        <el-col :span="24" style="text-align: center;">
                            <el-button type="primary" style="margin-right: 20px;" @click="agree">{{$lang('通过')}}</el-button>
                            <el-button type="info" style="margin-left: 20px;" plain @click="against">{{$lang('退回')}}</el-button>
                        </el-col>
                    </el-row>
                    <el-row v-else-if="buttonStep === 'fail'">
                        <el-col :span="24" style="text-align: center;">
                            <el-button type="warning" style="margin-right: 20px;" @click="dialogWithdraw = true">{{$lang('撤回到需求草稿')}}</el-button>
                            <el-button type="success" v-show="claimFlag" style="margin-right: 20px;" @click="claim">{{$lang('认领需求')}}</el-button>
                            <el-button v-if="!modifyDemandType" type="primary" style="margin-right: 20px;" @click="modify">{{$lang('修改需求')}}</el-button>
                            <el-button type="info" style="margin-left: 20px;" plain @click="giveUp">{{$lang('放弃需求')}}</el-button>
                        </el-col>
                    </el-row>
                    <el-row v-else-if="buttonStep === 'edit'">
                        <el-col :span="24" style="text-align: center;">
                            <el-button type="primary" style="margin-right: 20px;" @click="updateDemand">{{$lang('更新需求')}}</el-button>
                        </el-col>
                    </el-row>
                </footer>
            </div>
            <!-- 撤回到草稿 -->
            <el-dialog :title="$lang('提示')" :visible.sync="dialogWithdraw" width="30%">
                    <div style="padding: 20px 30px;">
                        <span class="required"></span>
                        <el-input type="textarea" :rows="2" :placeholder="$lang('请输入撤回原因')" v-model="modifyReason"> </el-input>
                        <p>撤回后，流程将回退至【待提交需求】节点，清除对应的报价，并给报价关联的采购发邮件通知。确定要撤回需求到草稿吗？</p>
                    </div>
                    <div slot="footer" class="dialog-footer">
                        <el-button :disabled="modifyDisabled" type="warning" @click="modifyDemand">{{$lang('确认修改')}}</el-button>
                        <el-button type="primary" @click="dialogWithdraw = false">{{$lang('再看看')}}</el-button>
                    </div>
            </el-dialog>
            <!-- 批次选择 -->
            <el-dialog title="" width="70%" :visible.sync="dialogTableVisible">
                <el-row>
                   <el-col :span="24"><div class="dialog_title">SKUID:{{skuid}}，BarCode：{{barCode}}，{{$lang('需求数量')}}{{demandFor}}；</div></el-col>
                </el-row>
                <header>
                    <el-row>
                        <el-col :span="24">
                                {{$lang('批次详情')}}
                        </el-col>
                    </el-row>
                </header> 
                <el-table ref="multipleTable" max-height="350" :border="true" :data="batchDatas" show-summary
                 :summary-method="getBatchSummaries" class="order-list-table table-common">
                 <el-table-column property="batch_code" :label="$lang('批次号')"></el-table-column>
                 <el-table-column property="unsalable" :label="$lang('是否滞销')"></el-table-column>
                 <el-table-column  :label="$lang('仓库')">
                     <template scope= "scope">
                         {{$lang(scope.row.warehouse)}}
                     </template>
                 </el-table-column>
                 <el-table-column property="purchase_team" :label="$lang('销售团队')"></el-table-column>
                 <el-table-column property="purchase_order_no" :label="$lang('采购单号')"></el-table-column>
                 <el-table-column property="sell_team" :label="$lang('采购团队')"></el-table-column>
                 <el-table-column property="procurement_date" :label="$lang('采购时间')"></el-table-column>
                 <el-table-column property="storage_time" :label="$lang('入库时间')"></el-table-column>
                 <el-table-column property="deadline_date" :label="$lang('到期日')"></el-table-column>
                 <el-table-column property="unit_price" :label="$lang('批次单价')"></el-table-column>
                 <!-- <el-table-column property="available_for_sale_num" label="可售数量"></el-table-column> -->
                    <el-table-column property="num" :label="$lang('已选数量')"></el-table-column>
                </el-table>
            </el-dialog>

            <!-- 计算方法 -->
            <el-dialog title="$lang('CE评级 & CE值计算方法与规则')" :visible.sync="dialogCalculate">
                <table class="calculate-table" cellpadding="0" cellspacing="0">
                    <tr><td colspan="3">{{$lang('CE公式')}} = Net Margin %/(Purchase Amount(CNY)/200,000+Payment Days)*1000,000</td></tr>
                    <tr>
                        <td rowspan="3">Purchase Amount (CNY)</td>
                        <td>≤100,000</td>
                        <td>100,000</td>
                    </tr>
                    <tr>
                        <td> >100,000 and <1,000,000 </td>
                        <td>Purchase Amount (CNY)</td>
                    </tr>
                    <tr>
                        <td>≥1,000,000</td>
                        <td>1,000,000</td>
                    </tr>
                </table>
                <div>
                    <p class="ceTitle">{{$lang('CE评级 & CE值规则：')}}</p>
                </div>
            </el-dialog>

            <!-- 放弃该需求 -->
            <el-dialog :title="$lang('弃单确认')" :visible.sync="dialogGiveUp">
                <el-row>
                    <el-col :span="24" style="text-align: center;">
                        <el-select class="el-selectOption" style="width: 46%;" :popper-append-to-body="false" v-model="whyGiveUp" :placeholder="$lang('请选择弃单原因')">
                            <el-option v-for="(item, index) in baseData.abandon_demand_reason" :key="index" :label="item.CD_VAL" :value="item.CD"></el-option>
                        </el-select>
                    </el-col>
                </el-row>
                <el-row style="padding: 30px 0;">
                    <el-col :span="24" style="text-align: center;">
                        <el-button type="primary" style="margin-right: 50px;" @click="giveUpConfire">{{$lang('确认弃单')}}</el-button>
                        <el-button type="info" plain style="margin-left: 50px;" @click="giveUpCancel">{{$lang('再看看')}}</el-button>
                    </el-col>
                </el-row>
            </el-dialog>

            <!-- 放弃该需求 -->
            <el-dialog title="$lang('修改确认')" :visible.sync="dialogModify">
                <el-row>
                    <el-col :span="24" style="text-align: center;">
                        <el-select class="el-selectOption" style="width: 46%;" :popper-append-to-body="false" v-model="whyChange" :placeholder="$lang('请选择修改原因')">
                            <el-option v-for="(item, index) in baseData.demand_change_reason" :key="index" :label="item.CD_VAL" :value="item.CD"></el-option>
                        </el-select>
                    </el-col>
                </el-row>
                <el-row style="padding: 30px 0;">
                    <el-col :span="24" style="text-align: center;">
                        <el-button type="primary" style="margin-right: 50px;" @click="modifyConfire">{{$lang('确认修改')}}</el-button>
                        <el-button type="info" plain style="margin-left: 50px;" @click="modifyCancel">{{$lang('再看看')}}</el-button>
                    </el-col>
                </el-row>
            </el-dialog>

             <!-- 退回确认 -->
             <el-dialog title="$lang('退回确认')" :visible.sync="dialogBack">
                <el-row>
                    <el-col :span="24" style="text-align: center;">
                        <el-select class="el-selectOption" style="width: 46%;" v-model="backInfo" :popper-append-to-body="false" :placeholder="$lang('请选择退回原因')">
                            <el-option v-for="(item, index) in baseData.demand_not_approve_reason" :key="index" :label="$lang(item.CD_VAL)" :value="item.CD"></el-option>
                        </el-select>
                    </el-col>
                </el-row>
                <el-row style="padding: 30px 0;">
                    <el-col :span="24" style="text-align: center;">
                        <el-button type="primary" style="margin-right: 50px;" @click="backConfire">{{$lang('确认退回')}}</el-button>
                        <el-button type="info" plain style="margin-left: 50px;" @click="backCancel">{{$lang('再看看')}}</el-button>
                    </el-col>
                </el-row>
            </el-dialog>

            <el-dialog
                :title="$lang('操作确认')"
                :visible.sync="deleteConfirmFlag"
                width="30%">
                <span style="line-height: 60px;padding: 20px 20px 10px;text-align: center">{{$lang('是否确认删除当前草稿，删除以后数据将不可恢复！')}}</span>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="deleteConfirm">{{$lang('确认删除')}}</el-button>
                    <el-button @click="deleteConfirmFlag = false">{{$lang('再看看')}}</el-button>
                </span>
            </el-dialog>
        </div>
        <div v-show="type == 'log'">
            <el-row>
                <el-col :span="6">
                    <div class="">
                        <span>{{$lang('操作时间')}}</span>
                        <el-date-picker style="display:inline-block; width:78%;" v-model="operationTime"
                            value-format="yyyy-MM-dd"
                            type="daterange"
                            range-separator="-"
                            :start-placeholder="$lang('开始日期')"
                            :end-placeholder="$lang('结束日期')">
                        </el-date-picker>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div class="">
                        <span>{{$lang('操作人')}}</span>
                        <el-input style="display:inline-block; width:70%;" v-model="logform.user" :placeholder="$lang('请输入操作人')"></el-input>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div class="">
                        <span>{{$lang('操作简介')}}</span>
                        <el-select style="display:inline-block; width:70%;" v-model="logform.info" :placeholder="$lang('请选择')">
                            <el-option
                                v-for="(item, index) in introDatas"
                                :key="index"
                                :label="$lang(item)"
                                :value="item">
                            </el-option>
                        </el-select>
                    </div>
                </el-col>
            </el-row>
            <el-row>
                <el-button type="primary" @click="query">{{$lang('查询')}}</el-button>
                <el-button type="info" plain @click="reset">{{$lang('重置')}}</el-button>
            </el-row>
            <el-row>
                <el-col style="height: 12px; background-color: #eee;" :span="24"></el-col>
            </el-row>
            <el-table border :data="logData" style="width: 100%" v-loading="logLoding">
                <el-table-column prop="time" :label="$lang('时间')" width="280"></el-table-column>
                <el-table-column prop="user" :label="$lang('操作人')" width="200"></el-table-column>
                <el-table-column  :label="$lang('操作简介')" width="200">
                    <template scope="scope">
                        {{$lang(scope.row.info)}}
                    </template>
                </el-table-column>
                <el-table-column :label="$lang('操作')">
                    <template slot-scope="scope">
                        <span v-if="scope.row.has_detail === '1'" style="color:#409EFF; cursor: pointer;" @click="logDetail(scope.row.id, scope.row.detail_type)">{{$lang('记录详情')}}</span>
                        <span v-else>-</span>
                    </template>

                </el-table-column>
            </el-table>
            <el-pagination background @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page.sync="logform.p" :page-sizes="[10, 30, 50, 100]" :page-size="logform.rows" layout="sizes,prev, pager, next, jumper" :total="totalCount"></el-pagination>
        </div>
    </div>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/utils/utils.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.2.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
    <script>
        if(getCookie('think_language') !== "zh-cn" ){
            ELEMENT.locale(ELEMENT.lang.en)
        }
        var stockRequire = ["ship_date", "seller", "sell_team", "deadline"],
            stockDsc = ["发货时间", "销售同事", "销售团队", "截止时间"],
            sellRequire = ["customer", "our_company", "business_mode", "receive_mode", "need_warehouse", "receive_country", "receive_province", "receive_address", "sell_currency", "sell_amount", "ship_date", "collection_cycle", "collection_time", "invoice_type", "tax_rate", "expense_currency", "expense", "tax_currency", "tax", "seller", "sell_team"];
            sellRequireDsc = ["客户名称", "我方公司", "业务类型", "客户收货方式", "发货操作", "国家", "省/市", "详细地址", "销售币种", "销售金额", "发货时间", "收款周期", "收款时间", "发票类型", "税点", "物流服务费用币种", "物流服务费用", "税额币种", "税额", "销售同事", "销售团队" ],
            sellGoods = ["search_id", "require_number", "purchase_number", "auth_and_link"],
            sellGoodsDsc = ["商品搜索ID", "需求数量", "采购数量", "授权和链路要求"];
        var OPTION = { lock: true, };
        var NOWDATETIME = new Date().getTime();
        var demand = new Vue({
            el: '#demand',
            data: {
                type: 　"detail",
                tableLoading: true,
                reportPriceDatas: [],
                getCd: [],
                baseData: {},
                currentStep: 0,
                stepFlag: false,
                stepIndex: '',
                failOrGiveUp: '',
                redFlag: false,
                buttonStep: "",
                draftFlag: false,
                spotFlag: false,
                form: {},
                audit_info: {}, // 客户审核详情
                dialogTableVisible: false,
                dialogCalculate: false,
                dialogModify: false,
                dialogBack: false,
                deleteConfirmFlag: false,
                currentState: "process",
                failState: false,
                claimFlag: false,
                dialogGiveUp: false,
                reportPriceFlag: true,
                whyGiveUp: "",
                whyChange: '',
                backInfo: '',
                shopDetailDatas: [],
                batchDatas: [],
                skuid: '',
                barCode: '',
                demandFor: '',
                imgShowIndex: '',
                allPrice: '',
                curreneyobj: {'': ''},
                exchangerate: {},

                //日志部分
                operationTime: '',
                logLoding: false,
                introDatas: [],
                progressDatas: [],
                logData: [],
                totalCount: 0,
                logform: {
                    demand_id: '',
                    begin_time: '',
                    end_time: '',
                    user: '',
                    info: '',
                    rows: 10,
                    p: 　1,
                },
                submitDemandType: false,//提交需求后的编辑状态
                salesOrder: true,  //销售订单
                modifyDemandType: false, //修改需求按钮展示状态
                countries: [],
                provinceLoading: false,
                cityLoading: false,
                contractLoading: false,
                provinces: [],
                citys: [],
                contract: [],
                upFileList: [],
                contryFlag: false,
                provinceFlag: false,
                dialogWithdraw:false,//撤回草稿弹框
                modifyReason:'',//撤回草稿数据
                modifyDisabled:false,
                picksBefore: {
                    disabledDate(item) {
                        return item.getTime() < (Date.now() - 24 * 60 * 60 * 1000);
                    }
                },
                queryPost: function (url, param) {
                    var headers = {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }
                    return axios.post(url, Qs.stringify(param), headers);
                }
            },
            created: function () {
                this._ajax(this.getSteps(), this.getDetailDatas(getQueryString("type")), this.getExchangeRate());
            },
            methods: {
                _ajax: function (a, b, c) {
                    var _this = this;
                    axios.all([a, b, c]).then(axios.spread((cds, detail, rate) => {
                        _this.tableLoading = false;
                        if (detail.data.code === 2000 && cds.data.code === 2000) {
                            _this.baseData = cds.data.data;
                            _this.form = detail.data.data.demand;
                            _this.audit_info = detail.data.data.audit_info;
                            var _attachmentArray = _this.form.attachment || [];

                            for (var q = 0, len = _attachmentArray.length; q < len; q++) {
                                var _obj_ = {
                                    name: _attachmentArray[q].original_name,
                                    url: ""
                                };
                                _this.upFileList.push(_obj_);
                            };

                            if (_this.form.is_purchase_only === "1") {
                                _this.form.contract = '无框架合同';
                            };

                            for (var o = 0, _len = _this.baseData.currency.length; o < _len; o++) {
                                _this.$set(_this.curreneyobj, _this.baseData.currency[o].CD, _this.baseData.currency[o].CD_VAL)
                            };

                            _this.reportPriceDatas = detail.data.data.quotation || [];

                            if (detail.data.data.goods) {
                                for (var i = 0, len = detail.data.data.goods.length; i < len; i++) {
                                    if (detail.data.data.goods[i].spot_batch == null) {
                                        _this.$set(detail.data.data.goods[i], "spot_batch", []);
                                    };
                                };
                                _this.shopDetailDatas = detail.data.data.goods;
                            };


                            if (detail.data.data.demand.is_spot === "1") {// 是否纯现货
                                cds.data.data.scm_step.splice(1, 2);
                                this.reportPriceFlag = false;
                                _this.getCd = cds.data.data.scm_step;

                                _this.spotFlag = true;

                            } else {
                                _this.getCd = cds.data.data.scm_step;
                            };



                            for (var i = 0, len = _this.getCd.length; i < len; i++) {
                                if (detail.data.data.status_list.step === _this.getCd[i].CD) {// 查看当前进度
                                    _this.currentStep = i;
                                };
                            };


                            if (detail.data.data.status_list.step === "N002120100") {
                                //草稿状态
                                _this.buttonStep = 'draft';
                            } else if (detail.data.data.status_list.step === "N002120200") {
                                //需求审批
                                _this.draftFlag = true;
                                _this.buttonStep = 'approve';
                                _this.stepFlag = true;
                            } else if (detail.data.data.status_list.step === "N002120300") {
                                //需求认领
                                _this.draftFlag = true;
                                _this.buttonStep = 'fail';
                                _this.stepFlag = true;
                                _this.claimFlag = true;
                            };

                            if (detail.data.data.demand.status === "N002130500") {// 失败状态
                                // _this.currentState = "error";
                                _this.stepIndex = _this.currentStep;
                                _this.redFlag = true;
                                _this.buttonStep = 'fail';
                                _this.claimFlag = false;
                            } else if (detail.data.data.demand.status === "N002130700") {// 弃单状态
                                _this.stepIndex = _this.currentStep;

                                _this.redFlag = true;

                                _this.buttonStep = '';

                                _this.stepFlag = true;

                                _this.failOrGiveUp = "giveUp";
                            };

                            var step = detail.data.data.status_list.step;

                            //总进度=待采购认领&销售进度=无需处理 || 总进度=待销售提交&销售进度=未处理（隐藏按钮）
                            _this.modifyDemandType = (step == 'N002120300' && this.form.status == 'N002130400') || (step == 'N002120600' && this.form.status == 'N002130300');
                        } else {
                            if (detail.data.code !== 2000) {
                                _this.$message.error(_this.$lang(detail.data.msg));
                                return;
                            };
                            _this.$message.error(_this.$lang('请求失败'));
                        };
                        
                        if (rate.data.code === 2000) {
                            _this.exchangerate = rate.data.data.exchange_rate;
                        };

                    })).catch(function (err) {
                        console.log(err);
                    });
                },
                getExchangeRate: function () {
                    return this.queryPost("/index.php?g=common&m=index&a=exchange_rate");
                },
                showImg: function (index) {
                    this.imgShowIndex = index;
                },
                hiddenImg: function () {
                    this.imgShowIndex = '';
                },
                lookOver: function lookOver(lookOverId) {
                    //需求列表--报价目录 点击查看跳转方法
                    newTab("/index.php?g=scm&m=display&a=purchases&type=" + lookOverId, this.$lang('采购详情'));
                },
                getSteps: function () {
                    let param = {
                        cd_type: {
                            scm_step: false,
                            abandon_demand_reason: false,
                            demand_not_approve_reason: false,
                            demand_change_reason: false,
                            our_company: false,
                            delivery_type: false,
                            sell_demand_type: false,
                            business_type: false,
                            currency: false,
                            collection_cycle: false,
                            collection_node: false,
                            payment_days: false,
                            collection_days_type: false,
                            invoice_type: false,
                            tax_rate: false,
                            sell_team: false,
                            sell_order_source: false,
                            payment_node: false,
                            auth_and_link: false
                        }
                    };
                    return this.queryPost("/index.php?g=common&m=index&a=get_cd", param);
                },
                getDetailDatas: function (id) {
                    return this.queryPost("/index.php?g=scm&m=demand&a=demand_detail", { id: id });
                },
                stepValue: function (item, index) {
                    return item === "成功结束" ? item : item.substr(1);
                },
                selectBatch: function (index, row) {
                    this.batchDatas = row.spot_batch;
                    this.skuid = row.sku_id;
                    this.barCode = row.bar_code;
                    this.demandFor = row.require_number;

                    this.dialogTableVisible = true;
                },
                editorDemand: function () {
                    backTab("/index.php?g=scm&m=display&a=demand_detail&type=" + getQueryString("type"), "编辑需求");
                },
                submitDemand: function () {

                    if ((this.formatAllPrice(this.form.sell_amount) !== this.formatAllPrice(this.allPrice)) && this.allPrice) {
                        this.$message.warning(this.$lang('预计销售金额与目标售价总和不相等'));
                        return;
                    };
                    var profits = {
                        revenue_spot: this.revenue_spot,
                        revenue_after_tax_spot: this.revenue_after_tax_spot, 
                        commodity_cost_spot: this.commodity_cost_spot,
                        tax_refund_spot: this.tax_refund_spot,
                        cost_after_tax_refund_spot: this.cost_after_tax_refund_spot,
                        tax_spot: this.tax_spot,
                        sale_cost_spot: this.sale_cost_spot,
                        gross_profit_spot: this.gross_profit_spot,
                        gross_profit_after_tax_refund_spot: this.gross_profit_after_tax_refund_spot,
                        gross_profit_rate_spot: this.gross_profit_rate_spot,
                        gross_profit_rate_after_tax_refund_spot: this.gross_profit_rate_after_tax_refund_spot,
                        net_profit_spot: this.net_profit_spot,
                        net_profit_rate_spot: this.net_profit_rate_spot,
                    };
                    
                    if (this.form.is_spot == 1) {
                        profits.days_of_receivables = this.dateWeighting;
                        profits.receivables_efficiency = this.dateLevel;
                        profits.average_days_of_receivables = this.customerWeighting;
                        profits.average_receivables_efficiency = this.customerLevel;
                    };

                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_submit", { id: getQueryString("type"), profit: profits }).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.$message.success(this.$lang('提交成功'));
                            if (this.form.is_spot == 1) {
                                backTab("/index.php?g=scm&m=display&a=demands&type=" + getQueryString("type"), this.$lang("需求详情"));
                            }else{
                                backTab("/index.php?g=scm&m=display&a=demand_draft&type=" + getQueryString("type"), this.$lang("需求详情"));
                            }
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };

                    });
                },
                formatAllPrice: function (pr) {
                    pr = pr + "";
                    var arr = pr.split(".");
                    if (!arr[1]) {
                        return pr;
                    };
                    if (arr[1] === "00") {
                        return arr[0];
                    } else if (arr[1].substr(1) === "0") {
                        return pr.substr(0, pr.length - 1);
                    } else {
                        return pr;
                    };
                },
                deleteConfirm: function () {
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_delete", { id: getQueryString("type") }).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.$message.success(this.$lang('删除成功'));
                            //关闭当前页面
                            closeTab();
                            // backTab("/index.php?g=scm&m=display&a=demand_list", this.$lang("需求列表"));
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    });
                },
                // 审批退回
                _approveAjax: function (_param) {
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_approve", _param).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.$message.success("$lang('操作成功')");
                            this.dialogBack = false;
                            window.location.reload()
                            // backTab("/index.php?g=scm&m=display&a=demand_list", this.$lang("需求列表"));
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    });
                },
                against: function () {// 退回
                    this.dialogBack = true;
                },
                agree: function () {// 通过
                    var _params = { id: getQueryString("type"), status: "1" };
                    this._approveAjax(_params);
                },
                backConfire: function () {// 确认退回
                    if (!this.backInfo) {
                        return;
                    };
                    var _params = { id: getQueryString("type"), status: "0", reason: this.backInfo };
                    this._approveAjax(_params);
                },
                backCancel: function () {// 取消退回
                    this.dialogBack = false;
                },
                // 预估利润
                showCalculateMethod: function () {
                    this.dialogCalculate = true;
                },
                // 审批失败状态
                modify: function () {// 修改需求
                    this.dialogModify = true;
                },
                giveUp: function () {// 放弃该需求
                    this.dialogGiveUp = true;
                },
                modifyConfire: function () {//修改确认
                    if (!this.whyChange) {
                        this.$message.warning(this.$lang('请选择修改原因'));
                        return;
                    };
                    this.queryPost("/index.php?g=scm&m=demand&a=return_to_draft", { id: getQueryString("type"), reason: this.whyChange }).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.dialogGiveUp = false;
                            window.location.reload();
                            // backTab("/index.php?g=scm&m=display&a=demand_detail&type=" + getQueryString("type"), "编辑需求");
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    });
                },
                modifyCancel: function () {//修改取消
                    this.whyChange = "";
                    this.dialogModify = false;
                },
                giveUpConfire: function () {// 确认弃单
                    if (!this.whyGiveUp) {
                        this.$message.warning(this.$lang('请选择弃单原因'));
                        return;
                    };
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_discard", { id: getQueryString("type"), info: this.whyGiveUp }).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.$message.success(this.$lang('弃单成功'));
                            this.dialogGiveUp = false;
                            window.location.reload();
                            // backTab("/index.php?g=scm&m=display&a=demand_list", this.$lang("需求列表"));
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    });
                },
                giveUpCancel: function () {
                    this.dialogGiveUp = false;
                },
                //待认领
                claim: function () {
                    backTab("/index.php?g=scm&m=display&a=procurement_claim&type=" + getQueryString("type"), this.$lang("创建认领"));
                },

                getSummaries: function () {
                    var sums = [this.$lang('合计')];

                    var _sum1 = 0,
                        _sum2 = 0,
                        _sum3 = 0,
                        _sum4 = 0;
                        _sum5 = 0;
                        _sum6 = 0;
                        _sum7 = 0;
                        _sum8 = 0;
                    for (var i = 0; i < this.shopDetailDatas.length; i++) {
                        if (this.shopDetailDatas[i].require_number) {
                            _sum1 += (this.shopDetailDatas[i].require_number - 0);
                        };

                        if (this.shopDetailDatas[i].sell_price && this.shopDetailDatas[i].require_number) {
                            _sum2 += (this.shopDetailDatas[i].sell_price * this.shopDetailDatas[i].require_number);
                        };
                        
                        if (this.shopDetailDatas[i].sell_price && this.shopDetailDatas[i].require_number) {
                            _sum3 += (this.shopDetailDatas[i].sell_price_not_contain_tax * this.shopDetailDatas[i].require_number);
                        };

                        if (this.shopDetailDatas[i].purchase_number) {
                            _sum4 += (this.shopDetailDatas[i].purchase_number - 0);
                        };
                        
                        if (this.shopDetailDatas[i].spot_number) {
                            _sum5 += (this.shopDetailDatas[i].spot_number - 0);
                        };

                        if (this.shopDetailDatas[i].on_way_number) {
                            _sum6 += (this.shopDetailDatas[i].on_way_number - 0);
                        };

                        if (this.shopDetailDatas[i].spot_cost) {
                            _sum7 += (+this.shopDetailDatas[i].spot_cost + +this.shopDetailDatas[i].on_way_cost);
                        };

                        if (this.shopDetailDatas[i].spot_drawback) {
                            _sum8 += (this.shopDetailDatas[i].spot_drawback - 0) + (this.shopDetailDatas[i].on_way_drawback - 0);
                        };

                    };
                    this.allPrice = _sum2.toFixed(2);
                    sums[6] = _sum1;
                    sums[7] = (this.curreneyobj[this.form.sell_currency] || '') + " " + this.$options.filters.numberFormat(_sum2);
                    sums[8] = (this.curreneyobj[this.form.sell_currency] || '') + " " + this.$options.filters.numberFormat(_sum3);
                    sums[9] = _sum4;
                    sums[10] = _sum5;
                    sums[11] = _sum6;
                    sums[12] = '￥' + _sum7.toFixed(2);
                    sums[13] = '￥' + _sum8;


                    return sums;
                },
                getBatchSummaries: function () {
                    var sums = [this.$lang('合计')];
                    var _sum1 = 0,
                        // _sum2 = 0,
                        _sum3 = 0;
                    for (var i = 0; i < this.batchDatas.length; i++) {

                        if (this.batchDatas[i].num) {
                            _sum3 += (this.batchDatas[i].num - 0);
                        };

                    };

                    sums[9] = "RMB";
                    sums[10] = _sum3;
                    return sums;
                },
                route: function (title, _html, type, type_id) {
                    var dom = document.createElement("a"),
                        _href = "/index.php?g=scm&m=display&a=" + _html + "&type=" + type + "&type_id=" + type_id;
                    dom.setAttribute("onclick", "opennewtab(this,'" + title + "')");
                    dom.setAttribute("_href", _href);
                    dom.click();
                },

                //日志部分
                detail: function () {
                    this.type = "detail";
                },
                log: function () {

                    // 获取操作简介
                    this.queryPost("/index.php?g=scm&m=log&a=log_info_list").then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.introDatas = _data.data;
                        };
                    });

                    this._logAjax();
                    this.type = "log";
                },
                _logAjax: function () {
                    this.logform.demand_id = getQueryString("type");
                    this.logLoding = true;
                    this.queryPost("/index.php?g=scm&m=log&a=log_list", this.logform).then((res) => {
                        this.logLoding = false;
                        var _data = res.data;
                        if (_data.code === 2000) {
                            this.logData = _data.data.list;
                            this.totalCount = _data.data.page.total_rows - 0;
                        };
                    });
                },
                handleSizeChange: function (size) {
                    this.logform.rows = size;
                    this._logAjax();
                },
                handleCurrentChange: function (currentPage) {
                    this.logform.p = currentPage;
                    this._logAjax();
                },
                logDetail: function (id, type_id) {
                    this.route(this.$lang("记录详情"), "logdetail", id, type_id);
                    // backTab("/index.php?g=scm&m=display&a=logdetail&type=" + id + "&type_id=" + type_id, "记录详情");

                },
                query: function () {
                    this._logAjax();
                },
                reset: function () {
                    this.operationTime = '';
                    this.logform = {
                        demand_id: '',
                        begin_time: '',
                        end_time: '',
                        user: '',
                        info: '',
                        rows: 10,
                        p: 　1,
                    };
                    this._logAjax();
                },
                iconReturn: function (index) {
                    return index === this.stepIndex ? (this.failOrGiveUp === "giveUp" ? "el-icon-warning red" : "el-icon-error red") : '';
                },
                //需求提交时的编辑需求
                editRequire: function () {
                    backTab("/index.php?g=scm&m=display&a=demand_detail&type=" + getQueryString("type"), "编辑需求");
                },
                modifyDemand: function () {
                    var _this = this;
                    if (!this.modifyReason) {
                        _this.$message.error(_this.$lang('请输入撤回原因'));
                        return false;
                    }
                    axios.post('/index.php?g=scm&m=demand&a=checkPredestinateNum',{demand_code: this.form.demand_code}).then(res => {
                        console.log(res)
                        // return false;
                        if (res.data.code === 200) {
                            this.queryModifyDemand()
                        } else {
                            this.$confirm('检测到所选在途库存数量有变动，撤回后将清空所有SKU的在途/现货库存选择数量，请重新选择, 是否继续?', '提示', {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                                }).then(() => {
                                    this.queryModifyDemand();
                                }).catch(() => {
                                this.$message({
                                    type: 'info',
                                    message: '已取消操作'
                                });          
                            });
                        }
                    })
                    
                },
                queryModifyDemand() {
                    this.modifyDisabled = true
                    var param = {
                        id: this.form.id,
                        reason: this.modifyReason
                    };
                    this.dialogWithdraw = false;
                    var _this = this;
                    axios.post('/index.php?g=scm&m=demand&a=return_to_draft', Qs.stringify(param))
                        .then(function (res) {
                            if (res.data.code == 2000) {
                                _this.$message.success(_this.$lang('修改成功'));
                                backTab("/index.php?g=scm&m=display&a=demand_draft&type=" + _this.form.id, _this.$lang("需求详情"));
                            } else {
                                _this.$message.error(_this.$lang(res.data.msg));
                            }
                        });
                },
                querySearchAsync(queryString, cb) {
                    if (!queryString) {
                        return;
                    };
                    var results = [];
                    this.queryPost("/index.php?g=common&m=index&a=search_customer_or_supplier", {
                        supplier_id: queryString,
                        type: '1'
                    }).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            results = _data.data.map(function (item, index) {
                                return {
                                    name: item.SP_NAME,
                                    value: item.SP_CHARTER_NO
                                }
                            });
                            cb(results);
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });

                },
                handleSelect: function (item) {
                    this.form.customer = item.name;
                    this.form.customer_charter_no = item.value;
                    this.contractLoading = true;
                },
                querySearchSeller: function (qs, cb) {
                    if (!qs) {
                        return;
                    };
                    this.queryPost("/index.php?g=common&m=user&a=search_user", {
                        name: qs
                    }).then((res) => {
                        var _data = res.data;
                        if (_data.code === 2000) {
                            if (_data.data) {
                                cb(_data.data);
                            };
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    })
                },
                focusSeller: function () {
                    this.selectSellerFlag = false;
                },
                blurSeller: function () {
                    if (!this.selectSellerFlag) {
                        this.form.seller = '';
                    };
                },
                handleSelectSeller: function (item) {
                    this.selectSellerFlag = true;
                },
                beforeUpload: function (file) {
                    for (var i = 0, len = this.form.attachment.length; i < len; i++) {
                        if (this.form.attachment[i].original_name === file.name) {
                            this.$message.warning(this.$lang('该文件已上传'));
                            return false;
                        };
                    };
                },
                upProgress: function (file) {
                    if (file.status === "success") {
                        if (file.response.status === 1) {

                            this.form.attachment.push({
                                original_name: file.response.info.name,
                                save_name: file.response.info.savename
                            });
                        } else {
                            this.$message.error(this.$lang('此文件上传失败'));
                        };
                    };
                },
                removeList: function (file) {
                    if (file.status === "success") {
                        for (var i = 0, len = this.form.attachment.length; i < len; i++) {
                            if (this.form.attachment[i].original_name === file.response.info.name) {
                                this.form.attachment.splice(i, 1);
                            };
                        };
                    };
                },
                //提交需求
                updateDemand: function () {
                    //校验数据是否为空
                    var res = this.validations(this.form,this.shopDetailDatas);
                    if (!res) {
                        return false;
                    }
                    this.form.goods = this.shopDetailDatas;
                    this.form.is_submit = 1;
                    this.$loading(OPTION);
                    this.queryPost("/index.php?g=scm&m=demand&a=demand_save", this.form).then((res) => {
                        this.$loading(OPTION).close();
                        var _data = res.data;
                        if (_data.code === 2000) {
                            window.location.reload();
                            backTab("/index.php?g=scm&m=display&a=demand_list", this.$lang("需求列表"));
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        };
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                // 提交数据验证
                validations: function (obj,goods) {
                    var _this = this;
                    if (obj.demand_type === "N002100200" || obj.demand_type === 'N002100201') {
                        for (var i = 0; i < sellRequire.length; i++) {
                            if (!this.form[sellRequire[i]]) {
                                this.$message.warning(sellRequireDsc[i] + '为必填项');
                                return false;
                            }
                        }
                    } else {
                        for (var i = 0, len = stockRequire.length; i < len; i++) {
                            if (!obj[stockRequire[i]]) {
                                this.$message.warning(stockDsc[i] + "为必填项");
                                return false;
                            };
                        };
                    }

                    if (!goods[0].sku_id) {
                        this.$message.warning(this.$lang('请导入商品'));
                        return false;
                    } else {
                        for (var j = 0; j < goods.length; j++) {
                            for (var k = 0; k < sellGoods.length; k++) {
                                if (!goods[j][sellGoods[k]]) {
                                    _this.$message.warning(sellGoodsDsc[k] + "不能为空");
                                    return false;
                                };
                            };
                        };
                    };

                    return true;
                },
                getAdress: function (id, _arr, load) {
                    var _this = this;    
                    load && (this[load] = true);
                    this.queryPost("/index.php?g=common&m=index&a=get_address", {
                        pid: id
                    }).then(function (res) {
                        load && (_this[load] = false);
                        var _data = res.data;
                        if (_data.code === 2000) {
                            _this[_arr] = _data.data;
                        } else {
                            _this.$message.error(_this.$lang(_data.msg));
                        }
                    });
                },
                //返利比例求返利金额
                getAmount: function (){
                    if(this.form.rebate_rate && this.form.rebate_rate > 0){
                        this.form.rebate_rate = Math.floor(Number(this.form.rebate_rate) * 100) / 100;
                        this.form.rebate_amount = (this.form.rebate_rate * Number(this.allPrice) / 100).toFixed(2);
                    }else{
                        this.form.rebate_rate = 0;
                        this.form.rebate_amount = '0.00';
                    }
                },
            },
            computed: {
                revenue_spot: function () {
                    var _goods = this.shopDetailDatas || [];
                    var _this = this;
                    var val = _goods.reduce(function (init, item) {
                        if (item.require_number) {
                            return init + (item.sell_price * (item.require_number - (+item.purchase_number)));
                        };
                    }, 0);
                    return utils.conversionRate(_this.exchangerate, _this.curreneyobj[_this.form.sell_currency], val, 'USD');
                },
                revenue_after_tax_spot: function () {
                    var val = this.revenue_spot - utils.conversionRate(this.exchangerate, this.curreneyobj[this.form.tax_currency_spot], this.form.tax_spot, 'USD')
                    return val || '0.00';
                },
                commodity_cost_spot: function () {
                    var _goods = this.shopDetailDatas || [];
                    var sums = 0;
                    for (var i = 0, len = _goods.length; i < len; i++) {
                        var batchs = _goods[i].spot_batch;
                        var onWays = _goods[i].on_way_batch || [];
                        for (var j = 0, jlen = batchs.length; j < jlen; j++) {
                            var price = batchs[j].unit_price || 0;
                            sums += batchs[j].num * utils.conversionRate(this.exchangerate, 'CNY', price, 'USD');
                        };
                        for (var j = 0, jlen = onWays.length; j < jlen; j++) {
                            var price = onWays[j].unitPrice || 0;
                            sums += onWays[j].selectNum * utils.conversionRate(this.exchangerate, 'CNY', price,
                                'USD');
                        };
                    };
                    return sums;
                },
                tax_refund_spot:function(){
                    var _goods = this.shopDetailDatas,sums = 0;
                    for (var i = 0, len = _goods.length; i < len; i++) {
                        sums += utils.conversionRate(this.exchangerate, 'CNY', _goods[i].spot_drawback, 'USD') + utils.conversionRate(this.exchangerate, 'CNY', _goods[i].on_way_drawback, 'USD');
                    }
                    return sums;
                },
                cost_after_tax_refund_spot:function(){
                    return +(this.commodity_cost_spot  - this.tax_refund_spot).toFixed(2);
                },
                tax_spot: function () {
                    return utils.conversionRate(this.exchangerate, this.curreneyobj[this.form.tax_currency_spot], this.form.tax_spot, 'USD') || '0.00';
                },
                sale_cost_spot: function () {
                    return parseFloat(utils.conversionRate(this.exchangerate, this.curreneyobj[this.form.expense_currency_spot], this.form.expense_spot, 'USD') + this.revenue_spot * this.form.rebate_rate * 0.01) || '0.00';
                },
                gross_profit_spot: function () {
                    return this.revenue_after_tax_spot - this.commodity_cost_spot;
                },
                gross_profit_after_tax_refund_spot: function () {
                    return +(this.gross_profit_spot + this.tax_refund_spot).toFixed(2);
                },
                gross_profit_rate_spot: function () {
                    if (!+this.revenue_after_tax_spot) {
                        return '0.00%'
                    };
                    return +this.gross_profit_spot.toFixed(2) / Math.abs(this.revenue_after_tax_spot);
                },
                gross_profit_rate_after_tax_refund_spot: function () {
                    if (!+this.gross_profit_after_tax_refund_spot) {
                        return '0.00%'
                    };
                    return +this.gross_profit_after_tax_refund_spot.toFixed(2) / Math.abs(this.revenue_after_tax_spot);
                },
                net_profit_spot: function () {
                    return this.gross_profit_after_tax_refund_spot - this.sale_cost_spot
                },
                net_profit_rate_spot: function () {
                    if (!+this.revenue_after_tax_spot) {
                        return '0.00%'
                    };
                    return +this.net_profit_spot.toFixed(2) / Math.abs(this.revenue_after_tax_spot);
                },
                // 收款效率
                dateWeighting: function () {
                    // 收款日期加权
                    var collections = this.form.collection_time;
                    if (!collections[0].date || !collections[0].percent) {
                        return;
                    };
                    var wei = collections.reduce(function (init, item) {
                        return init + getDate(item.date) * item.percent / 100;
                    }, 0);

                    return transformDays(wei.toFixed(0) - NOWDATETIME);

                },
                dateLevel: function () {
                    if (!this.dateWeighting) {
                        return;
                    };
                    var dateNum = this.dateWeighting - 0;
                    if (dateNum <= 20) {
                        return "A";
                    } else if (dateNum <= 30) {
                        return "B";
                    } else if (dateNum <= 40) {
                        return "C";
                    } else if (dateNum <= 60) {
                        return "D";
                    } else {
                        return "F";
                    };
                },
                customerLevel: function () {
                    if (this.form.receivables_day_avg === null || this.form.receivables_day_avg === undefined) {
                        return;
                    };
                    var avg = this.form.receivables_day_avg - 0;
                    
                    if (avg <= 20) {
                        return "A";
                    } else if (avg <= 30) {
                        return "B";
                    } else if (avg <= 40) {
                        return "C";
                    } else if (avg <= 60) {
                        return "D";
                    } else {
                        return "F";
                    };
                },
            },
            watch: {
                operationTime: function (newVal) {
                    if (newVal.length) {
                        this.logform.begin_time = newVal[0];
                        this.logform.end_time = newVal[1];
                    };
                },
                allPrice: function (val) {
                    this.getAmount();
                },
                'form.customer_charter_no': function (newVal) {
                    this.queryPost("/index.php?m=order_detail&a=getContract", {
                        sp_charter_no: newVal
                    }).then((res) => {
                        var _data = res.data;
                        this.contractLoading = false;
                        if (_data.status === 1) {
                            this.contract = _data.data;
                        } else {
                            this.$message.error(this.$lang(_data.msg));
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                },
                'form.receive_country': function (newVal) {
                    if (this.contryFlag) {
                        this.form.receive_province = '';
                        this.getAdress(newVal, 'provinces', 'provinceLoading');
                    };
                    this.contryFlag = true;
                },
                'form.receive_province': function (newVal) {
                    if (this.provinceFlag) {
                        this.form.receive_city = '';
                        this.getAdress(newVal, 'citys', 'cityLoading');
                    };
                    this.provinceFlag = true;
                },
            },
            filters: {
                numberFormat: function (num, flag) {
                    if (!num || num == 'NaN') {
                        return 0;
                    };
                    num = !flag ? (num - 0).toFixed(2) : num + '';
                    return num.replace(/(\d)(?=(\d{3})+\.)/g, function ($0, $1) {
                        return $1 + ',';
                    }).replace(/\.$/, '');
                },
                percentage:function(val){
                    return (parseFloat(val||0) * 100).toFixed(2) + '%';
                }
            }
        });

        //获取连接参数
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        };
        //获取时间
        function getDate (date){ return +new Date(date).getTime()};
        //转换成天数
        function transformDays (millisecond) {return Math.ceil(millisecond/(24 * 60 * 60 * 1000))};
    </script>
</body>

</html>