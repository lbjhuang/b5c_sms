<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/Application/Tpl/Home/Public/css/app_version_control.css">
    <link rel="stylesheet" href="/Application/Tpl/Home/Public/css/default.css">
    <script type="text/javascript" src="/Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="/Application/Tpl/Home/Public/js/modernizr.js"></script>
</head>

<body>
    <!-- 遮罩层 -->
    <div id="mask"></div>

    <h1>APP版本维护及更新日志</h1>
    <div class="app-version-main">
        <button class="create-new">新建发布</button>
        <h3>
            <span>APP:</span>
            <ul class="app-lists">
                <li class="erp-app-state active-state">ERP APP</li>
                <li class="gshopper-app-state active-state">Gshopper APP</li>
            </ul>
        </h3>
        <section id="cd-timeline" class="cd-container">
            <!-- 内容模块 start -->
            <foreach name="appList" item="app">
                <div class="app-view-item cd-timeline-block show-item">
                    <div class="cd-timeline-img <{$app.type}>-item">
                        <{$app.type}>
                    </div>
                    <!-- cd-timeline-img -->
                    <div class='cd-timeline-content' data-id="<{$app.id}>">
                        <h3>
                            发布时间：
                            <span class="publish-time">
                                <{$app.create_time}>
                            </span>
                            <br> 更新时间：
                            <span class="update-time">
                                <{$app.updated_time}>
                            </span>
                            <button class="edit-btn">编辑</button>
                        </h3>
                        <div class="app-info-content">
                            <ul>
                                <li>
                                    <span class="app-info-name">APP名称:</span>
                                    <span class="app-info-value app-name-value">
                                        <{$app.type}>
                                    </span>
                                </li>
                                <li>
                                    <span class="app-info-name">APP系统:</span>
                                    <span class="app-info-value app-system-value">
                                        <{$app.system}>
                                    </span>
                                </li>
                                <li>
                                    <span class="app-info-name">APP发布市场:</span>
                                    <span class="app-info-value app-publish-market"><{$app.platform}></span>
                                </li>
                                <li>
                                    <span class="app-info-name">APP版本:</span>
                                    <span class="app-info-value app-version-value">
                                        <{$app.version}>
                                    </span>
                                </li>
                                <li>
                                    <span class="app-info-name">APP下载链接:</span>
                                    <ul class="app-info-value">
                                        <li>
                                            <span class="app-platform">
                                                <{$app.system}>
                                            </span>:
                                            <span class="app-download-url">
                                                <{$app.download}>
                                            </span>
                                        </li>
                                        <li>
                                            <img src="//<{$domain}>/index.php?g=universal&m=appVer&a=makeQrCode&text=<{$app.qrUrl}>">
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <span class="app-info-name">APP强制更新:</span>
                                    <span class="app-info-value app-force-update">
                                        <{$app[ 'is_force'] ? '是' : '否'}>
                                    </span>
                                </li>
                                <li>
                                    <span class="app-info-name">适合更新版本:</span>
                                    <span class="app-info-value app-suggest-version">
                                        <{$app.suitable}>
                                    </span>
                                </li>
                                <li>
                                    <span class="app-info-name fl">更新内容:</span>
                                    <div class="app-info-value app-update-value">
                                        <{$app.update_desc}>
                                    </div>
                                </li>
                            </ul>
                            </di>
                        </div>
                    </div>
                </div>
                <!-- 内容模块 end -->
            </foreach>
        </section>
    </div>

    <!-- 弹窗 -->
    <div class="open-new-window">
        <div class="app-info-main">
            <div class="add-info-item">
                <span class="add-info-title">app名称</span>
                <select name="appType" id="app-type" class="app-name-input">
                    <option value="erp">erp</option>
                    <option value="gshopper">gshopper</option>
                    
                </select>
                <!-- <input type="text" class="app-name-input"> -->
            </div>
            <div class="add-info-item">
                <span class="add-info-title">app系统</span>
                <label for="app-ios">IOS</label>
                <input type="radio" name="appSystem" value="IOS" id="app-ios">
                <label for="app-android">Android</label>
                <input type="radio" name="appSystem" value="Android" id="app-android">
            </div>
            <div class="add-info-item">
                <span class="add-info-title">app版本</span>
                <input type="text" class="app-version-input">
            </div>
            <div class="add-info-item">
                <span class="add-info-title">app下载链接</span>
                <input type="text" class="app-download-link">
                <input type="hidden" class="app-download-filename">

            </div>
            <div class="add-info-item app-download-content">
                <span class="add-info-title">上传APK包</span>
                <input type="file" class="upload-file">
            </div>
            <div class="add-info-item has-btn">
                <span class="add-info-title">app发布市场</span>
                    <input type="text" class="app-publish-input" name="market">
            </div>
            <div class="add-info-item">
                <span class="add-info-title">app强制更新</span>
                <label for="app-update-yes">是</label>
                <input type="radio" name="appForceUpdate" value="1" id="app-update-yes">
                <label for="app-update-no">否</label>
                <input type="radio" name="appForceUpdate" value="0" id="app-update-no" >
            </div>
            <div class="add-info-item">
                <span class="add-info-title">适合更新版本</span>
                <input type="text" class="app-suitable-input" name="suitable">
            </div>
            <div class="add-info-item">
                <span class="add-info-title">更新内容</span>
                <textarea name="updateInfo" id="app-update-info" cols="30" rows="6"></textarea>
            </div>
            <div class="tips" style="color: #FF0000;">

            </div>
            <div class="btn-content">
                <button class="submit-btn">提交</button>
                <button class="do-edit-btn">修改</button>                
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>
    <script>
        //打开遮罩层
        function showOverlay() {
            $("#mask").height(document.body.scrollHeight);
            $("#mask").width(document.body.scrollWidth);
            // fadeTo第一个参数为速度，第二个为透明度
            // 多重方式控制透明度，保证兼容性，但也带来修改麻烦的问题
            $("#mask").fadeTo(100, 0.5);
            // 解决窗口缩小时放大后不全屏遮罩的问题
            // 简单来说，就是窗口重置的问题
            $(window).resize(function () {
                $("#mask").height(document.body.scrollHeight);
                $("#mask").width(document.body.scrollWidth);
            });
            $('.open-new-window').show()
        };
        //隐藏遮罩层
        function hideOverlay() {
            $("#mask").fadeOut(100);
            $('.open-new-window').hide()
        };
        //隐藏元素
        function hiddenBlock(doms) {
            doms.each(function () {
                if ($(this).offset().top > $(window).scrollTop() + $(window).height() * 0.8) {
                    $(this).find('.cd-timeline-img, .cd-timeline-content').addClass('is-hidden');
                }
            });
        }
        // 左右排列
        function doFloat() {
            $('.cd-timeline-block').each(function () {
                $(this).removeClass('left-item right-item')
            })
            $('.cd-timeline-block.show-item').each(function (ind, ele) {
                if (ind != 1) {
                    $(this).css('marginTop', '2em')
                }
                if (ind % 2 == 0) {
                    $(this).addClass('left-item')
                } else {
                    $(this).addClass('right-item')
                }
            })
        }

        $(function () {
            var newWindow = $('.open-new-window').html();
            var $timeline_block = $('.cd-timeline-block.show-item');
            // 隐藏区域
            hiddenBlock($timeline_block)
            // 左右浮动
            doFloat();
            // 滚轮滚动动画
            $('body').on('scroll', function () {
                $timeline_block.each(function () {
                    if ($(this).offset().top <= $(window).scrollTop() + $(window).height() * 1 &&
                        $(this).find('.cd-timeline-img').hasClass('is-hidden')) {
                        $(this).find('.cd-timeline-content').removeClass(
                            'is-hidden').addClass('bounce-in').end().find(
                            '.cd-timeline-img').removeClass('is-hidden');
                    }
                });
            });

            //切换状态
            $('.app-lists li').on('click', function () {
                $(this).toggleClass('active-state')
                if ($(this).hasClass('erp-app-state')) {
                    $('.erp-item').each(function () {
                        $(this).parent().toggleClass('show-item')
                        $(this).parent().toggle();
                    })
                } else if ($(this).hasClass('gshopper-app-state')) {
                    $('.gshopper-item').each(function () {
                        $(this).parent().toggleClass('show-item')
                        $(this).parent().toggle();
                    })
                }
                // 左右浮动
                doFloat();
                $('.cd-timeline-block.show-item').filter(function () {
                    return $(this).css('display') == 'block';
                }).each(function (ind, ele) {
                    if (ind == 1) {
                        $(this).css('marginTop', '10em')
                    }
                })
                //隐藏区域
                hiddenBlock($timeline_block)
            })

            //新建发布
            $('.create-new').on('click', function () {
                $('.open-new-window').html(newWindow)
                $('.do-edit-btn').remove()
                showOverlay();

                //验证
                $('.open-new-window input.app-name-input').blur(function () {

                    var appName = $.trim(this.value);
                    var regName = /[a-zA-z0-9]{3,20}/;
                    if (appName == '' || appName.length < 3 || !regName.test(appName)) {
                        $('.tips').text(
                            'App name should be 3~20,and only can be word and number.');
                        $(this).focus();
                    }
                });

                $('.open-new-window input.app-version-input').blur(function () {
                    var appVersion = $.trim(this.value);
                    var regVersion = /([0-9]+)\.([0-9]+)\.([0-9]+)/;
                    if (appVersion == '' || !regVersion.test(appVersion)) {
                        $('.tips').text('App Version only can be format: x.x.x!');
                        $(this).focus();
                    }
                });

                $('.open-new-window input.app-download-link').blur(function () {
                    var download = $.trim(this.value);
                    var regex = /(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?/;
                    if (download == '' || !regex .test(download)) {
                        $('.tips').text('Please enter valid URL.');
                        $(this).focus();
                    }
                });

                $('#app-update-info').blur(function () {
                    var appUpdateLog = $.trim(this.value);
                    if (appUpdateLog == '' || appUpdateLog.length >= 2000) {
                        $('.tips').text(
                            'Update log can not empty and should be less than 2000;');
                        $(this).focus();
                    }
                });
                //Upload APK file
                uploadAPK($('.app-download-content'))
            });
            function uploadAPK(dom) {
                //上传App包
                dom.on('change', function () {
                    var data = new FormData();
                    //为FormData对象添加数据
                    data.append("file", $('.app-download-content').find("input[type='file']")[0]["files"][0]);
                    var appId = $('.app-info-main .do-edit-btn').data('id');

                    //图片不为空上传
                    $.ajax({
                        url: "index.php?g=universal&m=appVer&a=upload&appId=" + appId,
                        type: "POST",
                        dataType: "JSON",
                        contentType: false,
                        processData: false,
                        data: data,
                        cache: false
                    })
                        .success(function (data) {
                            if (data.code == 2000) {
                                console.log(data);
                                $('.app-info-main .app-download-link').val(data.data.download);
                                $('.app-info-main .app-download-filename').val(data.data.file_name);
                            }
                        })
                        .error(function () {
                            console.log("error");
                        })
                        .complete(function () {
                            // console.log("complete");
                        });
                });
            }
            //增加app发布市场
            $('.open-new-window').on('click', '.app-publish-btn', function () {
                $('.app-publish-market').append(
                    '<input type="text" class="app-publish-input" name="market">')
            });
            //取消按钮
            $('.open-new-window').on('click', '.cancel-btn', function () {
                hideOverlay();
            });

            //提交按钮
            $('.open-new-window').on('click', '.submit-btn,.do-edit-btn', function () {
                console.log('add ... start ...');
                console.log($(this))
                var postData = {};
                //App名称及验证
                postData.name = $(".app-name-input").val();
                var regName = /[a-zA-z0-9]{3,20}/;
                if (postData.name == '' || !regName.test(postData.name)) {
                    $('.tips').text('App name should be 3~20,and only can be word and number.');
                    $('.open-new-window input.app-name-input').focus();
                    return;
                }

                //App系统及验证
                postData.system = $(".open-new-window input[name='appSystem']:checked").val();
                if (postData.system == '' || typeof (postData.system) == 'undefined') {
                    $('.tips').text('Please select App System, IOS or Android!');
                    return;
                }

                //APP版编号
                postData.version = $('.open-new-window input.app-version-input').val();
                var regVersion = /([0-9]+)\.([0-9]+)\.([0-9]+)/;
                if (postData.version == '' || !regVersion.test(postData.version)) {
                    $('.tips').text('App Version only can be format: x.x.x!');
                    $('.open-new-window input.app-version-input').focus();
                    return;
                }

                var download = $('.open-new-window input.app-download-link').val();
                var regex = /(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?/;
                if (download == '' || !regex .test(download)) {
                    $('.tips').text('Please enter valid URL.');
                    $('.open-new-window input.app-download-link').focus();
                    return;
                }
                postData.download = encodeURIComponent(download);//转义
                postData.fileName = $(".open-new-window .app-download-filename").val();

                //App发布市场
                postData.platform = $('.open-new-window input.app-publish-input').val();
                if (postData.platform.length == '') {
                    $('.tips').text('Please input which market this app will be published!');
                    $('.open-new-window input.app-publish-input').focus();
                    return;
                }
                postData.is_force = $(".open-new-window input[name='appForceUpdate']:checked").val();
                postData.suitable = $('.open-new-window input.app-suitable-input').val();
                postData.update_desc = $('#app-update-info').val();

                $('.tips').text('');
                if($(this).hasClass('submit-btn')){
                    $.ajax({
                        url: 'index.php?g=universal&m=appVer&a=add',
                        type: 'POST',
                        dataType: 'json',
                        data: JSON.stringify(postData),
                    })
                    .done(function (data) {
                        if (data.code == 200) {
                            window.location.reload();
                        }
                        hideOverlay();
                    })
                    .fail(function () {
                        console.log("error");
                    })
                    .always(function () {
                        console.log("complete");
                    });
                }else if($(this).hasClass('do-edit-btn')){
                    postData.appId = $('.do-edit-btn').data('id');
                    console.log(postData);
                    $.ajax({
                        url: 'index.php?g=universal&m=appVer&a=edit',
                        type: 'POST',
                        dataType: 'json',
                        data: JSON.stringify(postData),
                    })
                        .done(function (data) {
                            console.log(data)
                            if (data.code == 200) {
                                window.location.reload();
                            }
                            hideOverlay();
                        })
                        .fail(function (data) {
                            console.log("error");
                        })
                        .always(function () {
                            console.log("complete");
                        });
                }
                
            });

            //编辑按钮
            $('#cd-timeline').on('click', '.edit-btn', function () {
                $('.open-new-window').html(newWindow);
                $('.submit-btn').remove()
                $('.app-name-input').attr('disabled','true');
                $('input[name="appSystem"]').attr('disabled','true');
                $('.app-version-input').attr('disabled','true')
                showOverlay();
                var rootDom = $(this).parents('.cd-timeline-content')[0];
                $('.do-edit-btn').attr('data-id', $(rootDom).data('id'));
                //获取数据 =>
                $('.app-name-input').val($.trim($(rootDom).find('.app-name-value').text()));
                $('.app-version-input').val($.trim($(rootDom).find('.app-version-value').text()));
                $('.app-download-link').val($.trim($(rootDom).find('.app-download-url').text()));
                $('.app-info-main input[name="appSystem"][value='+$.trim($(rootDom).find('.app-system-value').text())+']').attr('checked',true);
                
                if($.trim($(rootDom).find('.app-system-value').text()) != "Android"){$('.app-download-content').hide()}
                var appForceUpdate = $.trim($(rootDom).find('.app-force-update').text()) == "是" ? '1':'0';
                $('.app-info-main input[name="appForceUpdate"][value='+appForceUpdate+']').attr('checked',true);
                $('.app-suitable-input').val($.trim($(rootDom).find('.app-suggest-version').text()));
                $('#app-update-info').val($.trim($(rootDom).find('.app-update-value').text()));
                $('.app-publish-input').val($.trim($(rootDom).find('.app-publish-market').text()));
                uploadAPK($('.upload-file'))

            })
        });
    </script>
</body>

</html>