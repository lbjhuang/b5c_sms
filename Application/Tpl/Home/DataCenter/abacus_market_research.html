<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>选市场</title>
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.13.0.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/DataCenter/css/element-ui-custom.css?v=<{$Think.config.VER_NUM}>">
    <style>
        [v-cloak] {
            display: none;
        }
        body{
            margin: 0 20px 0px 0;
            background: #F4F4F4;
        }
        html ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        html ::-webkit-scrollbar-button {
            display: none;
        }

        html ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.35);
            border-radius: 2px;
            height: 50px;
        }

        html ::-webkit-scrollbar-track{
            background-color: rgba(0, 0, 0, 0.1);
        }
        .market-research-box{
            font-size: 14px;
            color: rgba(0, 0, 0, 0.65);
            background: rgba(244,244,244,1);;
        }
        .tip-box {
            padding: 0 20px;
            background: #ffffff;
            margin-bottom: 20px;
        }
        .tip-box .el-collapse-item__header{
            border: none;
            font-weight: 600;
            line-height: 64px;
            height: 64px;
            font-size: 16px;
            color: #0375DE;
        }
        .tip-box .el-collapse {
            border: none;
        }
        .tip-box .el-collapse-item__wrap {
            border: none;
        }
        .tip-box .el-collapse-item__content{
            padding-bottom: 12px;
        }
        .filter-box{
            background: #ffffff;
            padding: 20px;
            position: relative;
        }
        .filter-box .row-2{
            width: 105px;
        }
        .filter-box .row-label {
            width: 75px;
            text-align: justify;
            line-height: 38px;
            height: 38px;
            color: #000000D9;
            display: inline-block;
            vertical-align: middle;
        }
        .filter-box .row-label.time {
            text-align: left;
            width: auto;
        }
        .filter-box .row-label::after{
            content: '';
            display: inline-block; 
            padding-left: 100%;
        }
        .filter-box .row-option {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-box .row-option .option-item{
            width: 150px;
            height: 28px;
            background: #F4F4F4;
            border-radius: 14px;
            text-align: center;
            line-height: 28px;
            cursor: pointer;
            margin: 5px 20px 20px 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            color: #000000A6;
        }
        .filter-box .row-option .option-item.active {
            background: rgba(3, 117, 222, 1);
            color: #fff;
        }
        .filter-box .btn-box{
            display: flex;
            justify-content: flex-start;
        }
        .filter-box .btn-box .btn{
            width: 120px;
            height: 32px;
            text-align: center;
            line-height: 32px;
            border-radius: 4px;
            background: #F4F4F4;
            margin-left: 25px;
            cursor: pointer;
            margin-top: 15px;
            color: #000000A6;
        }
        .filter-box .btn-box .btn.filter-btn{
            background: #0375de;
            color: #ffffff;
        }
        .dialog-text{
            text-indent: 1em;
        }
        .table-box{
            margin-top: 20px;
            background: #ffffff;
            padding: 0 20px;
            min-height: 420px;
        }
        .table-box .sort-box{
            padding: 20px 0;
            text-align: right;
            color: #00000073;
        }
        .table-box .tabel-data-box .data-none {
            margin: 100px auto 0;
            width: 850px;
        }
        .table-box .tabel-data-box .data-none .text-box{
            display: inline-block;
            margin-left: 60px;
        }
        .table-box .tabel-data-box .data-none .text-box .text-box-title{
            font-size: 24px;
            font-weight: 600;
            line-height: 28px;
            color: rgba(0, 0, 0, 0.65);
            padding-bottom: 15px;
        }
        .table-box .tabel-data-box .data-none .text-box .text-box-subtitle{
            font-size: 14px;
            line-height: 18px;
            color: rgba(0, 0, 0, 0.65);
            padding-top: 10px;
        }
        .table-box .tabel-data-box .table{
            width: 100%;
            padding-bottom: 15px;
            overflow-x: auto;
        }
        .table-box .tabel-data-box .table-head{
            display: table;
            border-bottom: 1px solid #E0E0E0;
            padding: 10px 20px;
            background: #f4f4f4;
            width: 100%;
            box-sizing: border-box;
            color: #000000A6;
        }
        .table-box .tabel-data-box .table-head .head-item{
            display: table-cell;
            padding: 0 12px;
            line-height: 18px;
            min-width: 105px;
            box-sizing: border-box;
            font-weight: 600;
            vertical-align: middle;
        }
        .table-box .tabel-data-box .table-head .head-item.left{
            text-align: left;
        }
        .table-box .tabel-data-box .table-head .head-item.right{
            text-align: right;
        }
        .table-box .tabel-data-box .table-body-wrap{
            display: table;
        }
        .table-box .tabel-data-box .table-body-wrap:nth-last-child(1) .table-foot{
            border-bottom: none;
        }
        .table-box .tabel-data-box .table-body{
            display: table;
            padding: 10px 20px;
            border-bottom: 1px dashed #E0E0E0;
            width: 100%;
            box-sizing: border-box;
        }
        .table-box .tabel-data-box .table-body .body-item{
            display: table-cell;
            padding: 0 12px;
            line-height: 18px;
            min-width: 105px;
            max-width: 106px;
            box-sizing: border-box;
            vertical-align: middle;
            color: #000000D9;
        }
        .table-box .tabel-data-box .table-body .body-item.left{
            text-align: left;
        }
        .table-box .tabel-data-box .table-body .body-item.right{
            text-align: right;
        }
        .table-box .tabel-data-box .table-foot{
            border-bottom: 1px solid #E0E0E0;
            padding: 8px 20px 20px 20px;
            color: #00000073;
            display: table;
            width: 100%;
            box-sizing: border-box;
        }
        .table-box .tabel-data-box .table-foot .table-foot-item{
            line-height: 18px;
            margin-bottom: 4px;

        }
        .table-box .tabel-data-box .table-foot .table-foot-item .table-foot-item-box{
            margin-right: 20px;
        }
        .el-popover{
            background: #000000A6;
            color: #ffffff;
            box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.1);
        }
        .el-popover .content{
            display: flex;
            font-size: 12px
        }
        .el-popover .content .label{
            margin-right: 8px;
            white-space: nowrap;
        }
        .el-popover .popper__arrow{
            display: none;
        }
        .row-option-voerflow{
            height: 110px;
            overflow: hidden;
            position: relative;
        }
        .collapse-box{
            position: absolute;
            top: 5px;
            right: 10px;
            height: 28px;
            display: flex;
            align-items: center;
            color: #0375de;
            cursor: pointer;
        }
        .row-option-voerflow.row-option-notvoerflow{
            overflow: auto;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="market-research-box" id="marketResearch" v-cloak>
        <div class="tip-box">
            <el-collapse v-model="activeNames" accordion>
                <el-collapse-item :title="$lang('功能说明')" name="1">
                    <div>{{$lang('选市场基础逻辑：选定亚马逊的细分市场（类目）有代表性的样本商品和头部商品，通过样本商品的市场表现来观察市场的主要需求、竞争情况等')}}</div></br>
                    <div>
                        <p>{{$lang('产品范围')}}</p>
                        <p class="dialog-text">* {{$lang('样本商品：细分市场（类目）下的销量Top 100的产品')}}</p>
                        <p class="dialog-text">* {{$lang('头部商品：样本商品中销量Top10的产品')}}</p>
                        <p class="dialog-text">* {{$lang('新品：上架时间不超过3个月的产品')}}</p>
                    </div></br>
                    <div>{{$lang('时间范围：近30天（不含今天）')}}</div>
                </el-collapse-item>
            </el-collapse>
        </div>
        <div class="filter-box">
            <!-- <div class="legend-btn" @click="legendShow">{{$lang('功能说明')}}</div> -->
            <el-row :gutter="25" class="filter-box-row">
                <el-col :span="2" class="row-2">
                    <div class="row-label">{{$lang('站点')}}</div>
                </el-col>
                <el-col :span="22" class="row-option">
                    <div class="option-item active">{{$lang('美国站')}}</div>
                </el-col>
            </el-row>
            <el-row :gutter="25" class="filter-box-row">
                <el-col :span="2" class="row-2">
                    <div class="row-label">{{$lang('类目')}}</div>
                </el-col>
                <el-col :span="22" class="row-option">
                    <div ref="categoryBox" class="row-option" :class="[{'row-option-voerflow' : overFlow },{'row-option-notvoerflow': !expand}]">
                        <div class="option-item" :class="serachFrom.category === 'ALL' ? 'active' : ''" @click="categoryChange('ALL')">
                            <span style="padding: 0 5px;">{{$lang('全部')}}</span>
                        </div>
                        <div v-for="(item,index) in categoryArr" :key="index">
                            <el-tooltip  v-if="item.name.length > 18" :content="item.name" placement="top" effect="dark" :tabIndex="index">
                                <div class="option-item" :class="serachFrom.category === item.name ? 'active' : ''" @click="categoryChange(item.name)">
                                    <span style="padding: 0 5px;">{{item.name}}</span>
                                </div>
                            </el-tooltip>
                            <div v-else class="option-item" :class="serachFrom.category === item.name ? 'active' : ''" @click="categoryChange(item.name)">
                                <span style="padding: 0 5px;">{{item.name}}</span>
                            </div>
                        </div>
                        
                        <div class="collapse-box" v-if="overFlow">
                            <span v-show="expand" @click="expand = false">
                                <span>{{$lang('展开')}}</span>
                                <i class="el-icon-arrow-down"></i>
                            </span>
                            <span v-show="!expand" @click="expand = true">
                                <span>{{$lang('收起')}}</span>
                                <i class="el-icon-arrow-up"></i>
                            </span>
                            
                        </div>
                    </div>
                </el-col>
            </el-row>
            <el-row :gutter="25" class="filter-box-row-time">
                <el-col :span="2" class="row-2">
                    <div class="row-label time"> {{$lang('采集时间')}}</div>
                    <el-popover
                        placement="right-end"
                        title=""
                        width="320"
                        trigger="hover">
                        <div class="content">
                            <div class="label">{{$lang('采集时间')}}</div>
                            <div class="legend-value">{{$lang('数据采集的时间，对应的数据统计范围为前30天。例如某个细分市场的采集时间为2020/10/25，统计这个细分市场数据的时间范围为2020/09/25~2020/10/24')}}</div>
                        </div>
                        <i slot="reference" class="el-icon-question" style="color: rgba(0, 0, 0, 0.65);"></i>
                    </el-popover>
                </el-col>
                <el-col :span="22" class="row-option">
                    <el-date-picker
                    v-model="date"
                    type="daterange"
                    :start-placeholder="$lang('开始日期')"
                    :end-placeholder="$lang('结束日期')"
                    :default-time="['00:00:00','23:59:59']"
                    format="yyyy-MM-dd"
                    value-format="yyyy-MM-dd HH:mm:ss"
                    :clearable="false">
                    </el-date-picker>
                </el-col>
            </el-row>
            
            <el-row :gutter="25" class="filter-box-row-btn">
                <div class="btn-box">
                    <div class="filter-btn btn" @click="doSearch">{{$lang('筛选')}}</div>
                    <div class="rest-btn btn" @click="rest">{{$lang('重置')}}</div>
                </div>
            </el-row>
        </div>
        <div class="table-box">
            <div class="sort-box">
                <span>{{$lang('排序规则')}}</span>&nbsp;&nbsp;
                <el-select v-model="serachFrom.sortField" size="small">
                    <el-option
                      v-for="(item,index) in fieldOptions"
                      :key="index"
                      :label="$lang(item.label)"
                      :value="item.value">
                    </el-option>
                </el-select>
                <el-select v-model="serachFrom.sort" size="small">
                    <el-option :label="$lang('升序')" value="asc"></el-option>
                    <el-option :label="$lang('降序')" value="desc"></el-option>
                </el-select>
            </div>
            <div class="tabel-data-box" v-loading="tableLoading">
                <div class="data-none" v-show="total == 0">
                    <img src="./Application/Tpl/Home/DataCenter/img/search.png" alt="">
                    <div class="text-box">
                        <div class="text-box-title">Sorry! It Seems that search results are empty.</div>
                        <div class="text-box-title">There are some tips might help.</div>
                        <div class="text-box-subtitle">1. Reduce screening criteria.</div>
                        <div class="text-box-subtitle"> 2. Use fuzzy keywords instead of precise keywords Let us know when you need support.</div>
                    </div>
                </div>
                <div  v-show="total !== 0">
                    <div class="table">
                        <div class="table-head">
                            <div class="head-item left">{{$lang('细分市场')}}</div>
                            <div class="head-item left">{{$lang('样本')}}</div>
                            <div class="head-item right">
                                <div>{{$lang('采集时间')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="label">{{$lang('采集时间')}}</div>
                                            <div class="legend-value">{{$lang('数据采集的时间，对应的数据统计范围为前30天。例如某个细分市场的采集时间为2020/10/25，统计这个细分市场数据的时间范围为2020/09/25~2020/10/24')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right">
                                <div>{{$lang('月总销量')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('样本商品月总销量，细分市场需求量的直观表现')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right" style="min-width: 160px;">
                                <div>{{$lang('样本商品月均销量')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('由样本商品总销量除以样本商品总数计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                                <div>{{$lang('头部商品月均销量')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('由头部商品总销量除以头部商品总数计算得到。通常，两者比值越小，垄断程度越高')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right" style="min-width: 170px;">
                                <div>{{$lang('样本商品月均销售额')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('由样本商品总销售额除以样本商品总数计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                                <div>{{$lang('头部商品月均销售额')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('由头部商品总销售额除以头部商品总数计算得到。通常，两者比值越小，垄断程度越高')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right">
                                <div>{{$lang('平均价格')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('所有样本商品的价格之和除以样本商品数计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right" style="min-width: 115px;">
                                <div>{{$lang('平均评分数')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('样本商品的评分数之和除以样本商品计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                                <div>{{$lang('平均星级')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('样本商品的评分数之和除以样本商品计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right" style="min-width: 160px;">
                                <div>{{$lang('样本商品平均BSR')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('样本商品BSR之和除以样本商品数计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                                <div>{{$lang('头部商品平均BSR')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('头部商品BSR之和除以头部商品数计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right" style="min-width: 115px;">
                                <div>{{$lang('平均卖家数')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('样本商品数卖家数之和除以样本商品计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item left">
                                <div>{{$lang('卖家类型')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="label">FBA</div>
                                            <div class="legend-value">{{$lang('样本商品中，选择FBA发货的卖家占卖家总数的百分比')}}</div>
                                        </div>
                                        <div class="content">
                                            <div class="label">AMZ</div>
                                            <div class="legend-value">{{$lang('样本商品中，Amazon自营占比占卖家总数的百分比')}}</div>
                                        </div>
                                        <div class="content">
                                            <div class="label">FBM</div>
                                            <div class="legend-value">{{$lang('样本商品中，自行发货的卖家占卖家总数的百分比')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item left" style="min-width: 120px;">
                                <div>{{$lang('集中度')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="label">{{$lang('商品集中度')}}</div>
                                            <div class="legend-value">{{$lang('头部商品总销量除以样本商品总销量计算得到')}}</div>
                                        </div>
                                        <div class="content">
                                            <div class="label">{{$lang('品牌集中度')}}</div>
                                            <div class="legend-value">{{$lang('销量前10品牌总销量除以样本商品总销量计算得到')}}</div>
                                        </div>
                                        <div class="content">
                                            <div class="label">{{$lang('卖家集中度')}}</div>
                                            <div class="legend-value">{{$lang('销量前10卖家总销量除以样本商品总销量计算得到')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right">
                                <div>{{$lang('新品数量')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('上架时间不超过3个月的商品为新品，新品数量指样本商品中的新品数量')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                                <div>{{$lang('新品占比')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('新品数量/样本商品总数')}}</div>
                                        </div>
                                        <div class="content">
                                            <div class="legend-value">{{$lang('通过两者可观察细分市场下新品的活跃度，市场对新品的接受程度')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                            <div class="head-item right" style="min-width: 155px;">
                                <div>{{$lang('细分市场商品总数')}}
                                    <el-popover
                                        placement="right-end"
                                        title=""
                                        width="260"
                                        trigger="hover">
                                        <div class="content">
                                            <div class="legend-value">{{$lang('亚马逊前台该类目下上架商品总数，通常，细分市场下的商品总数越多，竞争程度越激烈')}}</div>
                                        </div>
                                        <i slot="reference" class="el-icon-question"></i>
                                    </el-popover>
                                </div>
                            </div>
                        </div>
                        <div class="table-body-wrap" v-for="(item,index) in tableData" :key="index">
                            <div class="table-body">
                                <div class="body-item left" style="word-break:break-all;">{{item.category}}</div>
                                <div class="body-item left">
                                    <div>{{$lang('商品')}}：{{item.size_products | formatNum}}</div>
                                    <div>{{$lang('品牌')}}：{{item.size_brand | formatNum}}</div>
                                    <div>{{$lang('卖家')}}：{{item.size_sellers | formatNum}}</div>
                                </div>
                                <div class="body-item right">
                                    <div>{{item.created_at}}</div>
                                </div>
                                <div class="body-item right">{{item.monthly_sales | formatNum}}</div>
                                <div class="body-item right" style="min-width: 160px;">
                                    <div>{{item.avg_monthly_sales | formatNum}}</div>
                                    <div>{{item.avg_monthly_sales_top | formatNum}}</div>
                                </div>
                                <div class="body-item right" style="min-width: 170px;">
                                    <div>${{item.avg_monthly_revenue | formatNum}}</div>
                                    <div>${{item.avg_monthly_revenue_top | formatNum}}</div>
                                </div>
                                <div class="body-item right">${{item.avg_price | formatNum}}</div>
                                <div class="body-item right" style="min-width: 115px;">
                                    <div>{{item.avg_ratings | formatNum}}</div>
                                    <div>{{item.avg_rating  | formatNum}}</div>
                                </div>
                                <div class="body-item right" style="min-width: 160px;">
                                    <div>{{item.avg_bsr | formatNum}}</div>
                                    <div>{{item.avg_bsr_top | formatNum}}</div>
                                </div>
                                <div class="body-item right" style="min-width: 115px;">{{item.avg_sellers | formatNum}}</div>
                                <div class="body-item left">
                                    <div>FBA：{{item.fulfillment_fba | formatNum(true)}}</div>
                                    <div>AMZ：{{item.fulfillment_amz | formatNum(true)}}</div>
                                    <div>FBM：{{item.fulfillment_fbm | formatNum(true)}}</div>
                                </div>
                                <div class="body-item left" style="min-width: 120px;">
                                    <div>{{$lang('商品')}}：
                                        <span v-if="item.concentration_products>1">{{item.concentration_products/10 | formatNum(true,true)}}</span>
                                        <span v-else>{{item.concentration_products | formatNum(true)}}</span>
                                    </div>
                                    <div>{{$lang('品牌')}}：
                                        <span v-if="item.concentration_brand>1">{{item.concentration_brand/10 | formatNum(true,true)}}</span>
                                        <span v-else>{{item.concentration_brand | formatNum(true)}}</span>
                                     </div>
                                    <div>{{$lang('卖家')}}：
                                        <span v-if="item.concentration_sellers>1">{{item.concentration_sellers/10 | formatNum(true,true)}}</span>
                                        <span v-else>{{item.concentration_sellers | formatNum(true)}}</span>
                                    </div>
                                </div>
                                <div class="body-item right">
                                    <div>{{item.new_products | formatNum}}</div>
                                    <div>
                                        <span v-show="item.new_product_proportion == 0">N/A</span>
                                        <span v-show="item.new_product_proportion !== 0">{{item.new_product_proportion | formatNum(true)}}</span>
                                    </div>
                                </div>
                                <div class="body-item right" style="min-width: 155px;">
                                    <div>{{item.total_products | formatNum}}</div>
                                </div>
                            </div>
                            <div class="table-foot">
                                <div class="table-foot-item">{{$lang('完整市场路径')}}&nbsp;&nbsp;
                                    <span v-for="(cates,index) in item.categories" :key="index">{{cates}}
                                        <span v-if="index < item.categories.length - 1"> › </span>
                                    </span>
                                </div>
                                <div class="table-foot-item">
                                    <span class="table-foot-item-box">{{$lang('新品平均评分数')}}&nbsp;&nbsp;{{item.avg_ratings_new_product == 0 ? 'N/A' : item.avg_ratings_new_product | formatNum}}</span>
                                    <span class="table-foot-item-box">
                                        {{$lang('新品平均价格')}}&nbsp;&nbsp;
                                        <span v-show="item.avg_price_new_product == 0">N/A</span>
                                        <span v-show="item.avg_price_new_product !== 0">${{item.avg_price_new_product | formatNum}}</span>
                                    </span>
                                    <span class="table-foot-item-box">{{$lang('新品平均星级')}}&nbsp;&nbsp;{{item.avg_rating_new_product == 0 ? 'N/A' : item.avg_rating_new_product | formatNum}}</span>
                                    <span class="table-foot-item-box">{{$lang('新品月均销量')}}&nbsp;&nbsp;{{item.avg_monthly_sales_new_product == 0 ? 'N/A' : item.avg_monthly_sales_new_product | formatNum}}</span>
                                    <span class="table-foot-item-box">{{$lang('新品月均销售额')}}&nbsp;&nbsp;
                                        <span v-show="item.avg_monthly_revenue_new_product == 0">N/A</span>
                                        <span v-show="item.avg_monthly_revenue_new_product !== 0">${{item.avg_monthly_revenue_new_product | formatNum}}</span>
                                    </span>
                                    <span class="table-foot-item-box">{{$lang('平均利润率')}}&nbsp;&nbsp;
                                        <span v-show="item.avg_profit_margin == 0">N/A</span>
                                        <span v-show="item.avg_profit_margin !== 0">{{item.avg_profit_margin | formatNum(true)}}</span>
                                     </span>
                                    <span class="table-foot-item-box">{{$lang('卖家所属地')}}&nbsp;&nbsp;{{item.seller_location}} &nbsp;|&nbsp; {{item.seller_location_proportion | formatNum(true)}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="page" style="width: 700px;margin: 20px auto;padding-bottom: 15px;" v-if="total>10">
                        <el-pagination background @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page="serachFrom.pageNum" :page-sizes="[10, 30, 50, 100]" :page-size="serachFrom.pageSize"
                        layout="sizes, prev, pager, next, jumper" :total="total">
                        </el-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript" src="/Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="/Application/Tpl/Home/Public/js/axios.min.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="\Application\Tpl\Home\Public\js\H-ui.admin.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.13.0.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
<script>
    if (getCookie('think_language') !== "zh-cn") {
        ELEMENT.locale(ELEMENT.lang.en)
    }
    var VM = new Vue({
        el: '#marketResearch',
        data() {
            return {
                categoryArr: [],
                pickerOptions: {
                    disabledDate(time) {
                        return time.getTime() > Date.now();
                    },
                },
                fieldOptions: [
                    {label: '月总销量', value: 'monthly_sales'},
                    {label: '样本商品月均销量', value: 'avg_monthly_sales'},
                    {label: '样本商品月均销售额', value: 'avg_monthly_revenue'},
                    {label: '平均评分数', value: 'avg_ratings'},
                    {label: '平均价格', value: 'avg_price'},
                    {label: '样本商品平均BSR排名', value: 'avg_bsr'},
                    {label: '平均星级', value: 'avg_rating'},
                    {label: '平均利润率', value: 'avg_profit_margin'},
                    {label: '头部商品平均BSR', value: 'avg_bsr_top'},
                    {label: '头部商品月均销量', value: 'avg_monthly_sales_top'},
                    {label: '头部商品月均销售额', value: 'avg_monthly_revenue_top'},
                    {label: '商品集中度', value: 'concentration_products'},
                    {label: '品牌集中度', value: 'concentration_brand'},
                    {label: '卖家集中度', value: 'concentration_sellers'},
                    {label: 'Amazon自营占比', value: 'fulfillment_amz'},
                    {label: '商品总数', value: 'total_products'},
                    {label: '新品数量', value: 'new_products'},
                    {label: '新品平均价格', value: 'avg_price_new_product'},
                    {label: '新品平均评分数', value: 'avg_ratings_new_product'},
                    {label: '新品平均星级', value: 'avg_rating_new_product'},
                    {label: '新品月均销量', value: 'avg_monthly_sales_new_product'},
                    {label: '新品月均销售额', value: 'avg_monthly_revenue_new_product'},
                ],
                activeNames: '0',
                access_token: 'Y2xpZW50OnBAc3N3b3Jk',
                host: '//mtapi.gshopper.com',
                date: [],
                serachFrom: {
                    site: 'us',
                    category: 'ALL',
                    sortField: 'monthly_sales',
                    sort: 'asc',
                    endDate: '',
                    beginDate: '',
                    pageNum: 1,
                    pageSize: 10
                },
                total: 0,
                tableData: [],
                tableLoading: true,
                overFlow: false,
                expand: true,
            }
        },
        created() {
            this.setDefaultDate();
        },
        mounted() {
            this.login();
        },
        watch: {
            'serachFrom.sortField': function() {
                this.doSearch();
            },
            'serachFrom.sort': function() {
                this.doSearch();
            },
        },
        filters: {
            /**
             * 数值千分位表示，考虑小数情况
             *
             * @param number 数值(Number或者String)
             * @param {boolean} addSymbol 返回的结果是否加上%(boolean)
             * @param {boolean} dot2 返回的结果中，小数是否统一保留两位
             * @return 金额格式的字符串,如'1,234,567.45'
             */
            formatNum(number, addSymbol, dot2) {
                let hasMinus = false
                if (number === '-') {
                    return number
                } else if (number != null) {
                    let numStr = dot2 ? parseFloat(number).toFixed(2) : number.toString()
                    if (numStr.startsWith('-')) {
                    hasMinus = true
                    numStr = numStr.slice(1)
                    }
                    const numArr = numStr.split('.')
                    let [num, dotNum] = numArr
                    let result = []
                    const operateNum = num.split('').reverse()
                    const length = operateNum.length
                    for (let i = 0; i < length; i++) {
                    result.push(operateNum[i])
                    if (((i + 1) % 3 === 0) && (i !== length - 1)) {
                        result.push(',')
                    }
                    }
                    if (dotNum) {
                    result.reverse().push('.', ...dotNum)
                    } else {
                    result.reverse()
                    }

                    if (addSymbol) {
                    result = result.join('').concat('%')
                    } else {
                    result = result.join('')
                    }

                    if (hasMinus) {
                    result = '-' + result
                    }

                    return result
                }
            },
        },
        methods: {
            setDefaultDate() {
                let endDate = this.getEndDate();
                let startDate = this.getStartDate();

                this.date = [startDate,endDate]
            },
            // 获取搜索默认结束时间
            getEndDate() {
                var d = new Date();
                d.setDate(d.getDate()-1);
                var year = d.getFullYear();
                var mon=d.getMonth()+1;
                var day=d.getDate();
                s = year + "-" + (mon<10?('0'+mon):mon) + "-" + (day<10?('0'+day):day) + " 23:59:59";
                return s;
            },
            // 超出长度则显示tooltip,不超出不显示
            // mouseenter(refStr,item){
            //     if(this.$refs[refStr][0].offsetWidth >= this.$refs[refStr][0].parentNode.offsetWidth){
            //         item.disabled = false;
            //     } else {
            //         item.disabled = true;
            //     }
            // },
            // 获取搜索默认开始时间
            getStartDate() {
                let date = new Date();
                date.setDate(date.getDate()-30);
                year = date.getFullYear();
                mon=date.getMonth()+1;
                day=date.getDate();
                str = year + "-" + (mon<10?('0'+mon):mon) + "-" + (day<10?('0'+day):day) + " 00:00:00";
                return str;
            },
            requestGet(url,param) {
                return axios.get(this.host + url, {params: param,headers: { "Authorization": `Bearer ${this.access_token}`}});
            },
            requestPost(url,param) {
                var headers = {
                    headers: {
                        "Authorization": `Basic ${this.access_token}`
                    }
                };
                return axios.post(this.host + url, param, headers);
            },
            handleSizeChange(size) {
                this.serachFrom.pageNum = 1;
                this.serachFrom.pageSize = size;
                this.doSearch();
            },
            handleCurrentChange(page) {
                this.serachFrom.pageNum = page;
                this.doSearch();
            },
            login() {
                this.requestPost("/login?username=test@gshopper.com&password=izene123&grant_type=password").then((res) => {
                    console.log(res);
                    if(res.status === 200) {
                        
                        this.access_token = res.data.access_token;
                        this.getCategory();
                        this.doSearch();
                    } else {
                        this.$message.error('鉴权失败');
                    }
                }).catch((error) =>{
                    console.log(error);
                })
                
            },
            getCategory() {
                this.requestGet('/api/abacus/market/research/categories').then(res => {
                    console.log(res)
                    if(res.status == 200) {
                        this.categoryArr = res.data.map((item,index) => {
                            return {
                                name: item,
                                disabled: true,
                                ref: 'ref' + index
                            }
                        });
                        setTimeout(() => {
                            console.log(this.$refs.categoryBox.offsetHeight)
                            if(this.$refs.categoryBox.offsetHeight > 110) {
                                this.overFlow = true;
                            } 
                        }, 100);
                        
                    }
                })
            },
            doSearch() {
                let param = {
                    site: this.serachFrom.site,
                    category: this.serachFrom.category,
                    sortField: this.serachFrom.sortField,
                    sort: this.serachFrom.sort,
                    endDate: '',
                    beginDate: '',
                    pageNum: this.serachFrom.pageNum,
                    pageSize: this.serachFrom.pageSize
                };
                this.tableLoading = true;
                param.beginDate = (new Date(this.date[0]).getTime())/1000;
                param.endDate = (new Date(this.date[1]).getTime())/1000;
                this.requestGet('/api/abacus/market/research',param).then(res => {
                    console.log(res)
                    this.tableLoading = false;
                    if(res.status === 200) {
                        this.tableData = res.data.marketResearchList;
                        this.total = res.data.total;
                    }
                }).catch(err => {
                    console.log(err)
                    this.tableLoading = false;
                })
            },
            rest() {
                this.setDefaultDate();
                this.serachFrom.category = 'ALL';
                this.serachFrom.pageNum = 1;
                this.serachFrom.pageSize = 10;
                this.doSearch();
            },
            categoryChange(item) {
                this.serachFrom.category = item;
            }
        },
    })
</script>