<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>选品工具</title>
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.8.2.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/icon/css/font-awesome.min.css?v=<{$Think.const.V}>">
    <style>
        body{
            color: rgba(0, 0, 0, 0.85);
            font-size: 14px;
            font-family: apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans GB","Helvetica Neue",Arial,sans-serif;
        }
        .abacusshow-box{
            background: rgba(244, 242, 242, 1);
            padding-top: 15px;
        }
        .tip-box{
            padding: 0 35px;
            background: #fff;
        }
        .tip-box .el-collapse-item__header{
            border: none;
            font-weight: 600;
            line-height: 34px;
            height: 34px;
            font-size: 14px;
        }
        .tip-box .el-collapse {
            border: none;
        }
        .tip-box .el-collapse-item__wrap {
            border: none;
        }
        .tip-box .el-collapse-item__content{
            padding-bottom: 12px;
        }
        .el-icon-question{
            cursor: pointer;
        }
        .search-box{
            padding: 20px;
            background: #fff;
            margin-top: 15px;
        }
        .search-box .search-box-row{
            margin-bottom: 8px;
            font-size: 16px;
            overflow: hidden;
            padding-left: 15px;
        }
        .search-box .search-box-row .label-title{
            text-align: right;
            line-height: 28px;
            width: 100px;
            font-size: 14px;
            padding-left: 0 !important;
            color: rgba(0, 0, 0, 0.85);
        }
        .search-box .search-box-row .value-box{
            /* float: left; */
        }
        .search-box .search-box-row .value-box .el-input{
            width: 390px;
        }
        .search-box .search-box-btn-row{
            margin-top: 10px;
        }
        .search-box .search-box-btn-row .btn-box{
            padding-top: 15px;
        }
        .search-box .search-box-btn-row .btn-box .el-button{
            margin-left: 30px;
            width: 78px;
        }
        .search-box .search-box-row .value-box .bt-box{
            background: #f4f4f4;
            border-radius: 14px;
            width: 110px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            margin-right: 15px;
            float: left;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding: 0 5px;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.65);
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .search-box .search-box-row .value-box .bt-box.active{
            background: rgba(3, 117, 222, 1);
            color: #fff;
        }
        
        .table-box{
            background: #fff;
            padding: 0 35px;
            margin-top: 15px;
            padding-bottom: 40px;
        }
        .table-box .table-box-top{
            overflow: hidden;
            padding: 5px 5px;
        }
        .table-box .table-box-top .table-total{
            float: left;
        }
        .table-box .table-box-top .table-btn{
            float: right;
            margin-top: 25px;
        }
        .table-box .img-box{
            width: 60px;
            height: 60px;
            float: left;
            margin-top: 11px;
        }
        
        .table-box .txt-box{
            width: 155px;
            float: left;
            font-size: 12px;
            margin-left: 10px;
            text-align: left;
        }
        .table-box .txt-box .goods-name{
            text-overflow: -o-ellipsis-lastline;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            cursor: pointer;
            line-height: 16px;
        }
        .table-box .txt-box .goods-asin{
            color: #02a7f0;
            cursor: pointer;
            margin-top: 4px;
        }
        .table-box .txt-box .goods-brand{
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .dialog-tip{
            margin-bottom: 15px;
            overflow: hidden;
        }
        .dialog-tip .label{
            width: 110px;
            font-weight: 900;
            float: left;
        }
        .dialog-tip .text{
            float: left;
            width: 400px;
        }
        .calculation-box{
            border: 1px solid #ccc;
            padding: 5px 15px;
        }
        .calculation-box .label{
            font-weight: 900;
            font-size: 15px;
            line-height: 32px;
        }
        .calculation-box .el-form-item{
            margin-bottom: 0;
        }
        .calculation-box .el-input-group__append{
            padding: 0 3px;
        }
        .charts-box .top-text{
            padding-left: 20px;
        }
        .charts-box .top-text .text-label{
            font-size: 14px;
            color: rgba(0, 0, 0, 0.85);
        }
        .charts-box .top-text .protxt{
            
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 50px;
            width: 400px;
            vertical-align: bottom; 
        }
        .charts-box .top-text .text-val{
            font-size: 14px;
            color: rgba(0, 0, 0, 0.65);
        }
        /* element UI 组件样式 */
        .el-button--primary{
            background: #0375DE;
            border-color: #0375DE;
        }
        .table-box-top .el-button{
            width: 125px;
            position: relative;
            padding: 9px 5px;
        }
        .el-date-editor{
            width: 250px !important;
        }
        .table-box .el-table td{
            padding: 6px 0;
        }
        .el-table th.is-leaf{
            background: #f4f4f4;
            color: rgba(0, 0, 0, 0.65);
            padding: 6px 0px;
        }
        .el-table th.is-leaf .el-icon-question{
            color: rgba(0, 0, 0, 0.55);
            position: relative;
            top: -6px;
        }
        .el-dialog__header .el-dialog__title{
            color: rgba(0, 0, 0, 0.85);
            font-size: 16px;
            font-weight: 600;
        }
        .table-box .data-none {
            margin: 0 auto;
            width: 850px;
            padding-top: 100px;
        }
        .table-box .data-none .text-box{
            display: inline-block;
            margin-left: 60px;
        }
        .table-box .data-none .text-box .text-box-title{
            font-size: 24px;
            font-weight: 600;
            line-height: 28px;
            color: rgba(0, 0, 0, 0.65);
            padding-bottom: 15px;
        }
        .table-box .data-none .text-box .text-box-subtitle{
            font-size: 14px;
            line-height: 18px;
            color: rgba(0, 0, 0, 0.65);
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <div class="abacusshow-box" id="abacusshow" v-cloak>
        <div class="tip-box">
            <el-collapse v-model="activeNames" accordion>
                <el-collapse-item title="Tips" name="1">
                    <div>1.Data source and update frequency</div>
                    <div>2.Search function and parameter description</div>
                    <div>3.Search results and indicators</div>
                </el-collapse-item>
            </el-collapse>
        </div>
        <div class="search-box">
            <el-form ref="form" :model="searchForm" label-width="8px" size="small">
                <div class="search-box-row">
                    <el-row :gutter="30">
                        <el-col :span="4" class="label-title">
                            Date
                        </el-col>
                        <el-col :span="22" class="value-box">
                            <el-date-picker
                            size="mini"
                                v-model="searchForm.date"
                                type="date"
                                value-format="yyyy-MM-dd"
                                placeholder=""
                                :picker-options="pickerOptions">
                            </el-date-picker>
                        </el-col>
                    </el-row>
                </div>
                
                <div class="search-box-row">
                    <el-row :gutter="30">
                        <el-col :span="4" class="label-title">Platform</el-col>
                        <el-col :span="22" class="value-box">
                            <div class="bt-box" :class="isAll ? 'active': ''">Amazon</div>
                            <el-tooltip :value="true" :disabled="item.disabled" :content="item.platform" placement="top" effect="dark" v-for="(item,index) in platformOption" :key="index">
                                
                                <div class="bt-box" :class="item.checked ? 'active': ''" @click="platClick(item)">
                                    <span :ref="item.ref" @mouseenter.stop="mouseenter(item.ref,item)">{{item.platform}}</span>
                                </div>
                            </el-tooltip>
                        </el-col>
                    </el-row>
                </div>
                <div class="search-box-row">
                    <el-row :gutter="30">
                        <el-col :span="4" class="label-title">Marketplaces</el-col>
                        <el-col :span="22" class="value-box">
                            <div class="bt-box" :class="marketAll ? 'active': ''">United State</div>
                            <div class="bt-box" v-for="(item,index) in marketplacesArray" :key="index" :class="item.checked ? 'active': ''" @click="marketClick(item)">
                                <span>{{item.name}}</span>
                            </div>
                        </el-col>
                    </el-row>
                </div>
                <div class="search-box-row">
                    <el-row :gutter="30">
                        <el-col :span="4" class="label-title">Category</el-col>
                        <el-col :span="22" class="value-box">
                            <div class="bt-box" :class="isCtgyAll ? 'active': ''">Home & Kitchen</div>
                            <el-tooltip :value="true" :disabled="item.disabled" :content="item.category" placement="top" effect="dark" v-for="(item,index) in catagorys" :key="index">
                                <div class="bt-box" :class="item.checked ? 'active': ''" @click="categoryClick(item)" >
                                    <span style="padding: 0 6px;" :ref="item.ref" @mouseenter.stop="mouseenter(item.ref,item)">{{item.category}}</span>
                                </div>
                            </el-tooltip>
                        </el-col>
                    </el-row>  
                </div>
                <div class="search-box-row">
                    <el-row :gutter="30">
                        <el-col :span="4" class="label-title">Keyword</el-col>
                        <el-col :span="22" class="value-box">
                            <el-input v-model="searchForm.keywords" size="small"></el-input>
                        </el-col>
                    </el-row>
                        <!-- <div class="label-title">Keyword</div> -->
                </div>
                <div class="search-box-btn-row">
                        <div class="btn-box">
                            <el-button type="button" @click="reset" size="small">Reset</el-button>
                            <el-button type="primary" @click="doSearch" size="small">Search</el-button>
                        </div>
                </div>
                
            </el-form>
        </div>
        <div class="table-box" v-loading="loading">
            <div class="data-none" v-show="total == 0">
                <img src="./Application/Tpl/Home/DataCenter/img/search.png" alt="">
                <div class="text-box">
                    <div class="text-box-title">Sorry! It Seems that search results are empty.</div>
                    <div class="text-box-title">There are some tips might help.</div>
                    <div class="text-box-subtitle">1. Reduce screening criteria.</div>
                    <div class="text-box-subtitle"> 2. Use fuzzy keywords instead of precise keywords Let us know when you need support.</div>
                </div>
            </div>
            <div v-show="total>0">
                <div class="table-box-top">
                    <div class="table-total">
                        <p>Keyword:&nbsp;&nbsp;
                            <span style="font-weight: 600;">{{dataKeyword}}</span>
                        </p>
                        <p>Total:&nbsp;&nbsp;<span style="font-weight: 600;">{{total | format}} </span> records</p>
                    </div>
                    <div class="table-btn">
                        <el-button type="primary" @click="profitdialogVisible = true" size="small">
                            <span>Profit margin trial</span>
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">Use this function to calculate the profit of specific product</div>
                                <i class="el-icon-question" style="position: absolute;top: 0px;right: 1px;font-size: 10px;"></i>
                            </el-tooltip>
                        </el-button>
                        <el-button type="primary" @click="exportData" size="small">Export</el-button>
                    </div>
                    
                </div>
                <el-table :data="tableData" :empty-text="$lang('暂无数据')" stripe>
                    <el-table-column align="right" width="20px"></el-table-column>       
                    <el-table-column label="Products" align="left" width="280px">
                        <template slot-scope="scope">
                            
                            <el-popover placement="right" width="200"  trigger="hover" v-if="scope.row.thumb">
                                <el-image style="width: 200px; height: 200px" :src="scope.row.thumb"></el-image>
                                <div class="img-box" slot="reference">
                                    <el-image style="width: 60px; height: 60px" :src="scope.row.thumb"></el-image>
                                </div>
                            </el-popover>
                            <el-popover placement="right" width="200"  trigger="hover" v-else>
                                <el-image style="width: 200px; height: 200px" src="./img/place.png"></el-image>
                                <div class="img-box" slot="reference">
                                    <el-image style="width: 60px; height: 60px" src="./img/place.png"></el-image>
                                </div>
                            </el-popover>
                            <!-- <el-tooltip effect="dark" placement="left" v-if="scope.row.thumb">
                                <img slot="content" :src="scope.row.thumb" alt="">
                                <div class="img-box">
                                    <img class="table-img" :src="scope.row.thumb" alt="">
                                </div>
                            </el-tooltip>
                            <el-tooltip effect="dark" placement="left" v-else>
                                <img slot="content" src="./img/place.png" alt="" width="360px" height="350px">
                                
                                <div class="img-box">
                                    <img class="table-img" src="./img/place.png" alt="">
                                </div>
                            </el-tooltip> -->
                            <div class="txt-box">
                                <el-tooltip effect="dark" placement="top">
                                    <div slot="content" style="width: 400px;">{{scope.row.title}}</div>
                                    <div class="goods-name" @click="openLink(scope.row.link)">{{scope.row.title}}</div>
                                </el-tooltip>
                                <div class="goods-asin" @click="openLink(scope.row.link)">{{scope.row.itemId}}</div>
                                <div class="goods-brand">{{scope.row.brand}}</div>
                            </div>
                         </template>
                    </el-table-column>
                    <el-table-column label="Platform" align="left" width="130px">
                        <template slot-scope="scope">
                            <span v-if="scope.row.platform">{{scope.row.platform}}</span>
                            <span v-else>-</span>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="Marketplaces" align="left">
                        <template slot-scope="scope">
                            <span v-if="scope.row.marketplaces">{{scope.row.marketplaces}}</span>
                            <span v-else>-</span>
                        </template>
                    </el-table-column>
                    <el-table-column align="right">
                        <template slot="header" slot-scope="scope">
                            <div style="line-height: 12px;">BSR</div>
                            <div style="line-height: 12px;">Increase | Growth</div>
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">the newest BSR rank</div>
                                <i class="el-icon-question" style="top: -50px;right: -10px;"></i>
                            </el-tooltip>
                        </template>
                        <template slot-scope="scope">
                            <span style="padding-top: 20px;display: block;"> {{scope.row.bsr | format}}</span>
                            <div style="line-height: 12px;">
                                <span>
                                    <i v-if="scope.row.bsrIncrease !== '-' && scope.row.bsrIncrease>0" class="el-icon-top" style="font-size: 12px;color: #67C23A;"></i>
                                    <i v-if="scope.row.bsrIncrease !== '-' && scope.row.bsrIncrease<0" class="el-icon-bottom" style="font-size: 12px;color: #F56C6C;"></i>
                                    <span>{{scope.row.bsrIncrease == '-' ? scope.row.bsrIncrease : Math.abs(scope.row.bsrIncrease)}}</span>
                                </span>
                                <i>&nbsp;|&nbsp;</i>
                                <span>
                                    <i v-if="scope.row.bsrGrowth !== '-' && scope.row.bsrGrowth>0" class="el-icon-top" style="font-size: 12px;color: #67C23A;"></i>
                                    <i v-if="scope.row.bsrGrowth !== '-' && scope.row.bsrGrowth<0" class="el-icon-bottom" style="font-size: 12px;color: #F56C6C;"></i>
                                    <span>{{scope.row.bsrGrowth}}</span>
                                </span>
                            </div>
                            <!-- <el-tooltip effect="dark" placement="top" v-if="scope.row.bsr">
                                <div slot="content">
                                    <div v-for="(item,index) in scope.row.bsr_list" :key="index">{{index}}:{{item | format}}</div>
                                </div>
                                <i class="el-icon-question" style="position: relative;top: -55px;right: -5px;font-size: 12px;z-index: 10;"></i>
                            </el-tooltip> -->
                         </template>
                    </el-table-column>
                    <el-table-column align="right">
                        <template slot="header" slot-scope="scope">
                            Price
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">The newest price of products</div>
                                <i class="el-icon-question"></i>
                            </el-tooltip>
                        </template>
                        <template slot-scope="scope">
                            <span v-if="scope.row.price">{{scope.row.price | format}}</span>
                            <span v-else>-</span>
                         </template>
                    </el-table-column>
                    <el-table-column align="right">
                        <template slot="header" slot-scope="scope">
                            Reviews
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">The newest reviews of products</div>
                                <i class="el-icon-question"></i>
                            </el-tooltip>
                        </template>
                        <template slot-scope="scope">
                            <div v-if="scope.row.reviews"> {{scope.row.reviews | format}}</div>
                            <span v-else>-</span>
                         </template>
                    </el-table-column>
                    <el-table-column align="right">
                        <template slot="header" slot-scope="scope">
                            Rates
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">The newest rates of products</div>
                                <i class="el-icon-question"></i>
                            </el-tooltip>
                        </template>
                        <template slot-scope="scope">
                            <div v-if="scope.row.rating"> {{scope.row.rating | format}}</div>
                            <span v-else>-</span>
                         </template>
                    </el-table-column>
                    
                    <el-table-column align="right">
                        <template slot="header" slot-scope="scope">
                            Hotness
                            <!-- <el-tooltip effect="dark" placement="top">
                                <div slot="content">one index caculated by kinds of data from outside, it show the popularity of products</div>
                                <i class="el-icon-question"></i>
                            </el-tooltip> -->
                        </template>
                        <template slot-scope="scope">
                            <div v-if="scope.row.hotness"> {{scope.row.hotness | format}}</div>
                            <span v-else>-</span>
                         </template>
                    </el-table-column>
                    <el-table-column align="right" :show-overflow-tooltip="true">
                        <template slot="header" slot-scope="scope">
                            Pub Date
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">the published date of products</div>
                                <i class="el-icon-question"></i>
                            </el-tooltip>
                        </template>
                        <template slot-scope="scope">
                            <span v-if="scope.row.date"> {{scope.row.date}}</span>
                            <span v-else>-</span>
                         </template>
                    </el-table-column>
                    <el-table-column align="right">
                        <template slot="header" slot-scope="scope">
                            Fulfillment
                            <el-tooltip effect="dark" placement="top">
                                <div slot="content">the shipping method that sellers use</div>
                                <i class="el-icon-question"></i>
                            </el-tooltip>
                        </template>
                        <template slot-scope="scope">
                            <span v-if="scope.row.shippingWay"> {{scope.row.shippingWay}}</span>
                            <span v-else>-</span>
                         </template>
                    </el-table-column>
                    
                    <el-table-column label="Operations" align="right">
                        <template slot-scope="scope">
                            Hotness Trend
                            <!-- <span style="cursor: pointer;" @click="itemChartsChange(scope.row)">Hotness Trend</span> -->
                         </template>
                    </el-table-column>
                    <el-table-column align="right" width="40px"></el-table-column>
                </el-table>
                <div class="page" style="width: 700px;margin: 20px auto;" v-if="total>pageSize">
                    <el-pagination
                    background
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
                    :current-page="pageNo"
                    :page-sizes="[10, 30, 50, 100]"
                    :page-size="pageSize"
                    layout="sizes, prev, pager, next, jumper"
                    :total="total">
                    </el-pagination>
                </div>
            </div>
        </div>
        <el-dialog
            title="Profit Margin Trial"
            :visible.sync="profitdialogVisible"
            width="600px"
            center
            @close="closeDialog">
            <div class="dialog-tip">
                <div class="label">Operation tips:</div>
                <div class="text">Please input the selling price, logistics cost and purchase price of a single commodity, and select the corresponding category to calculate the profit margin of the commodity</div>
            </div>
            <div class="calculation-box">
                
                <el-form :model="calculation" label-width="80px" size="small">
                    <el-row :gutter="10">
                        <el-col :span="10">
                            <span class="label">{{$lang('商品销售收入')}}</span>
                        </el-col>
                    </el-row>
                    <el-row :gutter="10">
                        <el-col :span="10">
                            <el-form-item :label="$lang('销售价格$:')" prop="sellingPrice">
                                <el-input v-model="calculation.sellingPrice" type="number" @change="commissionChange"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="10">
                            <el-form-item :label="$lang('收取运费$:')" prop="collectFreight">
                                <el-input v-model="calculation.collectFreight" type="number"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row :gutter="10">
                        <el-col :span="10">
                            <span class="label">{{$lang('商品成本')}}</span>
                        </el-col>
                    </el-row>
                    <el-row :gutter="10">
                        <el-col :span="10">
                            <el-form-item :label="$lang('采购成本:')" prop="procurementCost">
                                <el-input v-model="calculation.procurementCost" type="number"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="10">
                            <el-form-item :label="$lang('头程运费:')" prop="headFreight">
                                <el-input v-model="calculation.headFreight" type="number"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row :gutter="10">
                        <el-col :span="10">
                            <span class="label">{{$lang('佣金')}}</span>
                        </el-col>
                    </el-row>
                    <el-row :gutter="10">
                        <el-col :span="8">
                            <el-form-item :label="$lang('佣金比例:')" prop="commissionRate">
                                <el-input v-model="calculation.commissionRate" @change="commissionChange" type="number">
                                    <template slot="append">%</template>
                                </el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item :label="$lang('佣金:')" prop="commission">
                                <span>{{calculation.commission}}</span>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-button type="primary" size="small" @click="count"style="width: 80px;">{{$lang('计算')}}</el-button>
                        </el-col>
                    </el-row>
                </el-form>
            </div>
            <el-row :gutter="10" style="margin-top: 20px;font-weight: 900;">
                <el-col :span="8">
                    <span class="label">{{$lang('利润：')}}</span>
                    <span>{{profit}}</span>
                </el-col>
                <el-col :span="8">
                    <span class="label">{{$lang('利润率：')}}</span>
                    <span>{{profitMargin}}</span>
                </el-col>
                <el-col :span="4">&nbsp;</el-col>
                <el-col :span="4">
                    <el-button size="small" type="button" @click="profitdialogVisible = false">{{$lang('确定')}}</el-button>
                </el-col>
            </el-row>
        </el-dialog>
        <el-dialog
            title="Hotness Trend"
            :visible.sync="chartsDialogVisible"
            width="1080px"
            center
            @close="chartClose">
            <div class="charts-box" v-loading="diaLoadding">
                <div class="top-text">
                            
                    <span class="text-label">Product:&nbsp;&nbsp;</span>
                    
                    <el-tooltip effect="dark" placement="top">
                        <div slot="content" style="width: 400px;">{{dialogItem.title}}</div>
                        <span class="text-val protxt">{{dialogItem.title}}</span>
                    </el-tooltip>
                    
                    <span class="text-label">Platform:&nbsp;&nbsp;</span>
                    <span class="text-val">{{dialogItem.platform}}</span>
                </div>
                <div id="charts-center" ref="refcharts" style="width: 100%;height:420px;">

                </div>
            </div>
        </el-dialog>
    </div>
</body>
<script type="text/javascript" src="/Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="/Application/Tpl/Home/Public/js/axios.min.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.8.2.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="/Application/Tpl/Home/Public//utils/utils.js"></script>
<script type="text/javascript" src="\Application\Tpl\Home\Public\js\H-ui.admin.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/echarts-4.2.1.js?v=<{$Think.config.VER_NUM}>">
</script>
<script src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>"></script>
<script>
    var VM = new Vue({
        el: '#abacusshow',
        data() {
            return {
                activeNames: '1',
                pickerOptions:{
                    disabledDate(time) {
                        return time.getTime() > Date.now();
                    },
                },
                dataKeyword: '',
                platformOption: [],
                pageNo: 1,
                pageSize: 10,
                total: 0,
                loading: false,
                tableData: [],
                searchForm: {
                    // year: '2020',
                    // month: 2,
                    date: this.getBeforeDate(1),
                    catagory: 'ALL',
                    keywords: '',
                    platcodeArray: 10,
                    marketArray: 'ALL'
                },
                // monthOptions: [1,2,3,4,5,6,7,8,9,10,11,12], // 月份
                isAll: true, // 平台全选
                catagorys: [], // 分类
                // catagoryIds: [],
                isCtgyAll: true, //分类全选
                marketAll: true, // market全选
                profitdialogVisible: false, // 利润计算器弹窗
                calculation: {
                    sellingPrice: '', // 销售价格
                    collectFreight: '', // 收取运费
                    procurementCost: '', // 采购成本
                    headFreight: '', // 头程运费
                    commissionRate: '', // 佣金比例
                    commission: '', // 佣金
                },
                profit: '', // 利润
                profitMargin: '', // 利润率
                myChart: null,
                chartsDialogVisible: false, // 图表弹窗
                dialogItem: '',
                diaLoadding: true,
                marketplacesArray: [],
                allMarketplacesArray: [],
                // sitescodeArray: [],
                access_token: 'Y2xpZW50OnBAc3N3b3Jk',
            }

        },
        created() {
            this.login()
            // this.initLogin();
        },
        
        filters: {
            // 数字加上千分位
            format :function format(num) {
                if (num === '-') return num
                num = Number(num).toFixed(2)
                var num1=num.split('.')[0]+'';//数字转字符串  
                var str="";//字符串累加  
                for(var i=num1.length- 1,j=1;i>=0;i--,j++){  
                    if(j%3==0 && i!=0 && num1[i-1] != '-'){//每隔三位加逗号，过滤正好在第一个数字的情况 过滤负数情况 
                        str+=num1[i]+",";//加千分位逗号  
                        continue;  
                    }  
                    str+=num1[i];//倒着累加数字
                }
                return `${str.split('').reverse().join("")}${num.split('.')[1] == '00' ? '' : '.' + num.split('.')[1]}`
                // return str.split('').reverse().join("") + '.' +  : '';//字符串=>数组=>反转=>字符串  
            },
        },
        methods: {
            requestGet(url, param) {
                var host = '//mtapi.gshopper.com';
                return axios.get(host + url, { params: param, headers: { "Authorization": `Bearer ${this.access_token}` } });
            },
            requestPost(url, param) {
                var headers = {
                    headers: {
                        "Authorization": `Basic ${this.access_token}`
                    }
                };
                var host = '//mtapi.gshopper.com';
                return axios.post(host + url, param, headers);
            },
            mouseenter(refStr,item){
                if(this.$refs[refStr][0].offsetWidth >this.$refs[refStr][0].parentNode.offsetWidth){
                    item.disabled = false;
                } else {
                    item.disabled = true
                }
            },
            // 获取
            getMarketplaces() {

            },
            // 计算搜索时间
            getBeforeDate(n){
                var n = n;
                var d = new Date();
                var year = d.getFullYear();
                var mon=d.getMonth()+1;
                var day=d.getDate();
                if(day <= n){
                    if(mon>1) {
                        mon=mon-1;
                    }
                    else {
                        year = year-1;
                        mon = 12;
                    }
                }
                d.setDate(d.getDate()-n);
                year = d.getFullYear();
                mon=d.getMonth()+1;
                day=d.getDate();
                s = year+"-"+(mon<10?('0'+mon):mon)+"-"+(day<10?('0'+day):day);
                return s;
            },
            // 图表弹窗关闭
            chartClose() {
                this.myChart.clear();
            },
            // 打开图表弹窗
            itemChartsChange(item) {
                this.chartsDialogVisible = true;
                this.dialogItem = item;
                this.getChartsData(item);
                
            },   
            getChartsData(item) {
                var param = {
                    item_id: item.item_id,
                    platform_id: item.platform_id,
                    country_code: item.country_code,
                    date: item.date
                }
                axios.get("/index.php?m=DataCenter&a=getMonthlyHotness",{params:param}).then((res) => {
                    console.log(res);
                    this.diaLoadding = false;
                    if(res.status === 200 && res.data.data) {
                        
                        this.initCharts(res.data.data);
                    }
                })
            },
             // 获取分类
            getCatagory() {
                var config = {
                    "headers": {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "Authorization": 'Bearer'
                    },
                }
                axios.get("/index.php?m=DataCenter&a=categories").then((res) => {
                    console.log(res);
                    if(res.status === 200) {
                        this.catagorys = res.data.list.map(item=>{
                            return {
                                category: item.category,
                                category_id: item.category_id,
                                checked: false,
                                disabled: true,
                                ref: 'ref'+item.category_id
                            }
                        });
                    }
                })
            },
            // 获取平台
            getPlatforms() {
                axios.get("/index.php?m=DataCenter&a=platforms").then((res) => {
                    console.log(res.data.data);
                    if(res.status === 200) {
                        this.platformOption = res.data.data.map(item => {
                            return {
                                id: item.id,
                                platform: item.platform,
                                createdAt: item.createdAt,
                                checked: false,
                                disabled: true,
                                ref: 'refPlat' + item.id,
                                country_codes: item.country_codes
                            }
                        });
                        let marketArray = res.data.data.map(item => {
                            return item.country_codes
                        });
                        let arr = [];
                        for(i=0;i<marketArray.length;i++){
                            arr = arr.concat(marketArray[i])
                        }
                        arr = Array.from(new Set(arr));
                        this.allMarketplacesArray = arr;
                        this.marketplacesArray = arr.map(item=>{
                            return {
                                name: item,
                                checked: false,
                            }
                        });
                    }
                })
            },
            initLogin(){
                // this.getCatagory();
                // this.getPlatforms();
                this.search();
            },
            // 鉴权
            login() {
                var param = {}
                this.requestPost("/login?username=test@gshopper.com&password=izene123&grant_type=password", param).then((res) => {
                    if (res.status === 200) {

                        this.access_token = res.data.access_token;
                        this.search();
                    } else {
                        this.$message.error('鉴权失败');
                    }
                }).catch((error) => {
                    this.$message.error(error);
                })

            },
            openLink(link){
                window.open(link)
            },
            removeRepeat(arr) {
                console.log(arr);
                let res = []
                let obj = {}
                for (let i = 0; i < arr.length; i++) {
                    if (!obj[arr[i].name]) { // name  对应数组中的name
                        res.push(arr[i])
                        obj[arr[i].name] = true;
                        console.log(1);
                    }
                }
                return res;
            },
            findMarketOpt(arr) {
                var array = [];
                for(i=0;i<arr.length;i++){
                    var itemArr = this.platformOption.find(item=> {
                        console.log()
                        return item.id === arr[i];
                    }).country_codes;
                    array.push(itemArr);
                }
                let array2 = []
                for(i=0;i<array.length;i++){
                    array2 = array2.concat(array[i])
                }
                array2 = array2.map(item => {
                    return {
                        name: item,
                        checked: false
                    }
                })
                return this.removeRepeat(array2);
            },
            // market搜索
            marketClick(item) {
                if(!item){
                    this.marketAll = true;
                    this.searchForm.marketArray = [];
                    for (var key in this.marketplacesArray) {
                        this.marketplacesArray[key].checked = false;
                    }
                } else {
                    this.marketAll = false;
                    item.checked = !item.checked;
                    if(item.checked) {
                        this.searchForm.marketArray.push(item.name)
                    } else {
                        var index = this.searchForm.marketArray.indexOf(item.name);
                        this.searchForm.marketArray.splice(index,1);
                    }
                    if(this.searchForm.marketArray.length === 0) {
                        
                        this.marketAll = true;
                    }
                }
            },
            // Platform搜索
            platClick(item){
                if(!item){
                    this.isAll = true;
                    this.marketAll = true;
                    this.searchForm.marketArray = [];
                    this.marketplacesArray = this.allMarketplacesArray.map(item=>{
                        return {
                            name: item,
                            checked: false,
                        }
                    });
                    this.searchForm.platcodeArray = [];
                    for (var key in this.platformOption) {
                        this.platformOption[key].checked = false;
                    }
                } else {
                    this.isAll = false;
                    this.marketAll = true;
                    this.searchForm.marketArray = [];
                    item.checked = !item.checked;
                    if(item.checked) {
                        this.searchForm.platcodeArray.push(item.id);
                        this.marketplacesArray = this.findMarketOpt(this.searchForm.platcodeArray);
                    } else {
                        var index = this.searchForm.platcodeArray.indexOf(item.id);
                        this.searchForm.platcodeArray.splice(index,1);
                        this.marketplacesArray = this.findMarketOpt(this.searchForm.platcodeArray);
                    }
                    if(this.searchForm.platcodeArray.length === 0) {
                        this.isAll = true;
                        this.marketplacesArray = this.allMarketplacesArray.map(item=>{
                            return {
                                name: item,
                                checked: false,
                            }
                        });
                    }
                    
                }
                
            },
            // Category搜索
            categoryClick(item) {
                if(!item){
                    this.isCtgyAll = true;
                    this.searchForm.catagory = [];
                    for (var key in this.catagorys) {
                        this.catagorys[key].checked = false;
                    }
                } else {
                    this.isCtgyAll = false;
                    item.checked = !item.checked;
                    if(item.checked) {
                        this.searchForm.catagory.push(item.category_id)
                    } else {
                        var index = this.searchForm.catagory.indexOf(item.category_id);
                        this.searchForm.catagory.splice(index,1);
                    }
                    if(this.searchForm.catagory.length === 0) {
                        
                        this.isCtgyAll = true;
                    }
                }
            },
            // 创建图表
            initCharts(data) {
                 console.log(data);
                this.myChart = echarts.init(this.$refs.refcharts);
                var option = {

                    tooltip: {
                        trigger: 'axis',
                        formatter: (param) => {
                            var name = param[0].name.replace(/-/g,'/');
                            var str = `${name}<br/>`;
                            var value = param[0].value.hotness;
                            str += `${param[0].marker} Hotness：${value}`;
                            return str
                        }
                    },
                    legend: {
                        icon: 'rect',
                        bottom: 0,
                        itemWidth: 10,
                        itemHeight: 10,
                        data: ['Hotness']
                    },
                    xAxis: {
                        type: 'category',
                        axisTick: {
                            show: false
                        },
                        axisLabel: {
                            interval: 0,
                            rotate:40,
                            formatter: function(value){
                                return value.replace(/-/g,'/')
                            },
                            showMaxLabel: true
                        },
                    },
                    yAxis: {
                        type: 'value',
                        splitLine: {
                            lineStyle: {
                                type: 'dotted',
                                color: '#F0F0F0'
                            }
                        },
                        splitNumber:4,
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        },
                    },
                    grid: {
                        right: 60,
                        left: 60,
                        bottom:80,
                    },
                    dataset: {
                        source: data,
                        // [
                        //     {'date':'2020-04/23','hotness':'5.6'},
                        //     {'date':'2020-04/24','hotness':'5.1'},
                        //     {'date':'2020/04/25','hotness':'7.6'},
                        //     {'date':'2020/04/26','hotness':'9.6'},
                        //     {'date':'2020/04/27','hotness':'4.6'},
                        //     {'date':'2020/04/28','hotness':'5.6'},
                        //     {'date':'2020/04/29','hotness':'5.1'},
                        //     {'date':'2020/04/30','hotness':'9.6'},
                        //     {'date':'2020/05/01','hotness':'8.6'},
                        //     {'date':'2020/05/02','hotness':'1.6'},
                        //     {'date':'2020/05/03','hotness':'3.6'},
                        //     {'date':'2020/05/04','hotness':'5.6'},
                        //     {'date':'2020/05/05','hotness':'2.6'},
                        //     {'date':'2020/05/06','hotness':'4.6'},
                        //     {'date':'2020/05/07','hotness':'6.6'},
                        //     {'date':'2020/05/08','hotness':'7.6'},
                        //     {'date':'2020/05/09','hotness':'5.6'},
                        //     {'date':'2020/05/10','hotness':'1.6'},
                        //     {'date':'2020/05/11','hotness':'3.6'},
                        //     {'date':'2020/05/12','hotness':'8.6'},
                        //     {'date':'2020/05/13','hotness':'0.6'},
                        //     {'date':'2020/05/14','hotness':'1.6'},
                        //     {'date':'2020/05/15','hotness':'2.6'},
                        //     ],
                    },
                    series: [{
                        name:'Hotness',
                        type: 'line',
                        symbol: 'none',
                        color: '#0375DE',
                    }]
                };
                this.myChart.setOption(option);
            },
            // 分页
            handleSizeChange(size) {
                console.log(size)
                this.pageSize = size;
                this.search();
            },
            handleCurrentChange(page) {
                this.pageNo = page;
                this.search();
            },
            // 导出
            exportData() {
                var param = {
                    platform: this.searchForm.platcodeArray,
                    marketplaces: this.searchForm.marketArray,
                    date: this.searchForm.date,
                    category: this.searchForm.catagory,
                    Keyword: this.searchForm.keywords.trim(),
                    modelVersion: 'hotness0.4'
                }

                axios.get('//mtapi.gshopper.com/api/abacus/selectionTool/products/export', { 
                    params: param, 
                    headers: { "Authorization": `Bearer ${this.access_token}` },
                    responseType: 'blob'
                }).then((res) => {
                    let blob = res.data
                    let reader = new FileReader()
                    reader.readAsDataURL(blob)
                    reader.onload = (e) => {
                        let a = document.createElement('a')
                        a.download = this.searchForm.date + '选品工具导出.csv'
                        a.href = e.target.result
                        document.body.appendChild(a)
                        a.click()
                        document.body.removeChild(a)
                    }
                }).catch(err => {
                    console.log(err)
                });
            },
            // 重置搜索
            reset() {
                this.pageSize = 10;
                this.pageNo = 1;
                // this.platClick();
                // this.categoryClick();
                this.searchForm.keywords = '';
                this.searchForm.date = this.getBeforeDate(1);
                this.search();
            },
            doSearch() {
                this.pageSize = 10;
                this.pageNo = 1;
                this.search();
            },
            // 搜索
            search() {
                
                this.loading = true;
                var param = {
                    pageSize: this.pageSize,
                    page: this.pageNo,
                    platform: this.searchForm.platcodeArray,
                    marketplaces: this.searchForm.marketArray,
                    date: this.searchForm.date,
                    category: this.searchForm.catagory,
                    Keyword: this.searchForm.keywords.trim(),
                    modelVersion: 'hotness0.4'
                }
                this.requestGet("/api/abacus/selectionTool/products/hotness", param).then((res) => {
                    this.loading = false;
                    if (res.status === 200) {
                            this.tableData = res.data.productList;
                            this.total = res.data.totalElement;
                            this.dataKeyword = this.searchForm.keywords;
                            // this.total = 70;

                    } else {
                        this.$message.error(res.data.msg);
                    }
                }).catch((error) => {
                    this.$message.error(error);
                })
            },
            // 计算佣金
            commissionChange() {
                if(this.calculation.sellingPrice && this.calculation.commissionRate){
                    this.calculation.commission = (this.calculation.sellingPrice*this.calculation.commissionRate/100).toFixed(2);
                }
            },
            
            closeDialog() {
                this.calculation.sellingPrice = "";
                this.calculation.procurementCost = "";
                this.calculation.commission = "";
                this.calculation.commissionRate = "";
                this.calculation.collectFreight = "";
                this.calculation.headFreight = "";
                this.profit = "";
                this.profitMargin = "";
            },
            // 计算利润
            count() {
                if(!this.calculation.sellingPrice) {
                    this.$message.warning(this.$lang('销售价格必须填写'));
                    return false;
                }
                if(!this.calculation.procurementCost) {
                    this.$message.warning(this.$lang('采购成本必须填写'))
                    return false;
                }
                if(!this.calculation.commission) {
                    this.$message.warning(this.$lang('佣金比例必须填写'))
                    return false;
                }
                this.calculation.collectFreight = this.calculation.collectFreight ? this.calculation.collectFreight : 0;
                this.calculation.headFreight = this.calculation.headFreight ? this.calculation.headFreight : 0;
                this.profit = (Number(this.calculation.sellingPrice) + Number(this.calculation.collectFreight))-(Number(this.calculation.procurementCost)+Number(this.calculation.headFreight)+Number(this.calculation.commission));
                this.profit = this.profit.toFixed(2);
                this.profitMargin = (this.profit/this.calculation.sellingPrice*100).toFixed(2) + '%';
            }
        },
    })
</script>
</html>