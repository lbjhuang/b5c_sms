<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.13.0.css?v=<{$Think.config.VER_NUM}>">
  <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.config.VER_NUM}>">
  <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
  <link rel="stylesheet" href="./Application/Tpl/Home/DataCenter/css/element-ui-custom.css?v=<{$Think.config.VER_NUM}>">
  <link rel="stylesheet"
    href="./Application/Tpl/Home/DataCenter/css/gp_channel_transfer.css?v=<{$Think.config.VER_NUM}>">
  <title>{{$lang('GP 渠道转化分析')}}</title>
  <style>

    .flex-center {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .el-collapse-item__header {
      padding-left: 20px;
    }

    .el-collapse-item__wrap {
      padding-left: 20px;
    }

    .query {
      position: relative;
      padding: 40px 20px 40px;
      font-size: 14px;
      background: #fff;
    }

    .query .tooltip {
      position: absolute;
      right: 0;
    }

    .query .title {
      flex: 0 0 auto;
      width: 30px;
      margin-right: 40px;
      font-size: 14px;
      font-weight: 400;
      color: rgba(0, 0, 0, 0.85);
    }

    .query .el-checkbox {
      margin-right: 24px;
      margin-bottom: 25px;
      color: rgba(0, 0, 0, 0.65);
    }

    .query .el-checkbox__input {
      display: none;
    }

    .query .el-checkbox__label {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 120px;
      height: 28px;
      padding-left: 0;
      border-radius: 14px;
      background: #F4F4F4;
    }

    .query .el-checkbox__input.is-checked+.el-checkbox__label {
      color: #fff;
      background: rgba(3, 117, 222, 1);
    }

    .date {
      display: flex;
      align-items: center;
    }

    .date .el-radio {
      margin-right: 24px;
      color: rgba(0, 0, 0, 0.65);
    }

    .date .el-radio__input {
      display: none;
    }

    .date .el-radio__label {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 120px;
      height: 28px;
      padding-left: 0;
      border-radius: 14px;
      background: #F4F4F4;
    }

    .date .el-radio__input.is-checked+.el-radio__label {
      color: #fff;
      background: rgba(3, 117, 222, 1);
    }

    .date .el-input__inner {
      height: 35px;
    }

    .channels,
    .sites {
      display: flex;
      margin-top: 25px;
      margin-bottom: -25px;
    }

    .channels .title {
      margin-top: 6px;
    }

    .channels .info {
      display: flex;
      flex-wrap: wrap;
    }

    .sites .title {
      margin-top: 6px;
    }

    .sites .info {
      display: flex;
      flex-wrap: wrap;
    }


    .statistics {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }

    .statistics-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around;
      width: 24.08%;
      height: 130px;
      padding: 30px 0;
      font-size: 16px;
      background: rgba(255, 255, 255, 1);
      border-radius: 8px;
    }

    .statistics-item-data {
      font-size: 40px;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.85);
    }

    .statistics-item .el-icon-caret-bottom {
      color: #FB022B;
    }

    .statistics-item .el-icon-caret-top {
      color: #2FC25B;
    }

    .charts {
      margin-top: 20px;
    }

    .channelRol {
      height: 730px;
      padding: 20px 1.2% 30px;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
    }

    .users-container {
      display: flex;
      justify-content: space-between;
      padding: 20px 1.19% 0;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
    }

    .users-transfer-chart,
    .users-chart {
      width: 45%;
    }

    .users-chart {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .flex-container {
      display: flex;
      justify-content: space-between;
    }

    .flex-container .channel-orders {
      box-sizing: border-box;
      width: 49.44%;
      padding: 20px 1.23% 0;
      background: #FFFFFF;
      border-radius: 8px;
    }

    .chart-title {
      margin-bottom: 8px;
      font-size: 16px;
      font-weight: bold;
    }

    .chart-date {
      font-weight: 400;
      color: rgba(0, 0, 0, 0.65);
    }

    .channel-orders__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .channel-orders .el-select {
      width: 120px;
    }

    .channel-orders .el-select .el-input__inner {
      height: 32px;
    }

    .channel-orders .el-select .el-input__suffix {
      top: 3px;
    }

    .channel-sites {
      padding: 20px 1.23% 0;
      margin-top: 20px;
      background: #FFFFFF;
      border-radius: 8px;
    }

    .browse-goods-table {
      padding: 20px;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
    }

    .el-popover {
      padding: 20px;
      font-size: 12px;
      width: 537px;
    }

    .el-popover .title {
      font-size: 16px;
      color: #000;
    }

    .el-tooltip__popper.is-light.tooltip {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      opacity: 0.95;
      border: none;
    }

    .browse-goods-table-expand {
      background: #F4F4F4;
    }

    .browse-goods-table-expand .cell {
      padding-left: 0;
    }

    .browse-goods-table-expand .cell .el-table__expand-icon {
      padding: 32px 0;
    }
  </style>
</head>

<body>
  <div id="vm" v-cloak>
    <div>
      <el-collapse v-model="activeNames">
        <el-collapse-item name="1">
          <template slot="title">
            <span style="font-weight: bold; font-size: 16px;">{{$lang('提示')}}</span>
          </template>
          <div>1.{{$lang('页面展示渠道范围：营销管理-平台管理中记录的平台')}}</div>
          <div>2.{{$lang('页面所展示数据为：Web与Wap 推广用户行为数据，不包含Android与iOS端用户行为数据')}}</div>
          <div>3.{{$lang('数据更新：页面展示数据更新至当日')}}</div>
        </el-collapse-item>
      </el-collapse>
      <div class="query">
        <div class="date">
          <div class="title">{{$lang('周期')}}</div>
          <el-radio v-model="dateTime" :label="date.value" v-for="date in dates" :key="date.value"
            @change="dateTimeChange">
            {{$lang(date.name)}}</el-radio>
          <el-date-picker v-model="rangeDate" :picker-options="pickerOptions" value-format="yyyy-MM-dd" type="daterange"
            range-separator="-" :start-placeholder="$lang('开始日期')" :end-placeholder="$lang('结束日期')"
            @change="rangeDateChange">
          </el-date-picker>
        </div>
        <div class="channels">
          <div class="title">{{$lang('渠道')}}</div>
          <div class="info">
            <el-checkbox v-model="checkAll" @change="handleCheckAllChange">{{$lang('全部')}}</el-checkbox>
            <el-tooltip v-for="(chanel, index) in chanelOptions" :key="chanel.platform_tag"
              :disabled="contentNotOverflowed(chanel.platform_name, 12, false)"
              :content="transStr(chanel.platform_name, false)" placement="top">
              <el-checkbox v-model="chanel.checked" :label="chanel.platform_tag" @change="handleCheckedChannelsChange">
                {{chanel.platform_name | strOmit(12)}}
              </el-checkbox>
            </el-tooltip>
          </div>
        </div>
        <section class="sites">
          <div class="title">{{$lang('站点')}}</div>
          <div class="info">
            <el-checkbox v-model="checkAllSite" @change="checkAllSiteChange">{{$lang('全部')}}</el-checkbox>
            <el-tooltip v-for="(site, index) in siteOptions" :key="site.sitecode"
              :disabled="contentNotOverflowed(site.sitename, 12, false)" :content="site.sitename"
              placement="top">
              <el-checkbox v-model="site.checked" :label="site.sitecode" @change="checkedSitesChange">
                {{site.sitename | strOmit(12)}}
              </el-checkbox>
            </el-tooltip>

          </div>
        </section>

      </div>
      <div class="statistics">
        <div class="statistics-item">
          <div>{{$lang('今日渠道购买用户')}}</div>
          <div class="statistics-item-data">{{channelStatisticData.user_metric_value}}</div>
          <div>
            {{$lang('环比')}}
            <i class="el-icon-caret-bottom" v-if="channelStatisticData.user_metric_value_ratio < 0"></i>
            <i class="el-icon-caret-top" v-else-if="channelStatisticData.user_metric_value_ratio > 0"></i>
            {{channelStatisticData.user_metric_value_ratio + '%' | ratioZero}}
          </div>
        </div>
        <div class="statistics-item">
          <div>{{$lang('今日渠道订单销售额')}}</div>
          <div class="statistics-item-data">$ {{channelStatisticData.sale_metric_value | toMillion}}</div>
          <div>
            {{$lang('环比')}}
            <i class="el-icon-caret-bottom" v-if="channelStatisticData.sale_metric_value_ratio < 0"></i>
            <i class="el-icon-caret-top" v-else-if="channelStatisticData.sale_metric_value_ratio > 0"></i>
            {{channelStatisticData.sale_metric_value_ratio + '%' | ratioZero}}
          </div>
        </div>
        <div class="statistics-item">
          <div>{{$lang('渠道购买用户累计')}}</div>
          <div class="statistics-item-data">{{channelStatisticData.user_metric_value_sum}}</div>
          <div style="visibility: hidden">
            {{$lang('环比')}}
          </div>
        </div>
        <div class="statistics-item">
          <div>{{$lang('渠道订单销售额累计')}}</div>
          <div class="statistics-item-data">$ {{channelStatisticData.sale_metric_value_sum | toMillion}}</div>
          <div style="visibility: hidden">
            {{$lang('环比')}}
          </div>
        </div>
      </div>
    </div>

    <div class="charts">
      <!-- <div class="channelRol">
        <div class="chart-title">
          {{$lang('渠道ROI趋势')}}
        </div>
        <div class="chart-date">{{channelUsersTransferChartData.dateTime}}
          <span v-show="rangeDateInfo"> | {{$lang(rangeDateInfo)}}</span>
        </div>
        <div ref="channelRoIChart" style="width: 97.6%; height: 680px;"></div>
      </div> -->

      <div class="users-container">
        <div class="users-transfer-chart">
          <div class="chart-title">
            {{$lang('渠道用户转化')}}
          </div>
          <div class="chart-date">{{channelUsersTransferChartData.dateTime}}
            <span v-show="rangeDateInfo"> | {{$lang(rangeDateInfo)}}</span>
          </div>
          <section style="margin-top: 32px;">
            <div style="position: relative; left: 315px; display: flex;flex-direction: column;align-items: center;width: 130px;height: 100px; box-sizing: border-box; padding-top: 15px;background: url('./Application/Tpl/Home/DataCenter/img/convert-ratio2.png') no-repeat;font-size: 14px;
                              font-weight: 500;color: rgba(0,0,0,0.45);background-size: cover;">
              <span>{{ $lang('整体转化率') }}</span>
              <span
                style="font-size: 32px;font-weight: 600;color: rgba(0,0,0,0.85)">{{ channelUsersTransferChartData.entirety[0] | ratioZero }}</span>
            </div>
          </section>
          <div ref="channelUsersTransferChart" style="width: 100%; height: 440px;"></div>
        </div>

        <el-radio-group v-model="usersTransferStep" class="users-operate" @change="getStepUsersChartData">
          <el-tooltip :disabled="contentNotOverflowed('渠道用户', 5)" :content="$lang('渠道用户')" placement="top">
            <el-radio-button label="1013">
              {{$lang('渠道用户') | strOmit(5)}}
              <el-tooltip :content="$lang('统计周期内，各渠道用户数（按照用户标识去重）之和')" placement="right" effect="light"
                popper-class="tooltip" :visible-arrow="false">
                <i class="el-icon-question el-icon--right"></i>
              </el-tooltip>
            </el-radio-button>
          </el-tooltip>

          <el-tooltip :disabled="contentNotOverflowed('浏览商品', 5)" :content="$lang('浏览商品')" placement="top">
            <el-radio-button label="1014">
              {{$lang('浏览商品') | strOmit(5)}}
              <el-tooltip :content="$lang('统计周期内，各渠道浏览商品用户数（按照用户标识去重）之和')" placement="right" effect="light"
                popper-class="tooltip" :visible-arrow="false">
                <i class="el-icon-question el-icon--right"></i>
              </el-tooltip>
            </el-radio-button>
          </el-tooltip>

          <el-tooltip :disabled="contentNotOverflowed('注册用户', 5)" :content="$lang('注册用户')" placement="top">
            <el-radio-button label="1015">
              {{$lang('注册用户') | strOmit(5)}}
              <el-tooltip :content="$lang('统计周期内，各渠道注册用户数之和')" placement="right" effect="light" popper-class="tooltip"
                :visible-arrow="false">
                <i class="el-icon-question el-icon--right"></i>
              </el-tooltip>
            </el-radio-button>
          </el-tooltip>

          <el-tooltip :disabled="contentNotOverflowed('加购用户', 5)" :content="$lang('加购用户')" placement="top">
            <el-radio-button label="1016">
              {{$lang('加购用户') | strOmit(5)}}
              <el-tooltip :content="$lang('统计周期内，各渠道有加入购物车行为的用户数之和')" placement="right" effect="light"
                popper-class="tooltip" :visible-arrow="false">
                <i class="el-icon-question el-icon--right"></i>
              </el-tooltip>
            </el-radio-button>
          </el-tooltip>

          <el-tooltip :disabled="contentNotOverflowed('购买用户', 5)" :content="$lang('购买用户')" placement="top">
            <el-radio-button label="1012">
              {{$lang('购买用户') | strOmit(5)}}
              <el-tooltip :content="$lang('统计周期内，各渠道成功购买的用户数之和')" placement="right" effect="light"
                popper-class="tooltip" :visible-arrow="false">
                <i class="el-icon-question el-icon--right"></i>
              </el-tooltip>
            </el-radio-button>
          </el-tooltip>

        </el-radio-group>

        <chart-wrapper ref="stepUsersChart" :title="$lang(stepUsersChartTitle)"
          :date-range="channelUsersTransferChartData.dateTime" :date-range-explain="$lang(rangeDateInfo)"
          class="users-chart" chart-height="520px">
        </chart-wrapper>
        <!-- <div class="users-chart">
  
          <div class="chart-date">{{channelUsersTransferChartData.dateTime}}
            <span v-show="rangeDateInfo"> | {{$lang(rangeDateInfo)}}</span>
          </div>
          <div ref="stepUsersChart" style="width: 100%; height: 470px;"></div>
        </div> -->
      </div>

      <div class="flex-container">
        <div class="channel-orders">
          <section class="channel-orders__header">
            <section>
              <div class="chart-title">
                <span v-if="channelScaleChartType == 1021">{{$lang('渠道订单分布')}}</span>
                <span v-else>{{$lang('渠道订单销售额分布')}}</span>
              </div>
              <div class="chart-date">{{channelUsersTransferChartData.dateTime}}
                <span v-show="rangeDateInfo"> | {{$lang(rangeDateInfo)}}</span>
              </div>
            </section>
            <el-select v-model="channelScaleChartType" @change="getChannelScaleChartData">
              <el-option :label="$lang('按订单数')" value="1021">
              </el-option>
              <el-option :label="$lang('按销售额')" value="1022">
              </el-option>
            </el-select>
          </section>

          <div ref="channelScaleChart" style="width: 100%; height: 490px;" v-show="channelScaleChartData.length"></div>
          <div class="flex-center" style="width: 100%; height: 490px; z-index: 999;" v-show="!channelScaleChartData.length">
            {{$lang('暂无数据')}}
          </div>
        </div>

        <div class="channel-orders">
          <section class="channel-orders__header">
            <section>
              <div class="chart-title">
                <span v-if="channelOrdersChartType == 1021">{{$lang('渠道订单趋势')}}</span>
                <span v-else>{{$lang('渠道订单销售额趋势')}}</span>
              </div>
              <div class="chart-date">{{channelUsersTransferChartData.dateTime}}
                <span v-show="rangeDateInfo"> | {{$lang(rangeDateInfo)}}</span>
              </div>
            </section>
            <el-select v-model="channelOrdersChartType" @change="getChannelOrdersChartData">
              <el-option :label="$lang('按订单数')" value="1021">
              </el-option>
              <el-option :label="$lang('按销售额')" value="1022">
              </el-option>
            </el-select>
          </section>

          <div ref="channelOrdersChart" style="width: 100%; height: 490px;" v-show="channelOrdersChartData.length"></div>
          <div class="flex-center" style="width: 100%; height: 490px; z-index: 999;" v-show="!channelOrdersChartData.length">
            {{$lang('暂无数据')}}
          </div>
        </div>
      </div>

      <section>
        <section class="erp-chart" style="margin-top: 20px;padding: 20px 20px 40px;">
          <header class="erp-chart__header">
            <section>
              <div class="erp-chart__title">
                {{$lang('渠道订单明细')}}
              </div>
              <div class="erp-chart__date">
                {{channelOrderData.datas.dateTime}}
              </div>
            </section>
            <section v-show="channelOrderData.datas.dateInfo.length > 0">
              <el-button plain class="erp-el-button" style="width: 78px; background: #0375DE; color: #fff;"
                @click="channelOrderTableExport">
                {{ $lang('导出') }}
              </el-button>
            </section>
          </header>
          <main class="erp-chart__main">
            <section style="margin: 32px 0; font-size: 12px; color: rgba(0, 0, 0, 0.65); font-weight: 400;">
              <span>{{$lang('所选渠道产生订单')}} {{channelOrderData.datas.order | formatNum}}</span>
              <span style="margin-left: 40px;">{{$lang('销售额合计')}}
                ${{channelOrderData.datas.sale_amount | toMillion}}</span>
            </section>
            <el-table ref="channelOrderTable" stripe v-loading="channelOrderTableLoading"
              :data="channelOrderData.datas.dateInfo" :default-sort="{prop: 'pay_time',order: 'descending'}"
              @sort-change="channelOrderTableSort" class="erp-el-table" style="margin-top: 20px;"
              v-show="channelOrderData.datas.dateInfo.length > 0">

              <el-table-column prop="order_no" :label="$lang('订单号')" >              </el-table-column>
              <el-table-column prop="plat_name" :label="$lang('所属站点')" sortable="custom" :sort-orders="tableSortOrders">
              </el-table-column>
              <el-table-column prop="channel_name" :label="$lang('所属渠道')" sortable="custom"
                :sort-orders="tableSortOrders">
              </el-table-column>
              <el-table-column prop="act_name" :label="$lang('转化来源')" show-overflow-tooltip>
              </el-table-column>
              <el-table-column prop="order_status" :label="$lang('订单状态')">
              </el-table-column>
              <el-table-column prop="pay_time" :label="$lang('付款时间')" sortable="custom" :sort-orders="tableSortOrders"
                show-overflow-tooltip>
              </el-table-column>
              <el-table-column prop="pay_time" :label="$lang('订单商品明细')">
                <template slot-scope="scope">
                  <el-button class="erp-el-button--text" @click="orderGoodsDetailOpen(scope.row)" type="text">
                    {{$lang('商品明细')}}
                  </el-button>
                </template>
              </el-table-column>
              <el-table-column :label="$lang('销售额')" prop="sale_value" align="right" sortable="custom"
                :sort-orders="tableSortOrders">
                <template slot-scope="scope">
                  ${{scope.row.sale_value | toMillion}}
                </template>
              </el-table-column>
              <el-table-column prop="customer_name" :label="$lang('购买用户')" show-overflow-tooltip>
              </el-table-column>
              <el-table-column prop="register_date" :label="$lang('用户注册时间')" sortable="custom"
                :sort-orders="tableSortOrders" show-overflow-tooltip>
              </el-table-column>
              <el-table-column prop="first_purchase" :label="$lang('首（复）购')">
              </el-table-column>
              <el-table-column :label="$lang('订单详情')">
                <template slot-scope="scope">
                  <!-- <el-image style="width: 24px; height: 24px" src="./Application/Tpl/Home/DataCenter/img/link.png"></el-image> -->
                  <el-button class="erp-el-button--text" @click="toOrderDetail(scope.row)" type="text">{{$lang('详情')}}
                  </el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-pagination background class="erp-el-pagination" :current-page="channelOrderTablePage"
              hide-on-single-page @current-change="channelOrderTablePageChange"
              layout="total, prev, pager, next, jumper" :total="channelOrderData.totalCount"
              style="margin-top: 32px;">
            </el-pagination>
          </main>
        </section>

        <el-dialog :title="$lang('订单商品明细')" class="erp-el-dialog" :visible.sync="orderGoodsDetailVisible">
          <section>
            <section
              style="display: flex;align-items: center; margin-top: 14px; font-weight: 400;color: rgba(0, 0, 0, 0.65);">
              <div>
                <span style="font-weight: 500;">{{$lang('订单号')}}</span>
                <span style="margin-left: 8px;">{{ channelOrderTableSelectedData.order_id }}</span>
              </div>
              <div style="margin-left: 40px;">
                <span>{{$lang('所属站点')}}</span>
                <span style="font-weight: 500; margin-left: 8px;">{{ channelOrderTableSelectedData.plat_name }}</span>
              </div>
              <div style="margin-left: 40px;">
                <span>{{ $lang('所属渠道') }}</span>
                <span
                  style="font-weight: 500; margin-left: 8px;">{{ channelOrderTableSelectedData.channel_name }}</span>
              </div>
              <div style="margin-left: 40px;">
                <span>{{ $lang('所属活动') }}</span>
                <span style="font-weight: 500; margin-left: 8px;">{{ channelOrderTableSelectedData.act_name }}</span>
              </div>
            </section>
          </section>

          <el-table ref="orderGoodsDetailTable" stripe v-loading="orderGoodsDetailTableLoading"
            :data="orderGoodsDetailTableData.datas" class="erp-el-table" style="margin-top: 32px;">
            <el-table-column prop="order_id" :label="$lang('图片')">
              <template slot-scope="scope">
                <el-image style="width: 60px; height: 60px" :src="scope.row.picture"></el-image>
              </template>
            </el-table-column>
            <el-table-column prop="sku_id" :label="$lang('SKU ID')">
            </el-table-column>
            <el-table-column prop="name" :label="$lang('商品名称')">
            </el-table-column>
            <el-table-column :label="$lang('销量')" align="right">
              <template slot-scope="scope">
                {{scope.row.item_count | formatNum}}
              </template>
            </el-table-column>
          </el-table>
          <el-pagination background class="erp-el-pagination" :current-page.sync="orderGoodsDetailTablePage"
            hide-on-single-page @current-change="getOrderGoodsDetailData" layout="total, prev, pager, next, jumper"
            :total="orderGoodsDetailTableData.totalCount" style="margin-top: 32px;">
          </el-pagination>
        </el-dialog>
      </section>


      <section class="channel-sites">
        <section class="channel-orders__header">
          <section>
            <div class="chart-title">
              {{$lang('渠道访问用户站点分布')}}
            </div>
            <div class="chart-date">{{channelUsersTransferChartData.dateTime}}
              <span v-show="rangeDateInfo"> | {{$lang(rangeDateInfo)}}</span>
            </div>
          </section>
        </section>

        <div ref="channelSitesChart" style="width: 100%; height: 510px;"></div>
      </section>

      <section class="browse-goods-table">
        <div class="chart-title">
          {{$lang('渠道用户浏览商品列表')}}
        </div>
        <el-table stripe ref="browseGoodsTable" v-loading="browseGoodsTableLoading"
          :row-key="getBrowseGoodsTableRowKeys" :expand-row-keys="browseGoodsTableExpandRowKeys"
          :data="browseGoodsData.datas" class="erp-el-table" :default-sort="{prop: 'pv',order: 'descending'}"
          style="margin-top: 20px;" @expand-change="browseGoodsTableExpandChange" stripe
          @sort-change="browseGoodsTableSort">
          <el-table-column type="expand" class-name="browse-goods-table-expand">
            <template slot-scope="scope">
              <el-radio-group v-model="statusCode" size="medium" @change="getBrowseGoodsChartData(scope.row.spu_id)">
                <el-radio-button label="1058">UV</el-radio-button>
                <el-radio-button label="1059">PV</el-radio-button>
                <el-radio-button label="1057">{{$lang('加购次数')}}</el-radio-button>
                <el-radio-button label="1056">{{$lang('加心愿单次数')}}</el-radio-button>
                <el-radio-button label="1055">{{$lang('立即购买次数')}}</el-radio-button>
              </el-radio-group>
              <div ref="browseGoodsTableChart" style="width: 100%; height: 400px;"></div>
            </template>
          </el-table-column>
          <el-table-column :label="$lang('图片')">
            <template slot-scope="scope">
              <el-popover placement="right" width="200" trigger="hover">
                <el-image style="width: 200px; height: 200px" :src="scope.row.picture"></el-image>
                <el-image style="width: 60px; height: 60px" :src="scope.row.picture" slot="reference"></el-image>
              </el-popover>
            </template>
          </el-table-column>
          <el-table-column prop="spu_id" label="SPU ID">
          </el-table-column>
          <el-table-column prop="goods_name" :label="$lang('商品名称')" show-overflow-tooltip width="200">
          </el-table-column>
          <el-table-column prop="category" :label="$lang('类目')">
          </el-table-column>
          <el-table-column prop="brand_name" :label="$lang('品牌')">
          </el-table-column>
          <el-table-column prop="is_odm" :label="$lang('ODM商品')" :render-header="renderTableHeader">
            <template slot-scope="scope">
              {{ $lang(scope.row.is_odm )}}
            </template>
          </el-table-column>
          <el-table-column label="UV" prop="uv" align="right" sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.uv | formatNum }}
            </template>
          </el-table-column>
          <el-table-column label="PV" prop="pv" align="right" sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.pv | formatNum }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('加购次数')" prop="purchase_number" align="right"
            :render-header="renderTableHeader" sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.purchase_number | formatNum }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('加心愿单次数')" align="right" prop="wish_number" width="110" :render-header="renderTableHeader"
            sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.wish_number | formatNum }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('立即购买次数')" align="right" prop="immediately_purchase_number" width="110" :render-header="renderTableHeader"
            sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.immediately_purchase_number | formatNum }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('订单')" align="right" :render-header="renderTableHeader" prop="order_number"
            sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.order_number | formatNum }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('销量')" align="right" :render-header="renderTableHeader" prop="sales_number"
            sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.sales_number | formatNum }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('销售额($)')" align="right" :render-header="renderTableHeader" prop="sales_amount"
            sortable="custom" :sort-orders="tableSortOrders">
            <template slot-scope="scope">
              {{scope.row.sales_amount | toMillion }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('推广成本($)')" align="right" :render-header="renderTableHeader">
            <template slot-scope="scope">
              {{scope.row.generalize_cost | toMillion }}
            </template>
          </el-table-column>
          <el-table-column :label="$lang('实际购买率')" align="right" :render-header="renderTableHeader">
            <template slot-scope="scope">
              {{scope.row.purchase_conversion | formatNum(true, true) }}
            </template>
          </el-table-column>
        </el-table>
        <el-pagination background hide-on-single-page class="erp-el-pagination" :current-page="browseGoodsTablePage"
          style="margin-top: 32px;" @current-change="browseGoodsTablePageChange"
          layout="total, prev, pager, next, jumper" :total="browseGoodsData.totalCount">
        </el-pagination>
      </section>
    </div>

  </div>
  <script src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
  <script src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
  <script src="./Application/Tpl/Home/Public/utils/utils.js?v=<{$Think.config.VER_NUM}>"></script>
  <script src="./Application/Tpl/Home/Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
  <script src="./Application/Tpl/Home/Public/js/vue-2.6.10.js"></script>
  <script src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
  <script src="./Application/Tpl/Home/Public/js/element-ui-2.13.0.js"></script>
  <script src="./Application/Tpl/Home/Public/js/queryString.js"></script>
  <script src="./Application/Tpl/Home/Public/js/element-en.js"></script>
  <script src="./Application/Tpl/Home/Public/js/echarts-4.7.0.js"></script>
  <script src="./Application/Tpl/Home/DataCenter/components/ChartWrapper.js?v=<{$Think.config.VER_NUM}>"></script>
  <script src="./Application/Tpl/Home/DataCenter/utils/globalConstAndFunc.js?v=<{$Think.config.VER_NUM}>"></script>

  <script>
    if (getCookie('think_language') !== "zh-cn") {
      ELEMENT.locale(ELEMENT.lang.en)
    };

    var vm = new Vue({
      el: '#vm',
      components: {
        'chart-wrapper': ChartWrapper
      },
      filters: {
        /**
        * 字符串超出部分用省略号表示
        *
        * @param {String} str 传入的字符串
        * @param {number} length 字符串的最多展示多少
        * @return 原字符串或截断后用省略号代替的字符串
        */
        strOmit(str, length) {
          return str.length > length ? str.slice(0, length) + '...' : str
        },
        /**
          * 数值千分位表示，考虑小数情况
          *
          * @param number 数值(Number或者String)
          * @param {boolean} addSymbol 返回的结果是否加上%(boolean)
          * @param {boolean} dot2 返回的结果中，小数是否统一保留两位
          * @return 金额格式的字符串,如'1,234,567.45'
          */
        formatNum(number, addSymbol, dot2) {
          let hasMinus = false
          if (number === '-') {
            return number
          } else if (number != null) {
            let numStr = dot2 ? parseFloat(number).toFixed(2) : number.toString()
            if (numStr.startsWith('-')) {
              hasMinus = true
              numStr = numStr.slice(1)
            }
            const numArr = numStr.split('.')
            let [num, dotNum] = numArr
            let result = []
            const operateNum = num.split('').reverse()
            const length = operateNum.length
            for (let i = 0; i < length; i++) {
              result.push(operateNum[i])
              if (((i + 1) % 3 === 0) && (i !== length - 1)) {
                result.push(',')
              }
            }
            if (dotNum) {
              result.reverse().push('.', ...dotNum)
            } else {
              result.reverse()
            }

            if (addSymbol) {
              result = result.join('').concat('%')
            } else {
              result = result.join('')
            }

            if (hasMinus) {
              result = '-' + result
            }

            return result
          }
        },
        /**
         * 数值>=百万时，返回以M为单位的数
         * 数值<百万时,不加单位
         * 返回结果都要保留两位小数,带有千分位分隔符
         *
         * @param number 数值(Number或者String)
         * @return 金额格式的字符串,如'1,234,567.45'
        */
        toMillion(value) {
          // 是否添加单位M
          let addUnit = false

          // 是否是负数
          let hasMinus = false

          if (value === '-' || value == null) {
            return value
          }
          if (typeof (value) === 'string') {
            value = parseFloat(value)
          }
          if (value >= 1000000) {
            addUnit = true
            value = (value / 1000000)
          }
          value = value.toFixed(2)

          // 添加千分位
          if (value.startsWith('-')) {
            hasMinus = true
            value = value.slice(1)
          }
          const numArr = value.split('.')
          let [num, dotNum] = numArr
          let result = []
          const operateNum = num.split('').reverse()
          const length = operateNum.length
          for (let i = 0; i < length; i++) {
            result.push(operateNum[i])
            if (((i + 1) % 3 === 0) && (i !== length - 1)) {
              result.push(',')
            }
          }
          if (dotNum) {
            result.reverse().push('.', ...dotNum)
          } else {
            result.reverse()
          }
          result = result.join('')
          if (hasMinus) {
            result = '-' + result
          }
          return addUnit ? (result + 'M') : result
        },
        ratioZero(value) {
          if (value === '0%' || value === '0.00%') {
            return '-'
          } else {
            return value
          }
        },
        /**
        * 将数值四舍五入(保留2位小数)后格式化成金额形式
        *
        * @param num 数值(Number或者String)
        * @return 金额格式的字符串,如'1,234,567.45'
        * @type String
        */
        formatCurrency(num) {
          num = num.toString().replace(/\$|\,/g, '');
          if (isNaN(num))
            num = "0";
          sign = (num == (num = Math.abs(num)));
          num = Math.floor(num * 100 + 0.50000000001);
          cents = num % 100;
          num = Math.floor(num / 100).toString();
          if (cents < 10)
            cents = "0" + cents;
          for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++)
            num = num.substring(0, num.length - (4 * i + 3)) + ',' +
              num.substring(num.length - (4 * i + 3));
          return (((sign) ? '' : '-') + num + '.' + cents);
        }
      },
      data: {
        apiHost: GlobalConstAndFunc.api(),
        language: getCookie('think_language') === 'zh-cn' ? 'cn' : 'us',
        tableSortOrders: ['ascending', 'descending'],
        activeNames: ['1'],
        chanelOptions: [],
        chanels: {
          value: [],
          showValue: []
        },
        checkAll: true,
        checkedChannels: '',
        checkedChannelsShow: '',
        siteOptions: [],
        checkAllSite: true,
        checkedSites: '',
        dates: [
          {
            name: '近7日',
            value: '7D'
          },
          {
            name: '近15日',
            value: '15D'
          },
          {
            name: '近30日',
            value: '30D'
          }
        ],
        rangeDate: '',
        pickerMinDate: '',
        pickerOptions: {
          onPick: ({ maxDate, minDate }) => {
            this.pickerMinDate = minDate.getTime()
            if (maxDate) {
              this.pickerMinDate = ''
            }
          },

          disabledDate: (time) => {
            if (this.pickerMinDate !== '') {
              const day30 = (30 - 1) * 24 * 3600 * 1000
              let maxTime = this.pickerMinDate + day30
              if (maxTime > new Date()) {
                maxTime = new Date()
              }
              return time.getTime() > maxTime
            }
            return time.getTime() > Date.now()
          }
        },
        dateTime: '7D', //	可选时间(7D,15D,30D), 和自定义时间任选一个
        channelStatisticData: {
          sale_metric_value_sum: '0', //	销售金额累计
          sale_metric_value: '0', //	昨日销售金额
          user_metric_value_sum: '0', //	购买用户数累计
          user_metric_value_ratio: '0', //	购买用户数环比
          sale_metric_value_ratio: '0', //	销售金额环比
          user_metric_value: '0', //	昨日购买用户数
        },
        channelOrdersChartType: '1021',
        channelScaleChartType: '1021',
        usersTransferStep: '1013',
        channelRoIChart: null,
        channelRoIChartData: [{ dateTime: null }],
        channelUsersTransferChart: null,
        channelUsersTransferChartData: {
          entirety: ['0.00%']
        },
        stepUsersChart: null,
        stepUsersChartData: [{ dateTime: null }],
        channelOrdersChart: null,
        channelOrdersChartData: [{}],
        channelScaleChart: null,
        channelScaleChartData: [{}],
        channelSitesChart: null,
        channelOrderTableLoading: true,
        channelOrderTableSortWord: 'pay_time',
        channelOrderTableSortRule: 'descending',
        channelOrderData: {
          datas: {
            dateInfo: []
          },
          totalCount: 0
        },
        channelOrderTablePage: 1,
        channelOrderTableSelectedData: {},
        orderGoodsDetailVisible: false,
        orderGoodsDetailTableLoading: false,
        orderGoodsDetailTableData: {},
        orderGoodsDetailTablePage: 1,
        browseGoodsTableLoading: true,
        browseGoodsData: {},
        getBrowseGoodsTableRowKeys(row) {
          return row.id
        },
        browseGoodsTablePage: 1,
        browseGoodsTableSortWord: 'pv',
        browseGoodsTableSortRule: 'descending',
        browseGoodsTableExpandRowKeys: [],
        browseGoodsTableChart: null,
        statusCode: '1058',
      },
      computed: {
        stepUsersChartTitle() {
          let title = ''
          switch (this.usersTransferStep) {
            case '1013':
              title = '渠道用户数'
              break;
            case '1014':
              title = '浏览商品用户数'
              break;
            case '1015':
              title = '注册用户数'
              break;
            case '1016':
              title = '加购用户数'
              break;
            case '1012':
              title = '购买用户数'
              break;
            default:
              break;
          }
          return title
        },
        // 各图表模块中展示的日期范围说明
        rangeDateInfo() {
          let str = null
          if (this.dateTime === '7D') {
            str = '近7日'
          } else if (this.dateTime === '15D') {
            str = '近15日'
          } else if (this.dateTime === '30D') {
            str = '近30日'
          }
          return str
        }
      },
      created: function () {
        axios.all([this.getChannels(), this.getSites()])
          .then(axios.spread((channelsRes, sitesRes) => {
            if (channelsRes.data.success) {
              this.chanelOptions = channelsRes.data.datas
              for (const chanel of this.chanelOptions) {
                chanel.checked = false
                this.chanels.value.push(chanel.platform_tag)
                this.chanels.showValue.push(chanel.platform_name)
              }

              this.checkedChannels = this.chanels.value.join(',')
              this.checkedChannelsShow = this.chanels.showValue.join(',')
            } else {
              this.$message.error(channelsRes.data.msg)
            }

            if (sitesRes.data.success) {
              this.siteOptions = sitesRes.data.datas
              let arr = []
              for (const site of this.siteOptions) {
                site.checked = false
                arr.push(site.sitecode)
              }

              this.checkedSites = arr.join(',')
            } else {
              this.$message.error(sitesRes.data.msg)
            }

            this.getAllChartData()
          })).catch(err => {
            console.log(err)
          })
      },
      mounted: function () {
        // this.channelRoIChart = echarts.init(this.$refs.channelRoIChart)
        this.channelUsersTransferChart = echarts.init(this.$refs.channelUsersTransferChart)
        this.stepUsersChart = echarts.init(this.$refs.stepUsersChart.$refs.chart)
        this.channelOrdersChart = echarts.init(this.$refs.channelOrdersChart)
        this.channelScaleChart = echarts.init(this.$refs.channelScaleChart)

        this.channelSitesChart = echarts.init(this.$refs.channelSitesChart)
        this.channelSitesChart.on('click', (event) => {
          this.checkAllSite = false
          let arr = []
          for (const site of this.siteOptions) {
            if (site.sitename === event.name) {
              site.checked = true
              this.checkedSites = site.sitecode
            } else {
              site.checked = false
            }
          }
          this.getAllChartData()
        })
      },
      methods: {
        /**
        * 传入的字符串在翻译后长度是否超过传入的规定长度
        *
        * @param {String} str 传入的字符串
        * @param {number} length 字符串的最多展示多少
        * @param {Boolean} trans 是否翻译传入的字符串
        * @return boolean
        */
        contentNotOverflowed(str, length, trans = true) {
          let transStr = trans ? this.$lang(str) : str
          return transStr.length <= length
        },
        /**
        * 翻译传入的字符串
        *
        * @param {String} str 传入的字符串
        * @param {Boolean} trans 是否翻译传入的字符串
        * @return string
        */
        transStr(str, trans = true) {
          return trans ? this.$lang(str) : str
        },
        // 获取所有渠道
        getChannels() {
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
          }
          return this.queryPost('/gpChannelAnalysis/queryChannelName', postData)
        },
        // 获取所有站点
        getSites() {
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            language: this.language,
          }
          return this.queryPost('/gpChannelAnalysis/querySiteName', postData)
        },
        getAllChartData() {
          this.getChannelStatisticData()
          // this.getChannelRoIChartData()
          this.getChannelUsersTransferChartData()
          this.getStepUsersChartData()
          this.getChannelOrdersChartData()
          this.getChannelScaleChartData()

          this.channelOrderTableSortWord = 'pay_time'
          this.channelOrderTableSortRule = 'descending'
          this.channelOrderTablePage = 1
          this.$refs.channelOrderTable.sort('pay_time', 'descending')
          // this.getChannelOrderData()

          this.getChannelSitesChartData()

          this.browseGoodsTableExpandRowKeys = []
          this.statusCode = '1058'
          this.browseGoodsTablePage = 1
          this.browseGoodsTableSortWord = 'pv',
          this.browseGoodsTableSortRule = 'descending',
          this.$refs.browseGoodsTable.sort('pv', 'descending')
          // this.getBrowseGoodsTableData()
        },
        // 渠道筛选条件，全部的状态更改
        handleCheckAllChange(val) {
          if (val) {
            for (const chanel of this.chanelOptions) {
              chanel.checked = false
            }
            this.checkedChannels = this.chanels.value.join(',')
            this.checkedChannelsShow = this.chanels.showValue.join(',')
            this.getAllChartData()
          } else {
            this.checkAll = true
          }
        },
        handleCheckedChannelsChange() {
          this.checkAll = false
          let arr = [], showArr = []
          for (const chanel of this.chanelOptions) {
            if (chanel.checked) {
              arr.push(chanel.platform_tag)
              showArr.push(chanel.platform_name)
            }
          }
          if (arr.length) {
            this.checkedChannels = arr.join(',')
            this.checkedChannelsShow = showArr.join(',')
          } else {
            this.checkAll = true
            this.checkedChannels = this.chanels.value.join(',')
            this.checkedChannelsShow = this.chanels.showValue.join(',')
          }

          this.getAllChartData()
        },
        // 站点筛选条件，全部的状态更改
        checkAllSiteChange(val) {
          if (val) {
            let arr = []
            for (const site of this.siteOptions) {
              site.checked = false
              arr.push(site.sitecode)
            }
            this.checkedSites = arr.join(',')
            this.getAllChartData()
          } else {
            this.checkAllSite = true
          }
        },
        checkedSitesChange() {
          this.checkAllSite = false
          let arr = []
          for (const site of this.siteOptions) {
            if (site.checked) {
              arr.push(site.sitecode)
            }
          }
          if (arr.length) {
            this.checkedSites = arr.join(',')
          } else {
            this.checkAllSite = true
            let arrTemp = []
            for (const site of this.siteOptions) {
              arrTemp.push(site.sitecode)
            }
            this.checkedSites = arrTemp.join(',')
          }

          this.getAllChartData()
        },
        dateTimeChange() {
          this.rangeDate = ''
          this.getAllChartData()
        },
        rangeDateChange() {
          this.dateTime = ''
          this.getAllChartData()
        },
        // 渠道统计数据获取
        getChannelStatisticData() {
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_flag: this.checkedChannelsShow,
            channel_name: this.checkedChannels.toString(),
            sitecode: this.checkedSites
          }
          this.queryPost('/gpChannelAnalysis/channelStatistic', postData).then(res => {
            if (res.data.success) {
              this.channelStatisticData = res.data.datas[0]
            } else {
              this.$message.error(res.data.msg)
            }
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道ROI趋势,数据获取
        getChannelRoIChartData() {
          this.channelRoIChart.showLoading({
            text: ''
          })

          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_flag: this.checkedChannelsShow,
            channel_name: this.checkedChannels.toString(),
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelROITrend', postData).then(res => {
            if (res.data.success) {
              if (res.data.datas) {
                this.channelRoIChartData = res.data.datas
              }
              this.initChartChannelRoI(res.data.datas)
            } else {
              this.$message.error(res.data.msg)
            }
            this.channelRoIChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道ROI趋势,图表配置
        initChartChannelRoI(resData) {
          resData ? resData = resData : resData = [{ date: null }]
          let series = [], legendData = [], option
          for (let item of resData) {
            const set = {
              type: 'line',
              name: item.channelName,
              data: item.value,
              // smooth: true
            }
            series.push(set)
            legendData.push(item.channelName)
          }
          option = {
            legend: {
              itemWidth: 12,
              itemHeight: 12,
              // itemGap: 40,
              icon: 'rect',
              bottom: 0,
              data: legendData
            },
            color: GlobalConstAndFunc.UI.colors9To16,
            tooltip: {
              trigger: 'axis'
            },
            grid: {
              left: '5%',
              bottom: 45
            },
            xAxis: {
              axisLabel: {
                showMaxLabel: true
              },
              axisTick: {
                show: false
              },
              data: resData[0].date
            },
            yAxis: {
              type: 'value',
              axisLine: {
                show: false
              },
              axisTick: {
                show: false
              },
              splitLine: {
                //   show: false
                lineStyle: {
                  type: 'dotted',
                  color: '#F0F0F0'
                }
              }
            },
            series: series
          }
          this.channelRoIChart.setOption(option, true)
        },
        // 渠道用户转化，数据获取
        getChannelUsersTransferChartData() {
          this.channelUsersTransferChart.showLoading({
            text: ''
          })

          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_flag: this.checkedChannelsShow,
            channel_name: this.checkedChannels.toString(),
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelUserTransform', postData).then(res => {
            if (res.data.success) {
              if (res.data.datas) {
                this.channelUsersTransferChartData = res.data.datas[0]
              }
              this.initChartChannelUsersTransfer(res.data.datas[0].chartDate)
            } else {
              this.$message.error(res.data.msg)
            }
            this.channelUsersTransferChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道用户转化，图表配置
        initChartChannelUsersTransfer(resData) {
          resData ? resData = resData : resData = []
          let series = [], legendData = [], option
          for (let item of resData) {
            let set = {
              type: 'bar',
              name: item.chanelName,
              stack: '总量',
              barWidth: 44,
              data: item.value
            }
            series.push(set)
            legendData.push(item.chanelName)
          }
          option = {
            legend: {
              ...GlobalConstAndFunc.Echarts.legendStyle,
              type: 'scroll',
              icon: 'rect',
              data: legendData
            },
            color: GlobalConstAndFunc.UI.colors9To16,
            grid: {
              left: 10,
              top: 0,
              containLabel: true
            },
            tooltip: {
              ...GlobalConstAndFunc.Echarts.tooltipStyle,
              trigger: 'axis',
              confine: true,
              formatter: (params) => {

                let barObj = {}, strObj = {}, total = 0
                params.sort((a, b) => {
                  return (b.value - a.value)
                })
                for (let i = 0; i < params.length; i++) {
                  barObj['bar' + i] = params[i]
                  barObj['bar' + i].formatValue = this.$options.filters['formatNum'](params[i].value)
                  total += Number(params[i].value)
                }

                total = this.$options.filters['formatNum'](total)
                // let str = `${params[0].name}<br/>合计: ${total}<br/>`
                let str = ''

                for (let i = 0; i < params.length; i++) {
                  let bar = barObj['bar' + i]
                  str += `<div>${bar.marker}${bar.seriesName} ${bar.formatValue}</div>`
                }

                const result = `<section>
                                  <div style="font-size: 14px;">${this.$lang(params[0].name)}</div>
                                  <div>${this.$lang('合计')} ${total}</div>
                                  <section style="display: grid; grid-template-columns: 170px 170px;">
                                    ${str}
                                  </section>
                                </section>`
                return result
              }
            },
            xAxis: {
              type: 'value',
              position: 'top',
              show: false,
              axisLabel: {
                show: false
              },
              splitLine: {
                show: false
              },
              axisTick: {
                show: false
              }
            },
            yAxis: {
              type: 'category',
              inverse: true,
              show: false,
              data: ["渠道用户", "浏览商品", "注册用户", "加购用户", "购买用户"]
            },
            series: series
          }
          this.channelUsersTransferChart.setOption(option, true)
        },
        // 渠道用户数，数据获取
        getStepUsersChartData() {
          this.stepUsersChart.showLoading({
            text: ''
          })

          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            channel_flag: this.checkedChannelsShow,
            metric_id: this.usersTransferStep,
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelUserType', postData).then(res => {
            if (res.data.success) {
              if (res.data.datas) {
                this.stepUsersChartData = res.data.datas
              }
              this.initChartStepUsers(res.data.datas)
            } else {
              this.$message.error(res.data.msg)
            }
            this.stepUsersChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道用户数，图表配置
        initChartStepUsers(resData) {
          resData ? resData = resData : resData = [{ date: null }]
          let series = [], legendData = [], option
          for (let item of resData) {
            const set = {
              type: 'line',
              name: item.channelName,
              data: item.value,
            }
            series.push(set)
            legendData.push(item.channelName)
          }
          option = {
            legend: {
              ...GlobalConstAndFunc.Echarts.legendStyle,
              type: 'scroll',
              icon: 'rect',
              data: legendData
            },
            color: GlobalConstAndFunc.UI.colors9To16,
            tooltip: {
              ...GlobalConstAndFunc.Echarts.tooltipStyle,
              trigger: 'axis',
              confine: true,
              formatter: (params) => {
                let barObj = {}, strObj = {}, total = 0
                for (let i = 0; i < params.length; i++) {
                  barObj['bar' + i] = params[i]
                  barObj['bar' + i].formatValue = this.$options.filters['formatNum'](params[i].value)
                  total += Number(params[i].value)
                }

                total = this.$options.filters['formatNum'](total)
                // let str = `${params[0].name}<br/>合计: ${total}<br/>`
                let str = ''
                for (let i = 0; i < params.length; i++) {
                  let bar = barObj['bar' + i]
                  str += `<div>${bar.marker}${bar.seriesName} ${bar.formatValue}</div>`
                }

                const result = `<section>
                                  <div style="font-size: 14px;">${params[0].name}</div>
                                  <div>${this.$lang('合计')} ${total}</div>
                                  <section style="display: grid; grid-template-columns: 170px 170px;">
                                    ${str}
                                  </section>
                                </section>`
                return result
              }
            },
            grid: {
              left: '5%',
              bottom: 70,
              containLabel: true
            },
            xAxis: {
              axisLabel: {
                showMaxLabel: true
              },
              axisTick: {
                show: false
              },
              data: resData[0].date
            },
            yAxis: {
              type: 'value',
              axisLine: {
                show: false
              },
              axisTick: {
                show: false
              },
              splitLine: {
                //   show: false
                lineStyle: {
                  type: 'dotted',
                  color: '#F0F0F0'
                }
              }
            },
            series: series
          }
          this.stepUsersChart.setOption(option, true)
        },
        // 渠道订单趋势，图表数据获取
        getChannelOrdersChartData() {
          this.channelOrdersChart.showLoading({
            text: ''
          })

          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            channel_flag: this.checkedChannelsShow,
            metric_id: this.channelOrdersChartType,
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelOrderTotal', postData).then(res => {
            if (res.data.success) {
              this.channelOrdersChartData = res.data.datas
              if (res.data.datas.length) {
                this.initChartChannelOrders(res.data.datas)
              }
            } else {
              this.$message.error(res.data.msg)
            }
            this.channelOrdersChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道订单趋势，图表配置
        initChartChannelOrders(resData) {
          let series = [], legendData = [], option
          for (let item of resData) {
            const set = {
              type: 'line',
              name: item.channelName,
              data: item.value,
            }
            series.push(set)
            legendData.push(item.channelName)
          }
          option = {
            legend: {
              ...GlobalConstAndFunc.Echarts.legendStyle,
              type: 'scroll',
              icon: 'rect',
              data: legendData
            },
            color: GlobalConstAndFunc.UI.colors9To16,
            tooltip: {
              ...GlobalConstAndFunc.Echarts.tooltipStyle,
              trigger: 'axis',
              confine: true,
              formatter: (params) => {
                //加法函数，用来得到精确的加法结果
                //说明：javascript的加法结果会有误差，在两个浮点数相加的时候会比较明显。这个函数返回较为精确的加法结果。
                //调用：accAdd(arg1,arg2)
                //返回值：arg1加上arg2的精确结果
                function accAdd(arg1, arg2) {
                  var r1, r2, m;
                  try { r1 = arg1.toString().split(".")[1].length } catch (e) { r1 = 0 }
                  try { r2 = arg2.toString().split(".")[1].length } catch (e) { r2 = 0 }
                  m = Math.pow(10, Math.max(r1, r2));
                  return (arg1 * m + arg2 * m) / m;
                }

                if (params.length < 1) return
                let str = '', total = 0
                let result = ''
                for (let i = 0; i < params.length; i++) {
                  let bar = params[i]
                  bar.formatValue = this.$options.filters['formatNum'](bar.value)
                  total = accAdd(total, params[i].value)
                  if (vm.channelOrdersChartType === '1022') {
                    // bar.formatValue = this.$options.filters['formatNum'](bar.value, false, true)
                    str += `<div>${bar.marker}${bar.seriesName} $ ${bar.formatValue}</div>`
                  } else {
                    // bar.formatValue = this.$options.filters['formatNum'](bar.value)
                    str += `<div>${bar.marker}${bar.seriesName} ${bar.formatValue}</div>`
                  }
                }
                total = this.$options.filters['formatNum'](total)

                if (vm.channelOrdersChartType === '1022') {
                  result = `<section>
                              <div style="font-size: 14px;">${params[0].name}</div>
                              <div>${this.$lang('订单销售额合计')} $ ${total}</div>
                              <section style="display: grid; grid-template-columns: 200px 200px;">
                                ${str}
                              </section>
                            </section>`
                } else {
                  result = `<section>
                              <div style="font-size: 14px;">${params[0].name}</div>
                              <div>${this.$lang('订单合计')} ${total}</div>
                              <section style="display: grid; grid-template-columns: 170px 170px;">
                                ${str}
                              </section>
                            </section>`
                }
                return result
              },
            },
            grid: {
              left: '5%',
              bottom: 80,
              containLabel: true
            },
            xAxis: {
              axisLabel: {
                showMaxLabel: true
              },
              axisTick: {
                show: false
              },
              data: resData[0].date
            },
            yAxis: {
              type: 'value',
              axisLine: {
                show: false
              },
              axisTick: {
                show: false
              },
              splitLine: {
                //   show: false
                lineStyle: {
                  type: 'dotted',
                  color: '#F0F0F0'
                }
              }
            },
            series: series
          }
          this.channelOrdersChart.setOption(option, true)
        },

        // 渠道订单分布，图表数据获取
        getChannelScaleChartData() {
          this.channelScaleChart.showLoading({
            text: ''
          })
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            channel_flag: this.checkedChannelsShow,
            metric_id: this.channelScaleChartType,
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelOrderAndChannelProportion', postData).then(res => {
            if (res.data.success) {
              this.channelScaleChartData = res.data.datas
              if (res.data.datas.length) {
                this.initChartChannelScale(res.data.datas)
              }
            } else {
              this.$message.error(res.data.msg)
            }
            this.channelScaleChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道订单分布，图表配置
        initChartChannelScale(resData) {
          resData ? resData = resData : resData = []
          let series = [], legendData = [], option
          for (let item of resData) {
            let set = {
              value: item.mertic_value,
              name: item.channel_name
            }
            series.push(set)
            legendData.push(item.channel_name)
          }
          option = {
            legend: {
              ...GlobalConstAndFunc.Echarts.legendStyle,
              type: 'scroll',
              data: legendData
            },
            color: GlobalConstAndFunc.UI.colors9To16,
            tooltip: {
              formatter: (params) => {
                if (vm.channelScaleChartType === '1021') {
                  let showVal = this.$options.filters['formatNum'](params.value)
                  return `${params.name} ${this.$lang('订单')} ${showVal} (${params.percent}%)`
                } else {
                  let showVal = this.$options.filters['formatNum'](params.value, false, true)
                  return `${params.name} ${this.$lang('订单销售额')} $${showVal} (${params.percent}%)`
                }
              },
            },
            series: [
              {
                name: '访问来源',
                type: 'pie',
                radius: '50%',
                data: series
              }
            ]
          }
          this.channelScaleChart.setOption(option, true)
        },
        // 渠道订单明细，数据获取
        getChannelOrderData() {
          this.channelOrderTableLoading = true
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            page: this.channelOrderTablePage,
            pageSize: 10,
            sitecode: this.checkedSites,
            sortWord: this.channelOrderTableSortWord,
            sortRule: this.channelOrderTableSortRule,
            language: this.language,
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelOrders', postData).then(res => {
            if (res.data.success) {
              this.channelOrderData = res.data
              this.channelOrderTableLoading = false
            } else {
              this.$message.error(res.data.msg)
            }
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道订单明细,排序
        channelOrderTableSort({ column, prop, order }) {
          this.channelOrderTableSortWord = prop
          this.channelOrderTableSortRule = order === 'ascending' ? 'asc' : 'desc'
          this.getChannelOrderData()
        },
        // 渠道订单明细,翻页
        channelOrderTablePageChange(page) {
          this.channelOrderTablePage = page
          this.getChannelOrderData()
        },
        // 渠道订单明细,前往订单详情
        toOrderDetail(data) {
          let { order_id, source_site, order_no } = data
          // sessionStorage.setItem("orderListOffsetTop", document.documentElement.scrollTop);
          var dom = document.createElement('a');
          var _href = "/index.php?g=OMS&m=Order&a=orderDetail&order_no=" + order_no + "&thrId=" + order_id + "&platCode=" + source_site;
          dom.setAttribute("onclick", "opennewtab(this,'" + this.$lang('订单详情') + "')");
          dom.setAttribute("_href", _href);
          dom.click();
        },
        // 渠道订单明细,查看商品明细
        orderGoodsDetailOpen(rowData) {
          this.orderGoodsDetailTablePage = 1
          this.orderGoodsDetailVisible = true
          this.channelOrderTableSelectedData = rowData
          this.getOrderGoodsDetailData(rowData.order_id)
        },
        // 订单商品明细，数据获取
        getOrderGoodsDetailData(order_id) {
          this.orderGoodsDetailTableLoading = true
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            order_id,
            page: this.orderGoodsDetailTablePage,
            pageSize: 10,
            language: this.language,
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelOrderDetails', postData).then(res => {
            if (res.data.success) {
              this.orderGoodsDetailTableData = res.data
              this.orderGoodsDetailTableLoading = false
            } else {
              this.$message.error(res.data.msg)
            }
          }).catch(err => {
            console.log(err)
          });
        },

        // 渠道订单明细,导出
        channelOrderTableExport() {
          var postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            sitecode: this.checkedSites,
            language: this.language,
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          axios.post(GlobalConstAndFunc.api() + '/gpChannelAnalysis/channelOrdersImport', Qs.stringify(postData), {
            headers: {
              'erp-req': true,
              'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            },
            responseType: 'blob'
          }).then((res) => {
            let blob = res.data
            let reader = new FileReader()
            reader.readAsDataURL(blob)
            reader.onload = (e) => {
              let a = document.createElement('a')
              let fileName = `${this.channelOrderData.datas.dateTime} 渠道订单明细.xlsx`
              if (this.language !== 'cn') {
                fileName = `${this.channelOrderData.datas.dateTime} Channel order details.xlsx`
              }
              a.download = fileName
              a.href = e.target.result
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
            }
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道访问用户站点分布，图表数据获取
        getChannelSitesChartData() {
          this.channelSitesChart.showLoading({
            text: ''
          })
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            channel_flag: this.checkedChannelsShow,
            metric_id: this.channelScaleChartType,
            language: this.language,
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelUserSiteDistribute', postData).then(res => {
            if (res.data.success) {
              if (res.data.datas) {
                this.initChannelSitesChart(res.data.datas)
              }
            } else {
              this.$message.error(res.data.msg)
            }
            this.channelSitesChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道访问用户站点分布，图表配置
        initChannelSitesChart(resData) {
          resData ? resData = resData : resData = []
          let series = [], legendData = [], option
          for (let item of resData) {
            let set = {
              value: item.value,
              name: item.sitename
            }
            series.push(set)
            legendData.push(item.sitename)
          }
          option = {
            legend: {
              ...GlobalConstAndFunc.Echarts.legendStyle,
              data: legendData
            },
            tooltip: {
              ...GlobalConstAndFunc.Echarts.tooltipStyle,
              formatter: (params) => {
                let { value, name, percent, marker, data } = params
                let formatValue = this.$options.filters['formatNum'](value)
                percent = percent.toFixed(2)
                return `${marker}${name} ${formatValue}(${percent}%)`
              }
            },
            color: GlobalConstAndFunc.UI.colors9To16,
            series: [
              {
                // name: '访问来源',
                type: 'pie',
                radius: '55%',

                data: series
              }
            ]
          }
          this.channelSitesChart.setOption(option, true)
        },
        // 表格表头不换行,溢出则隐藏，鼠标悬浮显示完整文本
        renderTableHeader(h, { column, $index }) {
          if ($index === 16) {
            return GlobalConstAndFunc.Element.renderTableHeader(h, { column, $index }, true)
          }
          return GlobalConstAndFunc.Element.renderTableHeader(h, { column, $index })
        },

        // 渠道用户浏览商品列表，数据获取
        getBrowseGoodsTableData() {
          this.browseGoodsTableLoading = true
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            page: this.browseGoodsTablePage,
            pageSize: 10,
            sitecode: this.checkedSites,
            language: this.language,
            sortWord: this.browseGoodsTableSortWord,
            sortRule: this.browseGoodsTableSortRule
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelUserLists', postData).then(res => {
            if (res.data.success) {
              this.browseGoodsData = res.data
              this.browseGoodsTableLoading = false
            } else {
              this.$message.error(res.data.msg)
            }
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道用户浏览商品列表,翻页
        browseGoodsTablePageChange(page) {
          this.browseGoodsTablePage = page
          this.browseGoodsTableExpandRowKeys = []
          this.statusCode = '1058'
          this.getBrowseGoodsTableData()
        },
        // 渠道用户浏览商品列表,排序
        browseGoodsTableSort({ column, prop, order }) {
          this.browseGoodsTableSortWord = prop
          this.browseGoodsTableSortRule = order === 'ascending' ? 'asc' : 'desc'
          this.getBrowseGoodsTableData()
        },
        // 渠道用户浏览商品列表,行数据展开与隐藏
        browseGoodsTableExpandChange(row, expandedRows) {
          if (expandedRows.length) {
            this.browseGoodsTableExpandRowKeys = []
            this.statusCode = '1058'
            if (row) {
              this.browseGoodsTableExpandRowKeys.push(row.id)
              this.$nextTick(() => {
                this.getBrowseGoodsChartData(row.spu_id)
              })
            }
          } else {
            this.browseGoodsTableExpandRowKeys = []
            this.statusCode = '1058'
          }
        },
        // 渠道用户浏览商品明细图表，数据获取
        getBrowseGoodsChartData(spu_id) {
          this.browseGoodsTableChart = echarts.init(this.$refs.browseGoodsTableChart)
          this.browseGoodsTableChart.showLoading({
            text: ''
          })
          let postData = {
            'erp-req': true,
            'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
            channel_name: this.checkedChannels.toString(),
            statusCode: this.statusCode,
            spu_id,
            sitecode: this.checkedSites
          }
          if (this.dateTime) {
            postData.dateTime = this.dateTime
          } else {
            postData.startDate = this.rangeDate[0]
            postData.endDate = this.rangeDate[1]
          }
          this.queryPost('/gpChannelAnalysis/channelUserDetails', postData).then(res => {
            if (res.data.success) {
              this.initBrowseGoodsChart(res.data.datas)
            } else {
              this.$message.error(res.data.msg)
            }
            this.browseGoodsTableChart.hideLoading()
          }).catch(err => {
            console.log(err)
          });
        },
        // 渠道用户浏览商品明细图表配置
        initBrowseGoodsChart(data) {
          let pieData = []
          for (let index = 0; index < data.pie.length; index++) {
            pieData.push({
              name: data.pie[0][index],
              value: data.pie[1][index]
            })
          }

          let option = {
            tooltip: {
            },
            dataset: [
              {
                source: data.chart,
                sourceHeader: false
              },
              {
                source: data.pie,
                sourceHeader: false
              },
            ],
            grid: {
              left: 700,
              bottom: 45,
              tooltip: {
                trigger: 'axis',
              },
            },
            xAxis: {
              type: 'category',
              axisLabel: {
                showMinLabel: true,
                showMaxLabel: true
              },
              axisTick: {
                show: false
              },
            },
            yAxis: {
              type: 'value',
              axisLine: {
                show: false
              },
              axisTick: {
                show: false
              },
              splitLine: {
                lineStyle: {
                  type: 'dotted',
                  color: '#F0F0F0'
                }
              }
            },
            series: [
              {
                type: 'pie',
                center: [250, '50%'],
                radius: 150,
                seriesLayoutBy: 'row',
                encode: {
                  itemName: 0,
                  value: 1
                },
                datasetIndex: 1,
              },
              {
                type: 'line',
                seriesLayoutBy: 'row',
                datasetIndex: 0,
              }
            ]
          }
          this.browseGoodsTableChart.setOption(option, true)
        },
        queryPost: function (url, param) {
          var headers = {
            headers: {
              'erp-req': true,
              'erp-cookie': 'PHPSESSID=' + getCookie('PHPSESSID') + ';',
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            }
          }
          // 初始化时间展示
          return axios.post(this.apiHost + url, Qs.stringify(param), headers);
        },
      }
    });
  </script>
</body>

</html>