<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../Public/lib/icheck/icheck.css"/>
    <link rel="stylesheet" href="../Public/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/Application/Tpl/Home/B2b/css/detail.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="/Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.const.V}>">
    <title><{$Think.lang.应付确认}></title>
    <script type="text/javascript" src="../Public/lib/My97DatePicker/WdatePicker.js"></script>
    <link rel="stylesheet" href="../Public/css/purchaseDetail.css"/>
    <link rel="stylesheet" href="../Public/css/common.css?v=2017203"/>
    <link rel="stylesheet" href="../Public/css/default.css?v=<{$Think.const.V}>">
    <style>
    .layui-layer-content {
        width: 500px;
        background: white !important;
        border: 1px solid #cccccc;
        border-right: 2px solid #cccccc
    }

    .child-basic-table th, .child-basic-table td{
        text-align: center;
    }
    .table-list th{
      background-color: #546e7a;
    }
    
    </style>
</head>
<body>
<div class="col-lg-12 col-md-12 col-sm-12 payable_detail" id="payment_info">
    <div class="row row_title">
        <a class="active"><{$Think.lang.付款详情}></a>
    </div>
    <form>
        <div class="detail_form">
            <!-- 赤练  基础信息 -->
            <table class="table payment_info">
                <thead>
                    <th width="15%"></th>
                    <th width="35%"></th>
                    <th width="15%"></th>
                    <th width="35%"></th>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4"> <{$Think.lang.基础信息}> </td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.应付单号}> </td>
                        <td><{$info.payment_no}></td>
                        <td> <{$Think.lang.应付单状态}> </td>
                        <td>
                            <switch name="info.status" >
                                  <case value="0"><{$Think.lang.待确认}></case>
                                  <case value="1"><{$Think.lang.待付款}></case>
                                  <case value="2"><{$Think.lang.待出账}></case>
                                  <case value="3"><{$Think.lang.已完成}></case>
                            </switch>
                        </td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.关联付款单号}> </td>
                        <td><{$info.payment_audit_no}></td>
                        <td> <{$Think.lang.采购单号}> </td>
                        <td><a onclick="opennewtab(this,'<{$Think.lang.订单详情页}>')" _href="<{:U('purchase_order_detail',['relevance_id'=>$order['relevance_id']])}>"
                        class="purchaseLinkHover"><{$order.procurement_number}></a><span class="purchase_commonBuy"><{:L($purchase_type[$order['purchase_type']])}></span>
                        </td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.采购PO单号}> </td>
                        <td><{$order.online_purchase_order_number}></td>
                        <td> <{$Think.lang.采购总金额}> </td>
                        <td><{:cdVal($order['amount_currency'])}> <{:format_number($order['amount'],2)}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.触发操作}> </td>
                        <td><{$info.action_type_cd}></td>
                        <td> <{$Think.lang.适用条款}> </td>
                        <td><{$info.clause_type}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.关联单据号}> </td>
                        <td><{$info.bill_no}></td>
                        <td> <{$Think.lang.我方公司}> </td>
                        <td><{:cdVal($order['our_company'])}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.供应商名称}> </td>
                        <td><{$order.sup_name}></td>
                        <td> <{$Think.lang.供应商名称（英文）}> </td>
                        <td><{$order.supplier_id_en}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.采购网站}> </td>
                        <td><{:cdVal($order['online_purchase_website'])}></td>
                        <td> <{$Think.lang.下单账号}> </td>
                        <td><{$order.online_purchase_account}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.销售团队}> </td>
                        <td><{:cdVal($order['sell_team'])}></td>
                        <td> <{$Think.lang.销售同事}> </td>
                        <td><{$order['seller']}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.采购团队}> </td>
                        <td><{:cdVal($order['payment_company'])}></td>
                        <td> <{$Think.lang.采购人}> </td>
                        <td><{$order.prepared_by}></td>
                    </tr>
                    <tr>
                        <td> <{$Think.lang.备注}> </td>
                        <td colspan="3"><{$info.confirm_remark}></td>
                    </tr>
                </tbody>
            </table>
            <!-- 赤练 收款信息 -->
            <table class="table payment_info">
                    <thead>
                        <th width="15%"></th>
                        <th width="35%"></th>
                        <th width="15%"></th>
                        <th width="35%"></th>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4"> <{$Think.lang.收款信息}> </td>
                        </tr>
                        <tr>
                            <td> <{$Think.lang.支付渠道}> <span class="required"></span></td>
                            <td>
                                <el-select filterable @change="paymentChannelChange(payment_channel_cd)"  v-model="payment_channel_cd" placeholder="请选择">
                                  <el-option
                                    v-for="item in payment_channel"
                                    :key="item.CD"
                                    :label="$lang(item.CD_VAL)"
                                    :value="item.CD">
                                  </el-option>
                                </el-select>
                                <el-input style="display: none;" v-model="payment_channel_cd" name="payment_audit[payment_channel_cd]"></el-input>
                            </td>
                            <td> <{$Think.lang.支付方式}> <span class="required"></span></td>
                            <td>
                                <el-select filterable @change="paymentMethodChange(payment_way_cd)" v-model="payment_way_cd" placeholder="请选择">
                                  <el-option
                                    v-for="item in payment_way"
                                    :key="item.CD"
                                    :label="$lang(item.CD_VAL)"
                                    :value="item.CD">
                                  </el-option>
                                </el-select>
                                <el-input style="display: none;" v-model="payment_way_cd" name="payment_audit[payment_way_cd]"></el-input>
                            </td>
                        </tr>
                        <tr>
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.预计付款日期}> </td>
                            <td>
                              <{$info.payable_date}>
                              <input type="hidden" name="payment_audit[payable_date_before]" value="<{$info.payable_date}>">
                              <input type="hidden" name="payment_audit[payable_currency_cd]" value="<{$order['amount_currency']}>">
                            </td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.预计付款日期}> <span class="required"></span></td>
                            <td>
                                <input type="hidden" name="confirm[id]" value="<{$info.id}>">
                                <input type="hidden" name="payment_audit[our_company_cd]" value="<{$order.our_company}>">
                                <input type="text" name="payment_audit[payable_date_after]" value="<{$now_date}>"
                            onfocus="WdatePicker({firstDayOfWeek:1})" placeholder="<{$Think.lang.付款日期}>" class="form-control"></td>
                        </tr>

                        
                        <!-- bankTransfer -->
                        <tr v-show="receiptStatus == 'bankTransfer'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.收款账户名}> </td>
                            <td><{$supplier_info.collection_account_name}></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.收款账户名}> <span class="required"></span></td>
                            <td>
                              <input class="form-control" name="order[supplier_collection_account]"
                               value="<{$supplier_info.collection_account_name}>"  place id="supplier_collection_account" @blur="changeGetVal">
                                <span style="color:#dddddd;font-size: 12px"><{$Think.lang.境外付款请输入英文}></span>
                            </td>
                        </tr>
                        <tr v-show="receiptStatus == 'bankTransfer'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.供应商开户行}> </td>
                            <td><{$supplier_info.SP_BANK_CD}></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.供应商开户行}> <span class="required"></span></td>
                            <td>
                              <input class="form-control" name="order[supplier_opening_bank]"
                               value="<{$supplier_info.SP_BANK_CD}>" id="supplier_opening_bank" @blur="changeGetVal">
                                <span style="color:#dddddd;font-size: 12px"><{$Think.lang.境外付款请输入英文}></span>
                            </td>
                        </tr>
                        <tr v-show="receiptStatus == 'bankTransfer'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.银行账号}> </td>
                            <td><{$supplier_info.BANK_ACCOUNT}></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.银行账号}> <span class="required"></span></td>
                            <td><input class="form-control" name="order[supplier_card_number]"
                               value="<{$supplier_info.BANK_ACCOUNT}>" id="supplier_card_number" @blur="changeGetVal"></td>
                        </tr>
                        <tr v-show="receiptStatus == 'bankTransfer'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.SWIFT CODE}> </td>
                            <td><{$supplier_info.SWIFT_CODE}></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.SWIFT CODE}> </td>
                            <td>
                                <input class="form-control el-input__inner" name="order[supplier_swift_code]" @blur="changeGetVal" id="supplier_swift_code"
                               value="<{$supplier_info.SWIFT_CODE}>">
                                <span style="color:#dddddd;font-size: 12px"><{$Think.lang.跨境支付SWIFT CODE必填，非跨境支付本地结算代码必填}></span>
                            </td>
                        </tr>
                      
                        <!-- 账号信息 -->
                        <tr v-show="receiptStatus == 'bankTransfer'">
                          <td> <{$Think.lang.确认前}>-<{$Think.lang.收款银行本地结算代码}> </td>
                          <td><{$supplier_info.BANK_SETTLEMENT_CODE}></td>
                          <td> <{$Think.lang.确认后}>-<{$Think.lang.收款银行本地结算代码}> </td>
                          <td>
                            <el-input name="payment_audit[bank_settlement_code]" @blur="changeGetVal" id="bank_settlement_code" v-model="bank_settlement_code" ></el-input>
                              <span style="color:#dddddd;font-size: 12px"><{$Think.lang.跨境支付SWIFT CODE必填，非跨境支付本地结算代码必填}></span>
                          </td>
                        </tr>
                        <tr v-show="receiptStatus == 'bankTransfer'">
                          <td> <{$Think.lang.确认前}>-<{$Think.lang.收款银行地址}> </td>
                          <td><{$supplier_info.BANK_ADDRESS}></td>
                          <td> <{$Think.lang.确认后}>-<{$Think.lang.收款银行地址}> <span class="required"></span></td>
                          <td>
                            <el-select v-model="selectCountry" style="width: 30%;" @change="changeGetVal"  filterable name="country" id="country_input"
                                    placeholder="<{$Think.lang.国家}>">
                                <el-option v-for="item in country" :key="item.id" :label="item.zh_name"
                                            :value="item.id"></el-option>
                            </el-select>
                            <!-- <el-select  v-model="selectProvince" style="width: 30%;" @change="changeGetVal" filterable name="province" id="province_input"
                                        placeholder="<{$Think.lang.省市}>">
                                <el-option v-for="item in province" :key="item.id" :label="item.zh_name"
                                            :value="item.id"></el-option>
                            </el-select>
                            <el-select  v-model="selectCounty"  style="width: 30%;" @change="changeGetVal" filterable name="county" id="county_input"
                                        placeholder="<{$Think.lang.区县}>">
                                <el-option v-for="item in county" :key="item.id" :label="item.zh_name"
                                            :value="item.id"></el-option>
                            </el-select> -->
                            <input type="hidden" name="payment_audit[bank_address]" id="city_input"/>
                            <input type="hidden" name="payment_audit[city]" id="cityID_input"/>
                          </td>
                        </tr>
                        <!-- <tr v-show="receiptStatus == 'bankTransfer'">
                          <td> <{$Think.lang.确认前}>-<{$Think.lang.收款银行详细地址}> </td>
                          <td><{$supplier_info.BANK_ADDRESS_DETAIL}></td>
                          <td> <{$Think.lang.确认后}>-<{$Think.lang.收款银行详细地址}> </td>
                          <td>
                            <el-input v-model="bank_address_detail" @blur="changeGetVal" id="bank_address_detail" name="payment_audit[bank_address_detail]" ></el-input>
                          </td>
                        </tr>
                        <tr v-show="receiptStatus == 'bankTransfer'">
                          <td> <{$Think.lang.确认前}>-<{$Think.lang.收款银行邮编}> </td>
                          <td><{$supplier_info.BANK_POSTAL_CODE}></td>
                          <td> <{$Think.lang.确认后}>-<{$Think.lang.收款银行邮编}> </td>
                          <td>
                            <el-input v-model="bank_postal_code" @blur="changeGetVal" id="bank_postal_code" name="payment_audit[bank_postal_code]"></el-input>
                          </td>
                        </tr> -->
                        <tr v-show="receiptStatus == 'bankTransfer'">
                          <td> <{$Think.lang.确认前}>-<{$Think.lang.收款账号币种}> </td>
                          <td><{$supplier_info.account_currency_val}></td>
                          <td> <{$Think.lang.确认后}>-<{$Think.lang.收款账号币种}> <span class="required"></span></td>
                          <td>
                            <el-select v-model="currency_cd" @change="changeGetVal" filterable :placeholder="$lang('请选择')">
                                <el-option
                                  v-for="item in currency"
                                  :key="item.cd"
                                  :label="item.cdVal"
                                  :value="item.cd">
                                </el-option>
                            </el-select>
                            <input type="hidden" id="account_currency" name="payment_audit[account_currency]" v-model="currency_cd"/>
                          </td>
                        </tr>
                        <!-- <tr v-show="receiptStatus == 'bankTransfer'">
                          <td> <{$Think.lang.确认前}>-<{$Think.lang.收款账户种类}> </td>
                          <td><{$supplier_info.account_type_val}></td>
                          <td> <{$Think.lang.确认后}>-<{$Think.lang.收款账户种类}> </td>
                          <td>
                            <el-select v-model="collection_account_type_cd" @change="changeGetVal" filterable placeholder="请选择">
                                <el-option
                                  v-for="item in collection_account_type"
                                  :key="item.cd"
                                  :label="item.cdVal"
                                  :value="item.cd">
                                </el-option>
                            </el-select>
                            <input type="hidden" id="account_type" name="payment_audit[account_type]" v-model="collection_account_type_cd"/>
                          </td>
                        </tr> -->




                        <!-- otherOrderPay -->
                        <tr v-show="receiptStatus == 'otherOrderPay'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.平台名称}> </td>
                            <td><{$supplier_info.online_purchase_website_val}></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.平台名称}> <span class="required"></span></td>
                            <td>
                               <el-select filterable @change="platformChange(platform_cd)" v-model="platform_cd" placeholder="请选择">
                                  <el-option
                                    v-for="item in platform"
                                    :key="item.CD"
                                    :label="item.CD_VAL"
                                    :value="item.CD">
                                  </el-option>
                                </el-select>
                                <el-input style="display: none;" v-model="platform_cd" name="payment_audit[platform_cd]"></el-input>
                              </td>
                        </tr>
                        <tr v-show="receiptStatus == 'otherOrderPay'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.店铺名称}> </td>
                            <td></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.店铺名称}></td>
                            <td>
                              <input class="form-control" name="payment_audit[store_name]"
                               value="" id="store_name" @blur="changeGetVal">
                            </td>
                        </tr>
                        <tr v-show="receiptStatus == 'otherOrderPay'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.平台订单号}> </td>
                            <td><{$info.online_purchase_order_number}></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.平台订单号}> <span class="required"></span></td>
                            <td>
                              <input class="form-control" name="payment_audit[platform_order_no]"
                               value="<{$info.online_purchase_order_number}>" id="platform_order_no" @blur="changeGetVal">
                            </td>
                        </tr>



                        <!-- otherTransfer -->
                        <tr v-show="receiptStatus == 'otherTransfer'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.该支付渠道收款账号}> </td>
                            <td></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.该支付渠道收款账号}> <span class="required"></span></td>
                            <td>
                              <input class="form-control" name="payment_audit[collection_account]"
                                value="" id="collection_account" @blur="changeGetVal">
                            </td>
                        </tr>
                        <tr v-show="receiptStatus == 'otherTransfer'">
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.该支付渠道收款用户名}> </td>
                            <td></td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.该支付渠道收款用户名}> <span class="required"></span></td>
                            <td>
                              <input class="form-control" name="payment_audit[collection_user_name]"
                                value="" id="collection_user_name" @blur="changeGetVal">
                            </td>
                        </tr>

                        <tr>
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.本期应付金额}>-<{$Think.lang.计算公式}> </td>
                            <td><{$info.formula}></td>
                            <!-- <td> <{$Think.lang.是否使用抵扣金额支付}>？ <span class="required"></span></td>
                            <td>
                                <input class="deductionRadio" type="radio" id="yes" name="confirm[use_deduction]" value="1" checked>
                                <label for="yes">是</label>&nbsp;&nbsp;
                                <input class="deductionRadio" type="radio" id="no" name="confirm[use_deduction]" value="0">
                                <label for="no">否</label>
                                &nbsp;&nbsp;<span class='text-show' style="display: none"><{$Think.lang.无可使用抵扣金}></span>
                            </td> -->
                            <td>
                            
                              <div v-if="'<{$order.amount_deduction_compensation_require}>' == 'Y'">
                                <{$Think.lang.本次使用赔偿、返利金额}>
                                <span class="required"></span>
                              </div>
                              <div v-else>
                                <{$Think.lang.本次使用赔偿、返利金额}>
                              </div>
                              <input type="hidden" class="amount_deduction_compensation_detail" name="compensation" value="">
                            </td>
                          
                            <td>
                              <span><{:cdVal($order['amount_currency'])}></span>
                              <input v-if="'<{$order.amount_deduction_compensation_require}>' == 'Y'" readonly="readonly" class="use-compensation-rebate form-control" style="width:150px;display: inline-block;background:#fff" type="text">
                              <input v-else disabled value="0" class="form-control" style="width:150px;display: inline-block" type="text">
                              <input type="hidden" class="use_deduction_compensation" name="confirm[amount_deduction_compensation]" value="">
                              <input type="hidden" class="use_deduction" name="confirm[amount_deduction]" value="">
                              / 
                              <span><{:cdVal($order['amount_currency'])}></span>
                              <span class="amount_deduction"><{:format_number($order['amount_deduction_compensation'],2)}></span>
                            </td>

                        </tr>



                        <tr class="deduction-tr" >
                          <td><{$Think.lang.赔偿、返利金额使用备注}></td>
                          <td>
                            <input :disabled="!isrequire" class="form-control" type="text" name="confirm[remark_deduction]"></td>
                            <!-- <input :disabled="'<{$order.amount_deduction_compensation_require}>' != 'Y'" class="form-control" type="text" name="confirm[remark_deduction]"></td> -->
                          <td><{$Think.lang.上传赔偿、返利金额使用沟通凭证}> <span v-show="isrequire" class="required"></span></td>
                          <!-- <td><{$Think.lang.上传赔偿、返利金额使用沟通凭证}> <span v-show="'<{$order.amount_deduction_compensation_require}>' == 'Y'" class="required"></span></td> -->
                          <td>
                              <button :disabled="!isrequire" class="btn-upload"><{$Think.lang.上传文件}></button>
                              <!-- <button :disabled="'<{$order.amount_deduction_compensation_require}>' != 'Y'" class="btn-upload"><{$Think.lang.上传文件}></button> -->
                              <ul class="file-lists">
                              </ul>
                              <input type="hidden" class="certificate-upload" name="confirm[voucher_deduction]"
                                    value="">
                          </td>
                          <div id="update" style="display: none">
                              <form id="upload" action="/index.php?m=order_detail&a=file_upload" method="post"
                                    enctype="multipart/form-data">
                                  <div style="margin-top: 50px">
                                      <input type="file" name="certificate" id="certificate" multiple>
                                      <input type="submit" id="submitBtn" onclick="return false">
                                  </div>
                              </form>
                          </div>
                      </tr>

                        <tr class="deduction-tr" >
                            <td><{$Think.lang.使用采购余额}> <span class="required"></span></td>
                            <td>
                                <span><{:cdVal($order['amount_currency'])}></span>
                                <input :disabled="'<{$order.amount_deduction}>' <= 0" class="use-deduction-show form-control" style="width:150px;display: inline-block" class="form-control" type="text">
                                <input type="hidden" class="use_deduction_account" name="confirm[amount_deduction_account]" value="">
                                / 
                                <span><{:cdVal($order['amount_currency'])}></span>
                                <span class="amount_deduction"><{:format_number($order['amount_deduction'],2)}></span>
                                <input type="hidden" class="amount_deduction_unformat" value="<{$order['amount_deduction']}>"/>
                            </td>
                            <td><{$Think.lang.抵扣后}>-<{$Think.lang.剩余应付}></td>
                            <td>
                                <span><{:cdVal($order['amount_currency'])}></span>
                                <span class="deducation-after-show"></span>
                            </td>
                        </tr>
                   
                      <tr style="display: none" class="remainder">
                            <td><{$Think.lang.继续支付剩余部分}></td>
                            <td>
                                <label><input type="radio" name="confirm[pay_remainder]"
                                              class="pay_remainder need_pay_remainder" value="1">需要支付</label>
                                <label><input type="radio" name="confirm[pay_remainder]"
                                              class="pay_remainder unneed_pay_remainder" value="2">本次结束</label>
                            </td>
                            <td class="next_payment"><{$Think.lang.下一次金额与日期}><span class="required"></span></td>
                            <td class="payable_detail_input payable_amount_confirm next_payment next_payment_info">
                                <span><{:cdVal($order['amount_currency'])}></span>
                                &nbsp;<span>0.00</span>&nbsp;
                                <input type="text" onfocus="WdatePicker({skin:'whyGreen',minDate:'%y-%M-%d'})"
                                      placeholder="请选择预计日期" name="confirm[next_pay_time]"
                                      class="form-control amount_confirm_show">
                            </td>
                            <td style="display: none" class="difference"><{$Think.lang.金额差异原因}></td>
                            <td style="display: none" class="difference difference_info">
                                <select name="confirm[difference_reason]" class="form-control difference_reason">
                                    <option value="">请选择差异原因</option>
                                    <volist name="payment_dif_reason" id="v">
                                        <option value="<{$v.CD}>"><{$v.CD_VAL}></option>
                                    </volist>
                                </select>
                            </td>
                        </tr>


                        <tr>
                            <td> <{$Think.lang.确认前}>-<{$Think.lang.本期应付金额}> </td>
                            <td class="payable_amount_confirm_before">
                                <?php if($info['amount_payable_split'] === null){ ?>
                                <span><{:cdVal($order['amount_currency'])}></span>
                                <span class="payable_amount_confirm_before_span"><{:format_number($info['amount_payable'],2)}></span>
                                <?php }else { ?>
                                <span>（<{$Think.lang.拆分前}>）<{:cdVal($order['amount_currency'])}></span>
                                <span class=""><{:format_number($info['amount_payable'],2)}></span>
                                <span>（<{$Think.lang.拆分后}>）<{:cdVal($order['amount_currency'])}></span>
                                <span class="payable_amount_confirm_before_span"><{:format_number($info['amount_payable_split'],2)}></span>
                                <?php } ?>
                            </td>
                            <td> <{$Think.lang.确认后}>-<{$Think.lang.本期应付金额}> <span class="required"></span></td>
                            <td class="payable_detail_input payable_amount_confirm ">
                              <div>
                                  <span><{:cdVal($order['amount_currency'])}></span>
                                  <input class="form-control amount_confirm_show"
                                        value="<{:format_number($info['amount_payable_split'] === null ? $info['amount_payable'] : $info['amount_payable_split'],2)}>">
                                  <input type="hidden" class="amount_confirm" name="confirm[amount_confirm]"
                                        value="<{:$info['amount_payable_split'] === null ? $info['amount_payable'] : $info['amount_payable_split']}>">
                              </div>
                            </td>
                        </tr>
                        <tr>
                            <td><{$Think.lang.差异原因}>/<{$Think.lang.应付差额}> </td>
                            <td class="payable_detail_input payable_amount_difference">
                                <!-- <{$info.amount_difference}> -->
                                <div>
                                    <span><{:cdVal($order['amount_currency'])}></span>
                                    <span>0.00</span>
                                    <input name="confirm[amount_difference]" value="0" type="hidden">
                                    <select name="confirm[difference_reason]" class="form-control difference_reason"
                                            style="display: none">
                                        <option value="">请选择差异原因</option>
                                        <volist name="payment_dif_reason" id="v">
                                            <option value="<{$v.CD}>"><{$v.CD_VAL}></option>
                                        </volist>
                                    </select>
                                </div>
                            </td>
                            <td><{$Think.lang.下一次付款日期与差额}> </td>
                            <if condition="$info['pay_remainder'] eq 2">
                            <td><{:cdVal($info['difference_reason'])}></td>
                            <elseif condition="$info['pay_remainder'] eq 1"/>
                            <td><{:cdVal($order['amount_currency'])}><{:format_number($info['amount_difference'],2)}> (<{$Think.lang.预计时间}>:<{$info['next_pay_time']}>)</td>
                            <else />
                            <td></td>
                            </if>
                        </tr>

                        <tr>
                            <td> <{$Think.lang.提交付款备注}> </td>
                            <td colspan="3"><input class="form-control" name="confirm[confirm_remark]"></td>
                        </tr>
                        <tr>
                            <td> <{$Think.lang.付款需求附件}> </td>
                            <td colspan="3">
                                <el-upload
                                  class="upload-demo"
                                  action="/index.php?m=order_detail&a=file_upload"
                                  :on-success="handleSuccessDeductible"
                                  :on-remove="handleRemoveDeductible"
                                  :before-upload="beforeUpload"
                                  multiple
                                  :file-list="payment_attachment">
                                  <el-button size="small" type="primary">上传附件</el-button>
                                </el-upload>
                                <input type="hidden" class="payment_attachment_upload" name="confirm[payment_attachment]"
                                    value="">
                            </td>
                        </tr>

                    </tbody>
                </table>               
                <div class="main-basic-info" v-if="paymentData.length > 0">
                    <header>
                        <{$Think.lang.选择合并付款应付单}>
                    </header>
                    <table border="0" cellspacing="0" cellpadding="0" class="child-basic-table">
                        <thead>
                        <tr>
                            <th width="80px">
                                <el-checkbox v-model="checkAll" @change="checkAllFn"></el-checkbox>
                            </th>
                            <th><{$Think.lang.付款单号}></th>
                            <th>Payment Key</th>
                            <th><{$Think.lang.采购单号}></th>
                            <th><{$Think.lang.采购PO单号}></th>
                            <th><{$Think.lang.触发操作}></th>
                            <th><{$Think.lang.适用条款}></th>
                            <th><{$Think.lang.关联单据号}></th>
                            <th><{$Think.lang.采购同事}></th>
                            <th><{$Think.lang.确认后}>-<{$Think.lang.本期应付金额}></th>
                            <th><{$Think.lang.确认后}>-<{$Think.lang.预计付款日期}></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="(item,index) in paymentData">
                            <td>
                              <el-checkbox v-model="item.checked" @change="checksin(item,index)"></el-checkbox>
                            </td>
                            <td>{{item.payment_audit_no}}</td>
                            <td>
                              <a @click="openPayDetail(item)" class="purchaseLinkHover">{{item.payment_no}}</a>
                            </td>
                            <td>
                              <a @click="openPurchaseDetail(item)" class="purchaseLinkHover">{{item.procurement_number}}</a>
                            </td>
                            <td>{{item.online_purchase_order_number}}</td>
                            <td>{{item.action_type_cd}}</td>
                            <td>{{item.clause_type}}</td>
                            <td>{{item.bill_no}}</td>
                            <td>{{item.prepared_by}}</td>
                            <td>{{item.amount_currency_val}}  {{item.amount_confirm}}</td>
                            <td>{{item.payable_date_after}}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            <div class="col-lg-12  col-md-12 col-xs-12 col-lg-12-btn">
                <button  type="button" class="btn-sure"><{$Think.lang.提交}></button>
                <!-- <button type="button" onclick="location='<{:U("payable_list")}>'" class="btn-back"><{$Think.lang.返回列表}></button> -->
            </div>
            <el-dialog title="<{$Think.lang.提示}>" :visible.sync="confirmDialog" width="30%" center>
                <template>
                    <span><{$Think.lang.确认后，合并付款应付单的【确认后-预计付款日期】全部会改为本应付单的【确认后-预计付款日期】哦！}></span>
                </template>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="confirmDialog = false"> <{$Think.lang.取消}> </el-button>
                    <el-button type="primary" @click="confirmSubmit" id="confirmBtn"> <{$Think.lang.确定}> </el-button>
                </span>
            </el-dialog>
            <el-dialog title="<{$Think.lang.供应商返利、赔偿使用确认}>" :visible.sync="compensationRebateDialog" width="50%" center>
              <p style="color: red;"><{$Think.lang.部分情况返利、赔偿金额缺失，可能是因为被合并在了【历史采购货款差异】金额中，确认后可前往对应页面进行余额转账.}></p>
              <el-table class="table-list" :data="compensationRebateData" border show-summary :summary-method="getSummaries">
                  <el-table-column align="center" :label="$lang('采购单号')">
                      <template slot-scope="scope">
                          <span>{{scope.row.order_no}}</span>
                      </template>
                  </el-table-column>
                  <el-table-column align="center" :label="$lang('币种')">
                      <template slot-scope="scope">
                        <span>{{scope.row.deduction_currency_cd_val}}</span>
                      </template>
                  </el-table-column>
                  <el-table-column align="center" :label="$lang('返利、赔偿余额')">
                      <template slot-scope="scope">
                        <span>{{scope.row.over_deduction_amount}}</span>
                      </template>
                  </el-table-column>
                  <el-table-column align="center" :label="$lang('选择')">
                      <template slot-scope="scope">
                        <el-input @change="getSummaries" v-model="scope.row.choose"></el-input>
                      </template>
                  </el-table-column>
              </el-table>
              <div style="display: flex;justify-content: space-around;margin-top: 20px;">
                <el-button type="primary" @click="compensationRebateSubmit('unused')"> <{$Think.lang.确认未使用}> </el-button>
                <el-button @click="compensationRebateSubmit('cancel')"> <{$Think.lang.取消}> </el-button>
                <el-button type="primary" @click="compensationRebateSubmit('sure')"> <{$Think.lang.确定}> </el-button>
              </div>
            </el-dialog>
        </div>
    </form>
</div>
</body>
<script type="text/javascript" src="../Public/lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="../Public/lib/bootstrap/js/tether.min.js"></script>
<script type="text/javascript" src="../Public/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="../Public/lib/layer/1.9.3/layer.js" type="text/javascript"></script>
<script type="text/javascript" src="../Public/js/H-ui.js"></script>
<script type="text/javascript" src="../Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
<script type="text/javascript" src="../Public/utils/utils.js"></script>
<script type="text/javascript" src="../Public/lib/jquery.form.min.js"></script>
<script type="text/javascript" src="../Public/lib/webuploader/0.1.5/webuploader.js"></script>
<script type="text/javascript" src="/Application/Tpl/Home/Public/js/vue.2.5.13.js"></script>
<script type="text/javascript" src="/Application/Tpl/Home/Public/js/element-ui-2.2.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
<script>

    var VM = new Vue({
        el: '#payment_info',
        data: {
            paymentData: [],//数据
            checkAll: false,
            pickPayment: [],
            confirmDialog: false,
            compensationRebateDialog:false,
            compensationRebateData:[],
            compensationRebateData2:[],
            chooseSum:0,
            payment_channel_cd:'N001000301',
            payment_channel:[
              {
                CD: 'N001000200',
                CD_VAL: '国内支付宝'
              }, {
                CD: 'N001000301',
                CD_VAL: '银行'
              }
            ],
            payment_channel_val:'',
            payment_way_cd:'N003020001',
            payment_way:[],
            payment_way_val:'',
            platform_cd:'',
            platform:[],
            payment_attachment:[],
            receiptStatus:'bankTransfer',
            urlNow:'',
            currency_cd:'',
            collection_account_type_cd:'',
            currency:[],
            collection_account_type:[],
            country:[],
            province:[],
            county:[],
            selectCountry:'',
            selectProvince:'',
            selectCounty:'',
            bank_settlement_code:'',
            bank_address_detail:'',
            bank_postal_code:'',
            isrequire:true
        },
        created() {
            this.urlNow = window.location.href
            // console.log('new'+ this.getUrl('channel'));
            console.log(this.urlNow);
            
            if(this.getUrl('receiptStatus')){
              this.payment_way_cd = this.getUrl('way')
              this.payment_channel_cd = this.getUrl('channel')
              this.receiptStatus = this.getUrl('receiptStatus')
              this.paymentChanne(this.payment_channel_cd)
            }else{
              this.paymentChanne('N001000301')
            }


            
            // this.paymentChanne('N001000301')
            this.getPaymentData(1);
            this.payment_channel_init()
            this.getCommonData()
        },
        mounted() {
          if('<{$order.amount_deduction_compensation_require}>' == 'Y'){
            this.isrequire = true
          }else{
            this.isrequire = false
          }
        },
        methods:{
          getCommonData:function(){
                var _this = this
                _this.bank_settlement_code = '<{$supplier_info.BANK_SETTLEMENT_CODE}>'
                if ('<{$supplier_info.CITY}>') {
                    area = '<{$supplier_info.CITY}>'.split(',');
                    _this.selectCountry = area[0] || '';
                    _this.selectProvince = area[1] || '';
                    _this.selectCounty = area[2] || '';
                }
                _this.bank_address_detail = "<{$supplier_info.BANK_ADDRESS_DETAIL}>"
                _this.bank_postal_code = '<{$supplier_info.BANK_POSTAL_CODE}>'
                _this.currency_cd = '<{$supplier_info.account_currency}>'
                _this.collection_account_type_cd = '<{$supplier_info.account_type}>'

                axios.post('index.php?g=oms&m=CommonData&a=commonData', {
                    data: {
                        query: {
                            "currency": true,
                            "collection_account_type":true,
                            // "area": true,
                        }
                    }
                }).then(function (res) {
                    if(res.data.code == 2000){
                        _this.currency = res.data.data.currency
                        _this.collection_account_type = res.data.data.collection_account_type
                        // _this.country = res.data.data.area
                    }
                })

                axios.post('/index.php?g=common&m=index&a=get_area', {
                    "parent_no": 0,
                    "is_id":''
                }).then(function (res) {
                    console.log(res)
                    if (res.data.code == 2000) {
                        _this.country = res.data.data;
                    } else {
                        _this.$message({
                            message: data.msg,
                            type: 'error'
                        });
                    }
                })
          },
          getPaymentData(cnm){
              var _this = this;

              var bank_address = ''
              var bank_address_id = ''
              if($("#county_input").val()){
                  bank_address = $("#country_input").val() + '-' +  $("#province_input").val() + '-' +  $("#county_input").val()
                  bank_address_id = VM.selectCountry + ',' + VM.selectProvince + ',' + VM.selectCounty
              }else if($("#province_input").val() && !$("#county_input").val()){
                  bank_address = $("#country_input").val() + '-' +  $("#province_input").val()
                  bank_address_id = VM.selectCountry + ',' + VM.selectProvince
              }else if($("#country_input").val() && !$("#province_input").val()){
                  bank_address = $("#country_input").val()
                  bank_address_id = VM.selectCountry
              }else if(!$("#country_input").val()){
                  bank_address = ''
                  bank_address_id = ''
              }
              $("#city_input").val(bank_address)
              $("#cityID_input").val(bank_address_id)

              var data = {
                search:{
                      supplier_collection_account: $('#supplier_collection_account').val(),
                      supplier_opening_bank: $('#supplier_opening_bank').val(),
                      supplier_card_number: $('#supplier_card_number').val(),
                      supplier_name: '<{$order.sup_name}>',
                      our_company_cd: '<{$order.our_company}>',
                      amount_currency: '<{$order.amount_currency}>',
                      payment_id: '<{$info.id}>',
                      // supplier_name: '<{$order.supplier_id}>',
                      supplier_swift_code: $('#supplier_swift_code').val(),
                      payment_channel_cd:this.payment_channel_cd,
                      payment_way_cd:this.payment_way_cd,
                      platform_cd:this.platform_cd,
                      collection_account:$('#collection_account').val(),
                      collection_user_name:$('#collection_user_name').val(),

                      bank_settlement_code:$('#bank_settlement_code').val(),
                      bank_address:$('#city_input').val(),
                      city:$('#cityID_input').val(),
                      bank_address_detail:$('#bank_address_detail').val(),
                      bank_postal_code:$('#bank_postal_code').val(),
                      account_currency:$('#account_currency').val(),
                      account_type:$('#account_type').val(),
                }
              }
              axios.post("/index.php?m=orderDetail&a=getPaymentBill", data)
              .then(function(res) {
                console.log(res);
                
                  var result = res.data;
                  if (result.code == 200) {
                    _this.paymentData = result.data.data;
                  } else {
//                    _this.$message.warning(_this.$lang(res.data.msg));
//                    if(!cnm){
//                      _this.$message.warning(_this.$lang(res.data.msg));
//                    }
                  }
              });
          },
          payment_channel_init:function(){
            var _this = this;
            var params = {
                "cd_type":{
//                  "payment_channel": "false",
                  "pur_website_and_new_plat":"false"
                }
            };

            axios.post("/index.php?g=common&m=index&a=get_cd", params).then(function(res){
              if(res.data.code == 2000){
                // _this.payment_channel = res.data.data.payment_channel
                _this.platform = res.data.data.pur_website_and_new_plat
              }
            })

          },
          paymentChanne:function(val){
            var _this = this;
            var params = {
                  "payment_channel_cd": val
            };

            axios.post("/index.php?g=common&m=index&a=getPaymentWay", params).then(function(res){
              console.log(res);
              if(res.data.code == 200){
                _this.payment_way = res.data.data
              }
            })
          },
          paymentChannelChange:function(val){
            // console.log(this.urlNow);
            // if(this.getUrl('channel')){
              // this.replaceParamVal('channel',val)
              // this.replaceParamVal('way','')

            //     var oUrl = this.urlNow.toString();
            //     var re=eval('/('+ 'channel'+'=)([^&]*)/gi');
            //     var nUrl = oUrl.replace(re,'channel'+'='+val);

            //     var re2=eval('/('+ 'way'+'=)([^&]*)/gi');
            //     var nUrl2 = nUrl.replace(re2,'way'+'='+'');

            //     window.location.href = nUrl2
            
            // }else{
              // this.urlNow = this.urlNow + '&channel=' + val + '&channel='
              // window.location.href = this.urlNow
            // }

            this.payment_channel_val = val
            this.payment_way_cd = ''

            this.paymentChanne(val)

            // window.location.reload();
            // window.location.href = this.urlNow

          },
          paymentMethodChange:function(val){
            
            this.urlNow = '/index.php?m=order_detail&a=payable_confirm&id=' + '<{$info.id}>'
            if(this.payment_channel_cd == 'N001000301'){
              // this.receiptStatus = 'bankTransfer'
              window.location.href = this.urlNow + '&channel=N001000301&receiptStatus=bankTransfer&way=' + val
            }else if(this.payment_channel_cd == 'N001000200' && val == 'N003020001'){
              // this.receiptStatus = 'otherTransfer'
              window.location.href= this.urlNow + '&channel=N001000200&receiptStatus=otherTransfer&way=N003020001'
            }else if(this.payment_channel_cd == 'N001000200' && val == 'N003020002'){
              // this.receiptStatus = 'otherOrderPay'
              window.location.href = this.urlNow + '&channel=N001000200&receiptStatus=otherOrderPay&way=N003020002'
            }

          },
          platformChange:function(val){
            this.getPaymentData();
            console.log(val);
          },
          getUrl:function(data){
              var search = window.location.search
              var urlParams = new URLSearchParams(search);
              return urlParams.get(data)
          },
          replaceParamVal:function(paramName,replaceWith){
              var oUrl = this.urlNow.toString();
              var re=eval('/('+ paramName+'=)([^&]*)/gi');
              var nUrl = oUrl.replace(re,paramName+'='+replaceWith);
              window.location.href=nUrl
          },
          // 附件

          // 上传付款凭证
          handleSuccessDeductible: function(res, file, fileList) {
              console.log(fileList);
              if(res.status == '0'){
                this.$message({
                    message: this.$lang(res.info),
                    type: 'error'
                });
              }else{
                this.payment_attachment = fileList;
              }
              // console.log(this.payment_attachment);
              var data = this.payment_attachment
              var payment_attachment_upload = []
              for(let key in data){
                var obj ={}
                obj.original_name = data[key].response.info.name
                obj.save_name = data[key].response.info.savename
                payment_attachment_upload.push(obj)
              }
              $('.payment_attachment_upload').val(JSON.stringify(payment_attachment_upload))

          },
          // 上传付款凭证
          handleRemoveDeductible: function(file, fileList) {
              console.log(fileList);
              this.payment_attachment = fileList;

              var data = this.payment_attachment
              var payment_attachment_upload = []
              for(let key in data){
                var obj ={}
                obj.original_name = data[key].response.info.name
                obj.save_name = data[key].response.info.savename
                payment_attachment_upload.push(obj)
              }
              $('.payment_attachment_upload').val(JSON.stringify(payment_attachment_upload))

          },
          /**
              * 过滤同名文件
              * */

          beforeUpload: function(file) {
              console.log(file);
              var flag = true;
              var _this = this;
              var length = this.payment_attachment.length;
              if (length) {
                  for (var i = 0; i < length; i++) {
                      if (file.name === _this.payment_attachment[i].name) {
                          flag = false;
                      }
                  }
              }
              if (!flag) {
                  _this.$message({
                      message: _this.$lang('不能上传同名文件'),
                      type: 'error'
                  });
              }
              return flag;
          },

          openPayDetail(item){
            newTab("/index.php?m=order_detail&a=payable_detail&id=" + item.id, '<{$Think.lang.应付详情页}>');
          },
          openPurchaseDetail(item){
            newTab("/index.php?m=order_detail&a=purchase_order_detail&relevance_id=" + item.relevance_id, '<{$Think.lang.订单详情页}>');
          },
          getSummaries(param) {
            // console.log('param',param);

            var chooseSum = 0
            var _this = this
            var compensationRebateArr = _this.compensationRebateData
            // console.log('compensationRebateArr',compensationRebateArr);
            
            for (const item in compensationRebateArr) {
              if(!Number.isFinite(Number(compensationRebateArr[item].choose))){
                _this.compensationRebateData[item].choose = 0
              }else{
                chooseSum += Number(compensationRebateArr[item].choose)
              }
            }

            var sums = [];

            _this.chooseSum = chooseSum.toFixed(4)
            
            sums[0] = '<{$Think.lang.合计}>';
            sums[3] = _this.chooseSum;
            
            return sums;
          

          },
          compensationRebateSubmit:function(type){
            // console.log(this.chooseSum);
            // console.log('compensationRebateData',this.compensationRebateData);
            var use_deduction_show = $('.use-deduction-show').val()
            let compensationRebateArr = this.compensationRebateData
            let compensationRebateArr2 = this.compensationRebateData2
            console.log(compensationRebateArr);
            console.log(compensationRebateArr2);
            if(type == 'sure'){
              // var use_deduction_show = $('.use-deduction-show').val()
              // var chooseSum = this.chooseSum
              $('.use-compensation-rebate').val(Number(this.chooseSum).toFixed(2))
              $('.use_deduction_compensation').val(Number(this.chooseSum).toFixed(2))
              $('.use_deduction').val((Number(this.chooseSum) + Number(use_deduction_show)).toFixed(2))
              var status = true
              for (const item in compensationRebateArr) {
                if(Number(compensationRebateArr[item].choose) > Number(compensationRebateArr[item].over_deduction_amount)){
                  this.$message({
                      message: this.$lang('选择的金额不能大于该行返利、赔偿余额'),
                      type: 'warning'
                  });
                  status = false
                  return;
                }
              }
              if(status){
                difference('use-deduction');
                for (const item in compensationRebateArr2) {
                  compensationRebateArr2[item].choose = compensationRebateArr[item].choose
                }
                // this.compensationRebateData2 = []
                this.compensationRebateDialog = false
                if(this.chooseSum>0){
                  this.isrequire = true
                }else{
                  this.isrequire = false
                }
              }

            }else if(type == 'unused'){
              $('.use-compensation-rebate').val(0)
              $('.use_deduction_compensation').val(0)
              // $('.use_deduction_compensation').val(this.chooseSum)
              $('.use_deduction').val((Number(this.chooseSum) + Number(use_deduction_show)).toFixed(2))
              difference('use-deduction');
              for (const item in compensationRebateArr) {
                this.compensationRebateData[item].choose = this.compensationRebateData2[item].choose
              }
              // this.compensationRebateData2 = []
              this.compensationRebateDialog = false
              this.isrequire = false
            }else{
              for (const item in compensationRebateArr) {
                this.compensationRebateData[item].choose = this.compensationRebateData2[item].choose
              }
              // this.compensationRebateData2 = []
              this.compensationRebateDialog = false
            }
            
            

          },
          checkAllFn: function() {
              if(this.checkAll){
                for(var item in this.paymentData){
                    Vue.set(this.pickPayment,item, this.paymentData[item].id);
                    Vue.set(this.paymentData[item], 'checked', this.checkAll);
                }
              }else{
                for(var item in this.paymentData){
                    Vue.set(this.paymentData[item], 'checked', this.checkAll);
                }
                this.pickPayment = [];
              }
              
          },
          checksin: function(item,index){
              if(item.checked){
                Vue.set(this.pickPayment,index, item.id); 
                for(var val in this.paymentData){//判断相同付款单号下的应付单
                  if(item.payment_audit_no == this.paymentData[val].payment_audit_no){
                    Vue.set(this.pickPayment,val, this.paymentData[val].id);
                    Vue.set(this.paymentData[val], 'checked', true);
                  }
                }               
              }else{
                Vue.delete(this.pickPayment,index);//vue方法
                for(var val in this.paymentData){//判断相同付款单号下的应付单
                  if(item.payment_audit_no == this.paymentData[val].payment_audit_no){
                    Vue.delete(this.pickPayment,val);
                    Vue.set(this.paymentData[val], 'checked', false);
                  }
                }   
              }
              if(this.pickPayment.length == this.paymentData.length){
                this.checkAll = true;
              }else{
                this.checkAll = false;
              }
          },
          changeGetVal: function(){
            this.getPaymentData();
          },
          confirmSubmit: function(){
            this.confirmDialog = false;
            var url = "<{:U('')}>";
            var amount_confirm = $(".payable_amount_confirm div input").val();
//            if (!checkNum(amount_confirm)) {
//              alert('<{$Think.lang.应付金额不能为负数}>');
//              return false;
//            }
            $('.certificate-upload').val(getFileList());
            if(!getFileList() && $('.use-deduction').val()){
              layer.msg("<span class='invoice_detail_bomb_tip'><i style='color:red;'>X</i>" + '<{$Think.lang.沟通凭证必填}>' + "</span>");
              return false;
            }
            for(var item in this.pickPayment){
              var input = document.createElement('input');  //创建input节点
              input.setAttribute('type', 'hidden');  //定义类型是文本输入
              input.setAttribute('name', 'payable_ids['+item+']');
              input.setAttribute('value', this.pickPayment[item]);
              $('form').append(input); //添加到form中显示
            }      
            var data = $('form').serialize();
            utils.lazy_loading('show');
            $.post(url, data, function (msg) {
              utils.lazy_loading();
              if (msg.status == 1) {
                layer.msg("<span class='invoice_detail_bomb_tip'><i>√</i>" + msg.info + "</span>");
                setTimeout(function () {
                  location = "<{:U('payable_detail',['id'=>$info['id']])}>";
                }, 1000)
              } else {
                layer.msg("<span class='invoice_detail_bomb_tip'><i style='color:red;'>X</i>" + msg.info + "</span>");
              }
            })
          },
        },
        watch: {
            selectCountry: function (newVal) {
              var _this = this;
                if (!newVal) return;
                axios.post('/index.php?g=common&m=index&a=get_area', {
                        parent_no: newVal,
                        is_id:'Y'
                }).then(function (res) {
                  if (res.data.code == 2000) {
                    _this.province = res.data.data;

                    if(res.data.data == null){
                        _this.selectProvince = '';
                        _this.county = [];
                        _this.selectCounty = '';
                    }else{
                        var provinceAll = res.data.data
                        var status = '1'
                        for(var i=0;i<provinceAll.length;i++){
                            if(provinceAll[i].id == _this.selectProvince){
                                status = '2'
                            }
                        }
                        if(status == '1'){
                            _this.selectProvince = '';
                            _this.county = [];
                            _this.selectCounty = '';
                        }
                    }

                  } else {
                    _this.$message({
                      message: data.msg,
                      type: 'error'
                    });
                  }
                })



            },
            selectProvince:function(newVal){
              var _this = this;
                if (!newVal || !_this.selectCountry) return;
                var parentId = _this.selectCountry + ',' + newVal;

                axios.post('/index.php?g=common&m=index&a=get_area', {
                        parent_no: newVal,
                        is_id:'Y'
                }).then(function (res) {
                  if (res.data.code == 2000) {
                    _this.county = res.data.data;

                    if(res.data.data == null){
                        _this.selectCounty = '';
                    }else{
                        var countyAll = res.data.data
                        var status = '1'
                        for(var i=0;i<countyAll.length;i++){
                            if(countyAll[i].id == _this.selectCounty){
                                status = '2'
                            }
                        }
                        if(status == '1'){
                            _this.selectCounty = '';
                        }
                    }
                  } else {
                    _this.$message({
                      message: data.msg,
                      type: 'error'
                    });
                  }
                })

            }
        }
    })
  function checkNum(money) {
    return /^(\d{1,3}(,\d{3})*|\d+)(\.\d{1,2})?$/.test(money);
  }

  function numberFormat(num) {
    if (isNaN(num)) {
      return num.replace(/(\d{1,3})(?=(\d{3})+(?:$|\D))/g, '$1,');
    } else {
      return num.toString().replace(/(\d{1,3})(?=(\d{3})+(?:$|\D))/g, '$1,');
    }
  }

  function toNumber(str) {
        str = '2000,111,123.00';
       console.log(str.replace(',', ''));
    return str.replace(',', '')
  }

  function difference(type) {
    var amount_payable = $('.payable_amount_confirm_before_span').html();
    amount_payable = parseFloat(amount_payable.replace(/,/g, ''));
    var afterDeduction = (amount_payable - $('.use_deduction').val()).toFixed(2);
    // 修改使用抵扣金 优先修改： 确认后-本期应付金额 = 确认前-本期应付金额 - 本次使用抵扣金金额
    if (type === 'use-deduction') {
      // console.log('afterDeduction',afterDeduction);
      // console.log('afterDeductionN',numberFormat(afterDeduction));
      // console.log('amount_payable',amount_payable);
      // console.log('deduction',$('.use_deduction').val());
      $('.amount_confirm').val(afterDeduction);
      $('.amount_confirm_show').val(numberFormat(afterDeduction));
    }
    var amount_confirm = parseFloat($('.amount_confirm').val());
    var difference = (amount_payable - amount_confirm).toFixed(2);
    var differenceDeduction = (difference - $('.use_deduction').val()).toFixed(2);
    //  抵扣后-剩余应付
    $('.deducation-after-show').text(numberFormat(afterDeduction));
    // 应付差额
    $('.payable_amount_difference').find('input').val(Math.abs(differenceDeduction));
    $('.payable_amount_difference').find('span:eq(1)').html(numberFormat(Math.abs(differenceDeduction)));
    // 下一次金额
    $('.next_payment_info').find('span:eq(1)').html(numberFormat(differenceDeduction));


    if (differenceDeduction > 0) {
      $('.need_pay_remainder').prop('checked', true).change();
      $('.remainder').show();
      $('.difference_reason:eq(0)').prop('disabled', true).hide();
      $('.difference_reason:eq(1)').prop('disabled', false).show();
    } else if (differenceDeduction < 0) {
      $('.need_pay_remainder,.unneed_pay_remainder').prop('checked', false).change();
      $('.remainder').hide();
      // $('.difference_reason:eq(0)').prop('disabled', false).show();
      // $('.difference_reason:eq(1)').prop('disabled', true).hide();
      $('.difference_reason:eq(0)').prop('disabled', true).hide();
      $('.difference_reason:eq(1)').prop('disabled', false).show();
    } else {
      $('.need_pay_remainder,.unneed_pay_remainder').prop('checked', false).change();
      $('.remainder').hide();
      $('.difference_reason:eq(0)').prop('disabled', true).hide();
      $('.difference_reason:eq(1)').prop('disabled', true).hide();
    }
  }

  $(function () {
      //本次抵扣金总额（同账户（我方公司、供应商、币种））
      var deduction_amount = $('.amount_deduction_unformat').val();
      //本期应付金额
      var amount_payable = $('.payable_amount_confirm_before_span').html();
      amount_payable = parseFloat(amount_payable.replace(/,/g, '')).toFixed(2)
      var use_deduction = parseFloat(deduction_amount) > parseFloat(amount_payable) ? amount_payable : deduction_amount;
      $('.use-deduction').val(use_deduction);
      var afterDeduction = (amount_payable - use_deduction).toFixed(2);
      $('.use-deduction-show').val(parseFloat(use_deduction).toFixed(2));
      $('.use_deduction_account').val(parseFloat(use_deduction).toFixed(2));
      $('.use_deduction').val(parseFloat(use_deduction).toFixed(2));
      $('.amount_confirm').val(afterDeduction);
      $('.amount_confirm_show').val(afterDeduction);
    if(deduction_amount <= 0){
        $('.use-deduction-show').val('0.00');
        $('.use_deduction_account').val('0.00');
        $('.use_deduction').val('0.00');
        $('.use-deduction').val(0);
        difference('use-deduction');
        // $('.deduction-tr').hide();

        $('.deductionRadio').attr('disabled',true);
        $('#yes').removeAttr("checked");
        $('#no').prop("checked",true)
        $('.text-show').show();
    }
    $('.use-deduction-show').change(function () {
      var money = $(this).val();
      if (!checkNum(money)) {
        alert('<{$Think.lang.使用抵扣金金额必须大于0}>');
        money = '0';
      };
      var deduction_amount = $('.amount_deduction_unformat').val();
      if(parseFloat(money) > parseFloat(deduction_amount)){
        alert('<{$Think.lang.超过可使用抵扣金}>');
        money = '0';
      }
      money = parseFloat(money.replace(/,/g, '')).toFixed(2);
      $(this).next().val(money);
      $('.use_deduction').val((Number($('.use_deduction_compensation').val()) + Number(money)).toFixed(2))

      $(this).val(numberFormat(money));
      difference('use-deduction');
    });
    $('.use-compensation-rebate').click(function(){
      VM.$data.compensationRebateDialog = true;
      if(VM.$data.compensationRebateData.length == 0){
        var data ={
        "search":{ 
              "supplier_id":'<{$order.supplier_new_id}>',
              "our_company_cd":'<{$order.our_company}>',
              "deduction_currency_cd":'<{$order.amount_currency}>',
          },
          "pages": {       
              "per_page": '',
              "current_page":''
          },
          "others":{
              "return_all":"Y",
              "need_greater_zero":"Y"
          }
      }
      
      $.ajax({
            type:"POST",
            async:false,
            url:"/index.php?g=purchase&m=deduction&a=deductionList",
            contentType: "application/json",
            data:JSON.stringify(data),
            dataType: "json",
            success:function(res){
                if(res.code == 200){
                  // let compensationRebateDataArr = res.data.data
                  // for (const item in compensationRebateDataArr) {
                  //   compensationRebateDataArr[item].choose = ''
                  // }
                  VM.$data.compensationRebateData = res.data.data
                  VM.$data.compensationRebateData2 = res.data.data
                }

            }
        });
      }





    })
    $('.amount_confirm_show').on('input',function (e) {
        if(e.target.value.indexOf(".")>-1 && !Number(e.target.value)){
            e.target.value   =   e.target.value.substr(0,e.target.value.indexOf(".")+3);
        }
    })
    $('.amount_confirm_show').change(function () {
      var money = $(this).val();
      if (!checkNum(money)) {
        //alert('<{$Think.lang.应付金额不能为负数}>');
        money = '0';
      }
      money = parseFloat(money.replace(/,/g, '')).toFixed(2);
      $(this).next().val(money);
      $(this).val(numberFormat(money));
      difference('amount_confirm');
    });

    $('.pay_remainder').change(function () {
      if ($('.pay_remainder:checked').val() == 1) {
        $('.next_payment').show().find(':input').val('');
        $('.difference').hide().find(':input').val('');
      } else {
        $('.next_payment').hide().find(':input').val('');
        $('.difference').show().find(':input').val('');
      }
    });
    // 提交
    $(".payable_detail .col-lg-12-btn .btn-sure").click(function () {
      var compensationRebateDataArr = VM.$data.compensationRebateData
      var compensationRebateDataArr2 = []
      if($('.use_deduction_compensation').val() != 0){
        for (const item in compensationRebateDataArr) {
          if(compensationRebateDataArr[item].choose){
            var obj = {}
            obj.compensation_order_no = compensationRebateDataArr[item].order_no
            obj.compensation_amount = compensationRebateDataArr[item].choose
            compensationRebateDataArr2.push(obj)
          }
        }
      }
      $('.amount_deduction_compensation_detail').val(JSON.stringify(compensationRebateDataArr2))

      if(VM.$data.pickPayment.length > 0){
        VM.$data.confirmDialog = true;
      }else{
        var url = "<{:U('')}>";
        var amount_confirm = $(".payable_amount_confirm div input").val();
        if (!checkNum(amount_confirm)) {
          alert('<{$Think.lang.应付金额不能为负数}>');
          return false;
        }
        $('.certificate-upload').val(getFileList());
        if(!getFileList() && $('.use-deduction').val()){
          layer.msg("<span class='invoice_detail_bomb_tip'><i style='color:red;'>X</i>" + '<{$Think.lang.沟通凭证必填}>' + "</span>");
          return false;
        }    

        var bank_address = ''
        var bank_address_id = ''
        if($("#county_input").val()){
            bank_address = $("#country_input").val() + '-' +  $("#province_input").val() + '-' +  $("#county_input").val()
            bank_address_id = VM.selectCountry + ',' + VM.selectProvince + ',' + VM.selectCounty
        }else if($("#province_input").val() && !$("#county_input").val()){
            bank_address = $("#country_input").val() + '-' +  $("#province_input").val()
            bank_address_id = VM.selectCountry + ',' + VM.selectProvince
        }else if($("#country_input").val() && !$("#province_input").val()){
            bank_address = $("#country_input").val()
            bank_address_id = VM.selectCountry
        }else if(!$("#country_input").val()){
            bank_address = ''
            bank_address_id = ''
        }
        $("#city_input").val(bank_address)
        $("#cityID_input").val(bank_address_id)

        var data = $('form').serialize();
          utils.lazy_loading('show');

          $.post(url, data, function (msg) {
          utils.lazy_loading();
          if (msg.status == 1) {
            layer.msg("<span class='invoice_detail_bomb_tip'><i>√</i>" + msg.info + "</span>");
            setTimeout(function () {
              location = "<{:U('payable_detail',['id'=>$info['id']])}>";
            }, 1000)
          } else {
            layer.msg("<span class='invoice_detail_bomb_tip'><i style='color:red;'>X</i>" + msg.info + "</span>");
          }
        })
      }
    });

    $('#yes').click(function () {
      $('.deduction-tr').show();
    });
    $('#no').click(function () {
      $('.use-deduction-show').val('0.00');
      $('.use-deduction').val(0);
      difference('use-deduction');
      $('.deduction-tr').hide();
    });

    $('.btn-upload').click(function () {
      $('#certificate').click();
      return false;
    });
    $('#certificate').change(function () {
      var $input = $('#certificate');
      // 相当于： $input[0].files, $input.get(0).files
      var files = $input.prop('files');
      console.log(files);
      var data = new FormData();
      data.append('file', files[0]);
      $.ajax({
        url: '/index.php?m=order_detail&a=file_upload',
        type: 'POST',
        data: data,
        cache: false,
        processData: false,
        contentType: false,
        success: function (res) {
          if (res.status == 1) {
            var obj = {
              savename: res.info.savename,
              name: res.info.name
            };
            $('.file-lists').append("<li><span style='display: none;'>" + JSON.stringify(obj) + "</span><a target='_blank' href='/index.php?m=order_detail&a=download&file='" + res.info.savename + ">" + res.info.name + "</a><a class='fileDel' onclick='delFile($(this))'>×</a></li>");
          }
        }
      });
    })


  });

  // 获取fileList 数据
  function getFileList() {
    var arr = [];
    $('.file-lists li').each(function () {
      var item = $(this).find('span').text();
      arr.push(JSON.parse(item));
    });
    return JSON.stringify(arr);
  }

  function delFile(obj) {
    obj.parent().remove();
  }

  // 千分位分割
  function fmoney(s, n) {
    n = n > 0 && n <= 20 ? n : 2;
    s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";
    var l = s.split(".")[0].split("").reverse(),
      r = s.split(".")[1];
    t = "";
    for (i = 0; i < l.length; i++) {
      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");
    }
    return t.split("").reverse().join("") + "." + r;
  }
</script>
</html>
