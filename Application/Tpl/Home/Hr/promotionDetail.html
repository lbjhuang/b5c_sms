<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>晋升单详情</title>
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/normailize.css?v=<{$Think.config.VER_NUM}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>">
    <style>
        [v-cloak] {
            display: none;
        }

        body {
            background: #f4f4f4;
            padding-bottom: 30px;
        }

        .promotion-detail {
            padding-right: 20px;
            min-width: 1500px;
        }

        .promotion-detail .el-tabs {
            background: #ffffff;
            padding-right: 20px;
            border-radius: 0px 0px 8px 8px;
        }

        .promotion-detail .el-tabs .el-tabs__content {
            border-radius: 0px 0px 8px 8px;
            padding-left: 30px;
        }

        .promotion-detail .el-tabs__header {
            padding-left: 30px;
            padding-top: 12px;
        }

        .info-box {
            background: #fff;
        }

        .info-box .info-title {
            padding: 24px 0 12px;
            text-align: left;
            font-size: 16px;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.85);
        }

        .info-box .info-content {
            display: flex;
            padding-bottom: 24px;
            border-bottom: 1px dashed rgba(229, 229, 229, 1);
        }

        .info-box:nth-last-child(1) .info-content {
            border: none;
        }

        .info-box .info-content .avatar {
            width: 150px;
            height: 200px;
            background: #f4f4f4;
        }

        .info-box .info-content .avatar img {
            width: 100%;
            height: 100%;
        }

        .info-box .info-content .info-table {
            width: 970px;
            text-align: left;
            margin-left: 40px;
        }

        .info-box .info-content .info-table .el-col {
            padding: 3px 0px 22px;
            font-weight: 600;
            font-size: 14px;
        }

        .info-box .info-content .info-table .el-col .flex-box {
            display: flex;
        }

        .info-box .info-content .info-table .cell-label {
            color: rgba(0, 0, 0, 0.45);
            padding-right: 10px;
            text-align: justify;
            width: 60px;
            display: inline-block;
            word-break: break-all;
        }

        .info-box .info-content .info-table .cell-label::after {
            content: '';
            display: inline-block;
            padding-left: 100%;
        }

        .info-box .info-content .rating-box {
            padding-top: 5px;
            margin-left: 100px;
        }

        .info-box .info-content .rating-box .rating-bg {
            width: 136px;
            height: 80px;
            text-align: center;
            background-color: rgba(3, 117, 222, 0.05);
            padding-top: 16px;
        }

        .info-box .info-content .rating-box .rating-bg-triangle {
            height: 0;
            width: 0;
            border-right: 68px solid transparent;
            border-left: 68px solid transparent;
            border-top: 24px solid rgba(3, 117, 222, 0.05);
        }

        .info-box .info-content .rating-box .rating-bg .rating-title {
            color: rgba(0, 0, 0, 0.85);
            font-size: 16px;
            font-weight: 600;
        }

        .info-box .info-content .rating-box .rating-bg .rating {
            color: rgba(3, 117, 222, 1);
            font-size: 40px;
            font-weight: 600;
            margin-top: 12px;
            word-wrap: break-word;
        }

        .info-box .info-content .text-content {
            padding-top: 4px;
            width: 100%;
            color: rgba(0, 0, 0, 0.65);
            line-height: 22px;
        }

        .info-box .info-content .info-content-left {
            width: 50%;
            margin-right: 40px;
        }

        .info-box .info-content .sub-txt {
            color: rgba(0, 0, 0, 0.65);
        }

        .info-box .info-content .info-content-left .text-content {
            width: auto;
        }

        .info-box .info-content .info-content-right {
            width: 50%;
        }

        .info-box .info-content .info-content-right .promotion-record {
            width: 500px;
        }

        .info-box .info-content .content-table {
            border-radius: 4px;
            border: 1px solid #E5E5E5;
        }

        .info-box .info-content .content-table .table-row {
            display: flex;
        }
        .info-box .info-content .content-table .table-row:nth-child(3){
            border-top: 1px solid #E5E5E5;
        }
        .info-box .info-content .content-table .table-row.table-title .content-table-box {
            border-bottom: 1px solid #E5E5E5;
            background: #F4F4F4;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.65);
        }

        .info-box .info-content .content-table .table-row .content-table-box {
            /* width: 160px; */
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: rgba(0, 0, 0, 0.85);
            border-right: 1px solid #E5E5E5;
        }

        .info-box .info-content .content-table .table-row .content-table-box:nth-last-child(1) {
            border-right: none;
        }


        .btn-box {
            text-align: center;
            padding: 24px 0;
        }

        .log-box {
            padding: 20px 30px 40px;
            min-height: 650px;
        }

        .log-table th {
            background: #f5f7fa;
        }

        .log-table .el-table_1_column_1 {
            background: #f5f7fa !important;
        }

        .log-table.el-table--enable-row-hover .el-table__body tr:hover td {
            background-color: #fff;
        }
    </style>
</head>

<body>
    <div class="promotion-detail" id="promotionDetail" v-cloak v-loading="detailLoading">
        <el-tabs v-model="activeName">
            <el-tab-pane :label="$lang('晋升加薪详情')" name="first">

                <div class="info-box">
                    <div class="info-title">{{$lang('员工基础信息')}}</div>
                    <div class="info-content">
                        <div class="avatar">
                            <img v-if="card.PIC" :src="'index.php?m=Api&a=show&filename=' + card.PIC" width="200"
                                alt="">
                            <div v-else class="no-img" style="height:100%;background: #f4f4f4;text-align: center;line-height: 200px;">{{$lang('暂无照片')}}</div>
                        </div>
                        <div class="info-table">
                            <el-row :gutter="40">
                                <el-col :span="8">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('工号')}}</span>
                                        <span class="cell-value">{{card.WORK_NUM}}</span>
                                    </div>
                                </el-col>
                                <el-col :span="8">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('英文名')}}</span>
                                        <span class="cell-value">{{card.EMP_SC_NM}}</span>
                                    </div>
                                </el-col>
                                <el-col :span="8">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('工作地址')}}</span>
                                        <span class="cell-value">{{$lang(card.WORK_PALCE)}}</span>
                                    </div>
                                </el-col>
                            </el-row>
                            <el-row :gutter="40">
                                <el-col :span="8">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('入职时间')}}</span>
                                        <span class="cell-value">{{card.PER_JOB_DATE}}</span>
                                    </div>
                                </el-col>
                                <el-col :span="8">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('司龄')}}</span>
                                        <span class="cell-value">{{card.COMPANY_AGE == 0 ? $lang('未满一个月') :
                                            card.COMPANY_AGE + $lang('月')}}</span>
                                    </div>
                                </el-col>
                            </el-row>
                            <el-row :gutter="40">
                                <el-col :span="8">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('职位')}}</span>
                                        <span class="cell-value">{{$lang(card.JOB_CD)}}</span>
                                    </div>
                                </el-col>
                                <el-col :span="12">
                                    <div class="flex-box">
                                        <span class="cell-label">{{$lang('部门')}}</span>
                                        <span class="cell-value">{{promotion.DEPT_NM}}</span>
                                    </div>
                                </el-col>
                            </el-row>
                        </div>
                        <div class="rating-box">
                            <div class="rating-bg">
                                <p class="rating-title">{{$lang('努力程度评级')}}</p>
                                <p class="rating">{{promotion.rating}}</p>
                            </div>
                            <div class="rating-bg-triangle"></div>
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <div class="info-title">{{$lang('主要工作内容')}}</div>
                    <div class="info-content">
                        <div class="text-content" v-html="promotion.work_content"></div>
                    </div>
                </div>

                <div class="info-box" v-if="earning.list">
                    <div class="info-title">{{$lang('个人前6个月数据')}}
                        <!-- <span v-if="earning.leader">--{{earning.leader}}</span> -->
                    </div>
                    <div class="info-content" style="border: none;">
                        <div class="content-table" style="width: 80%;">
                            <div class="table-row table-title">
                                <div class="content-table-box"></div>
                                <div class="content-table-box" v-for="(item,key) in earning.list" :key="key">
                                    {{$lang(item.title)}}
                                </div>
                            </div>
                            <div class="table-row">
                                <div class="content-table-box">{{$lang('销售额')}}（USD）</div>
                                <div class="content-table-box" v-for="(item,key) in earning.list" :key="key">
                                    {{item.amount}}
                                </div>
                            </div>
                            <div class="table-row">
                                <div class="content-table-box">{{$lang('盈亏')}}（USD）</div>
                                <div class="content-table-box" v-for="(item,key) in earning.list" :key="key">
                                    {{item.earning}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="info-content">
                        <div class="content-table" style="width: 50%;">
                            <div class="table-row table-title">
                                <div class="content-table-box"></div>
                                <div class="content-table-box">{{promotion.promotion_month == 1 ? 'Q3' : ' Q1' }} GP</div>
                                <div class="content-table-box">{{promotion.promotion_month == 1 ? 'Q3' : ' Q1' }} ODM</div>
                                <div class="content-table-box">{{promotion.promotion_month == 1 ? 'Q4' : ' Q2' }} GP</div>
                                <div class="content-table-box">{{promotion.promotion_month == 1 ? 'Q4' : ' Q2' }} ODM</div>
                            </div>
                            <div class="table-row">
                                <div class="content-table-box">{{$lang('销售额')}}（USD）</div>
                                <div class="content-table-box">{{promotion.gp_earning1_amount}}</div>
                                <div class="content-table-box">{{promotion.odm_earning1_amount}}</div>
                                <div class="content-table-box">{{promotion.gp_earning2_amount}}</div>
                                <div class="content-table-box">{{promotion.odm_earning2_amount}}</div>
                            </div>
                            <div class="table-row">
                                <div class="content-table-box">{{$lang('销售额占比')}}</div>
                                <div class="content-table-box">{{promotion.gp_earning1}}%</div>
                                <div class="content-table-box">{{promotion.odm_earning1}}%</div>
                                <div class="content-table-box">{{promotion.gp_earning2}}%</div>
                                <div class="content-table-box">{{promotion.odm_earning2}}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-box" v-if="score.list">
                    <div class="info-title">{{$lang('前6个月业务团队评分')}}<span v-if="score.dept"> --【{{score.dept}}】</span>
                    </div>
                    <div class="info-content">
                        <div class="content-table" style="width: 35%;">
                            <div class="table-row table-title">
                                <div class="content-table-box" v-for="(item,key) in score.list" :key="key">
                                    {{$lang(item.title)}}</div>
                            </div>
                            <div class="table-row">
                                <div class="content-table-box" v-for="(item,key) in score.list" :key="key">
                                    {{item.value}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-box" v-if="promotion.promotion_raise_type_cd === 'N003750002'">
                    <div class="info-content">
                        <div class="info-content-left">
                            <div class="info-title">{{$lang('上次加薪记录')}}</div>
                            <div class="basis-info-content">
                                <p class="sub-txt" v-if="promotion.is_first_promote == 1">{{$lang('之前未加薪过')}}</p>
                                <div class="content-table" v-else>
                                    <div class="table-row table-title">
                                        <div class="content-table-box">{{$lang('加薪时间')}}</div>
                                        <div class="content-table-box">{{$lang('加薪前工资')}}</div>
                                        <div class="content-table-box">{{$lang('加薪薪资')}}</div>
                                        <div class="content-table-box">{{$lang('加薪后薪资')}}</div>
                                    </div>
                                    <div class="table-row">
                                        <div class="content-table-box">{{promotion.last_promotion_time}}</div>
                                        <div class="content-table-box">{{promotion.currency_cd_val}} {{promotion.last_salary_amount | format}}</div>
                                        <div class="content-table-box">{{promotion.currency_cd_val}} {{(Number(promotion.now_salary_amount) - Number(promotion.last_salary_amount)) | format}}</div>
                                        <div class="content-table-box">{{promotion.currency_cd_val}} {{promotion.now_salary_amount | format}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="info-content-right">
                            <div class="info-title">{{$lang('本次加薪审批')}}</div>
                            <div class="basis-info-content promotion-record">
                                <div class="content-table">
                                    <div class="table-row table-title">
                                        <div class="content-table-box">{{$lang('加薪前工资')}}</div>
                                        <div class="content-table-box">{{$lang('加薪工资')}}</div>
                                        <div class="content-table-box">{{$lang('加薪后工资')}}</div>
                                    </div>
                                    <div class="table-row">
                                        <div class="content-table-box">{{promotion.currency_cd_val}} {{promotion.now_salary_amount | format}}</div>
                                        <div class="content-table-box">{{promotion.currency_cd_val}} {{(Number(promotion.raise_salary_amount) - Number(promotion.now_salary_amount)) | format}}</div>
                                        <div class="content-table-box">{{promotion.currency_cd_val}} {{promotion.raise_salary_amount | format}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box" v-else>
                    <div class="info-content">
                        <div class="info-content-left">
                            <div class="info-title">{{$lang('上次晋升记录')}}</div>
                            <div class="basis-info-content">
                                <p class="sub-txt" v-if="promotion.is_first_promote == 1">{{$lang('之前未晋升过')}}</p>
                                <div class="content-table" v-else>
                                    <div class="table-row table-title">
                                        <div class="content-table-box">{{$lang('晋升时间')}}</div>
                                        <div class="content-table-box">{{$lang('晋升前岗位')}}</div>
                                        <div class="content-table-box">{{$lang('晋升后岗位')}}</div>
                                    </div>
                                    <div class="table-row">
                                        <div class="content-table-box">{{promotion.last_promotion_time}}</div>
                                        <div class="content-table-box">
                                            {{$lang(promotion.last_promotion_before_job_name)}}</div>
                                        <div class="content-table-box">{{$lang(promotion.current_job_name)}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="info-content-right">
                            <div class="info-title">{{$lang('本次晋升审批')}}</div>
                            <div class="basis-info-content promotion-record">
                                <div class="content-table">
                                    <div class="table-row table-title">
                                        <div class="content-table-box">{{$lang('晋升前岗位')}}</div>
                                        <div class="content-table-box">{{$lang('晋升后岗位')}}</div>
                                    </div>
                                    <div class="table-row">
                                        <div class="content-table-box">{{$lang(promotion.current_job_name)}}</div>
                                        <div class="content-table-box">{{$lang(promotion.promotion_job_name)}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <div class="info-content">

                        <div class="info-content-left">
                            <div class="info-title">{{$lang('奖惩记录')}}</div>
                            <div class="text-content" v-html="promotion.reward_punishment_record"></div>
                        </div>
                        <div class="info-content-right">
                            <div class="info-title">{{$lang('直属领导意见')}}</div>
                            <div class="text-content" v-html="promotion.direct_leadership_opinion"></div>
                        </div>
                    </div>
                </div>

                <div class="info-box btn-box" v-if="button.is_show == 1">
                    <el-button type="primary" size="small" style="background: #0375DE;" @click="submit(1)">
                        {{$lang('同意')}}</el-button>
                    <el-button type="detault" size="small" @click="submit(2)">{{$lang('不同意')}}</el-button>

                </div>
            </el-tab-pane>
            <el-tab-pane :label="$lang('审批情况')" name="second">
                <div class="log-box">
                    <el-table :data="logData" ref="refTable" border :span-method="spanMethod" class="log-table">
                        <el-table-column label="" width="240" align="center">
                            <template slot-scope="scope">
                                <span v-if="scope.row.type == 1">{{$lang('发起')}}</span>
                                <span v-if="scope.row.type == 2">{{$lang('部门领导审批')}}</span>
                                <span v-if="scope.row.type == 3">{{$lang('业务部门总监审批')}}</span>
                                <span v-if="scope.row.type == 4">{{$lang('CEO审批')}}</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="created_by" align="center" :label="$lang('操作人')">
                        </el-table-column>
                        <el-table-column prop="created_at" align="center" :label="$lang('操作时间')">
                        </el-table-column>
                        <el-table-column prop="result" align="center" :label="$lang('审批情况')">
                            <template slot-scope="scope">
                                {{$lang(scope.row.result)}}
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </el-tab-pane>
        </el-tabs>
    </div>
</body>

</html>
<script type="text/javascript"
    src="/Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue-2.6.10.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="/Application/Tpl/Home/Public/js/axios.min.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="\Application\Tpl\Home\Public\js\H-ui.admin.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.2.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
<script>
    let VM = new Vue({
        el: '#promotionDetail',
        data() {
            return {
                activeName: 'first',
                id: '',
                detailLoading: true,
                promotion: {},
                card: {},
                button: {},
                earning: {},
                score: {},
                logData: [],
                merge: [],  //存放需要合并的行
                pos: ''   //需要合并行下标
            }
        },
        filters: {
            // 数字加上千分位
            format :function format(num) {
                if(num == '-') {
                    return '-'
                } else {
                    num = Number(num).toFixed(2)
                    var num1= num.split('.')[0]+'';//数字转字符串  
                    var str="";//字符串累加  
                    for(var i=num1.length- 1,j=1;i>=0;i--,j++){  
                        if(j%3==0 && i!=0 && num1[i-1] != '-'){//每隔三位加逗号，过滤正好在第一个数字的情况 过滤负数情况 
                            str+=num1[i]+",";//加千分位逗号  
                            continue;  
                        }  
                        str+=num1[i];//倒着累加数字
                    }
                    return `${str.split('').reverse().join("")}${num.split('.')[1] == '00' ? '' : '.' + num.split('.')[1]}`;
                }
            },
        },
        created() {
            let query = window.location.href.split('?')[1].split('&')[2];
            this.id = query.split('=')[1];
            console.log(this.id)
            this.getDetailData();
            this.getLogData();
        },
        methods: {
            getDetailData() {
                axios.get('index.php?m=hrApi&a=promotionDetail&id=' + this.id).then(res => {
                    console.log(res);
                    if (res.status && res.data.code == 200) {
                        this.detailLoading = false;
                        this.promotion = res.data.data.promotion;
                        this.promotion.work_content = decodeURI(this.promotion.work_content)
                        this.promotion.reward_punishment_record = decodeURI(this.promotion.reward_punishment_record)
                        this.promotion.direct_leadership_opinion = decodeURI(this.promotion.direct_leadership_opinion)
                        this.card = res.data.data.card;
                        this.button = res.data.data.button;
                        this.earning = res.data.data.earning;
                        this.score = res.data.data.score;
                    } else {
                        this.$message.error(this.$lang(res.data.msg))
                    }
                })
            },
            submit(type) {
                let param = {
                    approver_type: type,
                    id: this.id
                };
                this.detailLoading = true;
                axios.post('/index.php?m=hrApi&a=approver', param).then(res => {
                    console.log(res)
                    if (res.status && res.data.code == 200) {
                        this.$message.success(this.$lang('审批成功'))
                        window.location.reload()
                    } else {
                        this.$message.error(this.$lang(res.data.msg))
                        this.detailLoading = false;
                    }
                })
            },
            getLogData() {
                axios.get('/index.php?m=hrApi&a=approverlogList&id=' + this.id).then(res => {
                    if (res.status && res.data.code == 200) {
                        this.logData = res.data.data;
                        this.getSpanArr(this.logData)
                    } else {
                        this.$message.error(this.$lang(res.data.msg))
                    }
                })
            },
            getSpanArr(data) {
                for (var i = 0; i < data.length; i++) {
                    if (i === 0) {
                        this.merge.push(1);
                        this.pos = 0
                    } else {
                        // 判断当前元素与上一个元素是否相同
                        //根据相同type进行合并,根据需要可进行修改
                        if (data[i].type === data[i - 1].type) {
                            this.merge[this.pos] += 1;
                            this.merge.push(0);
                        } else {
                            this.merge.push(1);
                            this.pos = i;
                        }
                    }
                }
            },
            spanMethod({ row, column, rowIndex, columnIndex }) {
                if (columnIndex === 0) {
                    const _row = this.merge[rowIndex];
                    console.log(_row)
                    const _col = _row > 0 ? 1 : 0;
                    console.log(_col)
                    return {
                        rowspan: _row,
                        colspan: _col
                    }
                }
            }
        },
    })
</script>