<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>付款单列表</title>
    <link rel="stylesheet"
        href="./Application/Tpl/Home/Public/utils/css/public.style.css?v=<{$Think.config.VER_NUM}>" />
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.13.0.css" />
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.config.VER_NUM}>" />
</head>

<style>
    [v-cloak] {
        display: none;
    }

    .wrap {
        box-sizing: border-box;
        padding: 20px;
        margin: 0;
    }

    .el-button--mini {
        width: 12%;
        height: 30px;
    }

    .el-button-group {
        display: inline-block;
        vertical-align: middle;
        width: 100%;
        margin-bottom: 30px;
    }

    .active-btn {
        color: #fff;
        background-color: #409eff;
        border-color: #409eff;
    }

    .el-pagination {
        margin-bottom: 180px;
    }

    .export-wrap {
        white-space: nowrap;
        align-items: center;
        margin-bottom: 20px;
    }

    .export-wrap .occupy {
        display: inline-block;
        width: 49.5%;
    }

    .table-list {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        background: #ffffff;
        border: 1px solid #cadee7;
    }

    .table-list tr th {
        background: #546e7a;
        height: 40px;
        text-align: center;
        font-size: 0.7rem;
        color: #ffffff;
        letter-spacing: 0;
        border: 1px solid #668491;
        white-space: nowrap;
    }

    .table-list tr td {
        font-size: 0.68rem;
        color: #263238;
        letter-spacing: 0;
        text-align: center;
        padding: 0.5rem;
        border: 1px solid #cadee7;
        font-family: "Microsoft YaHei";
    }

    .table-list tr td p {
        font-size: 0.68rem;
        text-align: center;
        padding: 0;
        margin: 0;
        font-family: "Microsoft YaHei";
    }

    .table-list tr:nth-of-type(even) {
        background: #f7f9fb;
        border: 1px solid #cadee7;
    }

    .el-col {
        padding: 0 10px;
    }

    .el-select {
        width: 100%;
    }

    .el-date-editor .el-range-input {
        width: 36%;
    }

    .dialogWriteForm {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .dialogWriteLabel {
        width: 120px;
    }

    .is_kyriba_select label {
        line-height: 20px;
    }
</style>

<body>
    <div id="turn" v-cloak class="wrap">
        <el-form ref="form" :model="form" :label-position="labelPosition" label-width="120px">
            <el-row>
                <el-col :span="24">
                    <el-button-group>
                        <el-button size="mini">{{$lang('付款单状态:')}}</el-button>
                        <el-button @click="stateCheckAll()" size="mini" :class="{'active-btn':stateCheckAllItems}">
                            {{$lang('全部')}}</el-button>
                        <el-button v-for="(i,v) in states" :key="v" size="mini" @click="stateCheck(i.CD)"
                            :class="{'active-btn':form.search.status == i.CD}">{{$lang(i.CD_VAL)}}</el-button>
                    </el-button-group>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="6">
                    <el-form-item :label="$lang('付款单号')">
                        <el-input v-model="form.search.payment_audit_no"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('我方公司')">
                        <el-select v-model="form.search.our_company_cd" :placeholder="$lang('请选择')" filterable>
                            <el-option v-for="(item) in companyData" :key="item.cd" :label="item.cdVal"
                                :value="item.cd"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('预计付款日期')">
                        <el-date-picker v-model="payable_date_after" style="width: 100%;" type="daterange" align="right"
                            unlink-panels value-format="yyyy-MM-dd" :range-separator="$lang('至')"
                            :start-placeholder="$lang('开始日期')" :end-placeholder="$lang('结束日期')">
                        </el-date-picker>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('创建人')">
                        <el-input v-model="form.search.created_by"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="6">
                    <el-form-item :label="$lang('创建日期')">
                        <el-date-picker v-model="created_at" style="width: 100%;" type="daterange" align="right"
                            unlink-panels value-format="yyyy-MM-dd" :range-separator="$lang('至')"
                            :start-placeholder="$lang('开始日期')" :end-placeholder="$lang('结束日期')">
                        </el-date-picker>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('付款负责人')">
                        <el-input v-model="form.search.payment_manager_by"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label-width="120px" :label="$lang('审核负责人')">
                        <el-input v-model="form.search.accounting_audit_user"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="Payment Key">
                        <el-input v-model="form.search.payment_no"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="6">
                    <el-form-item :label="$lang('支付渠道')">
                        <el-select v-model="form.search.payment_channel_cd" :placeholder="$lang('请选择')" collapse-tags
                            multiple filterable>
                            <el-option v-for="(item) in payment_channel2" :key="item.CD" :label="$lang(item.CD_VAL)"
                                :value="item.CD"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('支付方式')">
                        <el-select v-model="form.search.payment_way_cd" :placeholder="$lang('请选择')" collapse-tags
                            multiple filterable>
                            <el-option v-for="(item) in payment_way2" :key="item.CD" :label="$lang(item.CD_VAL)"
                                :value="item.CD"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('来源')">
                        <el-select v-model="form.search.source_cd" :placeholder="$lang('请选择')" collapse-tags multiple
                            filterable>
                            <el-option v-for="(item) in source" :key="item.CD" :label="$lang(item.CD_VAL)"
                                :value="item.CD"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('付款公司')">
                        <el-select v-model="form.search.pay_com_cd" :placeholder="$lang('请选择')" collapse-tags multiple
                            filterable>
                            <el-option v-for="(item) in ourCompanyList" :key="item.CD" :label="$lang(item.CD_VAL)"
                                :value="item.CD"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>

            </el-row>
            <el-row>
                <el-col :span="6">
                    <el-form-item class="is_kyriba_select" :label="$lang('是否通过kyriba付款')">
                        <el-select v-model="form.search.pay_type" :placeholder="$lang('请选择')" multiple filterable>
                            <el-option v-for="(item) in is_kyriba" :key="item.CD" :label="$lang(item.CD_VAL)"
                                :value="item.CD">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item class="is_kyriba_select" :label="$lang('付款性质')">
                        <el-select v-model="form.search.payment_nature" :placeholder="$lang('请选择')" multiple filterable>
                            <el-option :label="$lang('对公')" value="1">
                            </el-option>
                            <el-option :label="$lang('对私')" value="2">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item class="is_kyriba_select" :label="$lang('供应商')">
                        <el-select v-model="form.search.supplier" :placeholder="$lang('请选择')" multiple filterable>
                            <!-- <div v-infinite-scroll="supplierDataGet"> -->
                            <el-option v-for="(item) in supplierList" :key="item.ID" :label="$lang(item.SP_NAME)"
                                :value="item.ID">
                            </el-option>
                            <!-- </div> -->

                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item class="is_kyriba_select" :label="$lang('是否有合同')">
                        <el-select v-model="form.search.contract_information" :placeholder="$lang('请选择')" multiple
                            filterable>
                            <el-option :label="$lang('有合同')" value="1">
                            </el-option>
                            <el-option :label="$lang('无合同')" value="-1">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="6">
                    <el-form-item :label="$lang('银行参考号')">
                        <el-input v-model="form.search.bank_reference_no"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('合同编号')">
                        <el-input v-model="form.search.contract_no"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('付款类型')">
                        <el-select v-model="form.search.payment_type" :placeholder="$lang('请选择')" multiple filterable>
                            <el-option v-for="(item) in paymentTypeData" :key="item.cd" :label="$lang(item.cdVal)"
                                :value="item.cd">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item :label="$lang('审批部门')">
                        <el-cascader v-model="form.search.dept_id" :options="departmentOptions"
                            :props="{ checkStrictly: true }" :show-all-levels="false" clearable filterable
                            :placeholder="$lang('请选择')">
                        </el-cascader>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="24">
                    <el-button type="primary" @click="getData()">{{$lang("查询")}}</el-button>
                    <el-button @click="reset()">{{$lang("重置")}}</el-button>
                </el-col>
            </el-row>
        </el-form>
        <div class="baseline"></div>
        <div class="use-row export-wrap">
            <div class="col-50 result-num occupy">
                {{ $lang("搜索结果") }}：&nbsp;&nbsp;{{ $lang("共") }}
                <b>{{ totalCount }}</b> {{ $lang("条") }}
            </div>
            <div class="col-50" style="text-align: right;">
                <el-button type="primary" :loading="batchPrintLoading" @click="batchPrint">{{$lang('批量打印流程单')}}</el-button>
                <el-button type="primary" @click="exportList">{{$lang("导出")}}</el-button>
                <el-button type="primary" @click="writeOffDialog()">{{$lang("批量核销")}}</el-button>
            </div>
        </div>
        <el-dialog :title="$lang('批量核销')" :visible.sync="dialogWriteOff" @close='closeDialogWriteOff'>
            <template>
                <div class="dialogWriteForm">
                    <div class="dialogWriteLabel">
                        <span style="color: red">*</span> {{$lang('支付渠道')}}:
                    </div>
                    <el-select @change="paymentChannelChange(payment_channel_cd)" filterable
                        v-model="payment_channel_cd" :placeholder="$lang('请选择')">
                        <el-option v-for="item in payment_channel" :key="item.CD" :label="item.CD_VAL" :value="item.CD">
                        </el-option>
                    </el-select>
                </div>
                <div class="dialogWriteForm">
                    <div class="dialogWriteLabel">
                        <span style="color: red">*</span> {{$lang('支付方式')}}:
                    </div>
                    <el-select @change="payment_wayChange(payment_way_cd)" filterable v-model="payment_way_cd"
                        :placeholder="$lang('请选择')">
                        <el-option v-for="item in payment_way" :key="item.CD" :label="item.CD_VAL" :value="item.CD">
                        </el-option>
                    </el-select>
                </div>
                <div v-show="platformNameStatus" class="dialogWriteForm">
                    <div class="dialogWriteLabel">
                        <span style="color: red">*</span> {{$lang('平台名称')}}:
                    </div>
                    <el-select @change="platformNameChange(platformName_cd)" filterable v-model="platformName_cd"
                        :placeholder="$lang('请选择')">
                        <el-option v-for="item in platformName" :key="item.CD" :label="item.CD_VAL" :value="item.CD">
                        </el-option>
                    </el-select>
                </div>
                <div class="dialogWriteForm">
                    <div class="dialogWriteLabel">
                        <span style="color: red">*</span> {{$lang('导入模板')}}:
                    </div>
                    <el-button :disabled="downloadStatus" type="primary" @click="writeOffDownload()">{{$lang('下载')}}
                    </el-button>
                </div>
            </template>
            <div slot="footer" class="dialog-footer">
                <!-- <el-button type="primary" @click="writeOffUpload()">上传核销</el-button> -->
                <el-upload class="upload-demo" action="/index.php?m=finance&a=importBatchCheck"
                    :on-success="handleSuccessDeductible" :on-remove="handleRemoveDeductible" :data="{type:uploadType}"
                    :before-upload="beforeUpload" :file-list="writeOff_attachment">
                    <el-button :disabled="downloadStatus" size="small" type="primary">{{$lang('上传核销')}}</el-button>
                </el-upload>
            </div>
        </el-dialog>
        <div class="use-row">
            <div class="col-100">
                <table class="table-list" id="dataList">
                    <thead>
                        <tr>
                            <th>
                                <el-checkbox @change="handleCheckboxAllSelect" v-model="is_all_selected"></el-checkbox>
                            </th>
                            <th>{{ $lang("付款单号") }}</th>
                            <th>{{ $lang("来源") }}</th>
                            <th>{{ $lang("付款单状态") }}</th>
                            <th>{{ $lang("我方公司") }}</th>
                            <th>{{ $lang("预计付款日期") }}</th>
                            <th>{{ $lang("审核负责人") }}</th>
                            <th>{{ $lang("付款负责人") }}</th>
                            <th>{{ $lang("应付金额") }}</th>
                            <th>{{ $lang("创建人") }}</th>
                            <th>{{ $lang("创建时间") }}</th>
                            <th>{{ $lang("操作") }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in dataList">
                            <td>
                                <el-checkbox @change="handleSelected" v-model="item.selected"></el-checkbox>
                            </td>
                            <td>{{ item.payment_audit_no }}</td>
                            <td>{{ $lang(item.source_cd_val) }}</td>
                            <td>{{ $lang(item.payable_status_val) }}</td>
                            <td>{{ $lang(item.our_company_cd_val) }}</td>
                            <td>{{ item.payable_date_after }}</td>
                            <td v-html="item.accounting_audit_user"></td>
                            <td>{{ item.payment_manager_by }}</td>
                            <td>{{ item.payable_currency_cd_val}} {{ item.payable_amount_after}}</td>
                            <td>{{ item.created_by }}</td>
                            <td>{{ item.created_at}}</td>
                            <td>
                                <el-button type="primary" @click="viewDetail(item)">{{$lang("查看详情")}}</el-button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="use-row">
            <div class="col-100 text-right">
                <el-pagination v-if="dataList" @size-change="handleSizeChange" @current-change="handleCurrentChange"
                    :current-page.sync="form.pages.current_page" :page-sizes="[10, 20, 50, 100,200]"
                    :page-size="form.pages.per_page" layout="sizes, prev, pager, next,jumper" :total="totalCount">
                </el-pagination>
            </div>
        </div>
        <div style="display: none;" id="printIframe"></div>
    </div>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/utils/utils.js"></script>
    <script type="text/javascript"
        src="./Application/Tpl/Home/Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.13.0.js"></script>
    <script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
    <script type="text/javascript"
        src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>"></script>
    <script type="text/javascript"
        src="./Application/Tpl/Home//Public/lib/jquery.table2excel.js?v=<{$Think.config.VER_NUM}>"></script>
    <script>
        if (getCookie("think_language") !== "zh-cn") {
            ELEMENT.locale(ELEMENT.lang.en);
        }
        var turn = new Vue({
            el: "#turn",
            data: {
                user_name: '<{$user_name}>',
                is_all: '<{$is_all}>',
                stateCheckAllItems: true,
                states: [
                    {
                        CD: "0", CD_VAL: "待提交",
                    },
                    {
                        CD: "4", CD_VAL: "待审核",
                    },
                    {
                        CD: "1", CD_VAL: "待确认付款账户",
                    },
                    {
                        CD: "9", CD_VAL: "待kyriba接收"
                    },
                    {
                        CD: "2", CD_VAL: "待出账",
                    },
                    {
                        CD: "3", CD_VAL: "已完成",
                    },
                    {
                        CD: "10", CD_VAL: "kyriba接收失败"
                    },
                    {
                        CD: "7", CD_VAL: "Kyriba审核未通过",
                    },
                    {
                        CD: "8", CD_VAL: "付款失败",
                    },
                    {
                        CD: "5", CD_VAL: "已删除",
                    },
                ],
                is_kyriba: [
                    {
                        CD: "1", CD_VAL: "是",
                    },
                    {
                        CD: "0", CD_VAL: "否",
                    },
                    {
                        CD: "2", CD_VAL: "暂未确定",
                    },
                ],
                companyData: [],
                labelPosition: "left",
                dataList: [],
                totalCount: 0,
                payable_date_after: '',
                created_at: '',
                form: {
                    search: {
                        payment_audit_no: "",
                        our_company_cd: "",
                        payment_manager_by: "",
                        created_by: "",
                        payable_date_after: {
                            start: '',
                            end: ''
                        },
                        created_at: {
                            start: '',
                            end: ''
                        },
                        status: '',
                        accounting_audit_user: '',
                        payment_channel_cd: [],
                        payment_way_cd: [],
                        source_cd: [],
                        payment_no: '',
                        pay_com_cd: [],
                        pay_type: [],
                        bank_reference_no: '',
                        payment_nature: [],
                        supplier: [],
                        contract_information: [],
                        contract_no: '',
                        payment_type: [],
                        dept_id: '',
                    },
                    pages: {
                        current_page: 1,
                        per_page: 10,
                    },
                },
                ourCompanyList: [],
                dialogWriteOff: false,
                payment_channel2: [
                    // {
                    //     CD: 'N001000200',
                    //     CD_VAL: '国内支付宝'
                    // }, {
                    //     CD: 'N001000301',
                    //     CD_VAL: '银行'
                    // }
                ],
                payment_way2: [],
                platformName_cd: '',
                platformName: [],
                platformNameStatus: false,
                downloadStatus: true,
                writeOff_attachment: [],
                uploadType: '',
                payment_channel: [],
                payment_channel_cd: '',
                payment_way_cd: '',
                payment_way: [],
                source: [],
                fullscreenLoading: false,
                is_all_selected: false, // 是否全选
                supplierList: [],
                // supplierPageData: {},
                supplierPage: 0,
                supplierLoading: false,
                paymentTypeData: [],
                departmentOptions: [],
                listdata:[],
                batchPrintLoading:false
            },
            created: function () {
                this.getData_init()
                this.getData();
                this.getCountryCode();
                this.supplierDataGet()
                this.paymentTypeDataGet()
                this.departmentDataGet()
            },
            methods: {
                getData_init: function () {
                    var _this = this;

                    if (_this.is_all != '1') {
                        _this.form.search.created_by = _this.user_name
                    }


                    var params = {
                        "cd_type": {
                            "payment_channel": "false",
                            "payment_way": "true",
                            "payment_source": "true",
                            "our_company": "false",
                            "supplier": "true"
                        }
                    };

                    axios.post("/index.php?g=common&m=index&a=get_cd", params).then(function (res) {
                        console.log(res);

                        if (res.data.code == 2000) {
                            _this.payment_channel2 = res.data.data.payment_channel
                            _this.payment_way2 = res.data.data.payment_way
                            _this.source = res.data.data.payment_source
                            _this.ourCompanyList = res.data.data.our_company
                            if (res.data.data.supplier) {
                                res.data.data.supplier.forEach(item => {
                                    _this.companyData.push({
                                        cd: item.ID,
                                        cdVal: item.SP_NAME
                                    })
                                });
                            }
                        }
                    })

                },
                supplierDataGet(query) {
                    // if (query !== '') {
                    //     this.supplierLoading = true
                    // }
                    const params = {
                        SP_NAME: '',
                        p: 1,
                        size: 10000
                    };

                    axios.get("/index.php?m=supplier&a=supplier_options_list", { params }).then((res) => {
                        if (res.data.code == 2000) {
                            this.supplierList = res.data.data.list
                            // this.supplierPageData = res.data.data.page
                        } else {
                            this.$message.error(this.$lang(res.data.msg))
                        }
                    })

                },
                paymentTypeDataGet() {
                    var data = {
                        data: {
                            query: {
                                payment_type: true,
                            }
                        }
                    }
                    axios.post("/index.php?g=oms&m=CommonData&a=commonData", data)
                        .then((res) => {
                            var result = res.data;
                            if (result.code == 2000) {
                                this.paymentTypeData = result.data.payment_type
                            } else {
                                this.$message.error(this.$lang("付款类型获取失败"));
                            }
                        });
                },
                departmentDataGet() {
                    axios.get("/index.php?m=hr&a=get_dept_options", {}).then((res) => {
                        if (res.data.code == 2000) {
                            this.departmentOptions = res.data.data
                        } else {
                            this.$message.error(this.$lang(res.data.msg))
                        }
                    })

                },
                // 获取币种
                getCountryCode: function () {
                    var _this = this;
                    var data = {
                        data: {
                            query: {
                                company: true,
                            }
                        }
                    }
                    axios.post("/index.php?g=oms&m=CommonData&a=commonData", data)
                        .then(function (res) {
                            var result = res.data;
                            if (result.code == 2000) {
                                _this.companyData = _this.companyData.concat(result.data.company);
                            } else {
                                _this.$message.warning(_this.$lang("公司获取失败"));
                            }
                        });
                },
                getData: function () {
                    var _this = this,
                        param = {};

                    param = _this.form;
                    param.search.created_at.start = _this.created_at[0] || '';
                    param.search.created_at.end = _this.created_at[1] || '';
                    param.search.payable_date_after.start = _this.payable_date_after[0] || '';
                    param.search.payable_date_after.end = _this.payable_date_after[1] || '';
                    param.search.dept_id = _this.form.search.dept_id
                    // console.log(this.form);
                    axios.post("/index.php?m=orderDetail&a=paymentAuditList", param)
                        .then(function (res) {
                            var result = res.data;
                            _this.listdata = res.data;
                            if (result.code == 200) {
                                _this.is_all_selected = false;
                                $(document.getElementsByTagName("iframe")).each(function (key, value) {
                                    var iframe_id = $(value).attr('data-id');
                                    if (iframe_id) {
                                        $(value).remove()
                                    }
                                });
                                if (result.data.data.data == null) {
                                    turn.dataList = []
                                    turn.totalCount = 0
                                } else {
                                    turn.dataList = result.data.data.data.map(function (item) {
                                        item.selected = false;
                                        // var iframe = document.createElement("iframe");
                                        // iframe.setAttribute('data-id', item.id);
                                        // iframe.setAttribute('id', item.id);
                                        // if (item.source_cd == 'N003010004') {
                                        //     console.log("这里被触发了11");
                                        //     iframe.src = "/index.php?m=finance&a=general_payment_detail&payment_audit_id=" + item.id + '&source_cd=' + item.source_cd;
                                        // } else {
                                        //     console.log("这里被触发了11");
                                        //     iframe.src = "/index.php?m=finance&a=pay_order_detail&payment_audit_id=" + item.id + '&source_cd=' + item.source_cd;
                                        // }
                                        // document.getElementById('printIframe').appendChild(iframe)
                                        return item;
                                    })
                                    console.log("当前数组", turn.dataList );
                                    turn.totalCount = +result.data.data.pages.total;
                                }
                            } else {
                                _this.$message.warning(_this.$lang("订单数据查询失败"));
                            }
                        });
                },
                viewDetail: function (item) {
                    console.log("触发了详情");
                    if (item.source_cd == 'N003010004') {
                        newTab("/index.php?m=finance&a=general_payment_detail&payment_audit_id=" + item.id + '&source_cd=' + item.source_cd, this.$lang("一般付款单详情"));
                    } else {
                        newTab("/index.php?m=finance&a=pay_order_detail&payment_audit_id=" + item.id + '&source_cd=' + item.source_cd, this.$lang("付款单详情"));
                    }
                },
                handleSizeChange: function (size) {
                    this.form.pages.per_page = size;
                    this.getData();
                },
                handleCurrentChange: function (currentPage) {
                    this.form.pages.current_page = currentPage;
                    this.getData();
                },
                stateCheck: function (e) {
                    var keyIndex = 0;
                    for (key in this.states) {
                        if (this.states[key].CD == e) {
                            keyIndex = key;
                            this.states[key].selected = true;
                        } else {
                            this.states[key].selected = false;
                        }
                    }
                    this.form.search.status = e;
                    this.states[keyIndex].selected == true ? this.getData() : '';
                    this.stateCheckAllItems = false
                },
                stateCheckAll: function () {
                    this.form.search.status = '';
                    this.stateCheckAllItems = true;
                    this.getData();
                },
                reset: function () {
                    this.form.search.payment_audit_no = '';
                    this.form.search.our_company_cd = '';
                    this.form.search.payment_manager_by = '';
                    this.form.search.created_by = '';

                    this.form.search.accounting_audit_user = '';
                    this.form.search.payment_channel_cd = [];
                    this.form.search.payment_way_cd = [];
                    this.form.search.source_cd = [];
                    this.form.search.pay_com_cd = [];
                    this.form.search.payment_no = '';
                    this.form.search.payment_nature = [],
                        this.form.search.supplier = [],
                        this.form.search.contract_information = [],
                        this.form.search.contract_no = '',
                        this.form.search.payment_type = [],
                        this.form.search.dept_id = '',

                        this.payable_date_after = '';
                    this.created_at = '';
                    this.form.pages.current_page.end = 1;
                    this.form.pages.per_page = 10;
                    this.form.search.status = '';
                    this.stateCheckAllItems = true;
                    this.form.search.pay_type = [];
                    this.getData();

                },
                writeOffDialog: function () {
                    this.dialogWriteOff = true
                    this.payment_channel_init()
                },
                writeOffUpload: function () {

                },
                payment_channel_init: function () {
                    var _this = this;
                    var params = {
                        "cd_type": {
                            "payment_channel": "false",
                            "pur_website_and_new_plat": "false"
                        }
                    };

                    axios.post("/index.php?g=common&m=index&a=get_cd", params).then(function (res) {
                        if (res.data.code == 2000) {
                            var data = []
                            var payment_channel = res.data.data.payment_channel
                            for (key in payment_channel) {
                                if (payment_channel[key].CD_VAL != '银行') {
                                    data.push(payment_channel[key])
                                }
                            }
                            _this.payment_channel = data
                            _this.platformName = res.data.data.pur_website_and_new_plat
                        }
                    })

                },
                downloadStatusWatch: function () {
                    if (this.payment_channel_cd != '' && this.payment_way_cd != '' && this.platformName_cd != '') {
                        this.downloadStatus = false
                    } else {
                        this.downloadStatus = true
                    }
                },
                paymentChannelChange: function (val) {

                    var _this = this;
                    _this.payment_way_cd = ''
                    var params = {
                        "payment_channel_cd": val
                    };
                    axios.post("/index.php?g=common&m=index&a=getPaymentWay", params).then(function (res) {
                        if (res.data.code == 200) {
                            _this.payment_way = res.data.data
                        }
                    })
                    this.platformName_cd = ''
                    this.downloadStatus = true
                    this.platformNameStatus = false
                    // this.downloadStatusWatch()



                },
                payment_wayChange: function (val) {
                    console.log(val);

                    this.downloadStatusWatch()
                    this.platformName_cd = ''
                    if (val == 'N003020001') {
                        this.uploadType = 'batchtransfer'
                        this.platformNameStatus = false
                        this.downloadStatus = false
                    } else if (val == 'N003020002') {
                        this.uploadType = 'batchorderpay'
                        this.platformNameStatus = true
                    } else if (val == 'N003020005') {
                        this.uploadType = 'batchtradeno'
                        this.platformNameStatus = false
                        this.downloadStatus = false
                    } else if (val == 'N003020004') {
                        this.uploadType = 'batchtransfer'
                        this.platformNameStatus = false
                        this.downloadStatus = false
                    } else {
                        this.platformNameStatus = false
                    }
                },
                platformNameChange: function (val) {
                    this.downloadStatusWatch()
                },
                writeOffDownload: function () {
                    console.log(this.payment_way_cd);
                    if (this.payment_way_cd == 'N003020001') {
                        var name = 'batchtransfer.zip'
                    } else if (this.payment_way_cd == 'N003020002') {
                        var name = 'batchorderpay.zip'
                    } else if (this.payment_way_cd == 'N003020005') {
                        var name = 'batchtradeno.zip'
                    } else if (this.payment_way_cd == 'N003020004') {//线下其他支付方式
                        var name = 'batchtransfer.zip'
                    }
                    var url = '/index.php?m=finance&a=downloadPackage&name=' + name
                    var link = document.createElement('a')
                    var body = document.querySelector('body')
                    link.href = url
                    link.style.display = 'none'
                    body.appendChild(link)
                    link.click()
                    body.removeChild(link)
                },
                closeDialogWriteOff: function () {
                    this.payment_channel_cd = ''
                    this.payment_way_cd = ''
                    this.payment_way = []
                    this.platformName_cd = ''
                    this.writeOff_attachment = []
                    this.downloadStatus = true
                    this.platformNameStatus = false
                },
                // 上传核销
                handleSuccessDeductible: function (res, file, fileList) {
                    console.log(res);
                    const loading = this.$loading({
                        lock: true,
                        text: 'Loading',
                        spinner: 'el-icon-loading',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    if (res.code == 2000) {
                        this.writeOff_attachment = fileList;
                        this.$message({
                            message: this.$lang('上传成功'),
                            type: 'success'
                        });
                        loading.close();
                        setTimeout(() => {
                            window.location.reload()
                        }, 1000);
                    } else {
                        loading.close();
                        this.$message({
                            message: res.msg,
                            type: 'error'
                        });
                        this.writeOff_attachment = []
                    }
                },
                handleRemoveDeductible: function (file, fileList) {
                    console.log(fileList);
                    this.writeOff_attachment = fileList;
                },
                // 过滤同名文件
                beforeUpload: function (file) {
                    console.log(file);
                    if (file.type != 'application/x-zip-compressed' && file.type != 'application/zip') {
                        this.$message.error('上传核销只能是 zip 格式');
                        return false;
                    }
                },

                // 导出付款单
                exportList() {
                    var param = this.form;
                    param.search.created_at.start = this.created_at[0] || '';
                    param.search.created_at.end = this.created_at[1] || '';
                    param.search.payable_date_after.start = this.payable_date_after[0] || '';
                    param.search.payable_date_after.end = this.payable_date_after[1] || '';
                    param.search.dept_id = this.form.search.dept_id

                    var tmep = document.createElement('form');
                    tmep.action = 'index.php?m=orderDetail&a=paymentAuditExport';
                    tmep.method = "post";
                    tmep.style.display = "none";
                    var opt = document.createElement("input");
                    opt.name = 'export_params';
                    opt.value = JSON.stringify(param);
                    tmep.appendChild(opt);
                    document.body.appendChild(tmep);
                    tmep.submit();
                    $(tmep).remove();
                },
                // 全选
                handleCheckboxAllSelect() {
                    _this = this
                    _this.dataList = _this.dataList.map(function (item) {
                        item.selected = _this.is_all_selected
                        return item;
                    })
                },
                // 单选
                handleSelected() {
                    var _this = this;
                    _this.is_all_selected = false;
                    this.dataList.forEach(function (item) {
                        if (item.selected) {
                            _this.is_all_selected = true;
                        }
                    })
                },
                getResultData(){
                         this.dataList = this.listdata.data.data.data.map(function (item) {
                             var iframe = document.createElement("iframe");
                             iframe.setAttribute('data-id', item.id);
                             iframe.setAttribute('id', item.id);
                             if (item.source_cd == 'N003010004') {
                                 iframe.src = "/index.php?m=finance&a=general_payment_detail&payment_audit_id=" + item.id + '&source_cd=' + item.source_cd;

                             } else {
                                 iframe.src = "/index.php?m=finance&a=pay_order_detail&payment_audit_id=" + item.id + '&source_cd=' + item.source_cd;
                             }
                             document.getElementById('printIframe').appendChild(iframe);
                             return item;
                         });
                         console.log("第一步")
                },
                batchPrint() {
                    this.batchPrintLoading = true;
                     this.getResultData();

                    let count = 0;
                    let that=this;
                    window.addEventListener('message',function(event){
                        if(event.data==='loadComplete'){
                         count+=1;
                         if(count===that.dataList.length){ //所有的iframe中详情接口加载完成
                             that.batchPrintLoading = false;
                             var print_ids = [];
                             that.dataList.forEach(function (item) {
                                 if (item.selected) {
                                     print_ids.push(item.id)
                                 }
                             })
                             if (print_ids.length === 0) return;
                             print_ids.sort(function (a, b) {
                                 return a - b
                             })
                             var frameSrc, contentHtml = "";
                             var load_count = 0;
                             print_ids.forEach(function (item) {
                                 contentHtml = contentHtml + '<div style="page-break-after:always">' + $(document.getElementById(item).contentWindow.document).find('html').html() + '</div>';
                                 load_count++;
                             })
                             var print_timer = setInterval(function () {
                                 if (contentHtml && load_count === print_ids.length) {
                                     clearInterval(print_timer)
                                     var printCont = window.open("print.htm", "print");
                                     printCont.document.write(contentHtml);
                                     printCont.document.close();
                                     setTimeout(function () {
                                         printCont.print();
                                     }, 300);
                                 }
                             }, 50)
                         }
                        }
                    })

                }
            },

        });
    </script>
</body>

</html>