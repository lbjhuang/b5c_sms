<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/utils/css/public.style.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="/Application/Tpl/Home/B2b/css/detail.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.const.V}>">
    <title>一般付款单详情</title>
</head>
<style>
    [v-cloak]{
        display: none;
    }
    h4{
        margin: 0;
        line-height: 40px;
    }
    .entry-info{
        width: 100%;
        text-align: center;
        border-left: 1px solid #E0E0E0;
        border-bottom: 1px solid #E0E0E0;
        font-size: 15px;
        margin-bottom:20px;
    }
    .entry-info caption{
        height: 40px;
        background-color: #546E7A;
        color: white;
        text-align: left;
        font-size: 15px;
        line-height: 40px;
        padding-left: 20px;
    }
    .entry-info tr td{
        border-right: 1px solid #E0E0E0;
        border-top: 1px solid #E0E0E0;
        padding: 10px 15px;
        font-size: 14px;
    }
    .entry-info tr td:nth-child(odd){
        width: 13.333%;
        background: #f5fafe;
    }
    .entry-info tr td:nth-child(even){
        width: 20%;
        /* background: #f5fafe; */
    }
    .recipt-entry-info tr td:nth-child(odd){
        width: 9.333%;
    }
    .recipt-entry-info tr td:nth-child(even){
        width: 17%;
    }
    .entry-info tr td .el-input__inner{
        height: 35px;
    }
    .input-with-select .el-input-group__prepend {
        background-color: #fff;
    }
    .currency{
        width: 90px;
    }
    .el-select .el-input__inner{
        width: 100%;
    }
    .width-100{
        width: 100% !important;
    }
    .required::after{
        content: "*";
        color:red;
        margin-left: 5px;
    }
    .order-list{
        width: 100%;
        text-align: center;
        border-left: 1px solid #E0E0E0;
        border-bottom: 1px solid #E0E0E0;
        font-size: 15px;
        margin-top: -20px
    }
    .order-list tr th{
        border-right: 1px solid #E0E0E0;
        border-top: 1px solid #E0E0E0;
        padding: 10px 15px;
        font-size: 14px;
        background: #546E7A;
        color: white;
    }
    .order-list tr td{
        border-right: 1px solid #E0E0E0;
        border-top: 1px solid #E0E0E0;
        padding: 10px 15px;
        font-size: 14px;
    }

    .el-tabs__nav-wrap::after, .el-tabs__active-bar {
        height: 0;
    }

    .el-tabs__nav div {
        font-size: 26px;
        font-weight: 600;
    }

    .right-btn {
        float: right;
        margin-right: 20px;
    }

    .main-basic-table td, .child-basic-table td {
        padding: 4px 10px;
        white-space: normal;
        line-height: 20px;
    }

    .el-pagination {
        margin-top: 20px;
        margin-bottom: 120px;
    }

    .log-table td {
        padding: 12px 0 !important;
    }
    .attachmentLink{
        display: flex;
        flex-wrap: wrap;
    }

</style>
<body>
<div id="receipt" v-cloak style="padding: 20px;">
    <div v-if="pay_show">
        <el-tabs v-model="activeName">
            <el-tab-pane :label="$lang('付款单详情')" name="first">
                <el-container>
                    <el-main style="padding: 0;">
                        <!-- 审核信息 -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.operation_info && detail.examine_info.length != 0 && payStatus == '7'">
                            <caption>{{$lang('审核信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('审核人')}}</td>
                                <td>{{detail.examine_info.examine_by}}</td>
                                <td>{{$lang('退回原因')}}</td>
                                <td style="width: 53.334%;">【{{detail.examine_info.return_reason}}】{{detail.examine_info.supply_note}}</td>
                            </tr>
                            </tbody>
                        </table>
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="payStatus == '11'">
                            <caption>{{$lang('审核信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('审核人')}}</td>
                                <td></td>
                                <td>{{$lang('失败原因')}}</td>
                                <td style="width: 53.334%;">{{detail.base_info.receive_fail_reason}}</td>
                            </tr>
                            </tbody>
                        </table>
                        <!-- 基本信息 -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.base_info">
                            <caption>{{$lang('基本信息')}}
                                <span class="right-btn">
                                    <el-button type="primary" size="small" :disabled="canDownload" v-loading.fullscreen.lock="fullscreenLoading" @click="handleDownload">{{$lang('下载全部附件')}}</el-button>
                                </span>
                            </caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('付款单号')}}</td>
                                <td>
                                    <div>{{detail.base_info.payment_audit_no}}</div>
                                    <div v-if="detail.base_info.payment_audit_no_old" style="color: red;">{{$lang('来源')}}：{{detail.base_info.payment_audit_no_old}}</div>
                                </td>
                                <td>{{$lang('付款单状态')}}</td>
                                <td>{{$lang(detail.base_info.payable_status_val)}}
                                    <span style="color: red;">{{detail.base_info.current_audit_user}}</span>
                                </td>
                                <td>{{$lang('来源')}}</td>
                                <td>{{$lang(detail.base_info.source_cd_val)}}</td>
                            </tr>
                            <tr>
                                <td>{{$lang('付款性质')}}</td>
                                <td>{{$lang(detail.base_info.payment_nature_val)}}</td>
                                <td>{{$lang('我方公司')}}</td>
                                <td>{{$lang(detail.base_info.our_company_cd_val)}}</td>
                                <td>{{$lang('供应商')}}</td>
                                <td>{{$lang(detail.base_info.supplier)}}</td>
                            </tr>
                            <tr>
                                <td>{{$lang('合同信息')}}</td>
                                <td>{{$lang(detail.base_info.contract_information_val)}}</td>
                                <td>{{$lang('合同编号')}}</td>
                                <td v-if="detail.base_info.contract_no">{{detail.base_info.contract_no}}({{detail.base_info.contract_name}})</td>
                                <td v-else></td>
                                <td>{{$lang('结算类型')}}</td>
                                <td>{{$lang(detail.base_info.settlement_type_val)}}</td>
                            </tr>
                            <tr>
                                <td class="bbb">{{$lang('采购性质')}}</td>
                                <td>{{$lang(detail.base_info.procurement_nature_val)}}</td>
                                <td>{{$lang('发票信息')}}</td>
                                <td>{{$lang(detail.base_info.invoice_information_val)}}</td>
                                <td>{{$lang('发票类型')}}</td>
                                <td>{{$lang(detail.base_info.invoice_type_val)}}</td>
                            </tr>
                            <tr>
                                <td>{{$lang('账单信息')}}</td>
                                <td>{{$lang(detail.base_info.bill_information_val)}}</td>
                                <td>{{$lang('付款类型')}}</td>
                                <td>{{$lang(detail.base_info.payment_type_val)}}</td>
                                <td>{{$lang('付款币种')}}</td>
                                <td>{{detail.base_info.payment_currency_cd_val}}</td>
                            </tr>
                            <tr>                                
                                <td>{{$lang('审核负责人')}}</td>
                                <td v-html="detail.base_info.accounting_audit_user"></td>
                                <td>{{$lang('付款负责人')}}</td>
                                <td>{{detail.base_info.payment_manager_by}}</td>
                                <td>{{$lang('创建人')}}</td>
                                <td>{{detail.base_info.created_by}}</td>
                            </tr>
                            <tr>
                                <td>{{$lang('创建时间')}}</td>
                                <td>{{detail.base_info.created_at}}</td>
                                <td>{{$lang('审批部门')}}</td>
                                <td>{{detail.base_info.dept_name}}</td>
                                <td>{{$lang('付款需求备注')}}</td>
                                <td>{{detail.base_info.payment_remark}}</td>
                            </tr>
                            <tr>
                                <td>{{$lang('发票附件')}}</td>
                                <td colSpan="5">
                                    <div class="attachmentLink">
                                        <span v-for="(item,index) in detail.base_info.invoice_attachment">
                                            <a class="file_type":href="'/index.php?m=order_detail&a=download&file='+item.saveName+'&origin_file_name='+item.lastName">{{item.lastName}}</a>
                                            <span v-if="index<detail.base_info.invoice_attachment.length-1">，</span>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>{{$lang('账单附件')}}</td>
                                <td colSpan="5">
                                    <div class="attachmentLink"  >
                                        <span v-for="(item,index) in detail.base_info.bill_attachment">
                                            <a class="file_type":href="'/index.php?m=order_detail&a=download&file='+item.saveName+'&origin_file_name='+item.lastName">{{item.lastName}}</a>
                                            <span v-if="index<detail.base_info.bill_attachment.length-1">，</span>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>{{$lang('其他附件')}}</td>
                                <td colSpan="5">
                                    <div class="attachmentLink"  >
                                        <span v-for="(item,index) in detail.base_info.other_attachment">
                                            <a class="file_type":href="'/index.php?m=order_detail&a=download&file='+item.saveName+'&origin_file_name='+item.lastName">{{item.lastName}}</a>
                                            <span v-if="index<detail.base_info.other_attachment.length-1">，</span>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- 应付明细信息 -->
                        <div class="main-basic-info" style="margin-bottom:20px;" v-if="detail.payable_info">
                            <header style="margin-bottom:20px; display: flex; justify-content: space-between;">
                                <div>{{$lang('应付明细信息')}}</div>
                            </header>
                            <table border="0" cellpadding="0" cellspacing="0" class="order-list">
                                <thead>
                                <tr>
                                    <th>Payment Key</th>
                                    <th>{{$lang('项目摘要')}}</th>
                                    <th>{{$lang('细分类型')}}</th>
                                    <th>{{$lang('支付金额（不含增值税）')}}</th>
                                    <th>{{$lang('增值税')}}</th>
                                    <th>{{$lang('小计')}}</th>
                                    <th>{{$lang('实际费用归属部门')}}</th>
                                    <th>{{$lang('实际费用申请人')}}</th>
                                    <th>{{$lang('关联单据类型')}}</th>
                                    <th>{{$lang('关联单据号')}}</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="item in detail.payable_info">
                                    <td>
                                        <a @click="viewDetail(item)" style="color:blue;cursor:pointer;">{{item.payment_no}}</a>
                                    </td>
                                    <td>{{$lang(item.project_summary)}}</td>
                                    <td>{{$lang(item.subdivision_type_val)}}</td>
                                    <td>{{item.amount | digitFormat}}</td>
                                    <td>{{item.vat_rate | digitFormat}}</td>
                                    <td>{{item.subtotal | digitFormat}}</td>
                                    <td>{{item.actual_fee_Department}}</td>
                                    <td>{{item.actual_fee_applicant}}</td>
                                    <td>{{$lang(item.relation_bill_type_val)}}</td>
                                    <td>{{item.relation_bill_no}}</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td><div>{{totalPaymentAmount | format}}</div></td>
                                    <td><div>{{totalTaxRate | format}}</div></td>
                                    <td><div>{{totalAmount | format}}</div></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 支付信息 -->
                        <table style="margin-bottom: 0;" class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.payment_info">
                            <caption>{{$lang('支付信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('支付渠道')}}</td>
                                <td>{{$lang(detail.payment_info.payment_channel_cd_val)}}</td>
                                <td>{{$lang('支付方式')}}</td>
                                <td>{{$lang(detail.payment_info.payment_way_cd_val)}}</td>
                                <td>{{$lang('币种')}}</td>
                                <td>{{detail.payment_info.payment_currency_cd_val}}</td>
                            </tr>
                            <tr v-if="payStatus == 3 || payStatus == 4 || payStatus == 5 || payStatus == 6 || payStatus == 8 || payStatus == 9 || payStatus == 10 || payStatus == 11">
                                <td>{{$lang('支付金额')}}</td>
                                <td>{{detail.payment_info.payment_currency_cd_val}} {{detail.payment_info.payable_amount_before}}</td>
                                <td>{{$lang('交易类型')}}</td>
                                <td>{{detail.payment_info.trade_type_cd_val}}</td>
                                <td>{{$lang('手续费承担方式')}}</td>
                                <td>{{detail.receipt_info.commission_type_val}}</td>
                            </tr>
                            <tr v-if="payStatus == 3 || payStatus == 4 || payStatus == 5 || payStatus == 6 || payStatus == 8 || payStatus == 9 || payStatus == 10 || payStatus == 11">
                                <td>{{$lang('银行参考号')}}</td>
                                <td>{{detail.receipt_info.bank_reference_no?detail.receipt_info.bank_reference_no:''}}</td>
                                <td>{{$lang('付款原因')}}</td>
                                <td>{{detail.receipt_info.bank_payment_reason?detail.receipt_info.bank_payment_reason:''}}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr v-if="payStatus == 3 || payStatus == 4 || payStatus == 8 || payStatus == 9 || payStatus == 10 || payStatus == 11">
                                <td>{{$lang('是否通过Kyriba支付')}}？</td>
                                <td>{{detail.payment_info.pay_type}}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr v-else>
                                <td>{{$lang('支付金额')}}</td>
                                <td>{{detail.payment_info.payment_currency_cd_val}} {{detail.payment_info.payable_amount_before}}</td>
                                <td>{{$lang('银行参考号')}}</td>
                                <td>{{detail.receipt_info.bank_reference_no?detail.receipt_info.bank_reference_no:''}}</td>
                                <td>{{$lang('付款原因')}}</td>
                                <td>{{detail.receipt_info.bank_payment_reason?detail.receipt_info.bank_payment_reason:''}}</td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- 收款方账户/订单信息 -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.receipt_info && beneficiary_account_status && detail.payment_info.payment_channel_cd != 'N001000300'">
                            <caption>{{$lang('收款方账户/订单信息')}}</caption>
                            <tbody>
                            <tr v-if="detail.payment_info.payment_channel_cd == 'N001000301'">
                                <td>{{$lang('收款账户名')}}</td>
                                <td>{{detail.receipt_info.supplier_collection_account}}</td>
                                <td>{{$lang('收款账户开户行')}}</td>
                                <td>{{detail.receipt_info.supplier_opening_bank}}</td>
                                <td>{{$lang('收款银行账号')}}</td>
                                <td>{{detail.receipt_info.supplier_card_number}}</td>
                            </tr>
                            <tr v-if="detail.payment_info.payment_channel_cd == 'N001000301'">
                                <td>{{$lang('收款银行SWIFT CODE')}}</td>
                                <td>{{detail.receipt_info.supplier_swift_code}}</td>
                                <td>{{$lang('收款银行本地结算代码')}}</td>
                                <td>{{detail.receipt_info.bank_settlement_code}}</td>
                                <td>{{$lang('收款银行地址')}}</td>
                                <td>{{detail.receipt_info.bank_address}}</td>
                            </tr>
                            <tr v-if="detail.payment_info.payment_channel_cd == 'N001000301'">
                                <!-- <td>{{$lang('收款银行详细地址')}}</td>
                                <td>{{detail.receipt_info.bank_address_detail}}</td>
                                <td>{{$lang('收款银行邮编')}}</td>
                                <td>{{detail.receipt_info.bank_postal_code}}</td> -->
                                <td>{{$lang('收款账号币种')}}</td>
                                <td>{{detail.receipt_info.account_currency_val}}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <!-- <tr v-if="detail.payment_info.payment_channel_cd == 'N001000301'">
                                <td>{{$lang('收款账户种类')}}</td>
                                <td>{{detail.receipt_info.account_type_val}}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr> -->
                            <tr v-if="detail.payment_info.payment_channel_cd != 'N001000301' && detail.payment_info.payment_way_cd == 'N003020001'">
                                <td>{{$lang('该渠道收款账户名')}}</td>
                                <td>
                                    {{detail.receipt_info.collection_user_name}}
                                </td>
                                <td>{{$lang('该渠道收款账号')}}</td>
                                <td>
                                    {{detail.receipt_info.collection_account}}
                                </td>
                                <td></td><td></td>
                            </tr>
                            <tr v-if="detail.payment_info.payment_channel_cd != 'N001000301' && detail.payment_info.payment_way_cd == 'N003020002'">
                                <td>{{$lang('平台名称')}}</td>
                                <td>
                                    {{detail.receipt_info.platform_cd_val}}
                                </td>
                                <td>{{$lang('店铺名称')}}</td>
                                <td>
                                    {{detail.receipt_info.store_name}}
                                </td>
                                <td>{{$lang('平台订单号')}}</td>
                                <td>
                                    {{detail.receipt_info.platform_order_no}}
                                </td>
                            </tr>
                            <tr v-if="detail.payment_info.payment_channel_cd != 'N001000301' && detail.payment_info.payment_way_cd == 'N003020005'">
                                <td>{{$lang('交易号')}}</td>
                                <td>
                                    {{detail.receipt_info.trade_no}}
                                </td>
                                <td></td><td></td><td></td><td></td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- 我方账户信息 -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.our_account_info && payStatus != '0' && payStatus != '1' && payStatus != '2' && payStatus != '7'">
                            <caption>{{$lang('我方账户信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('付款公司')}}</td>
                                <td>{{detail.our_account_info.pay_com_cd_val || detail.base_info.our_company_cd_val}}</td>
                                <td>{{$lang('资金调配合同')}}</td>
                                <td>{{detail.our_account_info.fund_allocation_contract_no}}</td>
                                <td>{{$lang('付款银行名称')}}</td>
                                <td>{{detail.our_account_info.open_bank}}</td>
                                <!-- <td>{{$lang('付款银行账号')}}</td>
                                <td>{{detail.our_account_info.payment_our_bank_account}}</td> -->
                            </tr>
                            <tr>
                                <td>{{$lang('付款银行账号')}}</td>
                                <td>{{detail.our_account_info.payment_our_bank_account}}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>

                            </tbody>
                        </table>

                        <!-- 提交付款信息 -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.submit_payment_info && (payStatus == '3' || payStatus=='4' || payStatus == '8' || payStatus == '9' || payStatus == '10' || payStatus == '11') && detail.operation_info.is_show_submit_payment_info">
                            <caption>{{$lang('提交付款信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('提交付款币种')}}</td>
                                <td>{{detail.submit_payment_info.payment_currency_cd_val}}</td>
                                <td>{{$lang('提交付款金额')}}</td>
                                <td>{{detail.submit_payment_info.payment_amount}}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- 出账确认信息 -->
                        <!-- <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.operation_info && detail.operation_info.payable_status == 3"> -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.billing_info && (payStatus == '4' || payStatus == '5')">
                            <caption>{{$lang('出账确认信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('扣款币种')}}</td>
                                <td>{{detail.billing_info.payment_currency_cd_val}}</td>
                                <td>{{$lang('扣款金额')}}</td>
                                <td>{{detail.billing_info.billing_amount}}</td>
                                <td>{{$lang('扣款手续费')}}</td>
                                <td>{{detail.billing_info.billing_fee}}</td>
                            </tr>
                            <tr>
                                <td>{{$lang('扣款总金额')}}</td>
                                <td>{{detail.billing_info.billing_total_amount}}</td>
                                <td>{{$lang('出账凭证、水单')}}</td>
                                <!-- <td>
                                    <a style="display:block;margin-bottom: 10px;color:blue;cursor: pointer; " v-for="item in show_billing_voucher" :href="'/index.php?m=order_detail&a=download&file=' + (item.save_name || item.original_name)">
                                    {{item.original_name || item.save_name}}
                                    </a>
                                </td> -->
                                <td>
                                    <div v-if="detail.billing_info.billing_voucher">
                                        <div class="attachmentLink"   v-for="item in JSON.parse(detail.billing_info.billing_voucher)">
                                            <a class="file_type" :href="'/index.php?m=order_detail&a=download&file='+item.save_name+'&origin_file_name='+item.original_name">{{item.original_name}}</a>
                                        </div>
                                    </div>
                                </td>
                                <td>{{$lang('出账日期')}}</td>
                                <td>{{detail.billing_info.billing_date}}</td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- 备注信息 -->
                        <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.remark_info && (payStatus == '3' || payStatus == '4' || payStatus == '5' || payStatus == '8' || payStatus == '9' || payStatus == '10' || payStatus == '11')">
                            <caption>{{$lang('备注信息')}}</caption>
                            <tbody>
                            <tr>
                                <td>{{$lang('付款/出账确认备注')}}</td>
                                <td style="width: 86.667%;">{{detail.remark_info.confirmation_remark}}</td>
                                <!-- <td></td>
                                <td></td>
                                <td></td>
                                <td></td> -->
                            </tr>
                            </tbody>
                        </table>


                    </el-main>
                </el-container>
                <div style="margin-top: 20px;" class="text-center" v-if="detail.operation_info">
                    <!-- <el-button v-if="payStatus == '2'" @click="payConfirm(paymentSure = false)">{{$lang('确认付款账户')}}</el-button> -->
                    <el-button v-if="payStatus == '1' || payStatus == '2'" @click="payConfirm(paymentSure = false)">{{$lang('确认付款账户')}}</el-button>
                    <!-- 待提交 -->
                    <el-button type="primary" v-if="payStatus == '7'" @click="operating('submitStatus')">{{$lang('提交')}}</el-button>
                    <el-button type="primary" v-if="payStatus == '7'" @click="operating('updataStatus')">{{$lang('编辑')}}</el-button>
                    <el-button type="primary" v-if="payStatus == '7'" @click="operating('deleteStatus')">{{$lang('删除')}}</el-button>
                    <!-- 待审核 -->
                    <el-button type="primary" v-if="payStatus == '0' && (detail.base_info.applicant_manager_by.indexOf(user_name) != -1 || user_name == 'ErpAdmin')" @click="operating('pass')">{{$lang('通过')}}</el-button>
                    <el-button v-if="payStatus == '0' && (detail.base_info.applicant_manager_by.indexOf(user_name) != -1 || user_name == 'ErpAdmin')" @click="returnBack = true">{{$lang('退回')}}</el-button>

                    <?php if(checkPermissions('orderDetail', 'returnToAccountingAudit')) { ?>
                    <el-button type="primary" v-if="payStatus == '0'" @click="operating('paddingPayReturn')">{{$lang('撤回')}}</el-button>
                    <?php }?>
                    <!-- 待付款（非银行） -->
                    <el-button type="primary" v-if="payStatus == '1'" @click="operating('paddingPayReturn')">{{$lang('撤回')}}</el-button>
                    <!-- 待付款（银行） -->

                    <el-button type="primary" v-if="payStatus == '2'" @click="operating('paddingPayReturn')">{{$lang('撤回')}}</el-button>

                    <el-button v-if="(payStatus == '1' || payStatus == '2') && (detail.base_info.is_return || user_name == 'ErpAdmin')" @click="returnBack = true">{{$lang('退回')}}</el-button>

                    <!-- 待出账 -->

                    <!-- <el-button type="primary" v-if="payStatus == '3'" @click="operating('billing')">{{$lang('出账确认')}}</el-button> -->
                    <el-button type="primary" v-if="payStatus == '3' || payStatus == '10'" @click="payConfirm(paymentSure = true,form.type = 3)">{{$lang('出账确认')}}</el-button>
                    <!-- 已完成 -->
                    <!-- <el-button type="primary" v-if="payStatus == '4' || payStatus == '5'" @click="operating('payReturn')">{{$lang('付款撤回')}}</el-button> -->
                    <!-- <el-button type="primary" v-if="payStatus == '4' || payStatus == '5'" @click="delDialog = true">{{$lang('付款撤回')}}</el-button> -->
                    <?php if(ButtonAction::hidden()){ ?>
                    <el-button type="primary" v-if="payStatus == '4' || payStatus == '5'" @click="payment_withdrawal">{{$lang('付款撤回')}}</el-button>
                    <?php }?>


                    <el-button :disabled="resubmitApplicationStatus" type="primary" v-if="payStatus == '8' || payStatus == '9' || payStatus == '11'" @click="operating('resubmitApplication')">{{$lang('重新提交申请')}}</el-button>

                    <el-button :disabled="resubmitApplicationStatus" type="primary" v-if="payStatus == '4' || payStatus == '5'"  @click="operating('returnToResubmit')">{{$lang('付款被退回，重新提交')}}</el-button>

                </div>
                <el-dialog :title="$lang('撤回到待付款')" :visible.sync="delDialog" width="35%" center>
                    <template>
                        <p><span style="color: red">*</span> {{$lang('撤回原因')}}:</p>
                        <el-input type="text" v-model="reason" :placeholder="$lang('请输入原因')"></el-input>
                    </template>
                    <span slot="footer" class="dialog-footer">
                            <el-button @click="delDialog = false"> {{$lang('取 消')}} </el-button>
                            <el-button type="primary" @click="returnConfirm"> {{$lang('确 定')}} </el-button>
                        </span>
                </el-dialog>
                <el-dialog :title="$lang('提示')" :visible.sync="getPaybleDialog" width="35%" center>
                    <template>
                        <div class="text-center">{{$lang('本操作将生成应付金：')}}</div>
                        <div class="text-center" v-for="item in payableData">{{item.currency_cd_val}} {{item.amount}}</div>
                    </template>
                    <span slot="footer" class="dialog-footer">
                            <el-button @click="getPaybleDialog = false"> {{$lang('取 消')}} </el-button>
                            <el-button type="primary" @click="getPaybleConfirm"> {{$lang('确 定')}} </el-button>
                        </span>
                </el-dialog>
                <el-dialog title="退回确认" :before-close="closeReturnBack" :visible.sync="returnBack">
                    <el-form ref="returnReasonForm" :model="returnReasonForm" label-width="100px" :rules="returnRules">
                        <el-form-item :label="$lang('退回原因')" prop="return_reason_cd">
                            <el-select :placeholder="$lang('请选择')" v-model="returnReasonForm.return_reason_cd" clearable filterable>
                                <el-option v-for="(item) in return_reasonData" :key="item.cd" :label="item.cdVal" :value="item.cd"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="$lang('补充说明')">
                            <el-input
                                    type="textarea"
                                    :rows="5"
                                    placeholder="请输入内容"
                                    v-model="returnReasonForm.supply_noteTextarea">
                            </el-input>
                        </el-form-item>
                        <el-form-item style="text-align: center">
                            <el-button style="margin-top: 20px;" type="primary" @click="operating('returnReasonForm')"> {{$lang('确定')}} </el-button>
                        </el-form-item>
                    </el-form>
                </el-dialog>
            </el-tab-pane>
            <el-tab-pane :label="$lang('操作日志')" name="second">
                <div class="main-basic-info">
                    <header style="margin-top:0;">
                        {{$lang('操作日志')}}
                    </header>
                    <table border="0" cellspacing="0" cellpadding="0" class="child-basic-table log-table">
                        <thead>
                        <tr>
                            <th>{{$lang('操作人')}}</th>
                            <th>{{$lang('操作时间')}}</th>
                            <th>{{$lang('操作')}}</th>
                            <th>{{$lang('备注')}}</th>
                            <th>{{$lang('当前状态')}}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in logData">
                            <td>{{item.created_by}}</td>
                            <td>{{item.created_at}}</td>
                            <td>{{$lang(item.operation_info)}}</td>
                            <td v-html="$lang(item.remark)"></td>
                            <td>{{$lang(item.status_name)}}</td>
                        </tr>
                        </tbody>

                    </table>
                    <div class="use-row">
                        <div class="col-100 text-right">
                            <el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page.sync="logSearch.p" :page-sizes="[10, 20, 50, 100, 200]" :page-size="logSearch.rows" layout="sizes, prev, pager, next,jumper" :total="totalCount"></el-pagination>
                        </div>
                    </div>
                </div>
            </el-tab-pane>
        </el-tabs>
    </div>
    <div v-if="!pay_show">
        <el-container>
            <el-header style="padding:0;">
                <el-row>
                    <el-col :span="12">
                        <h4>{{$lang('确认付款账户')}}</h4>
                    </el-col>
                </el-row>
            </el-header>
            <el-main style="padding: 0;">
                <!-- 审核信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.operation_info && detail.examine_info && detail.operation_info.payable_status == 0">
                    <caption>{{$lang('审核信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('审核人')}}</td>
                        <td>{{detail.examine_info.examine_by}}</td>
                        <td>{{$lang('退回原因')}}</td>
                        <td style="width: 53.334%;">【{{detail.examine_info.return_reason}}】{{detail.examine_info.supply_note}}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="payStatus == '11'">
                    <caption>{{$lang('审核信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('审核人')}}</td>
                        <td></td>
                        <td>{{$lang('失败原因')}}</td>
                        <td style="width: 53.334%;">{{detail.base_info.receive_fail_reason}}</td>
                    </tr>
                    </tbody>
                </table>
                <!-- 基本信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.base_info">
                    <caption>{{$lang('基本信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('付款单号')}}</td>
                        <td>{{detail.base_info.payment_audit_no}}</td>
                        <td>{{$lang('付款单状态')}}</td>
                        <td>{{detail.base_info.payable_status_val}}</td>
                        <td>{{$lang('来源')}}</td>
                        <td>{{$lang(detail.base_info.source_cd_val)}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('付款性质')}}</td>
                        <td>{{$lang(detail.base_info.payment_nature_val)}}</td>
                        <td>{{$lang('我方公司')}}</td>
                        <td>{{$lang(detail.base_info.our_company_cd_val)}}</td>
                        <td>{{$lang('供应商')}}</td>
                        <td>{{$lang(detail.base_info.supplier)}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('合同信息')}}</td>
                        <td>{{detail.base_info.contract_information_val}}</td>
                        <td>{{$lang('合同编号')}}</td>
                        <td v-if="detail.base_info.contract_no">{{detail.base_info.contract_no}}({{detail.base_info.contract_name}})</td>
                        <td v-else></td>
                        <td>{{$lang('结算类型')}}</td>
                        <td>{{detail.base_info.settlement_type_val}}</td>
                    </tr>
                    <tr>
                        <td class="ccc">{{$lang('采购性质')}}</td>
                        <td>{{$lang(detail.base_info.procurement_nature_val)}}</td>
                        <td>{{$lang('发票信息')}}</td>
                        <td>{{$lang(detail.base_info.invoice_information_val)}}</td>
                        <td>{{$lang('发票类型')}}</td>
                        <td>{{$lang(detail.base_info.invoice_type_val)}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('账单信息')}}</td>
                        <td>{{detail.base_info.bill_information_val}}</td>
                        <td>{{$lang('付款类型')}}</td>
                        <td>{{detail.base_info.payment_type_val}}</td>
                        <td>{{$lang('付款币种')}}</td>
                        <td>{{detail.base_info.payment_currency_cd_val}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('审核负责人')}}</td>
                        <td>{{detail.base_info.applicant_manager_by}}</td>
                        <td>{{$lang('付款负责人')}}</td>
                        <td>{{detail.base_info.payment_manager_by}}</td>
                        <td>{{$lang('创建人')}}</td>
                        <td>{{detail.base_info.created_by}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('创建时间')}}</td>
                        <td>{{detail.base_info.created_at}}</td>
                        <td>{{$lang('审批部门')}}</td>
                        <td>{{detail.base_info.dept_name}}</td>
                        <td>{{$lang('付款需求备注')}}</td>
                        <td>{{detail.base_info.payment_remark}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('发票附件')}}</td>
                        <td colSpan="5">
                            <div class="attachmentLink">
                                <span v-for="(item,index) in detail.base_info.invoice_attachment">
                                    <a class="file_type":href="'/index.php?m=order_detail&a=download&file='+item.saveName+'&origin_file_name='+item.lastName">{{item.lastName}}</a>
                                    <span v-if="index<detail.base_info.invoice_attachment.length-1">，</span>
                                </span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>{{$lang('账单附件')}}</td>
                        <td colSpan="5">
                            <div class="attachmentLink">
                                <span v-for="(item,index) in detail.base_info.bill_attachment">
                                    <a class="file_type":href="'/index.php?m=order_detail&a=download&file='+item.saveName+'&origin_file_name='+item.lastName">{{item.lastName}}</a>
                                    <span v-if="index<detail.base_info.bill_attachment.length-1">，</span>
                                </span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>{{$lang('其他附件')}}</td>
                        <td colSpan="5">
                            <div class="attachmentLink">
                                <span v-for="(item,index) in detail.base_info.other_attachment">
                                    <a class="file_type":href="'/index.php?m=order_detail&a=download&file='+item.saveName+'&origin_file_name='+item.lastName">{{item.lastName}}</a>
                                    <span v-if="index<detail.base_info.other_attachment.length-1">，</span>
                                </span>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <!-- 应付明细信息 -->
                <div class="main-basic-info" style="margin-bottom:20px;" v-if="detail.payable_info">
                    <header style="margin-bottom:20px;">
                        {{$lang('应付明细信息')}}
                    </header>
                    <table border="0" cellpadding="0" cellspacing="0" class="order-list">
                        <thead>
                        <tr>
                            <th>Payment Key</th>
                            <th>{{$lang('项目摘要')}}</th>
                            <th>{{$lang('细分类型')}}</th>
                            <th>{{$lang('支付金额（不含增值税）')}}</th>
                            <th>{{$lang('增值税')}}</th>
                            <th>{{$lang('小计')}}</th>
                            <th>{{$lang('关联单据类型')}}</th>
                            <th>{{$lang('关联单据号')}}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in detail.payable_info">
                            <td>
                                <a @click="viewDetail(item)" style="color:blue;cursor:pointer;">{{item.payment_no}}</a>
                            </td>
                            <td>{{item.project_summary}}</td>
                            <td>{{item.subdivision_type_val}}</td>
                            <td>{{item.amount}}</td>
                            <td>{{item.vat_rate}}</td>
                            <td>{{item.subtotal | digitFormat}}</td>
                            <td>{{item.relation_bill_type_val}}</td>
                            <td>{{item.relation_bill_no}}</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><div>{{totalPaymentAmount}}</div></td>
                            <td><div>{{totalTaxRate}}</div></td>
                            <td><div>{{totalAmount}}</div></td>
                            <td></td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>
                </div>




                <!-- 支付信息 -->
                <table style="margin-bottom: 0;" class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.payment_info">
                    <caption>{{$lang('支付信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('支付渠道')}}</td>
                        <td>{{$lang(detail.payment_info.payment_channel_cd_val)}}</td>
                        <td>{{$lang('支付方式')}}</td>
                        <td>{{detail.payment_info.payment_way_cd_val}}</td>
                        <td>{{$lang('币种')}}</td>
                        <td>{{detail.payment_info.payment_currency_cd_val}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('支付金额')}}</td>
                        <td>{{detail.payment_info.payment_currency_cd_val}} {{detail.payment_info.payable_amount_before}}</td>
                        <td>{{$lang('交易类型')}}<span class="required" v-if="paymentSure == false && form.isKyribaPay == 1"></span></td>
                        <td v-if="paymentSure == true">{{detail.payment_info.trade_type_cd_val}}</td>
                        <td v-if="paymentSure == false">
                            <el-select :placeholder="$lang('请选择')" v-model="form.trade_type_cd" clearable filterable>
                                <el-option v-for="(item) in transaction_type" :key="item.cd" :label="item.cdVal" :value="item.cd"></el-option>
                            </el-select>
                        </td>
                        <td>{{$lang('手续费承担方式')}}<span class="required" v-if="paymentSure == false && form.isKyribaPay == 1"></span></td>
                        <td v-if="paymentSure == true">{{detail.receipt_info.commission_type_val}}</td>
                        <td v-if="paymentSure == false">
                            <el-select :placeholder="$lang('请选择')" v-model="form.commission_type" clearable filterable>
                                <el-option v-for="(item) in commission_typeData" :key="item.cd" :label="$lang(item.cdVal)" :value="item.cd"></el-option>
                            </el-select>
                        </td>

                    </tr>
                    <tr v-if="payStatus == 3 || payStatus == 4 || payStatus == 10">
                        <td>{{$lang('是否通过Kyriba支付')}}？</td>
                        <td>{{detail.payment_info.pay_type}}</td>
                        <td>{{$lang('银行参考号')}}</td>
                        <td>{{detail.receipt_info.bank_reference_no?detail.receipt_info.bank_reference_no:''}}</td>
                        <td>{{$lang('付款原因')}}</td>
                        <td>{{detail.receipt_info.bank_payment_reason?detail.receipt_info.bank_payment_reason:''}}</td>
                    </tr>
                    <tr v-else>
                        <td>{{$lang('银行参考号')}}</td>
                        <td>{{detail.receipt_info.bank_reference_no?detail.receipt_info.bank_reference_no:''}}</td>
                        <td>{{$lang('付款原因')}}</td>
                        <td>{{detail.receipt_info.bank_payment_reason?detail.receipt_info.bank_payment_reason:''}}</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 收款方账户/订单信息 -->
                <table class="entry-info recipt-entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.receipt_info && beneficiary_account_status && detail.payment_info.payment_channel_cd != 'N001000300'">
                    <caption>{{$lang('收款方账户/订单信息')}}</caption>
                    <tbody>
                    <tr v-if="detail.payment_info.payment_channel_cd == 'N001000301'">
                        <td>{{$lang('收款账户名')}}</td>
                        <td>{{detail.receipt_info.supplier_collection_account}}</td>
                        <td>{{$lang('收款账户开户行')}}</td>
                        <td>{{detail.receipt_info.supplier_opening_bank}}</td>
                        <td>{{$lang('收款银行账号')}}</td>
                        <td>{{detail.receipt_info.supplier_card_number}}</td>
                    </tr>
                    <tr v-if="detail.payment_info.payment_channel_cd == 'N001000301'">
                        <td>{{$lang('收款银行SWIFT CODE')}}</td>
                        <td>{{detail.receipt_info.supplier_swift_code}}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr v-if="detail.payment_info.payment_channel_cd != 'N001000301' && detail.payment_info.payment_way_cd == 'N003020001'">
                        <td>{{$lang('该渠道收款账户名')}}</td>
                        <td>
                            {{detail.receipt_info.collection_user_name}}
                        </td>
                        <td>{{$lang('该渠道收款账号')}}</td>
                        <td>
                            {{detail.receipt_info.collection_account}}
                        </td>
                        <td></td><td></td>
                    </tr>
                    <tr v-if="detail.payment_info.payment_channel_cd != 'N001000301' && detail.payment_info.payment_way_cd == 'N003020002'">
                        <td>{{$lang('平台名称')}}</td>
                        <td>
                            {{detail.receipt_info.platform_cd_val}}
                        </td>
                        <td>{{$lang('店铺名称')}}</td>
                        <td>
                            {{detail.receipt_info.store_name}}
                        </td>
                        <td>{{$lang('平台订单号')}}</td>
                        <td>
                            {{detail.receipt_info.platform_order_no}}
                        </td>
                    </tr>
                    <tr v-if="detail.payment_info.payment_channel_cd != 'N001000301' && detail.payment_info.payment_way_cd == 'N003020005'">
                        <td>{{$lang('交易号')}}</td>
                        <td>
                            {{detail.receipt_info.trade_no}}
                        </td>
                        <td></td><td></td><td></td><td></td>
                    </tr>
                    </tbody>
                </table>

                <!-- 我方账户信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.our_account_info && payStatus != '0' && payStatus != '1' && payStatus != '2' && payStatus != '7'">
                    <caption>{{$lang('我方账户信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('付款公司')}}</td>
                        <td>{{detail.our_account_info.pay_com_cd_val || detail.base_info.our_company_cd_val}}</td>
                        <td>{{$lang('付款银行名称')}}</td>
                        <td>{{detail.our_account_info.open_bank}}</td>
                        <td>{{$lang('付款银行账号')}}</td>
                        <td>{{detail.our_account_info.payment_our_bank_account}}</td>
                    </tr>

                    </tbody>
                </table>



                <!-- 提交付款信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.submit_payment_info && (payStatus == '3' || payStatus=='4' || payStatus == '10') && detail.operation_info.is_show_submit_payment_info">
                    <caption>{{$lang('提交付款信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('提交付款币种')}}</td>
                        <td>{{detail.submit_payment_info.payment_currency_cd_val}}</td>
                        <td>{{$lang('提交付款金额')}}</td>
                        <td>{{detail.submit_payment_info.payment_amount}}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>


                <!-- 出账确认信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.billing_info && (payStatus == '4' || payStatus == '5')">
                    <caption>{{$lang('出账确认信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('扣款币种')}}</td>
                        <td>{{detail.billing_info.payment_currency_cd_val}}</td>
                        <td>{{$lang('扣款金额')}}</td>
                        <td>{{detail.billing_info.billing_amount}}</td>
                        <td>{{$lang('扣款手续费')}}</td>
                        <td>{{detail.billing_info.billing_fee}}</td>
                    </tr>
                    <tr>
                        <td>{{$lang('扣款总金额')}}</td>
                        <td>{{detail.billing_info.billing_total_amount}}</td>
                        <td>{{$lang('出账凭证、水单')}}</td>
                        <!-- <td>
                            <a style="display:block;margin-bottom: 10px;color:blue;cursor: pointer; " v-for="item in show_billing_voucher" :href="'/index.php?m=order_detail&a=download&file=' + (item.save_name || item.original_name)">
                            {{item.original_name || item.save_name}}
                            </a>
                        </td> -->

                        <td>
                            <div v-if="detail.billing_info.billing_voucher">
                                <div class="attachmentLink"   v-for="item in JSON.parse(detail.billing_info.billing_voucher)">
                                    <a class="file_type" :href="'/index.php?m=order_detail&a=download&file='+item.save_name+'&origin_file_name='+item.original_name">{{item.original_name}}</a>
                                </div>
                            </div>
                        </td>
                        <td>{{$lang('出账日期')}}</td>
                        <td>{{detail.billing_info.billing_date}}</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 付款确认的付款确认信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.payment_info && paymentSure == false">
                    <!-- <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.payment_info && payStatus == '2'"> -->
                    <caption>{{$lang('付款确认信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('付款公司')}} <span class="required"></span></td>
                        <td>
                            <el-select :placeholder="$lang('请选择付款公司')" v-model="form.pay_company" filterable @change="payCompanyChange">
                                <el-option v-for="(item,index) in ourCompanyList" :key="index" :label="item.cdVal" :value="item.cd"></el-option>
                            </el-select>
                        </td>
                        <td>
                            {{$lang('资金调配合同')}} <span :class="{required: is_required}"></span></td>
                        </td>
                        <td>
                            <el-select :placeholder="$lang('请选择')" v-model="form.fund_allocation_contract_no" clearable filterable :disabled="!is_required">
                                <el-option v-for="(item, index) in fund_allocation_contract" :key="index" :label="item.CON_NO" :value="item.CON_NO"></el-option>
                            </el-select>
                        </td>
                        <td>{{$lang('付款银行名称')}} <span class="required"></span></td>
                        <td>
                            <el-select :placeholder="$lang('请选择')" v-model="form.pay_open_bank" clearable filterable @change="getPayAccounts(form.pay_open_bank)">
                                <el-option v-for="(item,index) in open_bank_data" :key="index" :label="item" :value="item"></el-option>
                            </el-select>
                        </td>
                    </tr>
                    <tr>
                        <td>{{$lang('付款账号')}} <span class="required"></span></td>
                        <td>
                            <el-select :placeholder="$lang('请选择')" v-model="form.payment_our_bank_account" clearable filterable @change="getCurrCode(form.payment_our_bank_account)">
                                <el-option v-for="(item,index) in payAccounts" :key="index" :label="item.account_bank" :value="item.account_bank"></el-option>
                            </el-select>
                        </td>
                        <td>{{$lang('是否通过Kyriba支付')}}？
                            <!-- {{form.payment_our_bank_account}}
                            {{detail.base_info.payment_type_val}} -->
                            <span :class="(is_CITI && detail.base_info.payment_type_val == '' || is_CITI && detail.base_info.payment_type_val != '' && detail.operation_info.is_optional_payment )? 'required' : ''"></span>
                        </td>
                        <td>
                            <el-radio-group @change="isKyribaPayChange" :disabled="(is_CITI && detail.base_info.payment_type_val == '' || is_CITI && detail.base_info.payment_type_val != '' && detail.operation_info.is_optional_payment )? false : true" v-model="form.isKyribaPay">
                                <el-radio :label="1">{{$lang('是')}}</el-radio>
                                <el-radio :label="0">{{$lang('否')}}</el-radio>
                            </el-radio-group>
                        </td>
                        <td>{{$lang('是否已出账')}} <span :class="is_posted? '' : 'required'"></span></td>
                        <td>
                            <el-select :placeholder="$lang('请选择')" v-model="form.type" :disabled="is_posted" clearable filterable>
                                <el-option :label="$lang('未出账')" :value="2"></el-option>
                                <el-option :label="$lang('已出账')" :value="3"></el-option>
                            </el-select>
                        </td>
                    </tr>
                    <tr>
                        <td v-if="form.type == 2">{{$lang('提交付款币种')}} <span class="required"></span></td>
                        <td v-if="form.type == 2">
                            <el-select :placeholder="$lang('请选择')" v-model="form.payment_currency_cd" clearable filterable>
                                <el-option v-for="(item) in currencyData" :key="item.cd" :label="item.cdVal" :value="item.cd"></el-option>
                            </el-select>
                        </td>
                        <td v-if="form.type == 2">{{$lang('提交付款金额')}} <span class="required"></span></td>
                        <td v-if="form.type == 2">
                            <el-input v-model="form.payment_amount"></el-input>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>

                <!-- 出账确认信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.billing_info && form.type == 3">
                    <caption>{{$lang('出账确认信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('扣款币种')}}</td>
                        <td>{{paymentSure == true ? detail.billing_info.payment_currency_cd_val : debit_currency}}</td>
                        <td>{{$lang('扣款金额')}} <span class="required"></span></td>
                        <td>
                            <el-input v-model="form.billing_amount" @change="getamountTotal(form.billing_amount)"></el-input>
                        </td>
                        <td>{{$lang('扣款手续费')}} <span class="required"></span></td>
                        <td><el-input v-model="form.billing_fee" @change="getfeeTotal(form.billing_fee)"></el-input></td>
                    </tr>
                    <tr>
                        <td>{{$lang('扣款总金额')}}</td>
                        <td>
                            <span v-if="billingTotalFlag">{{change_billing_total_amount}}</span>
                            <span v-if="!billingTotalFlag">{{detail.billing_info.billing_total_amount}}</span>
                        </td>
                        <td>{{$lang('出账凭证/水单')}} <span class="required"></span></td>
                        <td>
                            <el-upload
                                    class="deductible-demo"
                                    action="/index.php?m=order_detail&a=file_upload"
                                    :on-success="handleSuccessBilling"
                                    :on-remove="handleRemoveBilling"
                                    :before-upload="beforeUploadBilling"
                                    multiple
                                    :file-list="form.billing_voucher">
                                <el-button size="small" type="primary">{{$lang('上传凭证')}}</el-button>
                            </el-upload>
                        </td>
                        <td>{{$lang('出账日期')}} <span class="required"></span></td>
                        <td><el-date-picker v-model="form.billing_date" type="date" align="right" value-format="yyyy-MM-dd">
                        </el-date-picker>
                        </td>
                    </tr>

                    </tbody>
                </table>

                <!-- 备注信息 -->
                <table class="entry-info" border="0" cellpadding="0" cellspacing="0" v-if="detail.remark_info && (payStatus == '1' || payStatus == '2' || payStatus == '3' || payStatus == '10')">
                    <caption>{{$lang('备注信息')}}</caption>
                    <tbody>
                    <tr>
                        <td>{{$lang('付款/出账确认备注')}}</td>
                        <td style="width: 86.667%;">

                            <el-input v-model="form.confirmation_remark"></el-input>
                            <!-- {{detail.remark_info.confirmation_remark}} -->
                        </td>
                        <!-- <td></td>
                        <td></td>
                        <td></td>
                        <td></td> -->
                    </tr>
                    </tbody>
                </table>

            </el-main>
        </el-container>
        <div class="text-center" v-if="detail.operation_info">
            <el-button type="primary" :disabled="confirmSubmitStatus"  @click="confirmSubmit">{{$lang('提 交')}}</el-button>
        </div>
        <el-dialog :title="$lang('提示')" :visible.sync="getPrePayDialog" width="35%" center>
            <template>
                <div class="text-center">{{$lang('本操作将生成抵扣金：')}}</div>
                <div class="text-center" v-for="item in deductionData">{{item.currency_cd_val}} {{item.amount}}</div>
            </template>
            <span slot="footer" class="dialog-footer">
                    <el-button @click="getPrePayDialog = false"> {{$lang('取 消')}} </el-button>
                    <el-button type="primary" @click="getPrePayConfirm"> {{$lang('确 定')}} </el-button>
                </span>
        </el-dialog>

    </div>
</div>

<!--引入js-->
<script type="text/javascript" src="./Application/Tpl/Home/Public/lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/utils/utils.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/H-ui.admin.js?v=<{$Think.const.V}>"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/axios.min.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.2.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-en.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/queryString.js?v=<{$Think.config.VER_NUM}>"></script>
<script>
    if (getCookie('think_language') !== "zh-cn") {
        ELEMENT.locale(ELEMENT.lang.en)
    }

    var  vm = new Vue({
        el:'#receipt',
        data:{
            ourCompanyList: [], // 我方公司
            user_name:'<{$user_name}>',
            pay_show: true,//展示付款单详情页还是确认页
            delDialog:false,//撤回到待提交弹窗
            getPrePayDialog: false,//抵扣金弹窗
            getPaybleDialog: false,//应付金弹窗
            deductionData: [],
            payableData: [],
            reason: '',//撤回原因
            payment_audit_id: '',//付款单id
            source_cd:'',//应付来源
            activeName: 'first',//tab切换
            form:{
                pay_company: '', // 付款公司
                pay_open_bank: '',//付款银行，不作为参数提交
                payment_currency_cd: '',//提交付款币种
                payment_amount: '',//提交付款金额
                payment_voucher: [],//付款凭证
                billing_amount: '',//扣款金额
                billing_fee: '',//扣款手续费
                billing_date: '',//出账日期
                billing_voucher: [],//付款水单
                payment_our_bank_account: '',//付款账号
                payment_account_id: '', // 付款账号id
                type: 2,//出账类型
                confirmation_remark:'',//付款/出账确认备注
                commission_type: '',//手续费承担方式
                trade_type_cd:'',//交易类型
                isKyribaPay:0,//是否通过kyriba支付
                fund_allocation_contract_no: ""  // 资金调配合同
            },
            debit_currency: '',
            billingTotalFlag: false,
            change_billing_total_amount: '',
            paymentSure: true,//判断是否出账确认
            detail:{},//详情页数据
            show_billing_voucher: [],//详情页显示付款水单
            show_payment_voucher: [],//详情页显示付款凭证
            logData: [],//日志信息数据
            logSearch: {//日志分页
                p: 1,
                rows: 10
            },
            totalCount: 0,//日志总数
            open_bank_data:[],//付款银行
            payAccounts:[],//付款账号
            currencyData: [],//币种
            return_reasonData: [],//退回原因
            commission_typeData: [],//手续费承担方式
            transaction_type:[],//交易类型
            payStatus:'',
            returnBack:false,
            returnReasonForm: {
                return_reason_cd: '',
                supply_noteTextarea:''
            },
            returnRules: {
                return_reason_cd:[
                    { required: true, message: '请选择退回原因', trigger: 'change' },
                ],
            },
            is_posted:false,
            is_CITI:false,
            pay_type_val:'',
            confirmSubmitStatus:false,
            resubmitApplicationStatus:false,
            beneficiary_account_status:true,
            canDownload: false, // 是否可下载
            is_required: false,
            fund_allocation_contract: [],
            fullscreenLoading: false, // laoding
        },
        filters: {
            // 数字加上千分位
            format :function format(num) {
                num = Number(num).toFixed(2)
                var num1=num.split('.')[0]+'';//数字转字符串  
                var str="";//字符串累加  
                for(var i=num1.length- 1,j=1;i>=0;i--,j++){  
                    if(j%3==0 && i!=0 && num1[i-1] != '-'){//每隔三位加逗号，过滤正好在第一个数字的情况 过滤负数情况 
                        str+=num1[i]+",";//加千分位逗号  
                        continue;  
                    }  
                    str+=num1[i];//倒着累加数字
                }
                return str.split('').reverse().join("") + '.' + num.split('.')[1];//字符串=>数组=>反转=>字符串  
            },
            digitFormat(num) {
                num = parseFloat(num.replace(/,/g, '')).toFixed(2);
                var num1=num.split('.')[0]+'';//数字转字符串  
                var str="";//字符串累加  
                for(var i=num1.length- 1,j=1;i>=0;i--,j++){  
                    if(j%3==0 && i!=0 && num1[i-1] != '-'){//每隔三位加逗号，过滤正好在第一个数字的情况 过滤负数情况 
                        str+=num1[i]+",";//加千分位逗号  
                        continue;  
                    }  
                    str+=num1[i];//倒着累加数字
                }
                return str.split('').reverse().join("") + '.' + num.split('.')[1];
            }
        },
        computed: {
            // 支付金额总计
            totalPaymentAmount() {
                var amount = 0;
                this.detail.payable_info.forEach(item => {
                    amount = amount + parseFloat(item.amount.replace(/,/g,''))
                })
                return amount.toFixed(2);
            },
            // 增值税总计
            totalTaxRate() {
                var total = 0;
                this.detail.payable_info.forEach(item => {
                    total = total + parseFloat(item.vat_rate.replace(/,/g,''));
                });
                return total.toFixed(2)
            },
            totalAmount() {
                var amount = 0;
                this.detail.payable_info.forEach(item => {
                    amount = amount + parseFloat(item.subtotal.replace(/,/g,''));
                })
                return amount.toFixed(2);
            }
        },
        created:function(){
            this.getCommonData();
            this.getCommonCode();
            // this.user_name = '<{$user_name}>';
        },
        methods: {
            // 切换付款公司清除付款银行和账号并且获取付款银行
            payCompanyChange() {
                this.form.pay_open_bank = "";
                this.form.payment_our_bank_account = "";
                this.payAccounts = [];
                this.open_bank_data = [];
                this.getCompanyCode();
                this.form.fund_allocation_contract_no = ""
                if (this.form.pay_company !== this.detail.base_info.our_company_cd) {
                    this.is_required = true;
                    this.getFundAllocationContact(this.form.pay_company)
                } else {
                    this.is_required = false;
                }
            },
            // 获取我方公司
            getOurCompanyCode: function(){
                var _this = this;
                var params = {
                    'cd_type':{
                        // 'our_company': 'false' // 查询已启用
                        company_open: 'true',   // 获取供应商和开放的公司数据
                        supplier: 'true'
                    }
                };

                axios.post("/index.php?g=common&m=index&a=get_cd", params).then((res)=>{
                    if(res.data.code == 2000){
                        _this.ourCompanyList = res.data.data.company_open
                        res.data.data.supplier.forEach(function (item) {
                            _this.ourCompanyList.push({
                                cd: item.ID,
                                cdVal: item.SP_NAME
                            })
                        })

                    }
                })

            },
            //获取付款单id
            getCommonData: function (){
                this.payment_audit_id = utils.parseQuery(window.location.search).payment_audit_id;
                this.source_cd = utils.parseQuery(window.location.search).source_cd;
                this.getData();
                this.getLogData();
            },
            // 获取币种
            getCommonCode: function(){
                var _this = this;
                var data = {
                    data:{
                        query: {
                            currency: true,
                            accounting_return_reason: true,
                            commission_type: true,
                            transaction_type:true,
                        }
                    }
                }
                axios.post("/index.php?g=oms&m=CommonData&a=commonData", data)
                    .then(function(res) {
                        var result = res.data;
                        if (result.code == 2000) {
                            _this.currencyData = result.data.currency;
                            _this.return_reasonData = result.data.accounting_return_reason;
                            _this.commission_typeData = result.data.commission_type;
                            _this.transaction_type = result.data.transaction_type;
                        } else {
                            _this.$message.warning(_this.$lang("币种获取失败"));
                        }
                    });
            },
            // 获取付款单详情
            getData: function () {
                var _this = this;
                var data = {
                    payment_audit_id: _this.payment_audit_id,
                }

                axios.post("index.php?m=finance&a=generalPaymentDetail", data)
                    .then(function(res) {
                        var result = res.data;
                        if (result.code == 2000) {
                            _this.detail = result.data;
                            var payableStatus = _this.detail.operation_info.payable_status
                            _this.pay_type_val = result.data.operation_info.pay_type
                            var payChannelStatus = _this.detail.operation_info.payment_channel_cd
                            _this.form.pay_company = _this.detail.our_account_info.pay_com_cd || _this.detail.base_info.our_company_cd;
                            _this.form.fund_allocation_contract_no = _this.detail.our_account_info.fund_allocation_contract_no;
                            if (_this.form.pay_company !== _this.detail.base_info.our_company_cd) {
                                // 待kyriba付款
                                _this.is_required = true;
                            }
                            // N001000301
                            if(payableStatus == '4'){
                                // 待审核
                                _this.payStatus = '0'
                            }else if(payableStatus == '1' && payChannelStatus != 'N001000301' && payChannelStatus){
                                // 待付款（非银行）
                                _this.payStatus = '1'
                            }else if(payableStatus == '1' && (payChannelStatus == 'N001000301' || payChannelStatus == null)){
                                // 待付款（银行）
                                _this.payStatus = '2'
                            }else if(payableStatus == '2'){
                                // 待出账 银行，非银行均开放该按钮
                                _this.payStatus = '3'
                            }else if(payableStatus == '3' && payChannelStatus == 'N001000301'){
                                // 已完成（银行）
                                _this.payStatus = '4'
                            }else if(payableStatus == '3' && payChannelStatus != 'N001000301'){
                                // 已完成（非银行）
                                _this.payStatus = '5'
                            }else if(payableStatus == '5'){
                                // 已删除
                                _this.payStatus = '6'
                            }else if(payableStatus == '0'){
                                //待提交
                                _this.payStatus = '7'
                            }else if(payableStatus == '7'){
                                // Kyriba审核未通过
                                _this.payStatus = '8'
                            }else if(payableStatus == '8'){
                                // 付款失败
                                _this.payStatus = '9'
                            }else if(payableStatus == '9'){
                                // 待kyriba接收
                                _this.payStatus = '10'
                            }else if(payableStatus == '10'){
                                // kyriba接收失败
                                _this.payStatus = '11'
                            }

                            if(_this.detail.billing_info.billing_voucher){
                                _this.show_billing_voucher = JSON.parse(_this.detail.billing_info.billing_voucher);
                            }
                            if(_this.detail.payment_info.payment_voucher){
                                _this.show_payment_voucher = JSON.parse(_this.detail.payment_info.payment_voucher);
                            }
                            _this.source_cd = _this.detail.operation_info.source_cd

                            if(_this.detail.base_info.payment_type_comment2 == '员工个人账户' && payChannelStatus == 'N001000301'){
                                _this.beneficiary_account_status = false
                            }

                            window.parent.postMessage('loadComplete',window.parent);

                        } else {
                            // _this.$message.warning(_this.$lang("订单详情查询失败"));
                        }
                    });
            },
            viewDetail: function(item) {
                if(this.source_cd == 'N003010002'){
                    // 费用单
                    newTab('/index.php?g=logistics&m=Expensebill&a=fee_detail&fee_id='+item.payment_id, '费用单详情');
                }else if(this.source_cd == 'N003010001'){
                    // 应付单
                    newTab("/index.php?m=order_detail&a=payable_detail&id=" + item.payment_id, '应付详情页');
                }else if(this.source_cd == 'N003010003'){
                    var after_sale_no = this.detail.base_info.after_sale_no
                    var order_no = this.detail.base_info.order_no
                    var order_id = this.detail.base_info.order_id
                    var platform_cd = this.detail.base_info.platform_cd

                    // B2C退款
                    var dom = document.createElement('a');
                    var _href = "/index.php?g=OMS&m=AfterSale&a=refund_detail&after_sale_no=" + after_sale_no + "&order_no=" + order_no + "&order_id=" + order_id + "&platform_country_code=" + platform_cd;
                    dom.setAttribute("onclick", "opennewtab(this,'" + this.$lang('退款详情') + "')");
                    dom.setAttribute("_href", _href);
                    dom.click();
                }

            },
            // 撤回到待付款
            returnConfirm:function(){
                var _this = this;
                if(!this.reason){
                    this.$message.error(this.$lang('请填写撤回原因'));
                    return;
                }else{
                    var data = {
                        action_type_cd: 'N002870015',
                        money_type: '1',
                        payment_audit_id: _this.payment_audit_id,
                    }
                    axios.post("/index.php?m=orderDetail&a=getPrePaymentInfo", data)
                        .then(function(res) {
                            var result = res.data;
                            if (result.code == 200) {
                                if(result.data.data && result.data.data.payable){
                                    _this.getPaybleDialog = true;
                                    _this.payableData = result.data.data.payable;
                                }else{
                                    _this.getPaybleConfirm();
                                }
                            } else {
                                _this.$message.warning(_this.$lang(result.msg));
                            }
                        });
                }

            },
            getPaybleConfirm:function(){
                var _this = this;
                _this.getPaybleDialog = false;
                axios.post('/index.php?m=order_detail&a=payable_return_to_payment_confirm',{
                    id:this.payment_audit_id,
                    reason:this.reason,
                    source_cd:this.source_cd,
                })
                    .then(function(res){
                        if(res.data.code == 2000){
                            _this.$message.success(_this.$lang('撤回成功'));
                            _this.delDialog = false;
                            window.location.reload();
                        }else{
                            _this.$message.error(_this.$lang(res.data.msg));
                        }
                    })
            },
            // 付款核销或者出账确认按钮点击
            payConfirm: function(){
                this.pay_show = false;
                if(this.form.type == '3' && this.detail.remark_info.confirmation_remark){
                    this.form.confirmation_remark = this.detail.remark_info.confirmation_remark
                }
                this.getOurCompanyCode(); // 获取我方公司数据
                this.getCompanyCode();
            },
            // 获取付款银行
            getCompanyCode: function(){

                var _this = this;
                var data = {
                    data:{
                        company_code: this.form.pay_company
                    }
                }

                axios.post("/index.php?m=finance&a=companyBanks", data)
                    .then(function(res) {
                        var result = res.data;
                        if (result.code == 2000) {
                            _this.open_bank_data = result.data.banks;
                        } else {
                            _this.$message.warning(_this.$lang("获取付款银行失败"));
                        }
                    });
            },
            // 获取付款账号
            getPayAccounts: function(val){
                var _this = this;
                if(!val){
                    _this.is_posted = false
                    _this.form.payment_our_bank_account = ''
                }
                var data = {
                    data:{
                        company_code: this.form.pay_company,
                        open_bank: val
                    }
                }

                axios.post("/index.php?m=finance&a=companyBankAccounts", data)
                    .then(function(res) {
                        var result = res.data;
                        if (result.code == 2000) {
                            _this.payAccounts = result.data;
                        } else {
                            _this.$message.warning(_this.$lang("获取付款账户失败"));
                        }
                    });
            },
            //获取扣款币种
            getCurrCode: function(val){
                var _this = this;
                this.payAccounts.forEach(function (item) {
                    if (item.account_bank === val) {
                        _this.form.payment_account_id = item.id;
                    }
                })
                if(!val){
                    this.is_posted = false
                }else{
                    if(this.payAccounts){
                        for(var item of this.payAccounts){
                            if (val == item.account_bank) {
                                this.debit_currency = item.currency;
                                if(item.bank_short_name == 'CITI'){
                                    // this.is_posted = true
                                    this.is_CITI = true
                                    this.form.type = 2
                                    this.form.isKyribaPay = ''
                                }else{
                                    // this.is_posted = false
                                    this.is_CITI = false
                                    this.form.type = 2
                                    this.form.isKyribaPay = 0
                                }
                                if(item.bank_short_name == 'CITI' && this.detail.base_info.payment_type_val != '' && !this.detail.operation_info.is_optional_payment){
                                    this.form.isKyribaPay = 0
                                }
                            }
                        }
                    }
                }

            },
            isKyribaPayChange:function(val){
                if(val == 1){
                    this.is_posted = true
                    this.form.type = 2
                }else{
                    this.is_posted = false
                    this.form.type = 2
                }
            },
            // 上传付款凭证
            handleSuccessDeductible: function(res, file, fileList) {
                this.form.payment_voucher = fileList;
            },
            // 上传付款凭证
            handleRemoveDeductible: function(file, fileList) {
                this.form.payment_voucher = fileList;
            },
            /**
             * 过滤同名文件
             * */

            beforeUpload: function(file) {
                var flag = true;
                var _this = this;
                var length = this.form.payment_voucher.length;
                if (length) {
                    for (var i = 0; i < length; i++) {
                        if (file.name === _this.form.payment_voucher[i].name) {
                            flag = false;
                        }
                    }
                }
                if (!flag) {
                    _this.$message({
                        message: _this.$lang('不能上传同名文件'),
                        type: 'error'
                    });
                }
                return flag;
            },
            // 上传付款水单
            handleSuccessBilling: function(res, file, fileList) {
                this.form.billing_voucher = fileList;
            },
            // 上传付款水单
            handleRemoveBilling: function(file, fileList) {
                this.form.billing_voucher = fileList;
            },
            /**
             * 过滤同名文件
             * */

            beforeUploadBilling: function(file) {
                var flag = true;
                var _this = this;
                var length = this.form.billing_voucher.length;
                if (length) {
                    for (var i = 0; i < length; i++) {
                        if (file.name === _this.form.billing_voucher[i].name) {
                            flag = false;
                        }
                    }
                }
                if (!flag) {
                    _this.$message({
                        message: _this.$lang('不能上传同名文件'),
                        type: 'error'
                    });
                }
                return flag;
            },
            // 付款单提交
            confirmSubmit:function(){
                var _this = this;
                _this.confirmSubmitStatus = true

                if(_this.form.type == 3){
                    var data = {
                        action_type_cd: 'N002870015',
                        money_type: '2',
                        payment_audit_id: _this.payment_audit_id,
                    }
                    axios.post("/index.php?m=orderDetail&a=getPrePaymentInfo", data)
                        .then(function(res) {
                            var result = res.data;
                            if (result.code == 200) {
                                if(result.data.data && result.data.data.deduction){
                                    _this.getPrePayDialog = true;
                                    _this.deductionData = result.data.data.deduction;
                                    _this.confirmSubmitStatus = false
                                }else{
                                    _this.getPrePayConfirm();
                                }

                            } else {
                                _this.$message.warning(_this.$lang(result.msg));
                                _this.confirmSubmitStatus = false
                            }
                        });
                }else{
                    _this.getPrePayConfirm();
                }

            },
            getPrePayConfirm:function(){
                this.getPrePayDialog = false;
                // var pay_voucher = [];
                // this.form.payment_voucher.forEach(function(el) {
                //     pay_voucher.push({
                //         original_name: el.response.info.name,
                //         save_name: el.response.info.savename
                //     })
                // });
                var billing_voucher = [];
                this.form.billing_voucher.forEach(function(el) {
                    billing_voucher.push({
                        original_name: el.response.info.name,
                        save_name: el.response.info.savename
                    })
                });

                var _this = this;

                if(_this.payStatus == '10' || _this.payStatus == '3' || _this.form.type == '3'){
                    if (_this.is_required) {
                        if (!this.form.fund_allocation_contract_no) {
                            _this.confirmSubmitStatus = false;
                            return _this.$message.warning(_this.$lang('资金调配合同不能为空'));
                        }
                    }
                    var data = {
                        // 未出账
                        // no_billing: {
                        //     payment_currency_cd: _this.form.payment_currency_cd,
                        //     payment_amount: _this.form.payment_amount,
                        //     payment_voucher: pay_voucher,
                        //     confirmation_remark:_this.form.confirmation_remark
                        // },
                        // 已出账/待出账
                        already_billing:{
                            billing_amount: _this.form.billing_amount,
                            billing_fee: _this.form.billing_fee,
                            billing_date: _this.form.billing_date,
                            billing_voucher: billing_voucher,
                            confirmation_remark:_this.form.confirmation_remark,
                        },
                        // payment_our_bank_account: _this.paymentSure == false ? _this.form.payment_our_bank_account : _this.detail.billing_info.payment_our_bank_account,
                        payment_our_bank_account: _this.paymentSure == false ? _this.form.payment_our_bank_account : _this.detail.our_account_info.payment_our_bank_account,
                        payment_account_id: _this.form.payment_account_id || _this.detail.our_account_info.payment_account_id,
                        payment_audit_id: _this.payment_audit_id,
                        commission_type: _this.paymentSure == false ? _this.form.commission_type : _this.detail.receipt_info.commission_type,
                        type: _this.form.type,
                        submit_type: _this.paymentSure,
                        // confirmation_remark:_this.form.confirmation_remark,
                        source_cd:_this.source_cd,
                        trade_type_cd: _this.paymentSure == false ? _this.form.trade_type_cd : _this.detail.payment_info.trade_type_cd,
                        pay_com_cd: _this.form.pay_company, // 付款公司CD
                        pay_type: (_this.payStatus == '10' || _this.payStatus == '3') ? _this.detail.operation_info.pay_type: _this.form.isKyribaPay,//是否通过kyriba支付
                        fund_allocation_contract_no: _this.form.fund_allocation_contract_no

                    }
                }else if(_this.form.type == '2'){
                    if (_this.is_required) {
                        if (!_this.form.fund_allocation_contract_no) {
                            _this.confirmSubmitStatus = false;
                            return _this.$message.warning(_this.$lang('资金调配合同不能为空'));
                        }
                    }
                    var data = {
                        // 未出账
                        no_billing: {
                            payment_currency_cd: _this.form.payment_currency_cd,
                            payment_amount: _this.form.payment_amount,
                            // payment_voucher: pay_voucher,
                            confirmation_remark:_this.form.confirmation_remark
                        },
                        // 已出账/待出账
                        // already_billing:{
                        //     billing_amount: _this.form.billing_amount,
                        //     billing_fee: _this.form.billing_fee,
                        //     billing_date: _this.form.billing_date,
                        //     billing_voucher: billing_voucher,
                        // },
                        // payment_our_bank_account: _this.paymentSure == false ? _this.form.payment_our_bank_account : _this.detail.billing_info.payment_our_bank_account,
                        payment_our_bank_account: _this.paymentSure == false ? _this.form.payment_our_bank_account : _this.detail.our_account_info.payment_our_bank_account,
                        payment_account_id: _this.form.payment_account_id,
                        payment_audit_id: _this.payment_audit_id,
                        commission_type: _this.paymentSure == false ? _this.form.commission_type : _this.detail.receipt_info.commission_type,
                        type: _this.form.type,
                        submit_type: _this.paymentSure,
                        // confirmation_remark:_this.form.confirmation_remark,
                        source_cd:_this.source_cd,
                        trade_type_cd: _this.paymentSure == false ? _this.form.trade_type_cd : _this.detail.payment_info.trade_type_cd,
                        pay_com_cd: _this.form.pay_company, // 付款公司CD
                        // pay_type:_this.detail.operation_info.pay_type,//是否通过kyriba支付
                        pay_type: (_this.payStatus == '10' || _this.payStatus == '3') ? _this.detail.operation_info.pay_type: _this.form.isKyribaPay,//是否通过kyriba支付
                        fund_allocation_contract_no: _this.form.fund_allocation_contract_no
                    }
                }
                axios.post("/index.php?m=orderDetail&a=paymentSubmit", data)
                    .then(function(res) {
                        var result = res.data;
                        if (result.code == 200) {
                            _this.$message.success(_this.$lang('提交成功'));
                            setTimeout(() => {
                                _this.getData();
                                _this.pay_show = true;
                                window.location.reload()
                            }, 1000);

                        } else {
                            _this.$message.warning(_this.$lang(result.msg));
                            _this.confirmSubmitStatus = false
                        }
                    });
            },
            // 获取扣款总金额
            getamountTotal: function(val){
                if(val >= 0){

                }else{
                    this.form.billing_amount = '0.00'
                }
                this.billingTotalFlag = true;
                if(this.form.billing_amount >= 0 && this.form.billing_fee >= 0){
                    this.change_billing_total_amount = (Number(this.form.billing_amount) + Number(this.form.billing_fee)).toFixed(2)
                }else{
                    this.change_billing_total_amount = '0.00';
                }

            },
            // 获取扣款总金额
            getfeeTotal: function(val){
                if(val >= 0){

                }else{
                    this.form.billing_fee = '0.00'
                }
                this.billingTotalFlag = true;
                if(this.form.billing_amount >= 0 && this.form.billing_fee >= 0){
                    this.change_billing_total_amount = (Number(this.form.billing_amount) + Number(this.form.billing_fee)).toFixed(2)
                }else{
                    this.change_billing_total_amount = '0.00';
                }
            },
            // 获取日志信息
            getLogData: function () {
                var _this = this;
                var data = {
                    search: {
                        payment_audit_id: _this.payment_audit_id
                    },
                    pages: {
                        per_page: this.logSearch.rows,
                        current_page: this.logSearch.p
                    }

                }
                axios.post("/index.php?m=orderDetail&a=paymentBillLog", data)
                    .then(function(res) {
                        var result = res.data;
                        if (result.code == 200) {
                            _this.logData = result.data.data.data;
                            _this.totalCount = Number(result.data.data.pages.total);
                        } else {
                            _this.$message.warning(_this.$lang("日志信息查询失败"));
                        }
                    });
            },
            // 日志分页
            handleSizeChange: function(size) {
                this.logSearch.rows = size;
                this.getLogData();
            },
            handleCurrentChange: function(currentPage) {
                this.logSearch.p = currentPage;
                this.getLogData();
            },
            // 待审核
            operating:function(type){
                var _this = this;
                // 通过
                if(type == 'pass'){
                    var data = {
                        payment_audit_id : _this.payment_audit_id,
                        source_cd : _this.source_cd,
                        status : 1,
                        is_return : 0,
                        accounting_return_reason : ''
                    }
                    axios.post("/index.php?m=orderDetail&a=accountingAudit", data)
                        .then(function(res) {
                            if(res.data.code == 200){
                                _this.$message({
                                    message: _this.$lang('提交成功'),
                                    type: 'success'
                                });
                                setTimeout(() => {
                                    _this.getData();
                                    window.location.reload()
                                }, 1000);

                            }else{
                                _this.$message({
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                            }
                        });
                }else if(type == 'returnReasonForm'){
                    // 退回
                    _this.$refs[type].validate((valid) =>{
                        if(valid){
                            var data = {
                                payment_audit_id : _this.payment_audit_id,
                                status : 0,
                                source_cd : _this.source_cd,
                                is_return : 1,
                                accounting_return_reason: _this.returnReasonForm.return_reason_cd,
                                supply_note : _this.returnReasonForm.supply_noteTextarea
                            }
                            axios.post("/index.php?m=orderDetail&a=accountingAudit", data)
                                .then(function(res) {
                                    if(res.data.code == 200){
                                        _this.returnBack = false
                                        _this.getCommonData();
                                        _this.getCommonCode();
                                        setTimeout(() => {
                                            _this.$message({
                                                message: _this.$lang('该付款单已退回'),
                                                type: 'success'
                                            });
                                        }, 1000);
                                        // window.location.reload();
                                        // _this.getData();
                                    }else{
                                        _this.$message({
                                            message: res.data.msg,
                                            type: 'warning'
                                        });
                                    }
                                });
                        }
                    })

                }else if(type == 'paddingPayReturn'){
                    var data = {
                        payment_audit_id: this.payment_audit_id,
                        source_cd: this.source_cd
                    }
                    axios.post("/index.php?m=order_detail&a=returnToAccountingAudit", data)
                        .then(function(res) {

                            if(res.data.code == 200){
                                _this.$message({
                                    message: _this.$lang('撤回成功'),
                                    type: 'success'
                                });
                                setTimeout(() => {
                                    window.location.reload()
                                }, 1000);
                                // _this.getData();
                            }else{
                                _this.$message({
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                            }
                        });


                }else if(type == 'payReturn'){
                    // axios.post('/index.php?m=order_detail&a=payable_return_to_payment_confirm',{id:this.payment_audit_id,reason:this.reason})
                    // .then(function(res){
                    //     if(res.data.code == 2000){
                    //         _this.$message.success(_this.$lang('撤回成功'));
                    //         _this.delDialog = false;
                    //         window.location.reload();
                    //     }else{
                    //         _this.$message.error(_this.$lang(res.data.msg));
                    //     }
                    // })

                }else if(type == 'billing'){
                    this.getPrePayConfirm()
                }else if(type == 'submitStatus'){
                  var _this = this;
                  if(_this.detail.base_info.need_show === 'Y'){
                    this.$alert(_this.$lang('申请付款相关附件如果有更改，线下请重\n' +
                      '新提交最新版本的相关文件至财务部。'), '', {
                      confirmButtonText: '确定',
                      callback: action => {
                        submitStatus()
                      }
                    });
                  }else{
                    submitStatus()
                  }
                  function submitStatus(){
                    var data = {
                      payment_audit_id: _this.payment_audit_id,
                      status: '4'
                    }
                    axios.post("index.php?m=finance&a=paymentStatusUpdate", data)
                      .then(function(res) {

                        if(res.data.code == 2000){
                          _this.$message({
                            message: _this.$lang('提交成功'),
                            type: 'success'
                          });
                          setTimeout(() => {
                            window.location.reload()
                          }, 1000);
                          // _this.getData();
                        }else{
                          _this.$message({
                            message: res.data.msg,
                            type: 'warning'
                          });
                        }
                      });
                  }

                }else if(type == 'updataStatus'){
                    newTab("/index.php?m=finance&a=edit_general_payment&payment_audit_id=" + this.payment_audit_id , this.$lang('编辑付款'));
                }else if(type == 'deleteStatus'){
                    var data = {
                        payment_audit_id: this.payment_audit_id,
                        status: '5'
                    }
                    axios.post("index.php?m=finance&a=paymentStatusUpdate", data)
                        .then(function(res) {

                            if(res.data.code == 2000){
                                _this.$message({
                                    message: _this.$lang('删除成功'),
                                    type: 'success'
                                });
                                setTimeout(() => {
                                    window.location.reload()
                                }, 1000);
                            }else{
                                _this.$message({
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                            }
                        });
                }else if(type == 'resubmitApplication' || type == 'returnToResubmit'){
                    _this.resubmitApplicationStatus = true
                    // 重新提交申请
                    var data = {
                        payment_audit_id : _this.payment_audit_id,
                        source_cd : _this.source_cd,
                        is_payment_return:type == 'resubmitApplication' ? '0' : '1'
                    }
                    // if(sourceCd == 'N003010004'){
                    axios.post("/index.php?m=order_detail&a=kyribaPaymentResubmit", data).then(function(res) {
                        if(res.data.code == 200){
                            var payment_audit_no_new = res.data.data.payment_audit_no_new
                            _this.getCommonData();
                            _this.getCommonCode();
                            setTimeout(() => {
                                _this.$message({
                                    message: _this.$lang('新的付款单号为：'+payment_audit_no_new+'。请重新去财务管理-付款单列表，通过原单号或新单号搜索并发起。'),
                                    type: 'warning'
                                });
                            }, 1000);
                            _this.resubmitApplicationStatus = false

                        }else{
                            _this.$message({
                                message: res.data.msg,
                                type: 'warning'
                            });
                            _this.resubmitApplicationStatus = false
                        }
                    });
                }

            },

            closeReturnBack:function(done){
                this.returnReasonForm.supply_noteTextarea = ''
                this.returnReasonForm.return_reason_cd = ''
                done()
            },
            payment_withdrawal:function(){
                if(this.pay_type_val == '1'){
                    this.$confirm("本付款单已经推送kyriba系统，单方面撤回可能导致两边系统数据不同步，请确保同步撤回！").then(()=>{
                        this.delDialog = true
                    })
                }else{
                    this.delDialog = true
                }
            },
            handleDownload: function() {
                // 下载全部附件
                var _this = this;
                _this.canDownload = true;
                _this.fullscreenLoading = true
                var files = [];
                var base = _this.detail.base_info;
                // var save_name = '付款单：' + base.payment_audit_no + '附件.zip';
                var invoice_attachment = base.invoice_attachment || [];
                var bill_attachment = base.bill_attachment || [];
                var other_attachment = base.other_attachment || [];

                invoice_attachment.forEach(function(item) {
                    files.push({"saveName": item.saveName,"lastName": item.lastName})
                })
                bill_attachment.forEach(function(item) {
                    files.push({"saveName": item.saveName,"lastName": item.lastName})
                })
                other_attachment.forEach(function(item) {
                    files.push({"saveName": item.saveName,"lastName": item.lastName})
                })


                let count = 0;
                for (let i = 0; i < files.length; i++) {
                    axios.get('/index.php?m=order_detail&a=download&file=' + files[i].saveName+'&origin_file_name=' + files[i].lastName,{responseType: 'blob'}).then(res => {
                        count++;
                        if(count == files.length) {
                            this.canDownload = false;
                            this.fullscreenLoading = false;
                        }
                        
                       var blob = new Blob([res.data], {type: res.headers['content-type']});
                       var url = window.URL.createObjectURL(blob)
                       var a = document.createElement('a')
                       a.setAttribute('id', files[i].lastName)
                       a.href = url
                       a.download = files[i].lastName
                       $('body').append(a)
                       a.click();
                       $('#' + files[i].lastName).remove()
                    })
                }
                // var param = {
                // files: files,
                // save_name: save_name
                // }
                // axios.post('/index.php?g=common&m=file&a=downloadZip', param, {responseType: 'blob'})
                //     .then(function (res) {
                //         console.log(res);
                //         _this.canDownload = false;
                //         _this.fullscreenLoading = false;
                //         var blob = new Blob([res.data], {type: res.headers['content-type']});
                //         var url = window.URL.createObjectURL(blob)
                //         var a = document.createElement('a')
                //         a.setAttribute('id', save_name)
                //         a.href = url
                //         a.download = save_name
                //         $('body').append(a)
                //         a.click();
                //         $('#' + save_name).remove()
                //     })
            },
            getFundAllocationContact: function(pay_com_cd) {
                var _this = this;
                _this.fund_allocation_contract = [];
                var params = {
                    'PAY_COMPANY_CD': pay_com_cd,
                    'CON_COMPANY_CD': _this.detail.base_info.our_company_cd
                }

                axios.post('/index.php?g=common&m=index&a=fund_allocation_contract', params).then(function(res) {
                    if (res.data.code === 2000) {
                        _this.fund_allocation_contract =  res.data.data;
                    } else {
                        _this.$message.warning(_this.$lang(res.data.msg))
                    }
                })
            },
        },
    })
</script>
</body>
</html>

