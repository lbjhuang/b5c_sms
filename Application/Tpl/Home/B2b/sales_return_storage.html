<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../Public/css/bootstrap.min.css">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/element-ui-2.2.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="../Public/icon/css/font-awesome.min.css">
    <link rel="stylesheet" href="../Public/css/send.css"/>
    <link rel="stylesheet" href="../Public/utils/css/public.style.css">
    <link rel="stylesheet" href="./Application/Tpl/Home/Public/css/default.css?v=<{$Think.const.V}>">
    <title><{$Think.lang.退货入库}></title>
    <script type="text/javascript">
        var url = window.location.href;
    </script>
    <style>
        .wrap {
            box-sizing: border-box;
            padding: 20px;
            margin: 0;
        }

        .row {
            margin: 0;
        }

        .row + .row {
            margin-top: 20px;
        }

        [class*="col-"] {
            padding: 0;
        }
        .thumbnail-wrap {
            position: relative;
            z-index: 999;
        }

        .thumbnail-wrap .img-wrap {
            position: absolute;
            top: -80px;
            left: 180px;
            width: 300px;
            height: 300px;
            border: 1px solid #eef5f9;
        }

        .thumbnail-wrap img {
            box-shadow: 4px 4px 20px #242525;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .table-only{
            margin-top: 0.5rem;
            border: 1px solid #cadee7;
            width: 100%;
            border-collapse: collapse;
            background-color: transparent;
        }
        .table-title{
            background: #546E7A;
            height: 2rem;
            font-family: "Arial", "Microsoft YaHei", "黑体", "宋体", sans-serif;
            font-size: 0.8rem;
            color: #FFFFFF;
            letter-spacing: 0;
            padding: 0 1rem;
            line-height: 2rem;
            border: 1px solid #546E7A;
            caption-side: top;
        }
        .table-only th {
            background: #F7F9FB;
            text-align: center;
            width: 10%;
            font-family: "Arial", "Microsoft YaHei", "黑体", "宋体", sans-serif;
            border-left: none;
            font-size: 14px;
            color: #263238;
            border-bottom: 1px solid #ECEFF1;
            vertical-align: middle;
            padding: 8px;
            font-weight: 400;
            border-left: 1px solid #CADEE7;
        }
        .table-only td {
            min-height: 38px;
            height: 38px;
            text-align: center;
            font-size: 14px;
            font-family: "Arial", "Microsoft YaHei", "黑体", "宋体", sans-serif;
            font-weight: 400;
            vertical-align: middle;
            padding: 8px;
            border-bottom: 1px solid #ECEFF1;
            border-left: 1px solid #CADEE7;
        }
    </style>
</head>
<div id="sales_return" v-cloak="" class="wrap">
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 use-title">
            <span>{{$lang('退货入库')}}</span>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12">
            <table class="b2b-table-one">
                <caption>{{$lang('基础信息')}}</caption>
                <tbody class="use-body">
                <tr>
                    <td><label>{{$lang('B2B订单号')}}</label></td>
                    <td>{{ info.detail.PO_ID}}</td>
                    <td><label>{{$lang('PO单号')}}</label></td>
                    <td>{{ info.detail.THR_PO_ID}}</td>
                </tr>
                <tr>
                    <td><label>{{$lang('客户')}}</label></td>
                    <td>{{ info.detail.CLIENT_NAME}}</td>
                    <td><label> {{$lang('我方公司')}}</label></td>
                    <td>{{info.detail.our_company}}</td>
                </tr>
                <tr>
                    <td><label> {{$lang('销售团队')}} </label></td>
                    <td>{{ info.detail.SALES_TEAM}}</td>
                    <td><label> {{$lang('销售同事')}} </label></td>
                    <td>{{ info.detail.PO_USER}}</td>
                </tr>

                <tr>
                    <td><label> {{$lang('退货状态')}} </label></td>
                    <td>{{ info.detail.status}}</td>
                    <td><label>{{$lang('订单备注')}} </label></td>
                    <td>{{info.detail.remarks}}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12">
            <table class="b2b-table-one">
                <caption>{{$lang('物流信息')}}</caption>
                <tbody class="use-body">
                <tr>
                    <td><label>{{$lang('退回仓库')}}</label></td>
                    <td>{{info.detail.warehouse}}</td>
                    <td><label>{{$lang('物流单号')}}</label></td>
                    <td>{{info.detail.logistics_number}}</td>
                </tr>
                <tr>
                    <td><label>{{$lang('预计到仓日期')}}</label></td>
                    <td>{{info.detail.expected_arrival_date}}</td>
                    <td><label> {{$lang('预估物流费用')}}</label></td>
                    <td>{{ info.detail.expected_logistics_cost_currency+ ' '+info.detail.expected_logistics_cost}}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12">
            <table class="table-only">
                <caption class="table-title">{{$lang('商品信息')}}</caption>
                <tbody class="use-body">
                <tr>
                    <th>{{$lang('SKU编码')}}</th>
                    <th>{{$lang('条形码')}}</th>
                    <th>{{$lang('图片')}}</th>
                    <th>{{$lang('商品名称')}}</th>
                    <th>{{$lang('SKU属性')}}</th>
                    <th>{{$lang('本次退货数量')}}</th>
                    <th>{{$lang('正品货位')}}</th>
                    <th>{{$lang('正常品入库数量')}}</th>
                    <th>{{$lang('残次品货位')}}</th>
                    <th>{{$lang('残次品入库数量')}}</th>
                </tr>
                <tr  :key="k" v-for="(v,k) in info.goods">
                    <td>{{v.sku_id}}</td>
                    <td style="white-space: pre-line" >{{v.upc_id}}</td>
                    <td>
                        <el-popover
                                placement="right"
                                title=""
                                trigger="hover">
                            <img :src="v.image_url" style="height: 300px;"/>
                            <img slot="reference" :src="v.image_url"  style="height: 50px;">
                        </el-popover>
                    </td>
                    <td>{{v.spu_name}}</td>
                    <td>{{v.attributes}}</td>
                    <td>{{v.return_num}}</td>
                    <td>{{v.location_code }}</td>
                    <td>
                        <div class="el-input"><input :disabled="(info.detail.status === '已完成'?true:false)" @input="checkNum($event.target,v,'warehouse_num_quality')" :value="v.warehouse_num_quality" autocomplete="off" placeholder="" type="text" rows="2" validateevent="true" class="el-input__inner"></div>
                    </td>
                    <td>{{v.defective_location_code  }}</td>
                    <td>
                        <div class="el-input"><input :disabled="(info.detail.status === '已完成'?true:false)"  @input="checkNum($event.target,v,'warehouse_num_broken')" :value="v.warehouse_num_broken" autocomplete="off" placeholder="" type="text" rows="2" validateevent="true" class="el-input__inner"></div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <a v-if="info.detail.status !== '已完成'" @click="postMessage"><button class="btn-pub btn-default mg-l-20">{{$lang('确认入库')}}</button></a>
    </div>
</div>
<script src="../Public/lib/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../Public/js/stock/alert.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/vue.2.5.13.js"></script>
<script type="text/javascript" src="../Public/js/axios.min.js"></script>
<script type="text/javascript" src="../Public/js/H-ui.js"></script>
<script type="text/javascript" src="../Public/js/H-ui.admin.js?v=<{$Think.config.VER_NUM}>"></script>
<script type="text/javascript" src="../Public/lib/bootstrap/js/tether.min.js"></script>
<script type="text/javascript" src="../Public/lib/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="./Application/Tpl/Home/Public/js/element-ui-2.2.js"></script>
<script type="text/javascript" src="../Public/utils/utils.js?v=1123"></script>
<script>
    top.$('.loading').hide()
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }

    var orderId = getQueryString('order_id');
    var vm = new Vue({
        el: '#sales_return',
        data: {
            orderId:orderId,
            info:{
                detail:{
                    return_no:'',	//退货单号
                    status:'',	//退货单状态
                    warehouse:'',	//仓库
                    logistics_number:'',	//物流单号
                    expected_arrival_date:'',	//预计到达日期
                    expected_logistics_cost_currency:'',	//预计物流费用币种
                    expected_logistics_cost:'',	//预计物流费用
                    PO_ID:'',	//B2B单号
                    THR_PO_ID:'',	//PO单号
                    CLIENT_NAME:'',	//客户名称
                    SALES_TEAM:'',	//销售团队
                    PO_USER:''	//销售同事
                },
                goods:[]
            },
            b2b:{
                po_currency:'',
                DOSHIP_ID:'',
                PO_ID:'',
                CLIENT_NAME:'',
                THR_PO_ID:'',
                PO_USER:'',
                SALES_TEAM:'',
                DELIVERY_METHOD:'',
                po_time:'',
                remarks:'',
                SHIPMENTS_NUMBER_all:'',
                AUTHOR:'',
                SUBMIT_TIME:'',
            }
        },
        computed:{
        },
        created:function(){
            this.getInfo();
        },
        methods:{
            checkNum:function(event,data,type){
                var _this = this;
                var r= /^[1-9][0-9]*$/
                var num = event.value
                if(!r.test(event.value)){
                    var n = Math.abs(parseInt(event.value))
                    if(isNaN(n)){
                        num = '0'
                    }else{
                        num = n
                    }
                }
                if(event.value === ''){
                    num = ''
                }
                event.value = String(num)
                data[type] = String(num)
                /*for(var x = 0;x<this.orderInfo.goods.length;x++){
                    if(this.orderInfo.goods[x] === data){
                        this.orderInfo.goods[x].
                    }
                }*/
            },
            getInfo:function(){
                var _this = this;
                axios.post('/index.php?m=b2b&a=return_goods_detail', {
                    id:_this.orderId
                }).then(function (response) {
                    if(response.data.code === 2000){
                        var data = response.data.data;
                        _this.info = data
                    }
                })
            },
            postMessage:function(){
                var _this = this;
                var goods = [];
                var bool = false
                for(var x = 0;x<_this.info.goods.length;x++){
                    var o = {
                        id:_this.info.goods[x].id,
                        warehouse_num_quality:(_this.info.goods[x].warehouse_num_quality?_this.info.goods[x].warehouse_num_quality:'0'),
                        warehouse_num_broken:(_this.info.goods[x].warehouse_num_broken?_this.info.goods[x].warehouse_num_broken:'0'),
                    }
                    if(o.warehouse_num_quality === '0' && o.warehouse_num_broken === '0'){
                        bool = true
                    }
                    goods.push(o)
                }
                if(bool){
                    _this.$message({
                        message:'请填写正确的入库数量' ,
                        type: 'warning'
                    });
                    return
                }
                axios.post('/index.php?m=B2b&a=return_goods_warehouse', {
                    id:_this.orderId,
                    goods:goods
                }).then(function (response) {
                    if(response.data.code === 2000){
                        _this.$message({
                            message:'操作成功' ,
                            type: 'success'
                        });
                        setTimeout(function(){
                            _this.orderDetal(_this.orderId,'退货详情')
                        },1200)
                        setTimeout(function(){
                            var url = window.location.pathname + window.location.search
                            sessionStorage.setItem('closeWindow',url)
                        },1500)
                    }else{
                        _this.$message({
                            message:response.data.msg ,
                            type: 'warning'
                        });
                    }
                })
            },
            orderDetal: function (orderId, title) {
                var dom = document.createElement('a');
                var _href;
                if (title === '退货详情') {
                    _href = "/index.php?m=b2b&a=sales_return&order_id="+orderId;
                }
                if (title === '退货入库') {
                    _href = "/index.php?m=b2b&a=sales_return_storage&order_id="+orderId;
                }
                dom.setAttribute("onclick", "opennewtab(this,'"+this.$lang(title) + "')");
                dom.setAttribute("_href", _href);
                dom.click();
            },
        }
    })
</script>
</body>

</html>