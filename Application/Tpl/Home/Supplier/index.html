<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <!--[if lt IE 9]>
    <script type="text/javascript" src="../Public/lib/html5.js"></script>
    <script type="text/javascript" src="../Public/lib/respond.min.js"></script>
    <script type="text/javascript" src="../Public/lib/PIE-2.0beta1/PIE_IE678.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="../Public/css/element-ui-2.2.css?v=<{$Think.const.V}>">
    <link rel="stylesheet" href="../Public/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../Public/lib/icon/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../Public/css/style.css?v=20170306" />
    <link rel="stylesheet" href="../Public/css/common.css?v=20170306"/>
    <link rel="stylesheet" href="../Public/css/default.css"/>
    <style>.commom_main{margin-bottom: 60px;}</style>
    <style>
        .el-select {
            height: 32px;
        }
        .el-input__inner {
            height: 32px !important;
        }
    </style>
</head>
<body>
<div  class="commom_wrap" id="supplier-list" style="width:100%;">
    <img src="../Public/images/ajax-loader.gif" width="" height="" alt="" class="img_load-pos hide"/>
    <!--载入搜索模块-->
    <form action="" method="get" id="form_btbtc" class="row">
        <div class="card common_top_menu">
            <div class="card-block" >
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                <th width="2%"></th>
                                <th width="21%"></th>
                                <th width="2%"></th>
                                <th width="2%"></th>
                                <th width="21%"></th>
                                <th width="2%"></th>
                                <th width="2%"></th>
                                <th width="21%"></th>
                                <th width="2%"></th>
                                <th width="2%"></th>
                                <th width="21%"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td><{$Think.lang.供应商}></td>
                                <td><input type="text" name="SP_NAME" value="<{$params.SP_NAME}>"  placeholder="<{$Think.lang.供应商名称}>" class="input-text keywords form-control" /></td>
                                <td></td>
                                <td><{$Think.lang.创建人}></td>
                                <td> <input type="text" name="CREATE_USER_ID" value="<{$params.CREATE_USER_ID}>"  placeholder="<{$Think.lang.创建人}>" class="input-text keywords form-control" /></td>
                                <td></td>
                                <td><{$Think.lang.国家}></td>
                                <td>
                                    <fieldset class="form-group">
                                        <select name="SP_ADDR1" class="select form-control" id="guo_bie">
                                            <option value=""><{$Think.lang.请选择国家}></option>
                                            <?php
                                                foreach (BaseModel::getCountries() as $cd => $nm) {
                                                    ?>
                                                        <option value="<?= $cd ?>" <if condition="$params.SP_ADDR1 eq $cd">selected="selected"</if> ><?= $nm ?></option>
                                                    <?php
                                                }
                                            ?>
                                        </select>
                                    </fieldset>
                                </td>
                                <td></td>
                                <td><{$Think.lang.采购团队}></td>
                                <td>
                                    <fieldset class="form-group">
                                        <select name="SP_TEAM_CD" class="select form-control" id="cai_gou">
                                            <option value=""><{$Think.lang.请选择采购团队}></option>
                                            <?php
                                                foreach (BaseModel::spTeamCd() as $cd => $nm) {
                                                                        ?>
                                                    <option value="<?= $cd ?>" <if condition="$params.SP_TEAM_CD eq $cd">selected="selected"</if> ><?= $nm ?></option>
                                                    <?php
                                                }
                                            ?>
                                        </select>
                                    </fieldset>
                                </td>
                            </tr>
                            <tr>
                                <td><{$Think.lang.审核状态}></td>
                                <td>
                                    <fieldset class="form-group">
                                        <select name="AUDIT_STATE" class="select form-control" id="AUDIT_STATE">
                                            <option value=""><{$Think.lang.选择审核状态}></option>
                                            <?php
                                                foreach (BaseModel::auditState() as $cd => $nm) {
                                                    ?>
                                                <option value="<?= $cd ?>" <if condition="$params.AUDIT_STATE eq $cd">selected="selected"</if>>
                                                    <{$Think.lang.$nm}>
                                                </option>
                                            <?php
                                                }
                                            ?>
                                        </select>
                                    </fieldset>
                                </td>
                                <td></td>
                                <td><{$Think.lang.风险评级}></td>
                                <td>
                                    <fieldset class="form-group">
                                        <select name="RISK_RATING" class="select form-control" id="RISK_RATING">
                                            <option value=""><{$Think.lang.选择风险评级}></option>
                                            <?php
                                                foreach (BaseModel::riskRating() as $cd => $nm) {
                                              ?>
                                                <option value="<?= $cd ?>" <if condition="$params.RISK_RATING eq $cd">selected="selected"</if> >
                                                    <!-- <?= $nm ?> -->
                                                    <{$Think.lang.$nm}>
                                                </option>
                                                <?php
                                                }
                                            ?>
                                        </select>
                                    </fieldset>
                                </td>
                                <td></td>
                                <td><{$Think.lang.合作评级}></td>
                                <td>
                                    <select name="cooperative_rating" class="select form-control" id="cooperative_rating">
                                        <option value=""><{$Think.lang.选择合作评级}></option>
                                        <?php
                                                foreach (BaseModel::getCooperativeRatingForFilter() as $cd => $nm) {
                                        ?>
                                        <option value="<?= $cd ?>" <if condition="$params.cooperative_rating eq $cd">selected="selected"</if> ><?= $nm ?></option>
                                        <?php
                                                }
                                            ?>
                                    </select>
                                </td>
                                <td></td>
                                <td>
                                    <{$Think.lang.介绍团队}>
                                </td>
                                <td>
                                    <!-- php 代码 -->
                                    <fieldset class="form-group">
                                        <select name="SP_JS_TEAM_CD" class="select form-control" id="jie_shao">
                                            <option value=""><{$Think.lang.请选择介绍团队}></option>
                                            <?php
                                                foreach (BaseModel::spJsTeamCd() as $cd => $nm) {
                                                                        ?>
                                                    <option value="<?= $cd ?>" <if condition="$params.SP_JS_TEAM_CD eq $cd">selected="selected"</if> >
                                                        <!-- <?= $nm ?> -->
                                                        <{$Think.lang.$nm}>
                                                    </option>
                                                    <?php
                                                }
                                            ?>
                                        </select>
                                    </fieldset>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>
                                    <{$Think.lang.ID}>
                                </td>
                                <td><input type="text" name="ID" value="<{$params.ID}>" placeholder="<{$Think.lang.ID}>"
                                        class="input-text keywords form-control" /></td>
                                <td></td>
                                <td>{{$lang('企业类型')}}</td>
                                <td>
                                    <el-select v-model="companyTypeCd" collapse-tags multiple @change="handleCompanyTypeSelect" :placeholder="$lang('请选择')">
                                        <el-option
                                          v-for="companyCd in companyTypeCds"
                                          :key="companyCd.cd"
                                          :label="$lang(companyCd.cdVal)"
                                          :value="companyCd.cd">
                                        </el-option>
                                      </el-select>
                                </td>
                                <td></td>
                                <td>
                                    <{$Think.lang.营业执照号}>
                                </td>
                                <td><input type="text" name="SP_CHARTER_NO" value="<{$params.SP_CHARTER_NO}>" placeholder="<{$Think.lang.输入营业执照号}>"
                                           class="input-text keywords form-control" /></td>
                            </tr>
                            <input type="hidden" name="company_type" value="" id="company_type">
                            <input type="hidden" name="m" value="<{$Think.MODULE_NAME}>">
                            <input type="hidden" name="a" value="<{$Think.ACTION_NAME}>">
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>
        <div class="row common_row_search ">
            <div class="col-lg-12 text-left col-md-12 col-sm-12">
                <button name="" class="btn btn-search" type="submit"><{$Think.lang.搜索}></button>
                <button type="button" value="" class="btn btn-clear btn-reset-clear" @click="reset"><{$Think.lang.重置}></button>
                <input type="hidden" name="CREATE_PLAT_CD" value="<{$params.CREATE_PLAT_CD}>"/>
            </div>
        </div>
    </form>

    <div style="height: 10px;"></div>
    <p class="commom_p"></p>
    <!--数据列表 -->
    <div class="row commom_main">
        <div style="width: 100%;">
            <form method="post" enctype="multipart/form-data">
                <span class="commom_main_recode"><{$Think.lang.共}> <{$count}> <{$Think.lang.条记录}></span>
                <input type="hidden" name="m" value="Supplier">
                <input type="hidden" name="a" value="mult_import_supplier">
                <div id="form_download">
                    <a class="btn button-style" href="<{:U('Supplier/template_download', array('name' => 'supplier_in.xls'))}>"><{$Think.lang.下载导入模板}></a>
                </div>
                <button type="submit" class="btn btnextend" ><{$Think.lang.执行导入}></button>
                <div id="form_choseFile">
                    <span  class="btn btnextend" href="#supplier_file" id="supplier_file_name"><{$Think.lang.选择文件}></span>
                    <input type="file" name="file"  id="supplier_file" onchange="document.getElementById('supplier_file_name').innerHTML = this.value?this.value:'<{$Think.lang.选择文件}>'"/>
                </div>
            </form>
        </div>
        <table class="table table-sort commom_table common_gsy_list" style="min-width: 1400px;">
            <thead>
                <tr class="text-c no-wrap">
                    <th></th>
                    <foreach name="model:attributes" key="k" item="val">
                        <!-- model层返回字段 -->
                        <th><{$Think.lang.$val}></th> 
                    </foreach>
                    <th><{$Think.lang.操作}></th>
                </tr>
            </thead>
            <tbody class="show-data">
                <foreach name="result" key="k" item="vo">
                    <!--供应商数据-->
                    <tr>
                        <empty name="vo.contracts">
                            <td class=""><i class="fa-minus fa"></i></td>
                            <else /> <td class="cur-s"><span><i class="fa-plus fa"></i></span></td>
                        </empty>
                        <foreach name="model:attributes" key="ks" item="val">
                            <?php
                                if ($ks == 'SP_TEAM_CD') {
                                    $sps = explode(',', $vo['SP_TEAM_CD']);
                                    if (count($sps) > 1) {
                                        $str = '';
                                        foreach ($sps as $key => $value) {
                                            $str .= $spTeamCd[$value] . ',';
                                        }
                                        $str = rtrim($str, ',');
                                        echo '<td class="no-wrap">'. $str .'</td>'; 
                                    } else {
                                        echo '<td class="no-wrap">'. $spTeamCd[$vo['SP_TEAM_CD']] .'</td>';
                                    }
                                } elseif ($ks == 'SP_JS_TEAM_CD') {
                                    echo '<td class="no-wrap">'. $spJsTeamCd[$vo['SP_JS_TEAM_CD']] .'</td>';
                                } elseif ($ks == 'CREATE_USER_ID') {
                                    echo '<td class="no-wrap">'. $allUserInfo[$vo['CREATE_USER_ID']] .'</td>';
                                } elseif ($ks == 'SP_ADDR1') {
                                    echo '<td class="no-wrap">'. $allCountryInfo[$vo['SP_ADDR1']] .'</td>';
                                } elseif ($ks == 'contract') {
                                    echo '<td class="no-wrap">'. count($vo['contracts']) .'</td>';
                                } elseif ($ks == 'AUDIT_STATE') {
                                ?>
                                    <if condition="$vo.AUDIT_STATE eq 1 ">
                                        <td class="no-wrap"><{$Think.lang.未审核}></td>
                                        <elseif condition="$vo.AUDIT_STATE eq 2" />
                                            <td class="no-wrap"><{$Think.lang.已审核}></td>
                                        <else />
                                            <td class="no-wrap"><{$Think.lang.无需审核}></td>
                                    </if>
                                <?php
                                } elseif ($ks == 'RISK_RATING') {
                                    $c_v = '-';
                                    switch ($vo['audit']['RISK_RATING']) {
                                        case 1:
                                            $c_v = '低风险';
                                            break;
                                        case 2:
                                            $c_v = '中风险';
                                            break;
                                        case 3:
                                            $c_v = '高风险';
                                            break;
                                    }
                                ?>
                                    <td class="no-wrap"><{$Think.lang.$c_v}></td>
                                <?php
                                } elseif ($ks == 'audit_time') {
                                    $time = $vo['audit']['REV_TIME']?$vo['audit']['REV_TIME']:'-';
                                ?>
                                    <td class="no-wrap"><{$time}></td>
                                <?php
                                } elseif ($ks == 'SP_NAME') {

                                ?>
                                    <td class="no-wrap"><{:L($vo[$ks])}></td>
                                <?php
                                } else {
                                    echo '<td class="no-wrap">'. $vo[$ks] .'</td>';
                                } 
                            ?>
                        </foreach>
                        <td class="cur">
                            <a class="btn btn-co-check" onclick="opennewtab(this,'供应商详情页')" _href="<{:U('Supplier/show', array('ID' => $vo[ID]))}>"><{$Think.lang.查看}></a>
                              <?php if(ButtonAction::hidden()){ ?>
                            <button class="btn btn-co-delete" onclick="del_supplier(<{$vo.ID}>, '<{$vo.SP_NAME}>');"><{$Think.lang.删除}></button>
                             <?php } ?>
                            <!--<a class="btn btn-pink" href="<{:U('Supplier/upload_contract')}>"><{$Think.lang.添加合同}></a>-->
                            <?php
                                if (!$vo['audit']) {
                                    //foreach (BaseModel::regionalClassification() as $key => $value) {
                                        //if (array_search($vo['SP_ADDR3'], $value) !== false and $key == 1) {
                                        if (true) {
                                            if ($auditRule) {
                                                if ($vo['AUDIT_STATE'] == '1') {
                            ?>
                                                <a class="btn btn-co-examine" onclick="opennewtab(this,'<{$Think.lang.供应商审核页}>')" _href="<{:U('Supplier/audit', array('ID' => $vo[ID]))}>"><{$Think.lang.审核}></a>
                            <?php
                                                }
                                            }
                                        }
                                    //}
                                }
                            ?>
                        </td>
                    </tr>
                    <!--合同-->
                    <tr class="hidden">
                        <td colspan="16" class="padding0">
                            <div class="insert-wrap">
                                <table class="table table-border table-bordered table-bg" style="width: 100%;">
                                    <thead class="th-wrap">
                                        <foreach name="contract:attributes" key="k" item="val">
                                            <th ><{$Think.lang.$val}></th>
                                        </foreach>
                                            <th><{$Think.lang.操作}></th>
                                    </thead>
                                    <tbody class="td-wrap">
                                        <foreach name="vo.contracts" key="vc" item="voc">
                                            <tr>
                                                <foreach name="contract:attributes" key="rs" item="v">
                                                    <if condition="$rs eq 'IS_RENEWAL'">
                                                            <if condition="$voc.IS_RENEWAL eq 1">
                                                                <td class="no-wrap"><{$Think.lang.否}></td>
                                                                <else /><td class="no-wrap"><{$Think.lang.是}></td>
                                                            </if>
                                                    <elseif condition="$rs eq 'START_TIME'"/><td class="no-wrap"><?= cutting_time($voc[$rs]) ?></td>
                                                    <elseif condition="$rs eq 'END_TIME'"/><td class="no-wrap"><?= cutting_time($voc[$rs]) ?></td>
                                                    <elseif condition="$rs eq 'CON_STAT'"/>
                                                        <if condition="$voc.CON_STAT eq 1">
                                                            <td class="no-wrap"><{$Think.lang.有效}></td>
                                                            <else /><td class="no-wrap"><{$Think.lang.失效}></td>
                                                        </if>
                                                    <else /> <td class="no-wrap"><{$voc.$rs}></td>
                                                    </if>
                                                </foreach>
                                                
                                                <td class="insert-wrap-left">
                                                    <a class="btn btn-co-check" onclick="opennewtab(this,'详情页')" _href="<{:U('Supplier/show_contract', array('ID' => $voc[ID]))}>"><{$Think.lang.查看}></a>
                                                    <a class="btn  btn-co-edit" onclick="opennewtab(this,'编辑页')" _href="<{:U('Supplier/update_contract', array('ID' => $voc[ID]))}>"><{$Think.lang.编辑}></a>
                                                    <?php
                                                        if ($voc['SP_ANNEX_ADDR1']) {
                                                    ?>
                                                            <!--<a class="btn btn-co-delete" href="<{:U('Supplier/contract_download', array('ID' => $voc[ID]))}>"><{$Think.lang.下载合同}></a>-->
                                                    <?php
                                                        } else {
                                                    ?>
                                                            <!--<button class="btn btn-co-delete" onclick="layer.msg('<{$Think.lang.文件不存在}>');"><{$Think.lang.下载合同}></button>-->
                                                    <?php
                                                        }
                                                    ?>
                                                </td>
                                            </tr>
                                        </foreach>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                </foreach>
            </tbody>
        </table>
        <include file="search_result" />
    </div>
</div>
<script type="text/javascript" src="../Public/lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="../Public/lib/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../Public/lib/layer/1.9.3/layer.js"></script>
<script type="text/javascript" src="../Public/lib/laypage/1.2/laypage.js"></script>
<script type="text/javascript" src="../Public/js/H-ui.js"></script>
<script type="text/javascript" src="../Public/js/H-ui.admin.js?<{$Think.config.VER_NUM}>"></script>
<script type="text/javascript" src="../Public/js/jquery-ui.min.js"></script>
<script type="text/javascript" src="../Public/js/vue.2.5.13.js"></script>
<script type="text/javascript" src="../Public/js/axios.min.js"></script>
<script type="text/javascript" src="../Public/js/element-ui-2.2.js"></script>
</body>
<script>
    var vm = new Vue({
        el: '#supplier-list',
        data: {
            companyTypeCds: [],
            companyTypeCd: '<{$params.company_type}>' && '<{$params.company_type}>'.split(','),
        },
        created() {
            this.getCommonData();
        },
        methods: {
            getCommonData() {
                var params = {
                    data: {
                        query: {
                            "company_type": true,
                        }
                    }
                }
                var _this = this;
                axios.post('index.php?g=oms&m=CommonData&a=commonData', params).then(function(res) {
                    if (res.data.code === 2000) {
                        _this.companyTypeCds = res.data.data.company_type
                    }
                })
            },
            handleCompanyTypeSelect() {
                $('#company_type').val(this.companyTypeCd.join(','))
            },
            reset() {
                this.companyTypeCd = [];
                $('#company_type').val('')
                $('#form_btbtc').submit();
            }
        }
    })
</script>
<script>
    $(".btn-reset-clear").click(function () {
         $("input[name='ID']").val("");
         $("input[name='SP_NAME']").val("");
         $("input[name='CON_NO']").val("");
         $("#cai_gou option:first").prop("selected", 'selected');
         $("#guo_bie option:first").prop("selected", 'selected');
         $("#jin_xing option:first").prop("selected", 'selected');
         $("#AUDIT_STATE option:first").prop("selected", 'selected');
         $("#RISK_RATING option:first").prop("selected", 'selected');
    });
    $('.show-data tr td span').click(function() {
        var _this = $(this).parent().parent();
        if (_this.next().hasClass('hidden')) {
            _this.next().removeClass('hidden');
            $(this).html('<i class="fa fa-minus"></i>');
        } else {
            _this.next().addClass('hidden');
            $(this).html('<i class="fa fa-plus"></i>');
        }
    });

    function del_supplier(id, supplierSpName)
    {
        var id = id;
        var url = '<{:U("supplier/del_supplier")}>';
        var index = 0;

        layer.confirm('<{$Think.lang.是否删除供应商}>' +  '-' + supplierSpName, {
            btn: ['确定','取消']
            }, function(){
                $.ajax({
                    'url': url,
                    'type': 'POST',
                    'data':{ID: id},
                    beforeSend:function(XMLHttpRequest){
                        index = layer.load(2, {
                            shade: [0.1,'#fff']
                        });
                    },
                    success: function (data) {
                        layer.close(index);
                        if (data.status == 1) {
                            layer.msg(data.info.msg);
                            setTimeout(function () { 
                                window.location.reload();
                            }, 1000);
                        } else {
                            layer.msg(data.info.msg);
                        }
                    },
                    error:function(XMLHttpRequest,textStatus,errorThrown){
                        layer.close(index);
                        layer.msg('error...状态文本值：'+textStatus+" 异常信息："+errorThrown);
                    }
                });
            }, function(){
                
            }
        );
    }
</script>
</html>